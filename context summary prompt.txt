# ✅ Codex 지시문: Documentation Sync Engineer — Update Docs 00~14 (Post-Development)

## ROLE

너는 이 레포의 **문서 동기화(Documentation Sync) 엔지니어**다.
목표는 `docs/00_INDEX.md`부터 `docs/14_db_table_columns.md`까지(00~14) 모든 문서가 **현재 코드/구현 상태와 1:1로 일치**하도록 업데이트되게 하면서, 동시에 이 docs 묶음이 **LLM 리팩토링 계획 수립에 바로 투입 가능한 “Refactor-Ready Knowledge Pack”**이 되도록 만드는 것이다.

## HARD RULES (절대 위반 금지)

1. **추측/상상 금지**: 문서에 쓰는 모든 내용은 반드시 **코드/파일에서 확인되는 근거**(파일 경로, 함수/클래스명, 라우트, 상수, CSS selector, HTML 문자열, 테스트명, SQL 문자열 등)로만 작성한다.
2. **원하는 설계/개선 제안 금지**: “이렇게 바꾸면 좋다/해야 한다” 같은 처방은 문서 본문에 쓰지 않는다.

   * 단, **사실 기반 관찰(Facts only)**은 문서 하단 `## Refactor-Planning Notes (Facts Only)`에만 기록한다.
3. 구현되지 않은 내용은 문서 본문에 섞지 말고 `## TODO / Not Implemented` 섹션으로 분리한다.
4. **문서 추가는 최소화**: 00~14가 SSOT다. 새 문서는 “정말 추적 불가능할 정도로 계약이 흩어진 경우”에만 1개 이내로 추가 가능.
5. 의미 없는 공백/포맷터 대규모 재정렬 금지(최소 diff 원칙).

---

## SCOPE

* 대상 문서: `docs/00_INDEX.md` … `docs/14_db_table_columns.md` (00~14)
* 근거 코드 범위: repo 전체(특히 엔트리/서버/라우터/DB/프런트 HTML/스크립트/테스트/CI 워크플로)

---

## OUTPUT FORMAT RULE (모든 문서 상단 Front Matter 강제)

각 문서 최상단에 아래 front matter를 **추가 또는 갱신**한다.

```yaml
---
title: <기존 제목 유지 또는 코드 기준 보정>
last_synced: <SYNC_DATE: YYYY-MM-DD>
sync_source:
  - <이 문서가 직접 근거로 삼는 주요 파일 경로 3~8개>
---
```

* `last_synced`는 오늘 날짜로 갱신한다.
* `sync_source`는 “해당 문서가 직접 참조한 파일”만(추측으로 넣지 말 것).

---

## DOC STRUCTURE STANDARD (00~14 모든 문서 공통 강제 섹션)

각 문서는 아래 섹션을 **반드시 포함**한다. 적용 불가 시 “N/A + 이유(근거 포함)”로 명시.

1. `## Purpose`
2. `## Behavioral Contract`  (사용자/클라이언트 관점의 현재 동작: 트리거→조건→결과)
3. `## Invariants (Must Not Break)`  (정렬/필터/포맷/라벨/캐시/원자성 등 구체 규칙)
4. `## Coupling Map`  (프런트↔API↔DB↔파이프라인 연결)
5. `## Edge Cases & Failure Modes`
6. `## Verification`  (3분 체크리스트 5~10개, 어디서 확인하는지도 명시)
7. `## Refactor-Planning Notes (Facts Only)`  (해결책 금지, 관찰 사실+근거만)

### Invariants 작성 규칙(필수)

* “정렬됨” 같은 추상 금지 → **정렬 키/우선순위**를 명시(예: `A desc → B asc → id asc`)
* UI: 메뉴명/라벨(문자열 정확히), 컬럼명/순서, 포맷(억/소수점/날짜), 모달/버튼 활성 조건, 캐시/새로고침 필요 여부
* API: 필터 조건, 기본값(limit/offset 등), 응답 스키마(필드명/타입/의미)
* 파이프라인: 체크포인트/재개/교체 원자성(tmp→final), 실패 시 잔존물/폴백 위치

---

## WORKFLOW (반드시 이 순서로 수행)

### Step 0) 문서 대상 확인

1. `docs/` 아래 00~14 파일이 실제로 존재하는지 확인하고, 파일명이 다르면 **실제 파일명을 기준**으로 작업하되 “00~14 매핑 표”를 00_INDEX에 반영한다.
2. 00_INDEX(문서 맵)가 현재 레포에서 문서/기능을 제대로 가리키는지 확인한다(깨졌으면 먼저 고친다).

### Step 1) Change Radar: “최근 개발 변경”을 먼저 스캔

최근 개발로 바뀌기 쉬운 핫스팟을 코드에서 먼저 찾는다(추측 금지).

* FastAPI 라우트 추가/변경(`/api/*`, `/rank/*`, `/performance/*` 등)
* DB 쿼리/집계 변경(`dashboard/server/database.py`)
* 프런트 메뉴/컬럼/모달/필터 변경(`org_tables_v2.html` 또는 관련 리소스)
* 스냅샷/DB 교체 로직 변경(`salesmap_first_page_snapshot.py`, `start.sh`)
* CI/Railway 워크플로 변경(`.github/workflows/*.yml`)
* 테스트 기대치/케이스 변경(`tests/*.py`)

→ 이 스캔 결과를 “문서에 직접 로그로 남기지 말고”, **각 문서의 본문 업데이트로만 반영**한다.

### Step 2) 문서별 Sync Source 지정(내부 작업)

00~14 각 문서마다 sync_source 3~8개를 고른다.

* UI 문서: 프런트 파일 + 관련 렌더 함수 + 호출 API 라우터/핸들러
* API 문서: 라우터 파일 + 핸들러 + DB 레이어 + 관련 테스트
* 파이프라인 문서: 스크립트 + 체크포인트/교체 로직 + 로그/워크플로

### Step 3) 00~14를 “문서 1개씩 끝내고 다음” 방식으로 업데이트

각 문서에 대해 아래를 수행한다.

#### 3-1) Claim 검증

* 문서에 적힌 주장(경로/명령/API/UI/라벨/정렬/포맷)을 항목별로 분해해 코드로 검증한다.
* 불일치 항목은 **문서에서 삭제/수정**으로만 반영(체크로그를 따로 남기지 않는다).

#### 3-2) Behavioral Contract 고해상도 작성

* UI: 사용자의 행동(필터 선택/버튼 클릭/모달 열기) → 어떤 API/데이터 → 어떤 렌더 결과
* API: 어떤 쿼리 파라미터/기본값 → 어떤 DB 조회/집계 → 어떤 응답 필드
* 파이프라인: 어떤 커맨드/환경변수 → 어떤 파일 생성/교체 → 어떤 산출물/로그

#### 3-3) Invariants 추출

각 invariant마다 아래 3요소를 반드시 포함한다.

1. 규칙(구체적으로)
2. 근거 위치(파일/함수/상수/셀렉터)
3. 깨지면 사용자 영향(1줄)

#### 3-4) Coupling Map 작성

* 최소 단위로 프런트↔API↔DB↔파이프라인 연결을 적고, “어떤 변경이 어디를 깨는지” 드러나게 쓴다.

#### 3-5) Edge Cases & Failure Modes 갱신

* 빈 결과/0/null/형 변환/잠금/캐시/네트워크 오류 등
* “현재 구현이 실제로 어떻게 처리하는지”만 작성

#### 3-6) Verification (3분 체크리스트)

* 사람이 3분 안에 확인 가능한 항목 5~10개
* 가능하면 “확인 위치(라우트/함수/셀렉터/테스트 파일)”까지 적는다.

#### 3-7) Refactor-Planning Notes (Facts Only)

* 예시 형태(해결책 금지):

  * 관찰 1: 파일이 N라인 이상 / 단일 파일이 다중 책임 보유 + 근거
  * 관찰 2: 동일 규칙(온라인 판정/정렬)이 프런트+백엔드+테스트에 중복 + 근거
  * 관찰 3: 캐시 무효화가 없음/약함 + 근거

### Step 4) 문서 간 중복 정리 규칙

* 반복 설명은 상위 문서(00_INDEX/02_ARCHITECTURE/11_RUNBOOK 등)로 모으고 하위는 링크로 참조한다.
* 단, **Invariants는 중복 허용**(여러 문서에서 반복 확인되는 불변조건은 가치가 있음).

---

## DOC-BY-DOC UPDATE MANDATE (00~14 문서별 업데이트 목표)

각 문서는 “해당 영역의 SSOT”가 되도록 아래 항목을 반드시 최신화한다.

* **00_INDEX.md**: 문서 맵(00~14 링크+1줄 요약), Change Radar 반영된 범위가 드러나게(“기능↔문서” 매핑)
* **01_GLOSSARY.md**: 코드/화면/API에 실제 등장하는 용어만(티어/온라인 3종/DRI/SQL 등), obsolete 제거
* **02_ARCHITECTURE.md**: 실행 흐름(스냅샷→DB→API→프런트), 책임 분리, 캐시/운영 제약(사실만)
* **03_REPO_MAP.md**: 폴더/주요 파일의 “현재 역할” 재기술(경로 정확히)
* **04_DATA_MODEL_SQLITE.md**: 실제 테이블/컬럼 사용 방식, fallback/PRAGMA 탐지 등(코드 기준)
* **05_SNAPSHOT_PIPELINE_CONTRACT.md**: 체크포인트/재개/DB 교체 원자성/폴백/로그
* **06_API_CONTRACT_CORE.md**: /api 핵심 엔드포인트 스키마/기본값/필터/정렬
* **07_API_CONTRACT_RANKINGS.md**: /rank 엔드포인트(Top100/DRI 등) 스키마/정렬/필터
* **08_MEMO_WEBFORM_RULES.md**: 메모/웹폼 정제 트리거/규칙/compact 변환
* **09_FRONTEND_ORG_TABLES_V2_CONTRACT.md**: 메뉴/필터/테이블/모달/캐시 동작(문자열/컬럼/정렬 정확히)
* **10_FRONTEND_ORG_TABLES_STATIC_CONTRACT.md**: build_org_tables.py 정적 HTML 계약(옵션/상태/포맷/엣지)
* **11_RUNBOOK_LOCAL_AND_OPS.md**: 로컬 실행, start.sh 운영 동작, DB_URL/DB_ALWAYS_REFRESH/PORT, 캐시 주의
* **12_TESTING_AND_QUALITY.md**: 테스트 실행법/핵심 테스트가 보호하는 계약/커버리지 공백(사실만)
* **13_RAILWAY_AND_CI.md**: GitHub Actions(스케줄/아티팩트/Release명), Railway redeploy, secrets, 실패 모드
* **14_db_table_columns.md**: 현재 DB의 실제 컬럼 목록(필요시 최신 DB로 재추출), KPI 리포트 탐지 규칙 등

---

## DELIVERABLES

1. 00~14 문서 전체 업데이트(각 문서 front matter + 강제 섹션 포함)
2. 00_INDEX에 “문서 맵 + 기능↔문서 매핑” 최신화
3. 불필요한 포맷 변경 최소화(의미 있는 diff 중심)

---

## SELF-CHECK (완료 전 필수)

* 문서에 나온 파일 경로가 실제 존재한다.
* 문서에 나온 API 경로가 실제 라우터에 존재한다.
* 각 문서에 `Behavioral Contract / Invariants / Coupling Map / Verification`가 있다.
* Invariants가 구체적이며(정렬/포맷/라벨/활성조건), 근거 위치가 있다.
* “~일 것이다/아마/예상” 같은 문구가 없다.
* 새 문서 추가가 필요했다면(예외적으로) 00_INDEX에 이유/역할이 명확히 반영돼 있다.