1: **MVP 산출물(=매일 자동으로 보는 “카운터파티 리스크 리포트”)**

- 1.1: 오늘 기준(YYYY-MM-DD)으로 **S0~P2 고객사에 속한 모든 카운터파티**를 대상으로
- 1.2: **2026 비온라인 목표 vs (확정+예상) 체결액**을 계산하고
- 1.3: **“가장 큰 갭/리스크 카운터파티”를 자동으로 상단에 랭킹**해서 보여주는 대시보드 메뉴 1개

2: **핵심 목적함수(단 하나)**

- 2.1: `매일 자동으로 “가장 큰 갭/리스크 카운터파티”를 찾아서 위에서부터 보여준다`
- 2.2: 여기서 “리스크”는 (A) 갭 + (B) 파이프라인 제로 + (C) 정성(메모) 기반 허들로 구성

3: **성공 판정(1주 MVP)**

- 3.1: 리포트가 **매일 자동 생성**되고(수동 0분)
- 3.2: 상단 “심각” 카운터파티를 보면 **왜 문제인지(근거 3개) + 무엇을 해야 하는지(추천 액션)**가 납득 가능
- 3.3: 리포트만 보고 담당자에게 “현황/전략 요구”를 할 때 **엉뚱한 대상이 상단에 뜨지 않는다(체감상 make sense)**

4: **집계 단위(정의 고정)**

- 4.1: “카운터파티” 키 = `(organizationId(고객사) , people.소속 상위 조직(카운터파티명))`
- 4.2: 화면 표기 = `고객사명 / 카운터파티명`
- 4.3: peopleId가 없는 deal은 카운터파티를 못 잡으므로 **“미분류(카운터파티 없음)”**으로 따로 묶고 데이터품질 경고로 처리(리스크 상단에는 기본 제외 or 별도 섹션)

5: **비온라인 정의(고정)**

- 5.1: `과정포맷 ∈ {구독제(온라인), 선택구매(온라인), 포팅}` → 온라인
- 5.2: 그 외(‘복합’ 포함) → 비온라인

6: **딜 포함/제외 규칙**

- 6.1: deal row 하나 = 1 deal
- 6.2: `상태 == 'Convert'`는 **항상 제외**

7: **금액 필드 선택(고정)**

- 7.1: `금액` 있으면 그걸 사용
- 7.2: `금액` 없으면 `예상 체결액` 사용
- 7.3: 숫자 파싱 실패/빈값이면 0 처리 + 데이터품질 플래그

8: **날짜(연도) 선택(고정)**

- 8.1: 기본 날짜 = `계약 체결일` 우선, 없으면 `수주 예정일`
- 8.2: 단, **연도 귀속은 ‘수강시작일’ 우선**(있으면 그 연도로 귀속)
- 8.3: 즉 `deal_year = year(수강시작일) if exists else year(계약 체결일 or 수주 예정일)`
- 8.4: (중요) 이 규칙으로 **2025 체결일이라도 수강시작일이 2026이면 2026으로 이동**됨

9: **확정/예상(파이프라인) 분류(고정)**

- 9.1: `계약 체결(확정)`

  - 조건: `상태=='Won'` AND `수강시작일, 수강종료일, 코스ID, 계약 체결일, 금액` 모두 존재

- 9.2: `성사 확정(확정)`

  - 조건: (9.1 미충족) AND `성사 가능성=='확정'`
  - 날짜: `계약 체결일` 있으면 사용, 없으면 `수주 예정일` 사용(둘 다 없으면 “연도 미정”으로 경고)
  - 금액: `금액` 우선, 없으면 `예상 체결액`

- 9.3: `성사 높음(예상)`

  - 조건: `성사 가능성=='높음'` (그리고 보통 `상태`는 Won/Lost/Convert가 아님)
  - 금액: `금액` 우선, 없으면 `예상 체결액`
  - 확률가중: **100% 반영(=그대로 더함)**

10: **2026 “진행 상황” 계산식(카운터파티별)**

- 10.1: `확정체결액_2026 = Σ(계약 체결 + 성사 확정) where 비온라인 AND deal_year=2026`
- 10.2: `예상체결액_2026 = Σ(성사 높음) where 비온라인 AND deal_year=2026`
- 10.3: `총커버리지_2026 = 확정체결액_2026 + 예상체결액_2026`

11: **2025 기준액(타겟 베이스라인) 계산(카운터파티별)**

- 11.1: `체결액_2025 = Σ(계약 체결 + 성사 확정) where 비온라인 AND deal_year=2025`
- 11.2: (중요) 8.4 규칙 때문에 “체결일 2025지만 수강시작 2026”은 자동으로 2026으로 빠져서 **2025 기준액에 포함되지 않음**

12: **고객사 티어(S0/P0/P1/P2) 자동 산정(수동 0분 설계)**

- 12.1: 고객사(organizationId)별 `체결액_2025(비온라인, 확정)`을 계산
- 12.2: 티어 규칙(추정: 금액 단위는 원 기준으로 처리 후 구간은 억 기준)

  - S0: `>= 10억` (단, 고객사명에 “삼성전자” 포함이면 제외)
  - P0: `2억 ~ <10억`
  - P1: `1억 ~ <2억`
  - P2: `0.5억 ~ <1억`

- 12.3: 위 티어에 속한 고객사의 카운터파티만 리포트 대상

13: **2026 타겟 산정(카운터파티별, 연간 1개 숫자)**

- 13.1: `target_2026 = 체결액_2025(카운터파티) * multiplier(고객사 티어)`
- 13.2: multiplier

  - S0: 1.5
  - P0: 1.7
  - P1: 1.7
  - P2: 1.5

- 13.3: 체결액\_2025가 0이면 target_2026도 0(신규/확장 타겟은 MVP에서는 “모름/추정” 영역 → 별도 설정파일로 확장 가능)

14: **갭 정의(고정)**

- 14.1: `gap = target_2026 - (확정체결액_2026 + 예상체결액_2026)`
- 14.2: `gap <= 0`이면 “목표 커버(양호)”로 처리

15: **파이프라인 제로 정의(고정)**

- 15.1: `pipeline_zero = (확정체결액_2026 + 예상체결액_2026 == 0) AND target_2026 > 0`
- 15.2: pipeline_zero는 **우선순위 최상위 플래그**(무조건 “심각” 후보)

16: **리스크 레벨(양호/보통/심각) 규칙(규칙+LLM 하이브리드)**

- 16.1: 1차(규칙)로 레벨 부여 → 2차(LLM)가 “이유/허들” 생성(레벨은 보통 규칙 우선)
- 16.2: 규칙 레벨(추정: 2026-01-03 기준, 월별 기대 커버리지 최소치 테이블)

  - 월별 최소 커버리지(min_cov_by_month):
    Jan 0.05 / Feb 0.10 / Mar 0.15 / Apr 0.20 / May 0.25 / Jun 0.30 / Jul 0.40 / Aug 0.50 / Sep 0.60 / Oct 0.75 / Nov 0.90 / Dec 1.00
  - `coverage = (확정+예상)/target` (target=0이면 coverage는 “N/A”)
  - 심각:

    - pipeline_zero = True **OR**
    - coverage < 0.5 \* min_cov_by_month(현재월)

  - 보통:

    - 0.5\*min_cov ≤ coverage < min_cov

  - 양호:

    - coverage ≥ min_cov **OR** gap ≤ 0

- 16.3: 보조 신호(있으면 근거 bullet로만 활용, 레벨을 뒤집지는 않음)

  - 최근 연락일(딜/피플의 ‘최근 연락일’)이 30일 이상 비어있거나 오래됨
  - 최근 90일 Lost 다수
  - 메모에서 “예산/승인/담당자 변경” 키워드 반복

17: **허들(장애물) 카테고리 10개(고정 라벨)**

- 17.1: `PIPELINE_ZERO` 딜 자체 없음(파이프라인 0)
- 17.2: `BUDGET` 예산 없음/동결/재무 악화
- 17.3: `DECISION_MAKER` 의사결정자 부재/변경/챔피언 이탈
- 17.4: `APPROVAL_DELAY` 내부 승인/구매/법무 지연
- 17.5: `LOW_PRIORITY` 우선순위 낮음/타이밍 안 맞음
- 17.6: `COMPETITOR` 경쟁사/대체재로 밀림
- 17.7: `FIT_UNCLEAR` 니즈 불명확/제품-니즈 미스매치
- 17.8: `NO_RESPONSE` 응답 없음/관계 약함/미팅 불가
- 17.9: `PRICE_TERM` 가격/조건/견적 이슈
- 17.10: `SCHEDULE_RESOURCE` 일정/운영 리소스/과정 설계 문제

18: **LLM 역할(“확률 예측”이 아니라 “리스크/이유/추천 액션 생성”)**

- 18.1: LLM 입력(카운터파티별)

  - 숫자 요약: target, 확정, 예상, gap, coverage, pipeline_zero, 최근연락일(가능하면), 최근 Lost 개수/사유
  - 딜 샘플: 2026 관련 딜 중 금액 상위 5개(이름/상태/성사가능성/금액/수강시작일/계약체결일/수주예정일)
  - 메모: 최근 N일(추천 180일) 메모 전문(딜/피플/조직 연결된 것) + 너무 길면 상위 20개만

- 18.2: LLM 출력(JSON 고정)

  - `risk_level`: "양호|보통|심각" (참고용, 규칙과 다르면 reason에 “규칙상 심각/보통” 명시)
  - `top_blockers`: 위 10개 중 최대 3개
  - `evidence_bullets`: 근거 3개(각 1문장)
  - `recommended_actions`: 추천 액션 2~3개(중간 레벨)

- 18.3: LLM 호출 대상(비용/속도 고려)

  - 기본: “보통/심각”만 호출
  - 추가: gap 상위 Top K(예: 20개)도 호출
  - 양호는 LLM 생략 가능(근거는 숫자 bullet로 대체)

19: **추천 액션(고정 템플릿 매핑)**

- 19.1: blocker→액션 매핑(예)

  - PIPELINE_ZERO: “의사결정자 맵핑 / 니즈 재발굴 / 시퀀스·세미나로 접점 생성”
  - BUDGET: “예산 라인 확인 / ROI·성과사례로 재프레이밍 / 단계형 제안”
  - DECISION_MAKER: “조직도·스폰서 재확인 / 챔피언 대체군 확보”
  - APPROVAL_DELAY: “구매·법무 체크리스트 확보 / 마감 타임라인 합의”
  - LOW_PRIORITY: “핵심 이슈와 교육의 연결 재정의 / 임원 아젠다 맞춤”
  - COMPETITOR: “비교표+레퍼런스 제시 / 차별 포인트 1페이지”
  - FIT_UNCLEAR: “니즈 인터뷰 / 커리큘럼 맞춤안 / 파일럿 제안”
  - NO_RESPONSE: “관계 리셋(다른 접점) / 내부 소개 루트 탐색”
  - PRICE_TERM: “패키징 조정 / 옵션 분리 / 조건 재설계”
  - SCHEDULE_RESOURCE: “일정 후보 3개 제안 / 운영 리소스 선점”

20: **우선순위(랭킹) 산정(정렬 키 고정)**

- 20.1: 정렬 우선순위(내림차순)

  1. `pipeline_zero` (True 먼저)
  2. `고객사 티어` (S0 > P0 > P1 > P2)
  3. `gap 절대금액` (큰 순)
  4. `카운터파티 2025 체결액` (큰 순)

- 20.2: 이유: 사용자가 원하는 “티어 우선”을 지키면서도 목적함수(갭/리스크)를 직접 반영

21: **리포트 상단 요약(요구사항 반영)**

- 21.1: “S0/P0/P1에서 70억, P2에서 10억 만들 수 있나?”를 숫자로 즉시 답

  - `target_sum(S0~P1)`, `coverage_sum(S0~P1)`, `gap_sum(S0~P1)`
  - `target_sum(P2)`, `coverage_sum(P2)`, `gap_sum(P2)`

- 21.2: 상태 요약

  - 심각/보통/양호 카운트
  - pipeline_zero 카운트(최우선 대응 대상 수)

22: **카운터파티 상세 카드(필수 필드 고정)**

- 22.1: 헤더: `고객사명 / 카운터파티명 (티어)`
- 22.2: KPI 1줄: `target | 확정 | 예상 | gap | coverage%`
- 22.3: 라벨: `양호/보통/심각`, `PIPELINE_ZERO 여부`
- 22.4: 근거 3개 bullet(최소)

  - (숫자 근거 1~2개) + (메모/이슈 근거 1~2개)

- 22.5: 추천 액션 2~3개
- 22.6: 딜 리스트(카운터파티 내부 우선순위 = 금액 상위)

  - 2026 관련 딜: 금액 상위 5~10개
  - 각 딜 표시: `딜이름, 상태, 성사가능성, 금액, 수강시작일, 계약체결일/수주예정일, 최근연락일(있으면)`

- 22.7: 메모 요약(LLM 또는 룰 기반)

  - “최근 핵심 이슈 3줄” + “키워드(예산/승인/담당자변경/경쟁 등)”

23: **데이터 처리 파이프라인(서버 내부)**

- 23.1: 입력: `salesmap_latest.db` (deal/people/organization/memo)
- 23.2: 1단계: 정규화 뷰/임시 테이블 생성(런타임)

  - deal: 금액/날짜 파싱, is_nononline, deal_year, counterparty_name 조인

- 23.3: 2단계: 2025 확정액 집계 → 고객사 티어 산정
- 23.4: 3단계: 카운터파티 2025 기준액 → 2026 타겟 산정
- 23.5: 4단계: 카운터파티 2026 확정/예상 집계 → gap/coverage
- 23.6: 5단계: 리스크 레벨(규칙) + (선택) LLM 이유 생성
- 23.7: 6단계: 리포트 JSON 생성

24: **저장(캐시) 전략(스냅샷 DB 교체 리스크 대응)**

- 24.1: `salesmap_latest.db`는 매일 교체되므로, 리포트 결과는 **별도 파일/별도 DB**에 저장
- 24.2: MVP 권장: `report_cache/yyyymmdd.json` (간단/안전)
- 24.3: 캐시 키: `as_of_date + (salesmap_latest.db 파일 해시 or 최신 수정날짜)`

  - 동일 스냅샷이면 재계산/LLM 재호출 방지

25: **LLM 호출 최적화(비용/속도)**

- 25.1: 카운터파티별 “입력 텍스트 해시” 저장 → 변동 없으면 LLM 결과 재사용
- 25.2: 메모는 “최근 180일, 최대 20개”로 자르고, 딜/숫자 요약은 구조화해서 토큰 절약
- 25.3: LLM 실패 시 폴백

  - blocker: 룰 키워드(예산/승인/담당자/경쟁)로 임시 라벨
  - 근거 bullet: 숫자 기반 3개만 출력

26: **대시보드/UX(메뉴 1개)**

- 26.1: 메뉴: `카운터파티 리스크(일간)`
- 26.2: 기본 화면(위→아래)

  1. 전체 요약(70억/10억)
  2. “심각” 섹션(정렬 적용)
  3. “보통” 섹션
  4. “양호” 섹션(기본 접기 가능)

- 26.3: 필터

  - 티어(S0/P0/P1/P2)
  - 리스크(양호/보통/심각)
  - pipeline_zero만 보기

- 26.4: 각 카드 클릭 시 딜 리스트/메모 요약 펼침

27: **API 설계(대략)**

- 27.1: `GET /api/report/counterparty-risk?date=YYYY-MM-DD`

  - date 없으면 today(서버 기준, 추정: Asia/Seoul)

- 27.2: `POST /api/report/counterparty-risk/recompute` (옵션, 관리자용)

  - 캐시 무시하고 재생성(LLM 포함)

- 27.3: 응답: JSON

  - `meta(as_of, db_version_hash)`
  - `summary(by_tier_group)`
  - `counterparties[]` (각 카드 데이터)

28: **스케줄링(매일 아침 1회 고정)**

- 28.1: 추정 타임존: `Asia/Seoul`
- 28.2: 방식 A(가장 단순): **첫 접속 시 오늘 리포트 없으면 생성**
- 28.3: 방식 B(더 “자동”): 서버 내부 cron(APScheduler)로 매일 08:00 생성 + 캐시 저장
- 28.4: DB 업데이트 타이밍과 충돌 시

  - DB 파일의 최신 수정시각/해시가 바뀐 뒤에만 생성하도록 가드

29: **데이터 품질 경고(리포트에 같이 표시)**

- 29.1: “연도 미정 딜 수”(계약체결일/수주예정일/수강시작일 모두 없음)
- 29.2: “금액 미정 딜 수”(금액/예상 체결액 모두 없음)
- 29.3: “카운터파티 미분류 딜 수”(peopleId 없음 or people join 실패)
- 29.4: 이 경고가 많으면 리스크 판단도 함께 “신뢰도 낮음” 배지 표시

30: **검증(테스트) 체크리스트(필수)**

- 30.1: 온라인/비온라인 분류가 요구사항과 일치(3개 값만 온라인)
- 30.2: 2025 체결일 + 2026 수강시작 → 2026으로 귀속되는지
- 30.3: ‘Convert’ 제외되는지
- 30.4: ‘Won + 필수필드’ → 계약 체결로 분류되는지
- 30.5: ‘성사 가능성 확정/높음’ 분류 및 금액 fallback 정상 동작
- 30.6: 티어 산정 구간이 의도대로(삼성전자 제외 포함)

31: **1주 MVP 구현 순서(작업 단위로 쪼갠 플랜)**

- 31.1: (D1) 데이터 파서/정규화 레이어: 금액/날짜 파싱 + is_nononline + counterparty join
- 31.2: (D2) 2025 확정액 집계 → 고객사 티어 자동 산정
- 31.3: (D3) 카운터파티 2025 기준액 → 2026 target 산정
- 31.4: (D4) 2026 확정/예상 집계 → gap/coverage → 규칙 리스크 레벨
- 31.5: (D5) 리포트 JSON + API endpoint + 프런트 메뉴 노출
- 31.6: (D6) LLM 이유/액션 생성(보통/심각만) + 캐시
- 31.7: (D7) 스케줄링(08:00) + 로그/에러 폴백

32: **MVP 이후(지금은 미루지만 확장 포인트)**

- 32.1: 메일 발송(요약만) + 링크
- 32.2: “리스크 레벨 오버라이드(수동)” 기능
- 32.3: 성사 가능성 ‘높음’을 100% 대신 과거 성사율로 캘리브레이션(카운터파티별 베이스라인)
- 32.4: 주간 회고용 트렌드(7일 변화: gap/coverage/메모 키워드)
