<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 B2B Dashboard</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --panel-2: #0c1424;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --accent-2: #f97316;
      --success: #22c55e;
      --error: #f87171;
      --shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Pretendard', 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 18% 12%, rgba(56, 189, 248, 0.08), transparent 28%),
        radial-gradient(circle at 84% 8%, rgba(249, 115, 22, 0.07), transparent 26%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      background: linear-gradient(145deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 12px;
      align-items: start;
    }

    .sidebar {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 200px;
    }

    .menu-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .menu-section {
      margin-top: 10px;
    }

    .menu-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 8px 10px;
      opacity: 0.9;
      border-radius: 10px;
      transition: background 0.15s ease;
    }

    .menu-section-header:hover {
      background: rgba(56, 189, 248, 0.08);
    }

    .menu-section-header.active-section {
      font-weight: 700;
    }

    .menu-section-items {
      padding-left: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .menu-toggle-icon {
      font-size: 12px;
      opacity: 0.7;
    }

    .menu-title {
      color: var(--muted);
      font-size: 13px;
      letter-spacing: 0.01em;
    }

    /* Counterparty Risk (cpr-) */
    .cpr-header {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .cpr-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin: 10px 0 4px;
    }
    .cpr-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    /* Global numeric alignment utility */
    th.num,
    td.num {
      text-align: right !important;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    /* Global DRI alignment utility */
    th.dri,
    td.dri {
      text-align: center !important;
      white-space: nowrap;
    }
    /* DRI table horizontal scroll wrapper */
    .table-scroll-x {
      overflow-x: auto;
      overflow-y: hidden;
    }
    /* Prevent wrapping in headers/cells inside scrollable tables */
    .table-scroll-x table th,
    .table-scroll-x table td {
      white-space: nowrap;
    }
    .table-scroll-x table td {
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Global DRI alignment utility */
    th.dri,
    td.dri {
      text-align: center !important;
      white-space: nowrap;
    }
    .cpr-card h3 {
      margin: 0 0 6px;
      font-size: 16px;
    }
    .cpr-kpi-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 13px;
    }
    .cpr-kpi {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(56, 189, 248, 0.08);
    }
    .cpr-chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 6px 0 4px;
    }
    .cpr-chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      cursor: pointer;
      font-size: 12px;
    }
    .cpr-chip.active {
      border-color: var(--accent);
      color: var(--accent);
    }
    .cpr-filter-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin: 8px 0;
    }
    .cpr-section {
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
      overflow: hidden;
    }
    .cpr-section summary {
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .cpr-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .cpr-table th,
    .cpr-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }
    .cpr-table th {
      background: var(--panel-2);
      position: sticky;
      top: 0;
      z-index: 1;
      text-align: left;
    }
    .cpr-table .num {
      text-align: right;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .cpr-row-detail {
      margin: 6px 0 10px;
      padding: 10px;
      border-radius: 10px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .cpr-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
    }
    .cpr-pill.error {
      border-color: var(--error);
      color: var(--error);
    }
    .cpr-pill.warn {
      border-color: var(--accent);
      color: var(--accent);
    }
    .cpr-pill.success {
      border-color: var(--success);
      color: var(--success);
    }

    /* QC modal/table */
    .qc-modal .modal {
      padding: 36px 24px;
      max-height: calc(100vh - 2cm);
      overflow: auto;
    }
    .qc-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: fixed;
    }
    .qc-table th,
    .qc-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }
    .qc-table thead th {
      position: sticky;
      top: 0;
      background: var(--panel-2);
      z-index: 1;
      text-align: left;
    }
    .qc-table tbody tr:nth-child(even) {
      background: rgba(0, 0, 0, 0.02);
    }
    .qc-table tbody tr:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    .qc-table .num {
      text-align: right;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .qc-deal-name {
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .qc-guidance {
      color: var(--muted-text, #666);
    }
    .qc-three-col {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }
    .qc-table-wrap {
      overflow-x: auto;
    }
    .qc-rule-section {
      margin-bottom: 16px;
    }
    .qc-rule-section h4 {
      margin: 0 0 6px 0;
      font-size: 28px;
    }
    .qc-modal .modal-header {
      position: relative;
    }
    .qc-modal .close-btn {
      position: absolute;
      right: 8px;
      top: 8px;
    }

    .menu-item {
      width: 100%;
      text-align: left;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1d30;
      color: var(--text);
      padding: 10px;
      cursor: pointer;
      transition: border-color 0.15s ease, background 0.15s ease;
    }

    .menu-item:hover {
      border-color: var(--accent);
    }

    .menu-item.active {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.12);
    }

    .seg-btn {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0f1d30;
    }

    .seg-btn.active {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.12);
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.01em;
    }

    .control-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .spacer {
      flex: 1;
    }

    select,
    button,
    input {
      background: #0c182c;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px 11px;
      font-size: 14px;
    }

    input[type="text"] {
      min-width: 220px;
    }

    button {
      background: linear-gradient(120deg, #0f213a, #122a49);
      cursor: pointer;
      transition: border-color 0.15s ease, transform 0.1s ease;
    }

    button:hover {
      border-color: var(--accent);
    }

    button:active {
      transform: translateY(1px);
    }

    .main-vertical {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 220px;
    }

    .card h2 {
      margin: 0;
      font-size: 15px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card.compact {
      padding: 8px 10px;
      min-height: auto;
      gap: 8px;
    }

    /* Compact header cards for control rows */
    .card.compact-header {
      padding: 8px 10px;
      min-height: auto;
      gap: 6px;
    }

    .dealcheck-screen .card {
      min-height: auto;
    }

    .card h2.dealcheck-retention-title {
      font-size: 30px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(34, 197, 94, 0.14);
      color: #22c55e;
    }

    .card h2.dealcheck-new-title {
      font-size: 30px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(251, 191, 36, 0.14);
      color: #fbbf24;
    }

    .dealcheck-screen .table-wrap,
    .dealcheck-table-wrap {
      overflow-x: auto;
      max-width: 100%;
    }

    .dealcheck-screen .dealcheck-table,
    .dealcheck-screen .dealcheck-table * {
      white-space: nowrap !important;
      word-break: keep-all !important;
      overflow-wrap: normal !important;
    }

    .dealcheck-screen .dealcheck-table {
      table-layout: fixed;
      width: 100%;
    }

    .dealcheck-screen .dealcheck-table th,
    .dealcheck-screen .dealcheck-table td {
      padding: 2px 8px;
      line-height: 18px;
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dealcheck-screen .btn-memo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 18px;
      line-height: 18px;
      padding: 0 8px;
      border-radius: 8px;
      font-size: inherit;
      vertical-align: middle;
      box-sizing: border-box;
      min-height: 0;
      min-width: 0;
      max-width: 100%;
      white-space: nowrap;
    }

    .btn-memo--active {
      cursor: pointer;
      border: 1px solid rgba(52, 211, 153, 0.55);
      background: rgba(52, 211, 153, 0.14);
      color: #34d399;
    }

    .btn-memo--active:hover {
      background: rgba(52, 211, 153, 0.22);
    }

    /* Target 2026 */
    .target2026-wrap { padding: 14px; }
    .target2026-header { display:flex; flex-direction:column; gap:6px; margin-bottom: 12px; }
    .target2026-title { font-size: 22px; font-weight: 900; }
    .target2026-sub { opacity: 0.75; font-size: 12px; }
    .target2026-grid-wrap { width: 100%; overflow-x: auto; }
    .target2026-grid { width: 100%; min-width: 960px; display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px; justify-items: stretch; align-items: stretch; }
    .target2026-card { padding: 14px; min-height: 120px; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; background: rgba(255,255,255,0.06); border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.08); backdrop-filter: blur(4px); width: auto; }
    .target2026-card-title { font-size: 18px; font-weight: 800; margin-bottom: 10px; }
    .target2026-card-metric { font-size: 28px; font-weight: 900; letter-spacing: -0.02em; font-variant-numeric: tabular-nums; }
    .target2026-card.top { border: 1px solid rgba(52,211,153,0.25); }
    .target2026-card.bottom { border: 1px solid rgba(251,191,36,0.25); }
    .target2026-card:hover { transform: translateY(-1px); transition: 120ms; }
    @media (max-width: 1100px) { .target2026-grid { grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 640px) { .target2026-grid { grid-template-columns: 1fr;} .target2026-card-metric { font-size: 24px; } }

    .btn-memo--active:focus {
      outline: 2px solid rgba(52, 211, 153, 0.45);
      outline-offset: 2px;
    }

    .btn-memo--disabled {
      cursor: not-allowed;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.35);
      box-shadow: none;
      filter: grayscale(1);
      opacity: 0.85;
      pointer-events: none;
    }

    .btn-memo--disabled:focus {
      outline: none;
    }

    .dealcheck-deal-name {
      display: inline-block;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: bottom;
      white-space: nowrap !important;
    }

    .sm-link {
      color: var(--accent);
      text-decoration: none;
      white-space: nowrap;
    }

    .sm-link:hover {
      text-decoration: underline;
    }

    .dealcheck-table td[data-col="personName"] a.sm-link {
      display: inline-block;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .memo-modal {
      max-width: 900px;
      width: min(900px, 92vw);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    .memo-modal .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .memo-modal .modal-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
    }

    .memo-modal .modal-body {
      overflow: auto;
      padding: 12px;
    }

    .memo-modal .modal-close {
      cursor: pointer;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #1f2937;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .memo-modal .modal-close:hover {
      background: rgba(56, 189, 248, 0.18);
    }

    .memo-modal table {
      width: 100%;
      border-collapse: collapse;
    }

    .memo-modal th,
    .memo-modal td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-size: 13px;
    }

    .memo-modal td.memo-date {
      white-space: nowrap;
      width: 80px;
    }

    .memo-modal td.memo-text {
      white-space: pre-wrap !important;
      word-break: break-word;
      overflow-wrap: anywhere;
      font-size: 1.5em !important;
      line-height: 1.45;
    }

    .memo-table {
      table-layout: fixed;
      width: 100%;
    }

    .control-row.tight {
      margin-top: 2px;
      gap: 6px;
    }

    .quad-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
      align-items: stretch;
      min-height: 320px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .code-block {
      background: #0c182c;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 320px;
      overflow: auto;
    }

    .json-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: start;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .col {
      flex: 1 1 0;
      min-width: 280px;
    }


    .json-box {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0c182c;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 120px;
    }

    th,
    td {
      padding: 8px 9px;
      border-bottom: 1px solid var(--border);
    }

    th {
      text-align: left;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    tr:hover {
      background: rgba(56, 189, 248, 0.08);
    }

    tr.active {
      background: rgba(56, 189, 248, 0.14);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .table-wrap {
      overflow: auto;
      max-height: 320px;
      border: 1px solid var(--border);
      border-radius: 10px;
      height: 100%;
    }

    .table-wrap.full {
      max-height: none;
    }

    .table-wrap.half {
      max-height: none;
    }

    .perf-table th,
    .perf-table td {
      min-width: 64px;
      white-space: nowrap;
    }

    .perf-table thead th {
      position: sticky;
      top: 0;
      z-index: 3;
      background: #0c182c;
    }

    .perf-table .sticky-col {
      position: sticky;
      left: 0;
      z-index: 2;
      background: #0c182c;
    }

    .perf-table thead .sticky-col {
      z-index: 4;
    }

    /* 월별 체결액 전용 테이블/셀 스타일 */
    .mp-monthly-table th,
    .mp-monthly-table td,
    .mp-monthly-table .mp-cell-btn {
      font-size: 12px;
      line-height: 1;
      text-align: center;
      vertical-align: middle;
      font-variant-numeric: tabular-nums;
    }

    .mp-monthly-table td.mp-kind,
    .mp-monthly-table th.mp-kind {
      text-align: center;
    }

    .mp-monthly-table .mp-cell-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 3.6em;
      height: 1.9em;
      padding: 0 0.2em;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: inherit;
      text-align: center;
    }

    .mp-monthly-table button.mp-cell-btn {
      cursor: pointer;
    }

    .mp-monthly-table .mp-cell-btn.is-zero {
      opacity: 0.55;
      border-color: rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.03);
      cursor: default;
    }

    .mp-monthly-table td.mp-num {
      width: 4.2em;
      min-width: 4.2em;
      padding: 0.15em 0.25em;
      text-align: center;
    }

    .pl-progress-table .row-label {
      text-align: left;
      padding-left: 6px;
      min-width: 140px;
    }

    .pl-progress-table .row-label.level-1 {
      padding-left: 18px;
    }

    /* P&L 전용 테이블 (임원 대시보드 스타일) */
    .pnl-table {
      border-collapse: separate;
      border-spacing: 0;
    }

    .pnl-table th,
    .pnl-table td {
      padding: 8px 10px;
      text-align: right !important;
    }

    .pnl-table th.col-item,
    .pnl-table td.col-item {
      text-align: left !important;
    }

    .pnl-table thead th {
      position: sticky;
      top: 0;
      z-index: 3;
    }

    .pnl-table th.group {
      font-weight: 700;
      letter-spacing: 0.2px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.18);
      text-transform: none;
    }

    .pnl-table th.year-group {
      background: rgba(255, 255, 255, 0.08);
      border-left: 2px solid rgba(255, 255, 255, 0.3);
      border-right: 2px solid rgba(255, 255, 255, 0.3);
    }

    .pnl-table .col-year {
      background: rgba(255, 255, 255, 0.06);
    }

    .pnl-table td.col-year {
      font-weight: 650;
      color: rgba(255, 255, 255, 0.92);
    }

    .pnl-table th.col-year {
      font-weight: 750;
      color: rgba(255, 255, 255, 0.95);
    }

    .pnl-table .year-start {
      border-left: 2px solid rgba(255, 255, 255, 0.28);
    }

    .pnl-table .year-end {
      border-right: 2px solid rgba(255, 255, 255, 0.28);
    }

    .pnl-table .col-t {
      background: rgba(255, 255, 255, 0.03);
    }

    .pnl-table .col-e {
      background: linear-gradient(180deg, rgba(80, 160, 255, 0.14) 0%, rgba(80, 160, 255, 0.06) 100%);
    }

    .pnl-table td.col-year.col-e,
    .pnl-table th.col-year.col-e {
      background: linear-gradient(180deg, rgba(80, 160, 255, 0.18) 0%, rgba(80, 160, 255, 0.08) 100%);
    }

    .pnl-table .month-start {
      border-left: 1px solid rgba(255, 255, 255, 0.12);
    }

    .pnl-table .badge {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.3px;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .pnl-table .badge-t {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
    }

    .pnl-table .badge-e {
      background: rgba(80, 160, 255, 0.22);
      color: rgba(255, 255, 255, 0.95);
      border-color: rgba(80, 160, 255, 0.25);
    }

    .pnl-table td.clickable {
      color: rgba(255, 255, 255, 0.95);
    }

    .pnl-table td.clickable:hover {
      cursor: pointer;
      filter: brightness(1.08);
      text-decoration: underline;
    }

    .pnl-table .pnl-num {
      display: block;
      width: 100%;
      text-align: right !important;
      font-variant-numeric: tabular-nums;
    }

    .mp-deals-table .pnl-num {
      display: block;
      width: 100%;
      text-align: right !important;
      font-variant-numeric: tabular-nums;
    }

    .pnl-table .pnl-item {
      display: block;
      width: 100%;
      text-align: left !important;
    }

    .pnl-table .pnl-head-right {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      width: 100%;
    }

    .pnl-table .is-current-month {
      background: rgba(255, 255, 255, 0.07);
    }

    .pnl-table .is-current-month.col-e {
      background: linear-gradient(180deg, rgba(80, 160, 255, 0.2) 0%, rgba(80, 160, 255, 0.1) 100%);
    }

    .pnl-table .current-month-start {
      border-left: 2px solid rgba(255, 255, 255, 0.28);
    }

    .pnl-table .current-month-end {
      border-right: 2px solid rgba(255, 255, 255, 0.28);
    }

    .pnl-table td.is-current-month .pnl-num {
      color: rgba(255, 255, 255, 0.96);
      font-weight: 650;
    }

    .pnl-table th.is-current-month-group {
      background: rgba(255, 255, 255, 0.09);
      border-left: 2px solid rgba(255, 255, 255, 0.28);
      border-right: 2px solid rgba(255, 255, 255, 0.28);
    }

    :root {
      --pnl-lever-h: 72px;
      --pnl-btn-gap: 8px;
    }

    /* P&L 가정(Assumptions) 바 */
    .pnl-assumptions {
      display: block;
      margin: 10px 0 12px 0;
      overflow-x: hidden;
    }

    .pnl-top-split {
      display: flex;
      gap: 0;
      align-items: flex-start;
    }

    .pnl-top-left {
      flex: 0 0 66.666%;
      min-width: 0;
      padding-right: 10px;
    }

    .pnl-top-right {
      flex: 0 0 33.333%;
      min-width: 0;
    }

    @media (max-width: 1100px) {
      .pnl-top-split {
        flex-direction: column;
      }
      .pnl-top-left {
        flex-basis: auto;
        width: 100%;
        padding-right: 0;
      }
      .pnl-top-right {
        display: none;
      }
    }

    .pnl-assump-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
      min-width: 0;
      flex-wrap: nowrap;
    }

    @media (max-width: 1100px) {
      .pnl-assump-row {
        flex-wrap: wrap;
      }
    }

    .pnl-field {
      padding: 8px 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      min-width: 0;
      height: var(--pnl-lever-h);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      flex: 1 1 0;
    }

    .pnl-field .label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pnl-ctrl {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .pnl-field input {
      width: 100%;
      min-width: 0;
      height: 34px;
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 6px 8px;
      color: rgba(255, 255, 255, 0.92);
    }

    .pnl-field .unit {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      white-space: nowrap;
    }

    .pnl-field.is-dirty {
      border-color: rgba(80, 160, 255, 0.28);
      background: rgba(80, 160, 255, 0.06);
    }

    .pnl-step {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.92);
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }

    .pnl-step:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .pnl-assump-actions {
      display: flex;
      flex-direction: column;
      gap: var(--pnl-btn-gap);
      align-items: stretch;
    }

    .pnl-action-btn {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.92);
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      line-height: 1;
    }

    .pnl-action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .pnl-actions-stack {
      height: var(--pnl-lever-h);
      display: flex;
      flex-direction: column;
      gap: var(--pnl-btn-gap);
      flex: 0 0 140px;
      min-width: 120px;
    }

    .pnl-actions-stack .pnl-action-btn {
      height: calc((var(--pnl-lever-h) - var(--pnl-btn-gap)) / 2);
    }

    .pnl-assump-info {
      margin-top: 8px;
      padding: 10px 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
    }

    .pnl-assump-info.hidden {
      display: none;
    }

    .pnl-assump-info .small {
      font-size: 12px;
      line-height: 1.4;
    }

    /* P&L 가정 확인 모달 */
    #pnlAssumpModalBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1300;
    }

    #pnlAssumpModalBackdrop.show {
      display: flex;
    }

    .pnl-assump-modal {
      width: min(520px, 92vw);
      border-radius: 14px;
      background: rgba(12, 18, 32, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
      overflow: hidden;
    }

    .pnl-assump-modal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .pnl-assump-modal .modal-title {
      font-weight: 750;
      font-size: 15px;
    }

    .pnl-assump-modal .modal-body {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pnl-assump-modal .modal-x {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.92);
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* ✅ 딜 목록 모달 폭/높이/스크롤 개선 */
    .modal.deals-modal-wide {
      width: min(96vw, 1400px) !important;
      max-width: 96vw !important;
      max-height: min(90vh, 900px);
      overflow: hidden;
    }

    .modal.deals-modal-wide .body {
      overflow: hidden !important;
      white-space: normal;
      padding: 0;
    }

    .deals-modal-scroll {
      overflow: auto;
      max-height: calc(min(90vh, 900px) - 56px);
      padding: 0 12px 12px;
    }

    /* ✅ 딜 모달 테이블: 값 길이대로 컬럼 폭 결정 */
    .modal.deals-modal-wide table.mp-deals-table {
      table-layout: auto;
      width: max-content;
      max-width: none;
    }

    /* ✅ 딜이름 칼럼: 20글자(≈20em) + 말줄임 확실히 */
    .modal.deals-modal-wide .deal-name-cell {
      width: 20em !important;
      max-width: 20em !important;
      min-width: 20em !important;
      white-space: nowrap;
    }

    .modal.deals-modal-wide .deal-name-cell .deal-name-link {
      display: block;
      width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ✅ auto-fit 컬럼: 내용 길이대로, 숨김 금지 */
    .modal.deals-modal-wide .mp-deals-table th.auto-fit,
    .modal.deals-modal-wide .mp-deals-table td.auto-fit {
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
    }

    /* ✅ 모달 딜 테이블: 좌측 정렬 강제 */
    .modal.deals-modal-wide .mp-deals-table th.align-left,
    .modal.deals-modal-wide .mp-deals-table td.align-left {
      text-align: left !important;
      padding-left: 10px;
    }

    .mp-deals-table thead th {
      position: static;
      background: rgba(12, 18, 32, 0.98);
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }

    .mp-deals-table td.num,
    .mp-deals-table th.num {
      text-align: right !important;
      font-variant-numeric: tabular-nums;
    }

    .mp-deals-table td.txt,
    .mp-deals-table th.txt {
      text-align: left !important;
    }

    .mp-deals-table tbody tr:nth-child(2n) {
      background: rgba(255, 255, 255, 0.02);
    }

    .mp-deals-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .deals-modal-header {
      position: sticky;
      top: 0;
      z-index: 6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(10, 16, 28, 0.98);
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }

    .deals-modal-title {
      font-weight: 750;
      font-size: 14px;
    }

    .deals-modal-subtitle {
      margin-top: 2px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.65);
    }

    .deals-modal-x {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.92);
      font-size: 18px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .deals-modal-x:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .deals-modal-x:active {
      transform: translateY(1px);
    }

    .breadcrumb {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #0c182c;
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.15);
      color: var(--accent);
      font-size: 11px;
      letter-spacing: 0.02em;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
    }

    .status.good {
      color: var(--success);
    }

    .status.bad {
      color: var(--error);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #0f1d30;
      cursor: pointer;
      font-size: 12px;
    }

    .chip.active {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.12);
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }

    .stat-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #0f1d30;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 72px;
    }

    .matrix-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      text-align: center;
    }

    .matrix-table th,
    .matrix-table td {
      border: 1px solid var(--border);
      padding: 6px;
    }

    .matrix-table td.active {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.12);
    }

    .event-badges {
      display: grid;
      grid-template-columns: repeat(2, minmax(40px, 1fr));
      gap: 6px;
    }

    .event-badge {
      display: inline-block;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .event-badge.active {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.12);
    }

    .info-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .info-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .memo-text {
      white-space: pre-wrap;
    }

    .toast {
      position: fixed;
      bottom: 18px;
      right: 18px;
      background: #111827;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      min-width: 220px;
      max-width: 340px;
      font-size: 13px;
      color: var(--text);
      display: none;
    }

    .toast.error {
      border-color: rgba(248, 113, 113, 0.4);
      color: var(--error);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 16px;
    }

    .modal {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      max-width: 520px;
      width: 100%;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal header {
      background: none;
      border: none;
      box-shadow: none;
      padding: 0;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }

    .modal h3 {
      margin: 0;
      font-size: 16px;
      color: var(--text);
    }

    .modal .meta {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .modal .body {
      background: #0c182c;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      white-space: pre-wrap;
      line-height: 1.45;
      max-height: 360px;
      overflow: auto;
    }

    .modal .code-body {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      word-break: break-all;
    }

    .json-modal {
      max-width: 1040px;
      width: 100%;
    }

    .json-modal .body {
      max-height: 720px;
    }

    /* Extra wide modal for counterparty detail */
    .modal.xl {
      max-width: 90vw;
      width: 90vw;
      min-width: 1200px;
    }

    .webform-modal {
      max-width: 1040px;
      width: 100%;
    }

    .webform-modal .body {
      max-height: 540px;
      white-space: normal;
      overflow: auto;
    }

    .nowrap-ellipsis {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 240px;
      display: inline-block;
      vertical-align: top;
    }

    .close-btn {
      background: #1f2937;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
    }

    /* StatePath filter drawer */
    .sp-drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 90;
    }

    .sp-drawer-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }

    .sp-drawer {
      position: fixed;
      top: 0;
      right: -420px;
      width: min(400px, 90vw);
      height: 100vh;
      background: #0f172a;
      border-left: 1px solid var(--border);
      box-shadow: -6px 0 20px rgba(0, 0, 0, 0.3);
      transition: right 0.22s ease;
      z-index: 91;
      display: flex;
      flex-direction: column;
    }

    .sp-drawer.open {
      right: 0;
    }

    .sp-drawer__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(120deg, #0f1d30, #102034);
    }

    .sp-drawer__body {
      padding: 14px 16px 20px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .sp-drawer__section {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #0c1424;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sp-drawer__title {
      font-weight: 700;
      font-size: 14px;
    }

    .sp-drawer__hint {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .sp-icon-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .sp-filter-cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.08);
      cursor: pointer;
      font-weight: 800;
      letter-spacing: -0.2px;
      user-select: none;
      transition: border-color 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
    }

    .sp-filter-cta:hover {
      background: rgba(255, 255, 255, 0.11);
      border-color: rgba(255, 255, 255, 0.22);
    }

    .sp-filter-cta:focus {
      outline: none;
    }

    .sp-filter-cta:focus-visible {
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
    }

    .sp-filter-cta__icon {
      opacity: 0.95;
      font-size: 14px;
    }

    .sp-filter-cta__text {
      font-size: 14px;
    }

    .sp-filter-cta__badge {
      min-width: 24px;
      height: 20px;
      padding: 0 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      background: rgba(255, 255, 255, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .sp-filter-cta.is-active {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .sp-filter-cta.is-active .sp-filter-cta__badge {
      background: rgba(255, 255, 255, 0.28);
    }

    .sp-filter-cta.is-open {
      background: rgba(255, 255, 255, 0.14);
      border-color: rgba(255, 255, 255, 0.35);
    }

    @keyframes spPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.0);
      }
      50% {
        box-shadow: 0 0 0 6px rgba(255, 255, 255, 0.12);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.0);
      }
    }

    .sp-filter-cta.hint-pulse {
      animation: spPulse 1.2s ease-in-out 2;
    }

    .applied-bar {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(56, 189, 248, 0.05);
    }

    .sp-header-card {
      padding: 10px 12px;
      margin-bottom: 6px;
    }

    .sp-header-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sp-applied-bar {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      overflow-x: auto;
      white-space: nowrap;
      padding: 2px 0;
      min-height: 28px;
    }

    .sp-applied-bar .pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
    }

    .sp-clear-btn {
      background: #1c283a;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }

    /* StatePath cards: remove global min-height */
    .sp-card {
      min-height: 0 !important;
      height: auto !important;
      align-self: flex-start;
      gap: 8px;
    }

    .sp-card .control-row {
      margin: 0;
    }

    .sp-card h2 {
      margin: 0;
    }

    /* Snapshot tiles */
    .sp-snapshots {
      padding: 0;
      margin: 0;
    }

    .sp-snap-card {
      padding: 10px 12px;
    }

    .sp-snap-grid {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(140px, 1fr);
      gap: 10px;
      align-items: start;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      padding-bottom: 0;
    }

    .sp-snap-tile {
      padding: 8px 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
    }

    .sp-snap-label {
      font-size: 12px;
      opacity: 0.75;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sp-snap-value {
      margin-top: 6px;
      font-size: 16px;
      font-weight: 700;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        flex-direction: row;
        flex-wrap: wrap;
      }
      .menu-item {
        flex: 1;
        min-width: 140px;
        text-align: center;
      }
      .quad-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
      }
      .table-wrap {
        max-height: 260px;
      }
      .json-grid {
        grid-template-columns: 1fr;
      }
    }

  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="menu-title">메뉴</div>
      <ul id="menuList" class="menu-list"></ul>
    </aside>

    <div class="content">
      <div id="contentRoot"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal-backdrop" id="memoModalBackdrop">
    <div class="modal">
      <header>
        <h3>메모 상세</h3>
        <button class="close-btn" id="memoModalClose" type="button">닫기</button>
      </header>
      <div class="meta">
        <span id="memoModalDate">-</span>
        <span id="memoModalAuthor">-</span>
      </div>
      <div class="body" id="memoModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="jsonModalBackdrop">
    <div class="modal json-modal">
      <header>
        <h3 id="jsonModalTitle">JSON 보기</h3>
        <button class="close-btn" id="jsonModalClose" type="button">닫기</button>
      </header>
      <div class="body code-body" id="jsonModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="webformModalBackdrop">
    <div class="modal webform-modal">
      <header>
        <h3 id="webformModalTitle">웹폼 내역</h3>
        <button class="close-btn" id="webformModalClose" type="button">닫기</button>
      </header>
      <div class="body" id="webformModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="dealsModalBackdrop">
    <div class="modal json-modal deals-modal-wide">
      <header class="deals-modal-header">
        <div>
          <div class="deals-modal-title" id="dealsModalTitle">딜 목록</div>
          <div class="deals-modal-subtitle" id="dealsModalSubtitle"></div>
        </div>
        <button class="deals-modal-x" id="dealsModalClose" type="button" aria-label="닫기">✕</button>
      </header>
      <div class="body code-body" id="dealsModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="dealMemoModalBackdrop">
    <div class="memo-modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title" id="dealMemoModalTitle">딜 메모</div>
        <button class="modal-close" id="dealMemoModalClose" type="button" aria-label="닫기">×</button>
      </div>
      <div class="modal-body" id="dealMemoModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="statePathModalBackdrop">
    <div class="modal json-modal">
      <header>
        <h3 id="statePathModalTitle">StatePath</h3>
        <div class="spacer"></div>
        <button class="chip" id="statePathCoreCopyBtn" type="button" title="Core JSON 복사">Core JSON 복사</button>
        <button class="close-btn" id="statePathModalClose" type="button">닫기</button>
      </header>
      <div class="body" id="statePathModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="statePathLegendBackdrop">
    <div class="modal json-modal">
      <header>
        <h3 id="statePathLegendTitle">StatePath 용어/필터 기준(24→25)</h3>
        <button class="close-btn" id="statePathLegendClose" type="button">닫기</button>
      </header>
      <div class="body" id="statePathLegendBody" style="max-height:70vh; overflow:auto;"></div>
    </div>
  </div>

  <script>
    const API_BASE = (() => {
      const origin = window.location.origin;
      if (origin && origin !== "null" && origin.startsWith("http")) {
        return origin.replace(/\/$/, "") + "/api";
      }
      return "http://localhost:8000/api";
    })();
    const PART_STRUCTURE = {
      "기업교육 1팀": {
        "1파트": ["김솔이", "황초롱", "김정은", "김동찬", "정태윤", "서정연", "오진선"],
        "2파트": ["강지선", "정하영", "박범규", "하승민", "이은서", "김세연"],
      },
      "기업교육 2팀": {
        "1파트": ["권노을", "이윤지B", "이현진", "김민선", "강연정", "방신우", "홍제환"],
        "2파트": ["정다혜", "임재우", "송승희", "손승완", "김윤지", "손지훈", "홍예진"],
        "온라인셀": ["강진우", "강다현", "이수빈"],
      },
    };
    const COUNTERPARTY_ONLINE_FORMATS = new Set(["구독제(온라인)", "선택구매(온라인)", "포팅"]);
    const SALESMAP_WORKSPACE_PATH = "64cb5beda5a78ae225d7815b"; // update if workspace path changes
    const SALESMAP_BASE = "https://salesmap.kr/64cb5beda5a78ae225d7815b";
    const salesmapOrgUrl = (orgId) => `${SALESMAP_BASE}/contact/organization/${encodeURIComponent(orgId || "")}`;
    const salesmapPeopleUrl = (personId) => `${SALESMAP_BASE}/contact/people/${encodeURIComponent(personId || "")}`;
    const salesmapDealUrl = (dealId) => `${SALESMAP_BASE}/deal/${encodeURIComponent(dealId || "")}`;
    const ORG_LIMIT = 200;
    const STATEPATH_SEGMENTS = ["전체", "대기업", "중견기업", "중소기업", "공공기관", "대학교", "기타/미입력"];
    const BUCKET_ORDER = ["Ø", "P5", "P4", "P3", "P2", "P1", "P0", "S0"];
    const STATEPATH_GLOSSARY = {
      unit: {
        short: "금액 단위: 억",
        long: "※ 이 화면의 모든 금액은 ‘억’ 단위입니다. (amount_eok)",
      },
      years: {
        short: "비교 구간: 2024→2025",
        long: "2024년과 2025년의 State를 비교해 Path(OPEN/CLOSE/UP/DOWN 등)를 계산합니다.",
      },
      quickFilters: {
        risk: {
          short: "Risk: CLOSE/DOWN 포함",
          long: "24→25에서 CLOSE(중단) 또는 DOWN(버킷 하락)이 하나라도 있으면 Risk로 봅니다.",
        },
        hasOpen: {
          short: "New Open: 신규 셀 오픈",
          long: "24년에 Ø였던 셀이 25년에 P5~S0로 바뀐 경우(Ø→비Ø)가 1개 이상입니다.",
        },
        hasScaleUp: {
          short: "Scale Up: 버킷 상승",
          long: "동일 셀에서 24 대비 25 버킷 등급이 상승한 경우가 1개 이상입니다.",
        },
        companyDir: {
          short: "Company↑: 회사 버킷 상승",
          long: "Company Total 버킷(Ø~S0)이 24→25에 올라가면 ↑, 내려가면 ↓, 같으면 = 입니다.",
        },
        seed: {
          short: "Seed: 첫 확장 방향",
          long: "2024에 한 lane만 열려 있고 2025에 다른 lane이 처음 열리면 그 방향을 Seed로 표시합니다. (H→B: HRD→BU / B→H: BU→HRD / SIMUL: 동시 / NONE: 해당 없음)",
        },
        railShift: {
          short: "Shift: rail 성장",
          long: "온라인(또는 오프라인) 합계 버킷이 24→25에 상승한 계정입니다.",
        },
      },
      snapshot: {
        accountCount: { short: "현재 필터 기준 계정 수", long: "현재 필터를 적용한 후 남은 계정 수입니다." },
        sums: { short: "합계/증감", long: "현재 필터 기준 2024·2025 합계(억)와 Δ(2025-2024)입니다." },
        companyDir: { short: "Company 변화", long: "회사 버킷이 상승/유지/하락한 계정 수입니다." },
        openRisk: { short: "OPEN/RISK", long: "OPEN 계정 수(OPEN 이벤트 존재)와 Risk 계정 수(CLOSE/DOWN 존재)입니다." },
      },
      patternExplorer: {
        transitionMatrix: {
          short: "Company 버킷 전이(24→25)",
          long: "행=2024 Company 버킷, 열=2025 Company 버킷. 셀 값=해당 전이를 가진 계정 수입니다. 셀 클릭 시 해당 전이만 필터링합니다.",
        },
        cellEventMatrix: {
          short: "4셀 이벤트(OPEN/CLOSE/UP/DOWN)",
          long: "HRD/BU × ONLINE/OFFLINE의 4셀에서 OPEN/CLOSE/UP/DOWN 발생 횟수를 보여줍니다. 배지 클릭 시 해당 셀+이벤트를 가진 계정만 필터링합니다.",
        },
        railMix: {
          short: "Online/Offline 변화 요약",
          long: "ONLINE/OFFLINE 합계 버킷의 up/flat/down 계정 수를 보여줍니다. 클릭 시 해당 rail 변화만 필터링합니다.",
        },
      },
      topPatterns: {
        short: "현재 필터에서 가장 많이 발생한 패턴",
        long: "현재 필터 결과에서 가장 빈도가 높은 OPEN/CLOSE/UP/DOWN 셀과 Seed 방향을 보여줍니다. 클릭 시 해당 조건으로 필터가 자동 적용됩니다.",
      },
      breadcrumb: {
        short: "현재 적용 중인 필터",
        long: "현재 선택된 세그먼트/매트릭스 선택/퀵필터/정렬 조건을 토큰으로 보여줍니다. 토큰의 (x)로 개별 조건을 해제할 수 있고, ‘전체 해제’로 초기화할 수 있습니다.",
      },
      sorting: {
        won2025_desc: "2025 체결액(억) 내림차순",
        delta_desc: "증감액(2025-2024) 내림차순",
        bucket_up_desc: "Company 버킷 상승폭(등급 차이) 내림차순",
        risk_first: "Risk 계정을 우선 정렬",
      },
      pagination: {
        short: "표시 행 수 제한",
        long: "테이블은 페이지 단위로 표시합니다(예: 200개). 패턴/요약/매트릭스는 전체 필터 결과를 기준으로 계산합니다.",
      },
      export: {
        table: {
          short: "목록 JSON 복사(필터 전체 기준)",
          long: "현재 필터 결과 전체(filteredItems 전체)를 테이블 요약 JSON으로 복사합니다. 페이지네이션과 무관하게 필터링된 전체 건수를 포함합니다.",
        },
        detail: {
          short: "Core JSON 복사",
          long: "계정 상세의 RevOps 추천을 제외하고 State/Path/Seed/QA만 복사합니다.",
        },
        note: {
          short: "페이지와 무관하게 필터 전체 기준",
          long: "테이블은 페이지로 보이지만 JSON 복사는 필터 결과 전체 기준입니다. 필요 시 검색/필터로 건수를 줄여 복사하세요.",
        },
      },
      events: {
        short: "OPEN/CLOSE/UP/DOWN/RAIL/COMPANY",
        long: "OPEN: Ø→비Ø, CLOSE: 비Ø→Ø, UP/DOWN: 버킷 등급 상승/하락(Ø<P5<...<S0). RAIL_SCALE_CHANGE는 ONLINE/OFFLINE 버킷 변화, COMPANY_SCALE_CHANGE는 Company 버킷 변화입니다.",
      },
      cells: {
        short: "HRD/BU × ONLINE/OFFLINE",
        long: "Lane은 상위 조직(upper_org)에 HRD 키워드 포함 시 HRD, 아니면 BU. Rail은 과정포맷이 온라인 3종이면 ONLINE, 그 외 OFFLINE입니다.",
      },
      buckets: {
        short: "버킷 임계값(회사/레일)",
        long: "Company: Ø(0), P5(0~0.1), P4(0.1~0.25), P3(0.25~0.5), P2(0.5~1), P1(1~2), P0(2~10), S0(10+). Rail/Cell은 임계값 절반입니다.",
      },
    };
    let DEBUG_ORG_SELECT = Boolean(window.DEBUG_ORG_SELECT);
    window.setOrgSelectDebug = (flag) => {
      DEBUG_ORG_SELECT = Boolean(flag);
      window.DEBUG_ORG_SELECT = DEBUG_ORG_SELECT;
      console.log("[orgSelect] debug mode:", DEBUG_ORG_SELECT);
    };

    const DEALCHECK_TEAMS = {
      edu1: {
        id: "edu1-dealcheck",
        label: "교육 1팀 딜체크",
        apiPath: "/deal-check/edu1",
        partTeamKey: "기업교육 1팀",
        menuOrder: 4,
      },
      edu2: {
        id: "edu2-dealcheck",
        label: "교육 2팀 딜체크",
        apiPath: "/deal-check/edu2",
        partTeamKey: "기업교육 2팀",
        menuOrder: 5,
      },
    };

    const DEALCHECK_MENU_DEFS = [
      { id: DEALCHECK_TEAMS.edu1.id, label: DEALCHECK_TEAMS.edu1.label, teamKey: "edu1", partFilter: null, parentId: null },
      { id: "edu1-dealcheck-part1", label: "교육 1팀 1파트 딜체크", teamKey: "edu1", partFilter: "part1", parentId: DEALCHECK_TEAMS.edu1.id },
      { id: "edu1-dealcheck-part2", label: "교육 1팀 2파트 딜체크", teamKey: "edu1", partFilter: "part2", parentId: DEALCHECK_TEAMS.edu1.id },
      { id: DEALCHECK_TEAMS.edu2.id, label: DEALCHECK_TEAMS.edu2.label, teamKey: "edu2", partFilter: null, parentId: null },
      { id: "edu2-dealcheck-part1", label: "교육 2팀 1파트 딜체크", teamKey: "edu2", partFilter: "part1", parentId: DEALCHECK_TEAMS.edu2.id },
      { id: "edu2-dealcheck-part2", label: "교육 2팀 2파트 딜체크", teamKey: "edu2", partFilter: "part2", parentId: DEALCHECK_TEAMS.edu2.id },
      { id: "edu2-dealcheck-online", label: "교육 2팀 온라인셀 딜체크", teamKey: "edu2", partFilter: "online", parentId: DEALCHECK_TEAMS.edu2.id },
    ];

    function menuLabelWithArrow(def) {
      return def.parentId ? `↳ ${def.label}` : def.label;
    }

    const MENU_SECTIONS = [
      {
        sectionId: "perf",
        title: "사업부 퍼포먼스",
        defaultOpen: true,
        items: [
          { id: "biz-perf-pl-progress-2026", label: "2026 P&L" },
          { id: "biz-perf-monthly", label: "2026 월별 체결액" },
          // ✅ 구 "카운터파티 리스크(일간)" → 2026 Daily Report(WIP) (id 유지)
          { id: "counterparty-risk-daily", label: "2026 Daily Report(WIP)" },
        ],
      },
      {
        sectionId: "ops",
        title: "운영 메뉴",
        defaultOpen: true,
        items: [
          { id: "target-2026", label: "2026 Target Board" },
          // ✅ 구 "2025 카운터파티 DRI" → 2026 카운터파티 DRI (id 유지)
          { id: "rank-2025-counterparty-dri", label: "2026 카운터파티 DRI" },
          ...DEALCHECK_MENU_DEFS.map((d) => ({ id: d.id, label: menuLabelWithArrow(d), parentId: d.parentId })),
        ],
      },
      {
        sectionId: "analysis",
        title: "분석 메뉴",
        defaultOpen: true,
        items: [
          { id: "statepath-2425", label: "StatePath 24→25" },
          { id: "rank-2025", label: "2025 체결액 순위" },
          { id: "org-view", label: "조직/People/Deal 뷰어" },
          // (선택) 기존 숨김 메뉴는 유지
          { id: "rank-2025-people", label: "2025 대기업 딜·People", hidden: true },
          { id: "industry-2025", label: "업종별 매출", hidden: true },
        ],
      },
      {
        sectionId: "qa",
        title: "검수 메뉴",
        defaultOpen: true,
        items: [
          { id: "deal-qc-r1r15", label: "개인별 세일즈맵 검수" },
          { id: "mismatch-2025", label: "고객사 불일치" },
        ],
      },
    ];

    const MENU_RENDERERS = {
      "biz-perf-monthly": renderBizPerfMonthly,
      "biz-perf-pl-progress-2026": renderBizPerfPlProgress2026,
      "rank-2025": renderRank2025Screen,
      "rank-2025-people": renderRank2025PeopleScreen,
      "rank-2025-counterparty-dri": renderRankCounterpartyDriScreen,
      "target-2026": renderTarget2026Screen,
      "counterparty-risk-daily": renderCounterpartyRiskDaily,
      "deal-qc-r1r15": renderDealQcR1R15Screen,
      "mismatch-2025": renderMismatch2025Screen,
      "industry-2025": renderIndustryMenu,
      "statepath-2425": renderStatePathMenu,
      "org-view": renderOrgScreen,
    };

    DEALCHECK_MENU_DEFS.forEach((def) => {
      MENU_RENDERERS[def.id] = (root) =>
        renderDealCheckScreen(def.teamKey, root, { label: def.label, partFilter: def.partFilter });
    });

    const MENU_ITEMS = MENU_SECTIONS.flatMap((section) => section.items);
    const MENU_IDS = new Set(MENU_ITEMS.map((item) => item.id));
    const MENU_SECTION_STORAGE_PREFIX = "menu_section_open__";
    const DEFAULT_MENU_ID = "org-view";
    const DEFAULT_PNL_ASSUMPTIONS = {
      onlineContribMarginRate: 0.85,
      offlineContribMarginRate: 0.55,
      monthlyProdCost: 0.2,
      monthlyMktCost: 0.3,
      monthlyLaborCost: 6.0,
    };

    function getDefaultPnlDrafts() {
      return {
        onlineContribMarginRate: (DEFAULT_PNL_ASSUMPTIONS.onlineContribMarginRate * 100).toFixed(1),
        offlineContribMarginRate: (DEFAULT_PNL_ASSUMPTIONS.offlineContribMarginRate * 100).toFixed(1),
        monthlyProdCost: DEFAULT_PNL_ASSUMPTIONS.monthlyProdCost.toFixed(1),
        monthlyMktCost: DEFAULT_PNL_ASSUMPTIONS.monthlyMktCost.toFixed(1),
        monthlyLaborCost: DEFAULT_PNL_ASSUMPTIONS.monthlyLaborCost.toFixed(1),
      };
    }

    function getInitialMenuId() {
      const hash = (window.location.hash || "").replace(/^#/, "");
      if (hash && MENU_IDS.has(hash)) return hash;
      return DEFAULT_MENU_ID;
    }

    const state = {
      activeMenuId: getInitialMenuId(),
      size: "대기업",
      rankSize: "전체",
      rankPeopleSize: "대기업",
      rankPeopleOrgFilter: "",
      rankPeopleUpperFilter: "",
      mismatchSize: "대기업",
      dealCheck: {
        edu1: { loading: false, error: null, items: [] },
        edu2: { loading: false, error: null, items: [] },
      },
      rankMultipliers: {
        S0: 1.5,
        P0: 1.7,
        P1: 1.7,
        P2: 1.5,
        P3: 1.0,
        P4: 1.0,
        P5: 1.0,
      },
      rankPeopleModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
        bound: false,
      },
      dealMemoModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
      },
      counterpartyRisk: {
        cache: new Map(),
        loading: false,
        error: null,
        data: null,
        date: null,
        filters: {
          tiers: new Set(["S0", "P0", "P1", "P2"]),
          risks: new Set(["심각", "보통", "양호"]),
          pipelineOnly: false,
          search: "",
        },
        sectionOpen: { 심각: true, 보통: true, 양호: false },
      },
      dealQc: {
        team: "all",
        owner: "",
        summary: null,
        loading: false,
        error: null,
        detailLoading: false,
        detailError: null,
      },
      statepath2425: {
        segment: "전체",
        search: "",
        sort: "won2025_desc",
        page: 0,
        pageSize: 200,
        items: [],
        summary: null,
        loading: false,
        error: null,
        limit: 500,
        quickFilters: {
          risk: false,
          hasOpen: false,
          hasScaleUp: false,
          companyDir: "all",
          seed: "all",
          railShift: "all",
        },
        patternFilter: {
          companyFrom: null,
          companyTo: null,
          cell: null,
          cellEvent: null,
          rail: null,
          railDir: null,
        },
        tier2024: [],
        ui: {
          filterDrawerOpen: false,
        },
        filteredItems: [],
        derived: null,
      },
      statepathLegend: {
        open: false,
        section: "all",
        trigger: null,
      },
      rankCounterpartyDri: {
        size: "대기업",
        rows: [],
        loading: false,
        error: null,
        selected: null,
        detail: null,
        search: "",
        dri: "all",
        hideMissingUpper: false,
        sort: "default",
        page: 0,
        offset: 0,
        teamPart: "all",
        teamPartOptions: ["all"],
      },
      rankCounterpartyCache: {},
      perfMonthly: {
        loading: false,
        error: null,
        data: null,
      },
      perfPlProgress2026: {
        loading: false,
        error: null,
        summary: null,
        dealsCache: new Map(),
        assumptions: { ...DEFAULT_PNL_ASSUMPTIONS },
        assumptionDraft: getDefaultPnlDrafts(),
      },
      orgs: [],
      orgSearch: "",
      selectedOrg: null,
      wonGroupJson: null,
      wonGroupJsonCompact: null,
      filteredWonGroupJson: null,
      filteredWonGroupJsonCompact: null,
      statePath: null,
      selectedUpperOrg: null,
      people: [],
      selectedPerson: null,
      deals: [],
      selectedDeal: null,
      orgMemos: [],
      personMemos: [],
      dealMemos: [],
      wonSummary: [],
      _globalModalsBound: false,
      modal: {
        backdrop: null,
        close: null,
        date: null,
        author: null,
        body: null,
        bound: false,
      },
      webformModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
      },
      jsonModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
        bound: false,
      },
      statePathModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
      },
      pendingOrgId: null,
      pendingOrgFallback: null,
      wonSummaryCleared: false,
    };

    const cache = {
      sizes: null,
      wonGroupJsonByOrg: new Map(),
      wonGroupJsonCompactByOrg: new Map(),
      statePathByOrg: new Map(),
      orgMemos: new Map(),
      peopleByOrg: new Map(),
      deals: new Map(),
      personMemos: new Map(),
      dealMemos: new Map(),
      rank2025BySize: new Map(),
      rank2025PeopleBySize: new Map(),
      mismatch2025BySize: new Map(),
      orgLookup: new Map(),
      wonSummary: new Map(),
      yearlyTotals: null,
      statepathPortfolioByKey: new Map(),
      rank2025CounterpartyDriBySize: new Map(),
      dealCheck: {
        edu1: null,
        edu2: null,
      },
    };
    const NAME_TO_TEAM_PART = buildNameToTeamPartIndex(PART_STRUCTURE);

    function showToast(message, tone = "info") {
      const el = document.getElementById("toast");
      el.textContent = message;
      el.className = `toast ${tone === "error" ? "error" : ""}`;
      el.style.display = "block";
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => {
        el.style.display = "none";
      }, 3200);
    }

    function buildNameToTeamPartIndex(structure) {
      const index = new Map();
      const add = (name, team, part) => {
        const key = (name || "").trim();
        if (!key) return;
        const existing = index.get(key);
        if (existing && (existing.team !== team || existing.part !== part)) {
          index.set(key, { ambiguous: true });
          return;
        }
        if (!existing) {
          index.set(key, { team, part });
        }
      };
      Object.entries(structure || {}).forEach(([team, parts]) => {
        Object.entries(parts || {}).forEach(([part, names]) => {
          (names || []).forEach((n) => add(n, team, part));
        });
      });
      return index;
    }

    function stripTrailingLetter(name) {
      if (!name) return "";
      const trimmed = name.trim();
      if (/^[\s]*$/.test(trimmed)) return "";
      if (/[A-Za-z]$/.test(trimmed)) {
        return trimmed.slice(0, -1);
      }
      return trimmed;
    }

    function normalizeOwnerName(name) {
      const trimmed = (name || "").trim();
      if (!trimmed) return "";
      return stripTrailingLetter(trimmed);
    }

    const PART_LOOKUP_CACHE = {};

    function getDealCheckPartLookup(teamKey) {
      if (PART_LOOKUP_CACHE[teamKey]) return PART_LOOKUP_CACHE[teamKey];
      const cfg = DEALCHECK_TEAMS[teamKey];
      const team = (cfg && PART_STRUCTURE[cfg.partTeamKey]) || {};
      const buildSet = (names) =>
        new Set((names || []).map((n) => normalizeOwnerName(n)).filter(Boolean));
      const lookup = {
        part1: buildSet(team["1파트"]),
        part2: buildSet(team["2파트"]),
        online: buildSet(team["온라인셀"]),
      };
      PART_LOOKUP_CACHE[teamKey] = lookup;
      return lookup;
    }

    function matchDealCheckPartFilter(teamKey, owners, partFilter) {
      if (!partFilter) return true;
      const names = Array.isArray(owners) ? owners : [];
      if (!names.length) return false;
      const lookup = getDealCheckPartLookup(teamKey);
      for (const name of names) {
        const normalized = normalizeOwnerName(name);
        if (!normalized) continue;
        if (partFilter === "part1" && lookup.part1.has(normalized)) return true;
        if (partFilter === "part2" && lookup.part2.has(normalized)) return true;
        if (partFilter === "online" && lookup.online.has(normalized)) return true;
      }
      return false;
    }

    function resolveOwnerTeamPart(name) {
      const trimmed = (name || "").trim();
      if (!trimmed) return { team: null, part: null, ambiguous: false, missing: true };
      const entry = NAME_TO_TEAM_PART.get(trimmed);
      if (entry) {
        if (entry.ambiguous) return { team: null, part: null, ambiguous: true, missing: false };
        return { team: entry.team, part: entry.part, ambiguous: false, missing: false };
      }
      const base = stripTrailingLetter(trimmed);
      if (base && base !== trimmed) {
        const alt = NAME_TO_TEAM_PART.get(base);
        if (alt) {
          if (alt.ambiguous) return { team: null, part: null, ambiguous: true, missing: false };
          return { team: alt.team, part: alt.part, ambiguous: false, missing: false };
        }
      }
      return { team: null, part: null, ambiguous: false, missing: true };
    }

    function computeTeamPartSummary(owners) {
      const names = Array.isArray(owners) ? owners.filter(Boolean) : [];
      if (!names.length) {
        return { ownersText: "-", teamPartText: "-", dri: "X" };
      }

      const unknownNames = [];
      const comboCounts = new Map();
      const comboMeta = new Map();
      names.forEach((name) => {
        const resolved = resolveOwnerTeamPart(name);
        if (resolved.ambiguous || resolved.missing || !resolved.team || !resolved.part) {
          unknownNames.push(name);
          return;
        }
        const key = `${resolved.team} ${resolved.part}`;
        comboCounts.set(key, (comboCounts.get(key) || 0) + 1);
        if (!comboMeta.has(key)) comboMeta.set(key, { team: resolved.team, part: resolved.part });
      });

      const ownersText = names.join(", ");

      if (unknownNames.length) {
        return {
          ownersText,
          teamPartText: `미확인(${unknownNames.join(", ")})`,
          dri: "X",
        };
      }

      if (!comboCounts.size) {
        return { ownersText, teamPartText: "-", dri: "X" };
      }

      const combos = Array.from(comboCounts.entries()).map(([key, count]) => {
        const meta = comboMeta.get(key) || { team: "", part: "" };
        return { key, count, team: meta.team, part: meta.part };
      });
      combos.sort((a, b) => {
        if (b.count !== a.count) return b.count - a.count;
        if (a.team !== b.team) return a.team.localeCompare(b.team);
        return a.part.localeCompare(b.part);
      });

      const displayCombos = combos.map((c) => c.key);
      let teamPartText = "";
      if (displayCombos.length === 1) {
        teamPartText = displayCombos[0];
      } else {
        const extra = displayCombos.length - 1;
        teamPartText = `${displayCombos[0]} 외 ${extra}개`;
      }

      const dri = displayCombos.length === 1 ? "O" : "X";

      return { ownersText, teamPartText, dri };
    }

    function inferPartFromOwners(teamKey, owners) {
      const names = Array.isArray(owners) ? owners : [];
      if (!names.length) return "미매핑";
      const lookup = getDealCheckPartLookup(teamKey);
      const parts = new Set();
      names.forEach((name) => {
        const normalized = normalizeOwnerName(name);
        if (!normalized) return;
        if (lookup.part1.has(normalized)) parts.add("1파트");
        if (lookup.part2.has(normalized)) parts.add("2파트");
        if (lookup.online.has(normalized)) parts.add("온라인셀");
      });
      if (!parts.size) return "미매핑";
      return ["1파트", "2파트", "온라인셀"].filter((p) => parts.has(p)).join("+");
    }

    function tierMultiplier(tier) {
      const t = (tier || "").toUpperCase();
      if (t === "S0") return 1.5;
      if (t === "P0" || t === "P1") return 1.7;
      if (t === "P2") return 1.5;
      if (t === "P3" || t === "P4" || t === "P5") return 1.0;
      return 1.0;
    }

    function isCounterpartyOnline(formatVal) {
      const fmt = (formatVal || "").trim();
      return COUNTERPARTY_ONLINE_FORMATS.has(fmt);
    }

    function amountFromDeal(deal) {
      const amt = Number(deal.amount || deal["금액"] || 0);
      if (Number.isFinite(amt) && amt > 0) return amt;
      const exp = Number(deal.expected_amount || deal.expectedAmount || deal["예상 체결액"] || 0);
      if (Number.isFinite(exp) && exp > 0) return exp;
      return 0;
    }

    function buildTarget2026Kpis(source) {
      const big = source?.big || [];
      const mid = source?.mid || [];
      const small = source?.small || [];
      const rowsAll = [...big, ...mid, ...small];
      console.debug("[target2026] rows", rowsAll.length, rowsAll[0] || {});

      const parseRow = (row) => {
        const tier = (row.orgTier || "").toUpperCase();
        const orgName = (row.orgName || "").trim();
        const offline25 = Number(row.cpOffline2025 || 0) || 0;
        const offline26 = Number(row.cpOffline2026 || 0) || 0;
        const target26 = offline25 * tierMultiplier(tier);
        return { tier, orgName, offline25, offline26, target26 };
      };

      const parseList = (rows) => rows.map(parseRow);
      const bigParsed = parseList(big);
      const midParsed = parseList(mid);
      const smallParsed = parseList(small);

      const isSamsungS0 = (r) => r.tier === "S0" && r.orgName === "삼성전자";

      const sumGroup = (list, pred) => {
        const filtered = list.filter(pred);
        const won26 = filtered.reduce((acc, r) => acc + r.offline26, 0);
        const target26 = filtered.reduce((acc, r) => acc + r.target26, 0);
        return { won26, target26, count: filtered.length };
      };

      const g1 = sumGroup(bigParsed, (r) => ["S0", "P0", "P1"].includes(r.tier) && !isSamsungS0(r));
      const g2 = sumGroup(bigParsed, (r) => r.tier === "P2");
      const g3 = sumGroup(bigParsed, (r) => ["P3", "P4", "P5"].includes(r.tier));
      const g4 = sumGroup([...midParsed, ...smallParsed], () => true);
      const g5 = sumGroup(bigParsed, (r) => r.tier === "S0" && !isSamsungS0(r));
      const g6 = sumGroup(bigParsed, (r) => r.tier === "P0");
      const g7 = sumGroup(bigParsed, (r) => r.tier === "P1");
      const g8 = sumGroup(bigParsed, (r) => r.tier === "P2");

      console.debug("[target2026] groupCounts", {
        g1: g1.count,
        g2: g2.count,
        g3: g3.count,
        g4: g4.count,
        g5: g5.count,
        g6: g6.count,
        g7: g7.count,
        g8: g8.count,
      });

      const groups = [
        { title: "대기업 S0/P0/P1", ...g1, rowClass: "top" },
        { title: "대기업 P2", ...g2, rowClass: "top" },
        { title: "대기업 P3/P4/P5", ...g3, rowClass: "top" },
        { title: "중견/중소", ...g4, rowClass: "top" },
        { title: "대기업 S0", ...g5, rowClass: "bottom" },
        { title: "대기업 P0", ...g6, rowClass: "bottom" },
        { title: "대기업 P1", ...g7, rowClass: "bottom" },
        { title: "대기업 P2", ...g8, rowClass: "bottom" },
      ];
      return groups;
    }

    function openStatePathModal(item) {
      if (!state.statePathModal.backdrop || !state.statePathModal.body) return;
      const body = state.statePathModal.body;
      if (state.statePathModal.copyCoreBtn) {
        state.statePathModal.copyCoreBtn.disabled = !item;
        state.statePathModal.copyCoreBtn.title = item
          ? getGlossaryShort("export.detail") || "Core JSON 복사"
          : "상세 로딩 후 사용";
      }
      if (state.statePathModal.title) {
        state.statePathModal.title.textContent = `StatePath - ${item.company_name || state.selectedOrg || ""}`;
      }
      const rowsYear = ["2024", "2025"]
        .map((y) => {
          const st = item.year_states?.[y] || {};
          return `<tr>
            <td>${y}</td>
            <td>${formatEok(st.total_eok || 0)} (${st.bucket || "-"})</td>
            <td>${formatEok(st.online_eok || 0)} (${st.bucket_online || "-"})</td>
            <td>${formatEok(st.offline_eok || 0)} (${st.bucket_offline || "-"})</td>
            <td>${formatEok(st.hrd_eok || 0)}</td>
            <td>${formatEok(st.bu_eok || 0)}</td>
          </tr>`;
        })
        .join("");

      const cells = ["HRD_ONLINE", "HRD_OFFLINE", "BU_ONLINE", "BU_OFFLINE"]
        .map((cell) => {
          const c24 = item.year_states?.["2024"]?.cells?.[cell] || {};
          const c25 = item.year_states?.["2025"]?.cells?.[cell] || {};
          return `<tr>
            <td>${cell}</td>
            <td>${formatEok(c24.amt_eok || 0)} (${c24.bucket || "-"})</td>
            <td>${formatEok(c25.amt_eok || 0)} (${c25.bucket || "-"})</td>
          </tr>`;
        })
        .join("");

      const events = item.path_2024_to_2025?.events || [];
      const eventsHtml = events.length
        ? events
            .map(
              (ev) =>
                `<li><strong>${ev.type}</strong> ${ev.cell ? ev.cell + ": " : ""}${ev.from || ""} → ${ev.to || ""} ${ev.rail ? `(${ev.rail})` : ""}</li>`
            )
            .join("")
        : "<li>변화 이벤트 없음</li>";

      const reco = item.ops_reco || {};
      const targets = (reco.target_counterparties || [])
        .map(
          (t) =>
            `<tr><td>${t.rank}</td><td>${t.upper_org || "-"}</td><td>${t.lane || "-"}</td><td>${formatEok(t.amt_2024_eok || 0)}</td><td>${formatEok(t.amt_2025_eok || 0)}</td></tr>`
        )
        .join("");
      const plays = (reco.action_play_top3 || [])
        .map((p) => `<li><strong>${p.type}</strong>: ${p.text}</li>`)
        .join("") || "<li>추천 없음</li>";

      body.innerHTML = `
        <section class="card">
          <h3>연도별 요약</h3>
          <div class="table-wrap full">
            <table class="cpr-table">
              <thead><tr><th>연도</th><th>총액(억)</th><th>온라인(억)</th><th>오프라인(억)</th><th>HRD(억)</th><th>BU(억)</th></tr></thead>
              <tbody>${rowsYear}</tbody>
            </table>
          </div>
        </section>
        <section class="card">
          <h3>4셀 비교</h3>
          <div class="table-wrap full">
            <table>
              <thead><tr><th>셀</th><th>2024</th><th>2025</th></tr></thead>
              <tbody>${cells}</tbody>
            </table>
          </div>
        </section>
        <section class="card">
          <h3>Path 이벤트 (Seed: ${item.path_2024_to_2025?.seed || "-"})</h3>
          <ul>${eventsHtml}</ul>
        </section>
        <section class="card">
          <h3>RevOps 추천</h3>
          <div>Objective: <strong>${reco.next_objective_type || "-"}</strong>, Target Cell: <strong>${reco.next_target_cell || "-"}</strong></div>
          <div class="table-wrap full">
            <table>
              <thead><tr><th>랭크</th><th>상위 조직</th><th>Lane</th><th>2024(억)</th><th>2025(억)</th></tr></thead>
              <tbody>${targets}</tbody>
            </table>
          </div>
          <ul>${plays}</ul>
        </section>
      `;
      if (state.statePathModal.backdrop) state.statePathModal.backdrop.style.display = "flex";
    }

    function closeStatePathModal() {
      if (state.statePathModal.backdrop) state.statePathModal.backdrop.style.display = "none";
    }

    function toJsonText(data) {
      if (data === null || data === undefined) return "";
      try {
        return JSON.stringify(data, null, 2);
      } catch (_) {
        return "";
      }
    }

    async function copyJsonData(data, successMessage) {
      const text = toJsonText(data);
      if (!text.trim()) {
        showToast("복사할 JSON이 없습니다.", "error");
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        showToast(successMessage || "JSON을 복사했습니다.", "success");
      } catch (_) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        showToast(successMessage || "JSON을 복사했습니다.", "success");
      }
    }

    function openJsonModal(title, data) {
      if (!state.jsonModal.backdrop || !state.jsonModal.body || !state.jsonModal.title) return;
      const text = toJsonText(data);
      if (!text.trim()) {
        showToast("표시할 JSON이 없습니다.", "error");
        return;
      }
      state.jsonModal.title.textContent = title || "JSON 보기";
      state.jsonModal.body.textContent = text;
      state.jsonModal.backdrop.style.display = "flex";
    }

    function openDealsModal(personLabel, deals) {
      if (!state.rankPeopleModal.backdrop || !state.rankPeopleModal.title || !state.rankPeopleModal.body) return;
      const list = Array.isArray(deals) ? deals : [];
      const body = state.rankPeopleModal.body;
      if (!list.length) {
        body.innerHTML = `<div class="muted">딜이 없습니다.</div>`;
      } else {
        body.innerHTML = `
          <div class="table-wrap full">
            <table>
              <thead>
                <tr>
                  <th>생성일</th>
                  <th>딜 이름</th>
                  <th>상태</th>
                  <th>금액(억)</th>
                  <th>계약 체결일</th>
                  <th>과정포맷</th>
                </tr>
              </thead>
              <tbody>
                ${list
                  .map(
                    (d) => `
                      <tr>
                        <td>${formatDate(d.created_at)}</td>
                        <td>${d.dealName || "-"}</td>
                        <td>${d.status || "-"}</td>
                        <td>${formatAmount(d.amount)}</td>
                        <td>${formatDate(d.contract_date)}</td>
                        <td>${d.course_format || "-"}</td>
                      </tr>
                    `
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
      }
      state.rankPeopleModal.title.textContent = personLabel || "딜 목록";
      state.rankPeopleModal.backdrop.style.display = "flex";
    }

    function fitColumnsToContent(tableEl, items, options = {}) {
      if (!tableEl) return;
      const inferPartFn = typeof options.inferPartFn === "function" ? options.inferPartFn : () => "-";
      const includeTier = Boolean(options.includeTier);
      const keys = [
        ...(includeTier ? ["tier"] : []),
        "courseFormat",
        "createdAt",
        "part",
        "owners",
        "probability",
        "expectedCloseDate",
        "expectedAmount",
      ];
      const canvas = fitColumnsToContent._canvas || (fitColumnsToContent._canvas = document.createElement("canvas"));
      const ctx = canvas.getContext("2d");
      if (!ctx) return;
      ctx.font = window.getComputedStyle(tableEl).font || "12px sans-serif";

      const measure = (text) => {
        const value = text === null || text === undefined ? "" : String(text);
        return ctx.measureText(value).width;
      };

      const clampWidth = (key, width) => {
        if (key === "tier") {
          const min = 44;
          const max = 72;
          return Math.max(min, Math.min(max, width));
        }
        if (key === "createdAt" || key === "expectedCloseDate") {
          return 72;
        }
        if (key === "courseFormat") {
          const min = 90;
          const max = 240;
          return Math.max(min, Math.min(max, width));
        }
        const min = 56;
        const max = 220;
        return Math.max(min, Math.min(max, width));
      };

      const longest = {};
      (items || []).forEach((row) => {
        const owners = Array.isArray(row.owners) ? row.owners.filter(Boolean) : [];
        const values = {
          ...(includeTier ? { tier: computeTierFromWon2025Total(row.orgWon2025Total) } : {}),
          courseFormat: row.courseFormat || "",
          createdAt: formatDateYYMMDD(row.createdAt),
          part: inferPartFn(owners),
          owners: owners.length ? owners.join(", ") : "-",
          probability: formatProbability(row.probability),
          expectedCloseDate: formatDateYYMMDD(row.expectedCloseDate),
          expectedAmount: formatAmount(row.expectedAmount),
        };
        keys.forEach((k) => {
          const text = values[k] || "";
          if (!longest[k] || String(text).length > String(longest[k]).length) {
            longest[k] = text;
          }
        });
      });

      const widths = {};
      keys.forEach((k) => {
        const text = longest[k] || "";
        widths[k] = clampWidth(k, measure(text) + 12);
      });

      keys.forEach((k) => {
        const col = tableEl.querySelector(`col[data-col="${k}"]`);
        if (col) {
          col.style.width = `${widths[k]}px`;
        }
      });

      // Fixed-width columns for org/upper/team
      ["orgName", "upperOrg", "teamSignature"].forEach((k) => {
        const col = tableEl.querySelector(`col[data-col="${k}"]`);
        if (col) {
          col.style.width = "15ch";
          col.style.minWidth = "15ch";
          col.style.maxWidth = "15ch";
        }
      });
    }

    function applyMemoColumnWidth(tableEl) {
      if (!tableEl) return;
      const col = tableEl.querySelector('col[data-col="memo"]');
      if (!col) return;
      const measureBox = document.createElement("div");
      measureBox.className = "dealcheck-screen";
      measureBox.style.position = "absolute";
      measureBox.style.visibility = "hidden";
      measureBox.style.pointerEvents = "none";
      measureBox.style.zIndex = "-1";
      measureBox.style.left = "-9999px";
      const makeBtn = (text, extra) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `btn-memo ${extra}`;
        btn.textContent = text;
        return btn;
      };
      const activeBtn = makeBtn("메모 확인", "btn-memo--active");
      const disabledBtn = makeBtn("메모 없음", "btn-memo--disabled");
      measureBox.appendChild(activeBtn);
      measureBox.appendChild(disabledBtn);
      document.body.appendChild(measureBox);
      const activeWidth = activeBtn.getBoundingClientRect().width;
      const disabledWidth = disabledBtn.getBoundingClientRect().width;
      document.body.removeChild(measureBox);
      const base = Math.max(activeWidth, disabledWidth);
      const buffer = 12;
      const min = 72;
      const max = 140;
      const finalWidth = Math.max(min, Math.min(max, base + buffer));
      col.style.width = `${finalWidth}px`;
    }

    function closeDealsModal() {
      if (!state.rankPeopleModal.backdrop) return;
      state.rankPeopleModal.backdrop.style.display = "none";
    }

    async function openDealMemoModal(dealId, triggerEl) {
      bindGlobalModalsOnce();
      if (!state.dealMemoModal.backdrop || !state.dealMemoModal.title || !state.dealMemoModal.body) {
        console.warn("[dealMemoModal] not bound");
        showToast("메모 팝업 초기화 오류(모달 연결 실패)", "error");
        return;
      }
      if (!dealId) return;
      let data;
      try {
        data = await fetchJson(`/deals/${dealId}/memos?limit=200`);
      } catch (err) {
        showToast(`메모를 불러오지 못했습니다: ${err.message}`, "error");
        return;
      }
      const items = data.items || [];
      if (!items.length) {
        showToast("메모 없음");
        if (triggerEl) {
          const cell = triggerEl.closest("td");
          if (cell) cell.textContent = "메모 없음";
        }
        return;
      }
      const rows = items
        .slice()
        .sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")))
        .map((m) => {
          const text = escapeHtml(normalizeMemoText(m.text));
          return `<tr><td class="memo-date">${formatDateYYMMDD(m.createdAt)}</td><td class="memo-text">${text || "-"}</td></tr>`;
        })
        .join("");
      state.dealMemoModal.title.textContent = "딜 메모";
      state.dealMemoModal.body.innerHTML = `
        <div class="table-wrap full">
          <table class="memo-table">
            <thead>
              <tr><th style="width: 120px;">생성일</th><th>메모 내용</th></tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
      state.dealMemoModal.backdrop.style.display = "flex";
      const escListener = (e) => {
        if (e.key === "Escape") {
          closeDealMemoModal();
        }
      };
      state.dealMemoModal._esc = escListener;
      document.addEventListener("keydown", escListener);
    }

    function closeDealMemoModal() {
      if (!state.dealMemoModal.backdrop) return;
      state.dealMemoModal.backdrop.style.display = "none";
      if (state.dealMemoModal._esc) {
        document.removeEventListener("keydown", state.dealMemoModal._esc);
        state.dealMemoModal._esc = null;
      }
    }

    function closeJsonModal() {
      if (!state.jsonModal.backdrop) return;
      state.jsonModal.backdrop.style.display = "none";
    }

    function ensureRankModals() {
      let guide = document.getElementById("rankGuideModalBackdrop");
      let mult = document.getElementById("rankMultiplierModalBackdrop");
      if (!guide) {
        const tpl = document.createElement("div");
        tpl.innerHTML = `
          <div class="modal-backdrop" id="rankGuideModalBackdrop" style="display:none;">
            <div class="modal">
              <div class="modal-header">
                <h3>등급 구간</h3>
                <button id="rankGuideModalClose" type="button">닫기</button>
              </div>
              <div class="modal-body" id="rankGuideModalBody"></div>
            </div>
          </div>
          <div class="modal-backdrop" id="rankMultiplierModalBackdrop" style="display:none;">
            <div class="modal">
              <div class="modal-header">
                <h3>등급별 배수 설정</h3>
                <button id="rankMultiplierModalClose" type="button">닫기</button>
              </div>
              <div class="modal-body" id="rankMultiplierModalBody"></div>
              <div class="control-row" style="margin-top:10px; justify-content:flex-end;">
                <button id="applyRankMultipliers" type="button">연산</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(tpl);
      }
      // cache references
      state.rankGuideModal = {
        backdrop: document.getElementById("rankGuideModalBackdrop"),
        close: document.getElementById("rankGuideModalClose"),
        body: document.getElementById("rankGuideModalBody"),
      };
      state.rankMultiplierModal = {
        backdrop: document.getElementById("rankMultiplierModalBackdrop"),
        close: document.getElementById("rankMultiplierModalClose"),
        body: document.getElementById("rankMultiplierModalBody"),
        apply: document.getElementById("applyRankMultipliers"),
      };
      if (state.rankGuideModal.close && state.rankGuideModal.backdrop) {
        state.rankGuideModal.close.addEventListener("click", () => closeRankGuideModal());
        state.rankGuideModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.rankGuideModal.backdrop) closeRankGuideModal();
        });
      }
      if (state.rankMultiplierModal.close && state.rankMultiplierModal.backdrop) {
        state.rankMultiplierModal.close.addEventListener("click", () => closeMultiplierModal());
        state.rankMultiplierModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.rankMultiplierModal.backdrop) closeMultiplierModal();
        });
      }
    }

    function openGradeGuideModal() {
      const modal = state.rankGuideModal;
      if (!modal || !modal.body || !modal.backdrop) return;
      modal.body.innerHTML = `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr><th>등급</th><th>구간(억, 이상~미만)</th></tr>
            </thead>
            <tbody>
              <tr><td>S0</td><td>10 이상</td></tr>
              <tr><td>P0</td><td>2 이상 ~ 10 미만</td></tr>
              <tr><td>P1</td><td>1 이상 ~ 2 미만</td></tr>
              <tr><td>P2</td><td>0.5 이상 ~ 1 미만</td></tr>
              <tr><td>P3</td><td>0.25 이상 ~ 0.5 미만</td></tr>
              <tr><td>P4</td><td>0.1 이상 ~ 0.25 미만</td></tr>
              <tr><td>P5</td><td>0.1 미만</td></tr>
            </tbody>
          </table>
        </div>
      `;
      modal.backdrop.style.display = "flex";
    }

    function openMultiplierModal(onApplied) {
      const modal = state.rankMultiplierModal;
      if (!modal || !modal.body || !modal.backdrop) return;
      modal.body.innerHTML = `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr><th>등급</th><th>배수</th></tr>
            </thead>
            <tbody>
              ${["S0","P0","P1","P2","P3","P4","P5"].map((g) => `
                <tr>
                  <td>${g}</td>
                  <td><input id="multiplier-${g}" type="number" step="0.01" min="0" style="width: 80px;" value="${state.rankMultipliers[g] ?? ""}" /></td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
      if (modal.apply) {
        modal.apply.onclick = () => {
          const next = { ...state.rankMultipliers };
          ["S0","P0","P1","P2","P3","P4","P5"].forEach((g) => {
            const el = document.getElementById(`multiplier-${g}`);
            if (!el) return;
            const val = parseFloat(el.value);
            if (Number.isFinite(val) && val > 0) {
              next[g] = val;
            }
          });
          state.rankMultipliers = next;
          closeMultiplierModal();
          if (onApplied) onApplied();
          showToast("배수를 적용했습니다.", "success");
        };
      }
      modal.backdrop.style.display = "flex";
    }

    function closeRankGuideModal() {
      if (state.rankGuideModal?.backdrop) state.rankGuideModal.backdrop.style.display = "none";
    }

    function closeMultiplierModal() {
      if (state.rankMultiplierModal?.backdrop) state.rankMultiplierModal.backdrop.style.display = "none";
    }

    function openMemoModal({ createdAt, ownerName, ownerId, text }) {
      if (!state.modal.backdrop) return;
      state.modal.date.textContent = `작성일: ${formatDate(createdAt)}`;
      state.modal.author.textContent = `작성자: ${ownerName || ownerId || "-"}`;
      const normalized = normalizeMemoText(text);
      state.modal.body.textContent = normalized || "(내용 없음)";
      state.modal.backdrop.style.display = "flex";
    }

    function closeMemoModal() {
      if (!state.modal.backdrop) return;
      state.modal.backdrop.style.display = "none";
    }

    function formatWebformDateLabel(val) {
      if (Array.isArray(val)) {
        const uniq = Array.from(new Set(val)).sort();
        return uniq.join(", ");
      }
      return val || "날짜 확인 불가";
    }

    function getWebformsForPerson(personId) {
      const source = state.filteredWonGroupJson?.groups?.length
        ? state.filteredWonGroupJson
        : state.wonGroupJson;
      if (!source || !source.groups) return [];
      for (const group of source.groups) {
        const match = (group.people || []).find((p) => p.id === personId);
        if (match && Array.isArray(match.webforms)) {
          return match.webforms;
        }
      }
      return [];
    }

    function flattenWebformRows(webforms) {
      const rows = [];
      (webforms || []).forEach((wf) => {
        const name = wf?.name || "-";
        const date = wf?.date;
        if (Array.isArray(date)) {
          const uniq = Array.from(new Set(date)).sort();
          uniq.forEach((d) => rows.push({ date: d || "날짜 확인 불가", name }));
        } else {
          rows.push({ date: date || "날짜 확인 불가", name });
        }
      });
      return rows;
    }

    function openWebformModal(personName, webforms) {
      if (!state.webformModal.backdrop) return;
      const rows = flattenWebformRows(webforms);
      state.webformModal.title.textContent = `웹폼 내역 - ${personName || "-"}`;
      if (!rows.length) {
        state.webformModal.body.innerHTML = `<div class="muted">웹폼 내역이 없습니다.</div>`;
        state.webformModal.backdrop.style.display = "flex";
        return;
      }
      const bodyRows = rows
        .map(
          (r) => `<tr><td>${formatWebformDateLabel(r.date)}</td><td>${r.name}</td></tr>`
        )
        .join("");
      state.webformModal.body.innerHTML = `
        <div class="table-wrap full">
          <table>
            <thead><tr><th style="width: 160px;">날짜</th><th>웹폼 제목</th></tr></thead>
            <tbody>${bodyRows}</tbody>
          </table>
        </div>
      `;
      state.webformModal.backdrop.style.display = "flex";
    }

    function closeWebformModal() {
      if (!state.webformModal.backdrop) return;
      state.webformModal.backdrop.style.display = "none";
    }

    function attachMemoRowClicks(tableId, memoList) {
      const table = document.getElementById(tableId);
      if (!table) return;
      table.querySelectorAll("tbody tr").forEach((tr, idx) => {
        const memo = memoList[idx];
        if (!memo) return;
        tr.style.cursor = "pointer";
        tr.addEventListener("click", () => openMemoModal(memo));
      });
    }

    function getSectionStorageKey(sectionId) {
      return `${MENU_SECTION_STORAGE_PREFIX}${sectionId}`;
    }

    function loadSectionOpen(section) {
      const key = getSectionStorageKey(section.sectionId);
      try {
        const stored = localStorage.getItem(key);
        if (stored === null) return Boolean(section.defaultOpen);
        return stored === "true";
      } catch (_) {
        return Boolean(section.defaultOpen);
      }
    }

    function saveSectionOpen(sectionId, open) {
      try {
        localStorage.setItem(getSectionStorageKey(sectionId), String(open));
      } catch (_) {
        // ignore storage errors
      }
    }

    function setActiveMenu(menuId, options = {}) {
      const { skipHash = false, force = false } = options;
      const nextId = MENU_IDS.has(menuId) ? menuId : DEFAULT_MENU_ID;
      const changed = state.activeMenuId !== nextId;
      state.activeMenuId = nextId;
      if (!skipHash) {
        try {
          window.location.hash = `#${nextId}`;
        } catch (_) {
          // ignore hash errors
        }
      }
      renderSidebar();
      if (changed || force) {
        return renderContent();
      }
      return Promise.resolve();
    }

    function renderSidebar() {
      const list = document.getElementById("menuList");
      if (!list) return;
      list.innerHTML = "";
      MENU_SECTIONS.forEach((section) => {
        const li = document.createElement("li");
        li.className = "menu-section";
        const header = document.createElement("div");
        header.className = "menu-section-header";
        let isOpen = loadSectionOpen(section);
        const isActiveSection = section.items.some((it) => it.id === state.activeMenuId);
        if (isActiveSection) header.classList.add("active-section");
        const titleEl = document.createElement("span");
        titleEl.textContent = section.title;
        const icon = document.createElement("span");
        icon.className = "menu-toggle-icon";
        icon.textContent = isOpen ? "▾" : "▸";
        header.appendChild(titleEl);
        header.appendChild(icon);

        const itemsWrap = document.createElement("div");
        itemsWrap.className = "menu-section-items";
        itemsWrap.style.display = isOpen ? "flex" : "none";

        header.addEventListener("click", () => {
          isOpen = !isOpen;
          itemsWrap.style.display = isOpen ? "flex" : "none";
          icon.textContent = isOpen ? "▾" : "▸";
          saveSectionOpen(section.sectionId, isOpen);
        });

        section.items
          .filter((item) => !item.hidden)
          .forEach((item) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "menu-item";
            if (state.activeMenuId === item.id) btn.classList.add("active");
            btn.textContent = item.label;
            btn.addEventListener("click", () => setActiveMenu(item.id));
            itemsWrap.appendChild(btn);
          });

        li.appendChild(header);
        li.appendChild(itemsWrap);
        list.appendChild(li);
      });
    }

    async function renderContent() {
      const contentRoot = document.getElementById("contentRoot");
      if (!contentRoot) return;
      const renderFn = MENU_RENDERERS[state.activeMenuId];
      if (!renderFn) {
        contentRoot.innerHTML = "<div class='muted'>선택한 메뉴를 찾을 수 없습니다.</div>";
        return;
      }
      const result = renderFn(contentRoot);
      if (result && typeof result.then === "function") {
        await result;
      }
    }

    async function fetchJson(path) {
      const resp = await fetch(`${API_BASE}${path}`);
      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(txt || resp.statusText);
      }
      return resp.json();
    }

    let target2026Cache = null;
    let pnlAssumptionTimer = null;
    async function loadBizPerfSummary() {
      if (state.perfMonthly.data) return state.perfMonthly.data;
      const data = await fetchJson(`/performance/monthly-amounts/summary?from=2025-01&to=2026-12`);
      state.perfMonthly.data = data;
      return data;
    }

    async function loadBizPerfDeals(segmentKey, rowKey, monthKey) {
      const params = new URLSearchParams();
      params.set("segment", segmentKey);
      params.set("row", rowKey);
      params.set("month", monthKey);
      return fetchJson(`/performance/monthly-amounts/deals?${params.toString()}`);
    }

    async function loadPlProgress2026Summary(year = 2026) {
      const cached = state.perfPlProgress2026.summary;
      if (cached && cached.year === year) return cached;
      const params = new URLSearchParams();
      params.set("year", year);
      const data = await fetchJson(`/performance/pl-progress-2026/summary?${params.toString()}`);
      state.perfPlProgress2026.summary = data;
      return data;
    }

    async function loadPlProgress2026Deals({ year = 2026, month, rail, variant = "E", limit = 500, offset = 0 }) {
      const key = `${year}|${month}|${rail}|${variant}|${offset}|${limit}`;
      const cache = state.perfPlProgress2026.dealsCache.get(key);
      if (cache) return cache;
      const params = new URLSearchParams();
      params.set("year", year);
      params.set("month", month);
      params.set("rail", rail);
      params.set("variant", variant);
      params.set("limit", limit);
      params.set("offset", offset);
      const data = await fetchJson(`/performance/pl-progress-2026/deals?${params.toString()}`);
      state.perfPlProgress2026.dealsCache.set(key, data);
      return data;
    }

    async function loadCounterpartyRows(size = "대기업", offset = 0, limit = 100) {
      const key = `${size || "대기업"}|${offset}|${limit}`;
      if (state.rankCounterpartyCache[key]) {
        return state.rankCounterpartyCache[key];
      }
      const params = new URLSearchParams();
      params.set("size", size || "대기업");
      params.set("limit", limit);
      params.set("offset", offset);
      const data = await fetchJson(`/rank/2025-top100-counterparty-dri?${params.toString()}`);
      const result = { rows: data.rows || [], meta: data.meta || {} };
      state.rankCounterpartyCache[key] = result;
      return result;
    }

    async function loadTarget2026SourceRows() {
      if (target2026Cache) return target2026Cache;
      let sizes = [];
      try {
        sizes = await getSizes();
      } catch (err) {
        console.debug("[target2026] getSizes failed, fallback defaults", err);
      }
      const pickSize = (pref) => {
        const found = sizes.find((s) => s.includes(pref));
        return found || pref;
      };
      const sizeBig = pickSize("대기업");
      const sizeMid = pickSize("중견");
      const sizeSmall = pickSize("중소");
      const [big, mid, small] = await Promise.all([
        loadCounterpartyRows(sizeBig, 0, 100),
        loadCounterpartyRows(sizeMid, 0, 100),
        loadCounterpartyRows(sizeSmall, 0, 100),
      ]);
      target2026Cache = { big: big.rows || [], mid: mid.rows || [], small: small.rows || [] };
      console.debug("[target2026] source rows", {
        big: target2026Cache.big.length,
        mid: target2026Cache.mid.length,
        small: target2026Cache.small.length,
      });
      if (target2026Cache.big.length === 0 && target2026Cache.mid.length === 0 && target2026Cache.small.length === 0) {
        throw new Error("DRI 데이터가 비어 있습니다.");
      }
      return target2026Cache;
    }

    async function fetchOrgById(orgId) {
      const cached = cache.orgLookup.get(orgId);
      if (cached) return cached;
      const data = await fetchJson(`/orgs/${orgId}`);
      if (data && data.item) {
        cache.orgLookup.set(orgId, data.item);
        return data.item;
      }
      return null;
    }

    async function navigateToOrg(orgId) {
      if (!orgId) return;
      state.pendingOrgId = orgId;
      state.orgSearch = orgId; // search by id to narrow list
      try {
        state.pendingOrgFallback = await fetchOrgById(orgId);
      } catch (_) {
        state.pendingOrgFallback = null;
      }
      state.size = "전체";
      await setActiveMenu("org-view", { force: true });
    }

    function formatDate(val) {
      if (!val) return "-";
      const clean = String(val).split("T")[0].split(" ")[0];
      return clean || val;
    }

    function formatDateYYMMDD(val) {
      if (!val) return "-";
      const clean = String(val).split("T")[0].split(" ")[0];
      const match = clean.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (match) {
        return match[1].slice(2) + match[2] + match[3];
      }
      const digits = clean.replace(/\D/g, "");
      if (digits.length >= 8) {
        return digits.slice(2, 8);
      }
      return clean || val;
    }

    function formatProbability(val) {
      if (val === null || val === undefined) return "-";
      let parsed = val;
      if (typeof val === "string") {
        const text = val.trim();
        if ((text.startsWith("[") && text.endsWith("]")) || (text.startsWith("{") && text.endsWith("}"))) {
          try {
            parsed = JSON.parse(text);
          } catch (_) {
            return text || "-";
          }
        } else {
          return text || "-";
        }
      }
      const joinParts = (arr) => {
        const parts = arr.map((item) => String(item).trim()).filter(Boolean);
        return parts.length ? parts.join("/") : "-";
      };
      if (Array.isArray(parsed)) {
        return joinParts(parsed);
      }
      if (parsed && typeof parsed === "object") {
        return joinParts(Object.values(parsed));
      }
      return String(parsed);
    }

    function formatAmount(num) {
      if (num === null || num === undefined || Number.isNaN(num)) return "-";
      const value = Number(num);
      if (!Number.isFinite(value)) return "-";
      return (value / 1e8).toFixed(2) + "억";
    }

    function formatEok1(amountWon) {
      const n = Number(amountWon || 0);
      if (!Number.isFinite(n)) return "0.0";
      return (n / 1e8).toFixed(1);
    }

    function formatEok(num) {
      if (num === null || num === undefined || Number.isNaN(num)) return "-";
      const value = Number(num);
      if (!Number.isFinite(value)) return "-";
      return value.toFixed(2) + "억";
    }

    // Target 2026 전용: 숫자 문자열만 반환(억 미포함)
    function formatEokNumberOnly(num) {
      if (num === null || num === undefined || Number.isNaN(num)) return "0.00";
      const value = Number(num);
      if (!Number.isFinite(value)) return "0.00";
      return value.toFixed(2);
    }

    function formatEokMax2(num) {
      const value = Number(num);
      if (!Number.isFinite(value)) return "-";
      return value.toFixed(1);
    }

    function formatPercentValue(num) {
      if (num === null || num === undefined || Number.isNaN(num)) return "-";
      let value = Number(num);
      if (!Number.isFinite(value)) return "-";
      if (value > 0 && value <= 1) value = value * 100;
      if (value < 0 && value >= -1) value = value * 100;
      return `${value.toFixed(1)}%`;
    }

    function applyAssumptionsToPnlData(data, assumptions = DEFAULT_PNL_ASSUMPTIONS) {
      if (!data || !data.rows) return data;
      const months = data.months || [];
      const columns = data.columns || [];
      const cloned = {
        ...data,
        rows: data.rows.map((row) => ({ ...row, values: { ...(row.values || {}) } })),
      };
      const rowMap = new Map(cloned.rows.map((row) => [row.key, row]));
      const yearKeyByVariant = {};
      columns.forEach((c) => {
        if (c.kind === "YEAR" && c.variant) {
          yearKeyByVariant[c.variant] = c.key;
        }
      });
      const isEKey = (key) => {
        if (!key) return false;
        return key.endsWith("_E") || key === yearKeyByVariant["E"];
      };

      const toNum = (v) => {
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };
      const setVal = (rowKey, key, value) => {
        if (!isEKey(key)) return;
        const row = rowMap.get(rowKey);
        if (!row) return;
        if (!row.values) row.values = {};
        row.values[key] = Number.isFinite(value) ? value : value === null ? null : null;
      };
      const sumNullable = (vals) => {
        const nums = vals.filter((v) => Number.isFinite(v));
        if (!nums.length) return null;
        return nums.reduce((a, b) => a + b, 0);
      };
      const sumRowVariant = (rowKey, variant) => {
        const row = rowMap.get(rowKey);
        if (!row) return null;
        let has = false;
        let total = 0;
        months.forEach((m) => {
          const v = toNum(row.values ? row.values[`${m}_${variant}`] : null);
          if (Number.isFinite(v)) {
            total += v;
            has = true;
          }
        });
        return has ? total : null;
      };

      const onlineMargin = Number(
        assumptions.onlineContribMarginRate ?? DEFAULT_PNL_ASSUMPTIONS.onlineContribMarginRate
      );
      const offlineMargin = Number(
        assumptions.offlineContribMarginRate ?? DEFAULT_PNL_ASSUMPTIONS.offlineContribMarginRate
      );
      const monthlyProd = Number(assumptions.monthlyProdCost ?? DEFAULT_PNL_ASSUMPTIONS.monthlyProdCost);
      const monthlyMkt = Number(assumptions.monthlyMktCost ?? DEFAULT_PNL_ASSUMPTIONS.monthlyMktCost);
      const monthlyLabor = Number(assumptions.monthlyLaborCost ?? DEFAULT_PNL_ASSUMPTIONS.monthlyLaborCost);
      const monthlyRent = monthlyLabor * 0.15;

      const yearKeyE = yearKeyByVariant["E"];

      months.forEach((month) => {
        const suffix = `${month}_E`;
        const revOnline = toNum(rowMap.get("REV_ONLINE")?.values?.[suffix]);
        const revOffline = toNum(rowMap.get("REV_OFFLINE")?.values?.[suffix]);
        const revTotalVal = toNum(rowMap.get("REV_TOTAL")?.values?.[suffix]) ?? sumNullable([revOnline, revOffline]);

        const contribOnline = revOnline === null ? null : revOnline * (1 - onlineMargin);
        const contribOffline = revOffline === null ? null : revOffline * (1 - offlineMargin);
        const contribTotal = sumNullable([contribOnline, contribOffline]);

        const profitOnline = revOnline === null ? null : revOnline - (contribOnline ?? 0);
        const profitOffline = revOffline === null ? null : revOffline - (contribOffline ?? 0);
        const profitTotal = sumNullable([profitOnline, profitOffline]);

        const fixedOther = revOffline === null ? null : 1.0 + revOffline * 0.05;
        const fixedTotal =
          fixedOther === null ? null : monthlyProd + monthlyMkt + monthlyLabor + monthlyRent + fixedOther;

        const opVal = profitTotal === null || fixedTotal === null ? null : profitTotal - fixedTotal;
        const margin = revTotalVal && opVal !== null && revTotalVal > 0 ? (opVal / revTotalVal) * 100 : null;

        setVal("COST_CONTRIB_ONLINE", suffix, contribOnline);
        setVal("COST_CONTRIB_OFFLINE", suffix, contribOffline);
        setVal("COST_CONTRIB_TOTAL", suffix, contribTotal);

        setVal("PROFIT_CONTRIB_ONLINE", suffix, profitOnline);
        setVal("PROFIT_CONTRIB_OFFLINE", suffix, profitOffline);
        setVal("PROFIT_CONTRIB_TOTAL", suffix, profitTotal);

        setVal("COST_FIXED_PROD", suffix, monthlyProd);
        setVal("COST_FIXED_MKT", suffix, monthlyMkt);
        setVal("COST_FIXED_LABOR", suffix, monthlyLabor);
        setVal("COST_FIXED_RENT", suffix, monthlyRent);
        setVal("COST_FIXED_OTHER", suffix, fixedOther);
        setVal("COST_FIXED_TOTAL", suffix, fixedTotal);

        setVal("OP", suffix, opVal);
        setVal("OP_MARGIN", suffix, margin);
      });

      if (yearKeyE) {
        cloned.rows.forEach((row) => {
          if (row.format === "percent") {
            const revTotal = sumRowVariant("REV_TOTAL", "E");
            const opTotal = sumRowVariant("OP", "E");
            const marginYear = revTotal && opTotal !== null && revTotal > 0 ? (opTotal / revTotal) * 100 : null;
            setVal("OP_MARGIN", yearKeyE, marginYear);
          } else {
            const summed = sumRowVariant(row.key, "E");
            setVal(row.key, yearKeyE, summed);
          }
        });
        // year-level fixed others for E use yearly offline rev if present
        const revOfflineYear = toNum(rowMap.get("REV_OFFLINE")?.values?.[yearKeyE]);
        const fixedOtherYear = revOfflineYear === null ? null : 1.0 + revOfflineYear * 0.05;
        if (fixedOtherYear !== null) {
          setVal("COST_FIXED_OTHER", yearKeyE, fixedOtherYear);
          const fixedTotalYear =
            monthlyProd * 12 + monthlyMkt * 12 + monthlyLabor * 12 + monthlyRent * 12 + fixedOtherYear;
          setVal("COST_FIXED_TOTAL", yearKeyE, fixedTotalYear);
          const profitTotalYear = toNum(rowMap.get("PROFIT_CONTRIB_TOTAL")?.values?.[yearKeyE]);
          const opYear =
            profitTotalYear === null || fixedTotalYear === null ? null : profitTotalYear - fixedTotalYear;
          setVal("OP", yearKeyE, opYear);
          const revTotalYear = toNum(rowMap.get("REV_TOTAL")?.values?.[yearKeyE]);
          const marginYear =
            revTotalYear && opYear !== null && revTotalYear > 0 ? (opYear / revTotalYear) * 100 : null;
          setVal("OP_MARGIN", yearKeyE, marginYear);
        }
      }

      return cloned;
    }

    function isOnlineCourseFormat(v) {
      const s = (v ?? "").trim();
      return s === "구독제(온라인)" || s === "선택구매(온라인)" || s === "포팅";
    }

    function formatRatio(num) {
      if (num === null || num === undefined || Number.isNaN(num)) return "n/a";
      const value = Number(num);
      if (!Number.isFinite(value)) return "n/a";
      return value.toFixed(2);
    }

    function renderStatePathLegendModal() {
      const body = state.statepathLegend.body;
      if (!body) return;
      const sectionLabel = {
        snapshot: "Snapshot",
        filters: "Quick Filters",
        pattern: "Pattern Explorer",
        segment: "Segment Comparison",
        top: "Top Patterns",
        breadcrumb: "Breadcrumb",
        pagination: "Sorting/Pagination",
        export: "Export/JSON",
        all: "전체",
      }[state.statepathLegend.section] || "전체";
      const bucketRowsCompany = [
        ["Ø", "0"],
        ["P5", "0 < x < 0.1"],
        ["P4", "0.1 ≤ x < 0.25"],
        ["P3", "0.25 ≤ x < 0.5"],
        ["P2", "0.5 ≤ x < 1"],
        ["P1", "1 ≤ x < 2"],
        ["P0", "2 ≤ x < 10"],
        ["S0", "10 이상"],
      ];
      const bucketRowsRail = [
        ["Ø", "0"],
        ["P5", "0 < x < 0.05"],
        ["P4", "0.05 ≤ x < 0.125"],
        ["P3", "0.125 ≤ x < 0.25"],
        ["P2", "0.25 ≤ x < 0.5"],
        ["P1", "0.5 ≤ x < 1"],
        ["P0", "1 ≤ x < 5"],
        ["S0", "5 이상"],
      ];
      const bucketTable = (title, rows) =>
        `<div style="margin-top:8px;">
          <div class="muted">${title}</div>
          <div class="table-wrap full">
            <table>
              <thead><tr><th>버킷</th><th>구간(억)</th></tr></thead>
              <tbody>${rows.map((r) => `<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join("")}</tbody>
            </table>
          </div>
        </div>`;
      body.innerHTML = `
        <div class="muted">열려있는 섹션: ${sectionLabel}</div>
        <h4>1) 단위/전제</h4>
        <div>${getGlossaryLong("unit")}</div>
        <div>${getGlossaryLong("years")}</div>

        <h4>2) Snapshot Cards</h4>
        <div>${STATEPATH_GLOSSARY.snapshot.accountCount.short}</div>
        <div>${STATEPATH_GLOSSARY.snapshot.sums.long}</div>
        <div>${STATEPATH_GLOSSARY.snapshot.companyDir.long}</div>
        <div>${STATEPATH_GLOSSARY.snapshot.openRisk.long}</div>

        <h4>3) Quick Filters</h4>
        <ul>
          <li>${getGlossaryLong("quickFilters.risk")}</li>
          <li>${getGlossaryLong("quickFilters.hasOpen")}</li>
          <li>${getGlossaryLong("quickFilters.hasScaleUp")}</li>
          <li>${getGlossaryLong("quickFilters.companyDir")}</li>
          <li>${getGlossaryLong("quickFilters.seed")}</li>
          <li>${getGlossaryLong("quickFilters.railShift")}</li>
        </ul>

        <h4>4) Pattern Explorer</h4>
        <div>${getGlossaryLong("patternExplorer.transitionMatrix")}</div>
        <div>${getGlossaryLong("patternExplorer.cellEventMatrix")}</div>
        <div>${getGlossaryLong("patternExplorer.railMix")}</div>

        <h4>5) Top Patterns</h4>
        <div>${getGlossaryLong("topPatterns")}</div>

        <h4>6) Breadcrumb</h4>
        <div>${getGlossaryLong("breadcrumb")}</div>

        <h4>7) Sorting / Pagination</h4>
        <div>정렬: ${Object.values(STATEPATH_GLOSSARY.sorting).join(", ")}</div>
        <div>${getGlossaryLong("pagination")}</div>

        <h4>9) Export / JSON</h4>
        <div>${getGlossaryLong("export.table")}</div>
        <div>${getGlossaryLong("export.detail")}</div>
        <div>${getGlossaryLong("export.note")}</div>

        <h4>10) Events / Cells / Buckets</h4>
        <div>${getGlossaryLong("events")}</div>
        <div>${getGlossaryLong("cells")}</div>
        ${bucketTable("Company 버킷 임계값", bucketRowsCompany)}
        ${bucketTable("Rail/Cell 버킷 임계값", bucketRowsRail)}
      `;
    }

    function bindStatePathHelpButtons(root = document) {
      root.querySelectorAll("[data-help-section]").forEach((btn) => {
        btn.addEventListener("click", () => openStatePathLegendModal(btn.getAttribute("data-help-section"), btn));
      });
    }
    function getGlossaryShort(path) {
      const parts = path.split(".");
      let cur = STATEPATH_GLOSSARY;
      for (const p of parts) {
        if (cur && typeof cur === "object" && p in cur) {
          cur = cur[p];
        } else {
          return "";
        }
      }
      if (typeof cur === "string") return cur;
      return cur?.short || "";
    }

    function getGlossaryLong(path) {
      const parts = path.split(".");
      let cur = STATEPATH_GLOSSARY;
      for (const p of parts) {
        if (cur && typeof cur === "object" && p in cur) {
          cur = cur[p];
        } else {
          return "";
        }
      }
      if (typeof cur === "string") return cur;
      return cur?.long || cur?.short || "";
    }

    function renderStatePathHelpButton(sectionKey) {
      return `<button class="info-btn" aria-label="용어/기준 보기" data-help-section="${sectionKey}" title="${getGlossaryShort(sectionKey)}">ⓘ</button>`;
    }

    function openStatePathLegendModal(sectionKey = "all", trigger = null) {
      state.statepathLegend.section = sectionKey || "all";
      state.statepathLegend.open = true;
      state.statepathLegend.trigger = trigger || null;
      const body = state.statepathLegend.body;
      if (!body) return;
      renderStatePathLegendModal();
      if (state.statepathLegend.backdrop) state.statepathLegend.backdrop.style.display = "flex";
      if (state.statepathLegend.close) state.statepathLegend.close.focus?.();
    }

    function closeStatePathLegendModal() {
      state.statepathLegend.open = false;
      if (state.statepathLegend.backdrop) state.statepathLegend.backdrop.style.display = "none";
      const trigger = state.statepathLegend.trigger;
      if (trigger && typeof trigger.focus === "function") {
        trigger.focus();
      }
    }

    function bucketOrderIndex(bucket) {
      const idx = BUCKET_ORDER.indexOf(bucket || "Ø");
      return idx >= 0 ? idx : 0;
    }

    function getItemField(item, keys, fallback = null) {
      for (const k of keys) {
        if (item[k] !== undefined && item[k] !== null) return item[k];
      }
      return fallback;
    }

    function getCompanyBuckets(item) {
      const b24 = getItemField(item, ["companyBucket2024", "company_bucket_2024", "company_bucket_2024".toLowerCase(), "company_bucket_2024".toUpperCase()], "Ø");
      const b25 = getItemField(item, ["companyBucket2025", "company_bucket_2025"], "Ø");
      const bon24 = getItemField(item, ["companyOnlineBucket2024", "company_online_bucket_2024"], "Ø");
      const bon25 = getItemField(item, ["companyOnlineBucket2025", "company_online_bucket_2025"], "Ø");
      const boff24 = getItemField(item, ["companyOfflineBucket2024", "company_offline_bucket_2024"], "Ø");
      const boff25 = getItemField(item, ["companyOfflineBucket2025", "company_offline_bucket_2025"], "Ø");
      return {
        company: { "2024": b24, "2025": b25 },
        online: { "2024": bon24, "2025": bon25 },
        offline: { "2024": boff24, "2025": boff25 },
      };
    }

    function getCellsByYear(item, year) {
      if (year === "2024") {
        return item.cells_2024 || item.cells2024 || {};
      }
      if (year === "2025") {
        return item.cells_2025 || item.cells2025 || {};
      }
      return {};
    }

    function computePatternMeta(item) {
      const buckets = getCompanyBuckets(item);
      const cells24 = getCellsByYear(item, "2024");
      const cells25 = getCellsByYear(item, "2025");
      const cells = ["HRD_ONLINE", "HRD_OFFLINE", "BU_ONLINE", "BU_OFFLINE"];
      const openCells = [];
      const closeCells = [];
      const upCells = [];
      const downCells = [];
      const cellBuckets = {};
      cells.forEach((cell) => {
        const b24 = (cells24[cell] && cells24[cell].bucket) || "Ø";
        const b25 = (cells25[cell] && cells25[cell].bucket) || "Ø";
        cellBuckets[cell] = { "2024": b24, "2025": b25 };
        if (b24 === "Ø" && b25 !== "Ø") openCells.push(cell);
        else if (b24 !== "Ø" && b25 === "Ø") closeCells.push(cell);
        else if (bucketOrderIndex(b25) > bucketOrderIndex(b24)) upCells.push(cell);
        else if (bucketOrderIndex(b25) < bucketOrderIndex(b24)) downCells.push(cell);
      });
      const companyDir =
        bucketOrderIndex(buckets.company["2025"]) > bucketOrderIndex(buckets.company["2024"])
          ? "up"
          : bucketOrderIndex(buckets.company["2025"]) < bucketOrderIndex(buckets.company["2024"])
          ? "down"
          : "flat";
      const railDir = {
        ONLINE:
          bucketOrderIndex(buckets.online["2025"]) > bucketOrderIndex(buckets.online["2024"])
            ? "up"
            : bucketOrderIndex(buckets.online["2025"]) < bucketOrderIndex(buckets.online["2024"])
            ? "down"
            : "flat",
        OFFLINE:
          bucketOrderIndex(buckets.offline["2025"]) > bucketOrderIndex(buckets.offline["2024"])
            ? "up"
            : bucketOrderIndex(buckets.offline["2025"]) < bucketOrderIndex(buckets.offline["2024"])
            ? "down"
            : "flat",
      };
      const seed = getItemField(item, ["seed"], null);
      const meta = {
        companyBuckets: buckets.company,
        onlineBuckets: buckets.online,
        offlineBuckets: buckets.offline,
        cellBuckets,
        openCells,
        closeCells,
        upCells,
        downCells,
        companyDir,
        railDir,
        seed,
      };
      meta.hasOpen = openCells.length > 0;
      meta.hasScaleUp = upCells.length > 0;
      meta.risk = closeCells.length > 0 || downCells.length > 0;
      return meta;
    }

    function buildMajorEventLabels(meta) {
      const labels = [];
      (meta.openCells || []).forEach((c) => labels.push(`OPEN:${c}`));
      (meta.closeCells || []).forEach((c) => labels.push(`CLOSE:${c}`));
      (meta.upCells || []).forEach((c) => labels.push(`UP:${c}`));
      (meta.downCells || []).forEach((c) => labels.push(`DOWN:${c}`));
      if (meta.railDir) {
        Object.entries(meta.railDir).forEach(([rail, dir]) => {
          if (dir !== "flat") labels.push(`RAIL:${rail} ${dir === "up" ? "↑" : "↓"}`);
        });
      }
      return labels;
    }

    function stripRevOpsFromStatePath(detailObj) {
      if (!detailObj) return null;
      let cloned;
      try {
        cloned = JSON.parse(JSON.stringify(detailObj));
      } catch (_) {
        return null;
      }
      delete cloned.ops_reco;
      delete cloned.revops_reco;
      return cloned;
    }

    function buildStatePathTableExportObject() {
      const spState = state.statepath2425 || {};
      const itemsAll =
        (spState.filteredItems && spState.filteredItems.length ? spState.filteredItems : spState.items) || [];
      const rows = itemsAll.map((row) => {
        const orgId = row.orgId || row.org_id || "";
        const orgName = row.orgName || row.org_name || orgId || "";
        const segment = row.segment || row.sizeGroup || row.size_raw || row.sizeRaw || "";
        const amt24 = row.companyTotalEok2024 ?? row.company_total_eok_2024 ?? 0;
        const amt25 = row.companyTotalEok2025 ?? row.company_total_eok_2025 ?? 0;
        const bucket24 = row.companyBucket2024 || row.company_bucket_2024 || "Ø";
        const bucket25 = row.companyBucket2025 || row.company_bucket_2025 || "Ø";
        const delta = row.deltaEok ?? row.delta_eok ?? amt25 - amt24;
        const meta = computePatternMeta(row);
        return {
          org_id: orgId,
          company_name: orgName,
          segment,
          y2024: { amt_eok: amt24, bucket: bucket24 },
          y2025: { amt_eok: amt25, bucket: bucket25 },
          delta_eok: delta,
          major_events: buildMajorEventLabels(meta),
        };
      });
      const filters = {
        segment: spState.segment || "전체",
        search: spState.search || "",
        sort: spState.sort || "won2025_desc",
        quickFilters: { ...(spState.quickFilters || {}) },
        patternFilter: { ...(spState.patternFilter || {}) },
      };
      return {
        export_type: "statepath_2425_table_v2",
        generated_at: new Date().toISOString(),
        filters,
        row_count: rows.length,
        rows,
      };
    }

    function buildStatepathPortfolioKey(segment, search, sort, limit) {
      return JSON.stringify({
        segment: segment || "전체",
        search: search || "",
        sort: sort || "won2025_desc",
        limit: limit || 500,
      });
    }

    function resetStatepathClientFilters() {
      const spState = state.statepath2425;
      spState.quickFilters = {
        risk: false,
        hasOpen: false,
        hasScaleUp: false,
        companyDir: "all",
        seed: "all",
        railShift: "all",
      };
      spState.patternFilter = {
        companyFrom: null,
        companyTo: null,
        cell: null,
        cellEvent: null,
        rail: null,
        railDir: null,
      };
      spState.tier2024 = [];
      spState.page = 0;
      spState.search = "";
      spState.sort = "won2025_desc";
    }

    let statepathFilterDrawerTrigger = null;
    let statepathFilterEscBound = false;

    function handleStatepathFilterEsc(e) {
      if (e.key === "Escape") {
        closeStatepathFilterDrawer({ restoreFocus: true });
      }
    }

    function openStatepathFilterDrawer() {
      const drawer = document.getElementById("statepathFilterDrawer");
      const backdrop = document.getElementById("statepathFilterBackdrop");
      const closeBtn = document.getElementById("statepathCloseFilterDrawer");
      const btn = document.getElementById("statepathOpenFilterDrawer");
      if (!drawer || !backdrop) return;
      statepathFilterDrawerTrigger = document.activeElement;
      drawer.classList.add("open");
      backdrop.classList.add("open");
      state.statepath2425.ui = state.statepath2425.ui || {};
      state.statepath2425.ui.filterDrawerOpen = true;
      if (closeBtn) closeBtn.focus();
      if (btn) btn.classList.add("is-open");
      if (!statepathFilterEscBound) {
        document.addEventListener("keydown", handleStatepathFilterEsc);
        statepathFilterEscBound = true;
      }
    }

    function closeStatepathFilterDrawer({ restoreFocus = true } = {}) {
      const drawer = document.getElementById("statepathFilterDrawer");
      const backdrop = document.getElementById("statepathFilterBackdrop");
      const btn = document.getElementById("statepathOpenFilterDrawer");
      if (drawer) drawer.classList.remove("open");
      if (backdrop) backdrop.classList.remove("open");
      state.statepath2425.ui = state.statepath2425.ui || {};
      state.statepath2425.ui.filterDrawerOpen = false;
      if (btn) btn.classList.remove("is-open");
      if (statepathFilterEscBound) {
        document.removeEventListener("keydown", handleStatepathFilterEsc);
        statepathFilterEscBound = false;
      }
      if (restoreFocus && statepathFilterDrawerTrigger instanceof HTMLElement) {
        statepathFilterDrawerTrigger.focus();
      }
      statepathFilterDrawerTrigger = null;
    }

    function bindStatepathFilterDrawerEvents() {
      const openBtn = document.getElementById("statepathOpenFilterDrawer");
      const closeBtn = document.getElementById("statepathCloseFilterDrawer");
      const backdrop = document.getElementById("statepathFilterBackdrop");
      if (openBtn) {
        openBtn.addEventListener("click", () => openStatepathFilterDrawer());
      }
      if (closeBtn) {
        closeBtn.addEventListener("click", () => closeStatepathFilterDrawer());
      }
      if (backdrop) {
        backdrop.addEventListener("click", () => closeStatepathFilterDrawer());
      }
    }

    function countActiveStatepathFilters() {
      const spState = state.statepath2425 || {};
      let count = 0;
      if (Array.isArray(spState.tier2024) && spState.tier2024.length) count += 1;
      const qf = spState.quickFilters || {};
      if (qf.risk) count += 1;
      if (qf.hasOpen) count += 1;
      if (qf.hasScaleUp) count += 1;
      if ((qf.companyDir || "all") !== "all") count += 1;
      if ((qf.seed || "all") !== "all") count += 1;
      if ((qf.railShift || "all") !== "all") count += 1;
      const pf = spState.patternFilter || {};
      if (pf.companyFrom || pf.companyTo) count += 1;
      if (pf.cell || pf.cellEvent) count += 1;
      if (pf.rail && pf.railDir) count += 1;
      return count;
    }

    function updateStatepathFilterCountBadge() {
      const badge = document.getElementById("statepathFilterCount");
      const btn = document.getElementById("statepathOpenFilterDrawer");
      if (!badge) return;
      const count = countActiveStatepathFilters();
      badge.textContent = String(count);
      if (btn) {
        btn.classList.toggle("is-active", count > 0);
      }
    }

    function isDefaultQuickFilters(qf) {
      return (
        !qf ||
        (qf.risk === false &&
          qf.hasOpen === false &&
          qf.hasScaleUp === false &&
          (qf.companyDir || "all") === "all" &&
          (qf.seed || "all") === "all" &&
          (qf.railShift || "all") === "all")
      );
    }

    function isDefaultPatternFilters(pf) {
      return (
        !pf ||
        !pf.companyFrom &&
        !pf.companyTo &&
        !pf.cell &&
        !pf.cellEvent &&
        !pf.rail &&
        !pf.railDir
      );
    }

    function applyStatepathFilters(items) {
      const spState = state.statepath2425;
      const qf = spState.quickFilters;
      const pf = spState.patternFilter;
      const metas = new Map();
      const result = [];
      const baseItems = Array.isArray(items) ? items : [];
      for (const item of baseItems) {
        const meta = computePatternMeta(item);
        const metaKey = item.orgId || item.org_id || item.orgName || item.org_name;
        metas.set(metaKey, meta);
        const tierSel = spState.tier2024 || [];
        if (Array.isArray(tierSel) && tierSel.length > 0) {
          const b24 = (meta.companyBuckets || {})["2024"] || "Ø";
          if (!tierSel.includes(b24)) continue;
        }
        if (qf.risk && !meta.risk) continue;
        if (qf.hasOpen && !meta.hasOpen) continue;
        if (qf.hasScaleUp && !meta.hasScaleUp) continue;
        if (qf.companyDir !== "all" && meta.companyDir !== qf.companyDir) continue;
        if (qf.seed && qf.seed !== "all" && meta.seed !== qf.seed) continue;
        if (qf.railShift === "onlineUp" && meta.railDir.ONLINE !== "up") continue;
        if (qf.railShift === "offlineUp" && meta.railDir.OFFLINE !== "up") continue;
        if (pf.companyFrom && pf.companyFrom !== meta.companyBuckets["2024"]) continue;
        if (pf.companyTo && pf.companyTo !== meta.companyBuckets["2025"]) continue;
        if (pf.cell || pf.cellEvent) {
          const targetCell = pf.cell;
          const events = [];
          meta.openCells.forEach((c) => events.push({ cell: c, type: "OPEN" }));
          meta.closeCells.forEach((c) => events.push({ cell: c, type: "CLOSE" }));
          meta.upCells.forEach((c) => events.push({ cell: c, type: "UP" }));
          meta.downCells.forEach((c) => events.push({ cell: c, type: "DOWN" }));
          const matched = events.some((ev) => {
            if (targetCell && ev.cell !== targetCell) return false;
            if (pf.cellEvent && pf.cellEvent !== ev.type) return false;
            return true;
          });
          if (!matched) continue;
        }
        if (pf.rail && pf.railDir && meta.railDir[pf.rail] !== pf.railDir) continue;
        result.push(item);
      }
      return { items: result, metas };
    }

    function buildStatepathSummary(items, metas) {
      const buckets = BUCKET_ORDER;
      const matrix = Array.from({ length: buckets.length }, () => Array.from({ length: buckets.length }, () => 0));
      const cellMatrix = {
        HRD_ONLINE: { OPEN: 0, CLOSE: 0, UP: 0, DOWN: 0 },
        HRD_OFFLINE: { OPEN: 0, CLOSE: 0, UP: 0, DOWN: 0 },
        BU_ONLINE: { OPEN: 0, CLOSE: 0, UP: 0, DOWN: 0 },
        BU_OFFLINE: { OPEN: 0, CLOSE: 0, UP: 0, DOWN: 0 },
      };
      const railSummary = { ONLINE: { up: 0, flat: 0, down: 0 }, OFFLINE: { up: 0, flat: 0, down: 0 } };
      let sum2024 = 0;
      let sum2025 = 0;
      let deltaSum = 0;
      let openCount = 0;
      let riskCount = 0;
      const seedCounts = { "H→B": 0, "B→H": 0, SIMUL: 0, NONE: 0 };
      items.forEach((item) => {
        const metaKey = item.orgId || item.org_id || item.orgName || item.org_name;
        const meta = metas.get(metaKey) || computePatternMeta(item);
        const b24 = meta.companyBuckets["2024"];
        const b25 = meta.companyBuckets["2025"];
        matrix[buckets.indexOf(b24)][buckets.indexOf(b25)] += 1;
        sum2024 += Number(item.companyTotalEok2024 ?? item.company_total_eok_2024 ?? 0);
        sum2025 += Number(item.companyTotalEok2025 ?? item.company_total_eok_2025 ?? 0);
        deltaSum += Number(item.deltaEok ?? item.delta_eok ?? 0);
        if (meta.hasOpen) openCount += 1;
        if (meta.risk) riskCount += 1;
        railSummary.ONLINE[meta.railDir.ONLINE] += 1;
        railSummary.OFFLINE[meta.railDir.OFFLINE] += 1;
        const seed = meta.seed || "NONE";
        if (seedCounts[seed] !== undefined) seedCounts[seed] += 1;
        ["HRD_ONLINE", "HRD_OFFLINE", "BU_ONLINE", "BU_OFFLINE"].forEach((cell) => {
          const bPrev = meta.cellBuckets[cell]["2024"];
          const bCurr = meta.cellBuckets[cell]["2025"];
          if (bPrev === "Ø" && bCurr !== "Ø") cellMatrix[cell].OPEN += 1;
          else if (bPrev !== "Ø" && bCurr === "Ø") cellMatrix[cell].CLOSE += 1;
          else if (bucketOrderIndex(bCurr) > bucketOrderIndex(bPrev)) cellMatrix[cell].UP += 1;
          else if (bucketOrderIndex(bCurr) < bucketOrderIndex(bPrev)) cellMatrix[cell].DOWN += 1;
        });
      });

      const changeCounts = {
        up: items.filter((it) => {
          const k = it.orgId || it.org_id || it.orgName || it.org_name;
          const meta = metas.get(k) || computePatternMeta(it);
          return meta.companyDir === "up";
        }).length,
        flat: items.filter((it) => {
          const k = it.orgId || it.org_id || it.orgName || it.org_name;
          const meta = metas.get(k) || computePatternMeta(it);
          return meta.companyDir === "flat";
        }).length,
        down: items.filter((it) => {
          const k = it.orgId || it.org_id || it.orgName || it.org_name;
          const meta = metas.get(k) || computePatternMeta(it);
          return meta.companyDir === "down";
        }).length,
      };

      return {
        accountCount: items.length,
        sum2024Eok: sum2024,
        sum2025Eok: sum2025,
        deltaSum,
        companyBucketChangeCounts: changeCounts,
        openAccountCount: openCount,
        riskAccountCount: riskCount,
        seedCounts,
        companyTransitionMatrix: { buckets, counts: matrix },
        cellEventMatrix: cellMatrix,
        railChangeSummary: railSummary,
      };
    }

    function computeStatepathDerived() {
      const spState = state.statepath2425;
      const { items, metas } = applyStatepathFilters(spState.items);
      let sorted = [...items];
      sorted.sort((a, b) => (b.companyTotalEok2025 ?? b.company_total_eok_2025 ?? 0) - (a.companyTotalEok2025 ?? a.company_total_eok_2025 ?? 0));
      spState.filteredItems = sorted;
      spState.derived = buildStatepathSummary(sorted, metas);
      spState.page = 0;
    }

    function renderStatePathSnapshots() {
      const wrap = document.getElementById("statepathSnapshots");
      if (!wrap) return;
      const spState = state.statepath2425;
      const d = spState.derived;
      if (!d) {
        wrap.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
        return;
      }
      wrap.innerHTML = `
        <div class="sp-snapshots">
          <div class="sp-snap-grid">
            <div class="sp-snap-tile">
              <div class="sp-snap-label">계정수</div>
              <div class="sp-snap-value" title="${STATEPATH_GLOSSARY.snapshot.accountCount.short}">${d.accountCount}</div>
            </div>
            <div class="sp-snap-tile">
              <div class="sp-snap-label">2024 합계</div>
              <div class="sp-snap-value" title="${STATEPATH_GLOSSARY.snapshot.sums.short}">${formatEok(d.sum2024Eok)}</div>
            </div>
            <div class="sp-snap-tile">
              <div class="sp-snap-label">2025 합계</div>
              <div class="sp-snap-value" title="${STATEPATH_GLOSSARY.snapshot.sums.short}">${formatEok(d.sum2025Eok)}</div>
            </div>
            <div class="sp-snap-tile">
              <div class="sp-snap-label">Δ 합</div>
              <div class="sp-snap-value" title="${STATEPATH_GLOSSARY.snapshot.sums.short}">${formatEok(d.deltaSum || (d.sum2025Eok - d.sum2024Eok))}</div>
            </div>
            <div class="sp-snap-tile">
              <div class="sp-snap-label">Company 변화</div>
              <div class="sp-snap-value" title="${STATEPATH_GLOSSARY.snapshot.companyDir.short}">↑ ${d.companyBucketChangeCounts.up} / → ${d.companyBucketChangeCounts.flat} / ↓ ${d.companyBucketChangeCounts.down}</div>
            </div>
            <div class="sp-snap-tile">
              <div class="sp-snap-label">OPEN / RISK</div>
              <div class="sp-snap-value" title="${STATEPATH_GLOSSARY.snapshot.openRisk.long}">${d.openAccountCount} / ${d.riskAccountCount}</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderSegmentPickerInDrawer() {
      const wrap = document.getElementById("statepathSegmentPicker");
      if (!wrap) return;
      const spState = state.statepath2425;
      const current = spState.segment || "전체";
      wrap.innerHTML = `
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
          ${STATEPATH_SEGMENTS.map(
            (seg) =>
              `<label style="display:flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--border);border-radius:10px;min-width:120px;">
                <input type="radio" name="sp-seg" value="${seg}" ${seg === current ? "checked" : ""} />
                <span>${seg}</span>
              </label>`
          ).join("")}
        </div>
      `;
      wrap.querySelectorAll('input[name="sp-seg"]').forEach((input) => {
        input.addEventListener("change", () => {
          const val = input.value || "전체";
          if (state.statepath2425.segment === val) return;
          state.statepath2425.segment = val;
          resetStatepathClientFilters();
          loadStatePathPortfolio2425(true);
        });
      });
    }

    function renderTier2024Filter() {
      const wrap = document.getElementById("statepathTier2024Wrap");
      if (!wrap) return;
      const spState = state.statepath2425;
      const selected = Array.isArray(spState.tier2024) ? spState.tier2024 : [];
      const buckets = [...BUCKET_ORDER].reverse();
      const presets = [
        { key: "all", label: "전체", value: [] },
        { key: "top", label: "상위(P2~S0)", value: ["P2", "P1", "P0", "S0"] },
        { key: "no-empty", label: "Ø 제외", value: BUCKET_ORDER.filter((b) => b !== "Ø") },
      ];
      wrap.innerHTML = `
        <div class="control-row" style="gap:6px;flex-wrap:wrap;">
          ${presets
            .map(
              (p) =>
                `<button type="button" class="chip ${selected.length === p.value.length && p.value.every((v) => selected.includes(v)) ? "active" : ""}" data-preset="${p.key}">${p.label}</button>`
            )
            .join("")}
        </div>
        <div class="sp-drawer__hint">미선택 = 전체</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
          ${buckets
            .map(
              (b) =>
                `<label style="display:flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;min-width:72px;">
                  <input type="checkbox" data-tier="${b}" ${selected.includes(b) ? "checked" : ""} />
                  <span>${b}</span>
                </label>`
            )
            .join("")}
        </div>
      `;
      const applyChange = () => {
        spState.page = 0;
        computeStatepathDerived();
        renderStatePathSnapshots();
        renderStatePathPatterns();
        renderStatePathTable();
        renderBreadcrumbs();
      };
      wrap.querySelectorAll("[data-preset]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const preset = presets.find((p) => p.key === btn.getAttribute("data-preset"));
          spState.tier2024 = preset ? [...preset.value] : [];
          applyChange();
        });
      });
      wrap.querySelectorAll('input[data-tier]').forEach((checkbox) => {
        checkbox.addEventListener("change", (e) => {
          const val = e.target.getAttribute("data-tier");
          const next = new Set(spState.tier2024 || []);
          if (e.target.checked) {
            next.add(val);
          } else {
            next.delete(val);
          }
          spState.tier2024 = Array.from(next);
          applyChange();
        });
      });
    }

    function renderQuickFilters() {
      const wrap = document.getElementById("statepathQuickFilters");
      if (!wrap) return;
      const spState = state.statepath2425;
      const qf = spState.quickFilters;
      const groups = [
        {
          title: "이벤트",
          items: [
            { key: "risk", label: "Risk", type: "toggle", path: "quickFilters.risk" },
            { key: "hasOpen", label: "New Open", type: "toggle", path: "quickFilters.hasOpen" },
            { key: "hasScaleUp", label: "Scale Up", type: "toggle", path: "quickFilters.hasScaleUp" },
          ],
        },
        {
          title: "성장 방향",
          items: [
            { key: "companyDir", label: "Company ↑", type: "single", value: "up", path: "quickFilters.companyDir" },
            { key: "companyDir", label: "Company =", type: "single", value: "flat", path: "quickFilters.companyDir" },
            { key: "companyDir", label: "Company ↓", type: "single", value: "down", path: "quickFilters.companyDir" },
          ],
        },
        {
          title: "Seed",
          items: [
            { key: "seed", label: "Seed H→B", type: "single", value: "H→B", path: "quickFilters.seed" },
            { key: "seed", label: "Seed B→H", type: "single", value: "B→H", path: "quickFilters.seed" },
            { key: "seed", label: "Seed NONE", type: "single", value: "NONE", path: "quickFilters.seed" },
          ],
        },
        {
          title: "Rail",
          items: [
            { key: "railShift", label: "Online ↑", type: "single", value: "onlineUp", path: "quickFilters.railShift" },
            { key: "railShift", label: "Offline ↑", type: "single", value: "offlineUp", path: "quickFilters.railShift" },
          ],
        },
      ];
      wrap.innerHTML = groups
        .map(
          (group) => `
            <div class="sp-drawer__hint" style="margin:6px 0 4px;">${group.title}</div>
            <div class="control-row" style="gap:6px;flex-wrap:wrap;">
              ${group.items
                .map((chip, idx) => {
                  const active = chip.type === "toggle" ? qf[chip.key] : qf[chip.key] === chip.value;
                  return `<button class="chip ${active ? "active" : ""}" data-chip-key="${chip.key}" data-chip-type="${chip.type}" data-chip-value="${chip.value || ""}" title="${getGlossaryLong(chip.path)}">${chip.label}</button>`;
                })
                .join("")}
            </div>
          `
        )
        .join("");
      wrap.querySelectorAll("[data-chip-key]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const key = btn.getAttribute("data-chip-key");
          const type = btn.getAttribute("data-chip-type");
          const value = btn.getAttribute("data-chip-value");
          if (type === "toggle") {
            qf[key] = !qf[key];
          } else {
            qf[key] = qf[key] === value ? "all" : value;
          }
          spState.page = 0;
          computeStatepathDerived();
          renderStatePathSnapshots();
          renderStatePathPatterns();
          renderStatePathTable();
          renderBreadcrumbs();
        });
      });
    }

    function renderTransitionMatrix() {
      const wrap = document.getElementById("statepathTransitionMatrix");
      if (!wrap) return;
      const spState = state.statepath2425;
      const pf = spState.patternFilter;
      const matrix = spState.derived?.companyTransitionMatrix;
      if (!matrix) {
        wrap.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
        return;
      }
      const rowsHtml = matrix.buckets
        .map((from, i) => {
          const cells = matrix.buckets
            .map((to, j) => {
              const count = matrix.counts[i][j];
              const active = pf.companyFrom === from && pf.companyTo === to;
              return `<td data-from="${from}" data-to="${to}" class="${active ? "active" : ""}" title="2024 ${from} → 2025 ${to} (계정수 ${count}) / 클릭하면 이 전이만 필터">${count}</td>`;
            })
            .join("");
          return `<tr><th title="${getGlossaryLong("buckets")}">${from}</th>${cells}</tr>`;
        })
        .join("");
      wrap.innerHTML = `
        <h4 class="muted">Company Bucket 전이</h4>
        <div class="table-wrap full">
          <table class="matrix-table">
            <thead>
              <tr><th title="${getGlossaryLong("patternExplorer.transitionMatrix")}">2024\\2025</th>${matrix.buckets.map((b) => `<th title="${getGlossaryLong("buckets")}">${b}</th>`).join("")}</tr>
            </thead>
            <tbody>${rowsHtml}</tbody>
          </table>
        </div>
      `;
      wrap.querySelectorAll("td[data-from]").forEach((td) => {
        td.addEventListener("click", () => {
          const from = td.getAttribute("data-from");
          const to = td.getAttribute("data-to");
          if (pf.companyFrom === from && pf.companyTo === to) {
            pf.companyFrom = null;
            pf.companyTo = null;
          } else {
            pf.companyFrom = from;
            pf.companyTo = to;
          }
          spState.page = 0;
          computeStatepathDerived();
          renderStatePathSnapshots();
          renderStatePathPatterns();
          renderStatePathTable();
          renderBreadcrumbs();
        });
      });
    }

    function renderCellEventMatrix() {
      const wrap = document.getElementById("statepathCellMatrix");
      if (!wrap) return;
      const spState = state.statepath2425;
      const pf = spState.patternFilter;
      const cellMatrix = spState.derived?.cellEventMatrix;
      if (!cellMatrix) {
        wrap.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
        return;
      }
      const cells = [
        ["HRD_ONLINE", "HRD_OFFLINE"],
        ["BU_ONLINE", "BU_OFFLINE"],
      ];
      wrap.innerHTML = `
        <h4 class="muted">4셀 이벤트</h4>
        <div class="grid-2col" style="display:grid;grid-template-columns:repeat(2,minmax(200px,1fr));gap:10px;">
          ${cells
            .flat()
            .map((cell) => {
              const counts = cellMatrix[cell];
              const badge = (type, label) => {
                const active = pf.cell === cell && pf.cellEvent === type;
                return `<span class="event-badge ${active ? "active" : ""}" data-cell="${cell}" data-event="${type}" title="${type} 이벤트: ${getGlossaryLong("events")} / 클릭 시 필터">${label} ${counts[type]}</span>`;
              };
              return `<div style="border:1px solid var(--border);border-radius:10px;padding:8px;" title="${getGlossaryLong("cells")}">
                <div class="muted">${cell}</div>
                <div class="event-badges">
                  ${badge("OPEN", "OPEN")}
                  ${badge("CLOSE", "CLOSE")}
                  ${badge("UP", "UP")}
                  ${badge("DOWN", "DOWN")}
                </div>
              </div>`;
            })
            .join("")}
        </div>
      `;
      wrap.querySelectorAll("[data-cell]").forEach((el) => {
        el.addEventListener("click", () => {
          const cell = el.getAttribute("data-cell");
          const ev = el.getAttribute("data-event");
          if (pf.cell === cell && pf.cellEvent === ev) {
            pf.cell = null;
            pf.cellEvent = null;
          } else {
            pf.cell = cell;
            pf.cellEvent = ev;
          }
          spState.page = 0;
          computeStatepathDerived();
          renderStatePathSnapshots();
          renderStatePathPatterns();
          renderStatePathTable();
          renderBreadcrumbs();
        });
      });
    }

    function renderRailSummary() {
      const wrap = document.getElementById("statepathRailSummary");
      if (!wrap) return;
      const spState = state.statepath2425;
      const pf = spState.patternFilter;
      const summary = spState.derived?.railChangeSummary;
      if (!summary) {
        wrap.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
        return;
      }
      const renderRail = (rail) => {
        return ["up", "flat", "down"]
          .map((dir) => {
            const active = pf.rail === rail && pf.railDir === dir;
            return `<span class="event-badge ${active ? "active" : ""}" data-rail="${rail}" data-dir="${dir}" title="${getGlossaryLong("patternExplorer.railMix")} / 클릭 시 필터">${rail} ${dir === "up" ? "↑" : dir === "down" ? "↓" : "→"} ${summary[rail][dir]}</span>`;
          })
          .join(" ");
      };
      wrap.innerHTML = `
        <h4 class="muted">Rail 변화</h4>
        <div>${renderRail("ONLINE")}</div>
        <div style="margin-top:6px;">${renderRail("OFFLINE")}</div>
      `;
      wrap.querySelectorAll("[data-rail]").forEach((el) => {
        el.addEventListener("click", () => {
          const rail = el.getAttribute("data-rail");
          const dir = el.getAttribute("data-dir");
          if (pf.rail === rail && pf.railDir === dir) {
            pf.rail = null;
            pf.railDir = null;
          } else {
            pf.rail = rail;
            pf.railDir = dir;
          }
          spState.page = 0;
          computeStatepathDerived();
          renderStatePathSnapshots();
          renderStatePathPatterns();
          renderStatePathTable();
          renderBreadcrumbs();
        });
      });
    }

    function renderStatePathPatterns() {
      renderTier2024Filter();
      renderQuickFilters();
      renderTransitionMatrix();
      renderCellEventMatrix();
      renderRailSummary();
      renderTopPatterns();
      bindStatePathHelpButtons(document);
    }

    function renderTopPatterns() {
      const wrap = document.getElementById("statepathTopPatterns");
      if (!wrap) return;
      const spState = state.statepath2425;
      const cellMatrix = spState.derived?.cellEventMatrix;
      const seedCounts = spState.derived?.seedCounts || {};
      if (!cellMatrix) {
        wrap.innerHTML = "";
        return;
      }
      const pickTopCell = (key) => {
        let bestCell = null;
        let bestVal = -1;
        Object.entries(cellMatrix).forEach(([cell, counts]) => {
          if (counts[key] > bestVal) {
            bestCell = cell;
            bestVal = counts[key];
          }
        });
        return { cell: bestCell, count: bestVal };
      };
      const pickTopSeed = () => {
        let bestSeed = null;
        let bestVal = -1;
        Object.entries(seedCounts).forEach(([seed, cnt]) => {
          if (cnt > bestVal) {
            bestSeed = seed;
            bestVal = cnt;
          }
        });
        return { seed: bestSeed, count: bestVal };
      };
      const tops = [
        { label: "Top OPEN", data: pickTopCell("OPEN"), type: "cell", event: "OPEN" },
        { label: "Top CLOSE", data: pickTopCell("CLOSE"), type: "cell", event: "CLOSE" },
        { label: "Top UP", data: pickTopCell("UP"), type: "cell", event: "UP" },
        { label: "Top DOWN", data: pickTopCell("DOWN"), type: "cell", event: "DOWN" },
        { label: "Top Seed", data: pickTopSeed(), type: "seed" },
      ];
      wrap.innerHTML = `
        <h4 class="muted" style="margin-top:10px;">Top Patterns ${renderStatePathHelpButton("top")}</h4>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
          ${tops
            .map((t, idx) => {
              const text =
                t.type === "seed"
                  ? `${t.label}: ${t.data.seed || "-"} (${t.data.count ?? 0})`
                  : `${t.label}: ${t.data.cell || "-"} (${t.data.count ?? 0})`;
              return `<button class="chip" data-top-idx="${idx}" title="${getGlossaryLong("topPatterns")} / 클릭 시 필터 적용">${text}</button>`;
            })
            .join("")}
        </div>
      `;
      wrap.querySelectorAll("[data-top-idx]").forEach((btn) => {
        const idx = Number(btn.getAttribute("data-top-idx"));
        const t = tops[idx];
        if (!t) return;
        btn.addEventListener("click", () => {
          if (t.type === "seed") {
            state.statepath2425.quickFilters.seed = t.data.seed || "all";
          } else {
            state.statepath2425.patternFilter.cell = t.data.cell || null;
            state.statepath2425.patternFilter.cellEvent = t.event;
          }
          state.statepath2425.page = 0;
          computeStatepathDerived();
          renderStatePathSnapshots();
          renderStatePathPatterns();
          renderStatePathTable();
          renderBreadcrumbs();
        });
      });
    }

    function renderBreadcrumbs() {
      const wrap = document.getElementById("statepathAppliedBar");
      if (!wrap) return;
      const spState = state.statepath2425;
      const tokens = [];
      if (spState.segment && spState.segment !== "전체") tokens.push({ label: spState.segment, type: "segment" });
      if (Array.isArray(spState.tier2024) && spState.tier2024.length) {
        tokens.push({ label: `24티어:${spState.tier2024.join(",")}`, type: "tier2024" });
      }
      const qf = spState.quickFilters;
      if (qf.risk) tokens.push({ label: "Risk", type: "qf", key: "risk" });
      if (qf.hasOpen) tokens.push({ label: "Open", type: "qf", key: "hasOpen" });
      if (qf.hasScaleUp) tokens.push({ label: "Scale Up", type: "qf", key: "hasScaleUp" });
      if (qf.companyDir !== "all") tokens.push({ label: `Company ${qf.companyDir}`, type: "qf", key: "companyDir" });
      if (qf.seed !== "all") tokens.push({ label: `Seed ${qf.seed}`, type: "qf", key: "seed" });
      if (qf.railShift !== "all") tokens.push({ label: qf.railShift === "onlineUp" ? "Online ↑" : "Offline ↑", type: "qf", key: "railShift" });
      const pf = spState.patternFilter;
      if (pf.companyFrom || pf.companyTo) tokens.push({ label: `Company ${pf.companyFrom || "Ø"}→${pf.companyTo || "Ø"}`, type: "pf", key: "company" });
      if (pf.cell || pf.cellEvent) tokens.push({ label: `${pf.cellEvent || ""} ${pf.cell || ""}`.trim(), type: "pf", key: "cell" });
      if (pf.rail && pf.railDir) tokens.push({ label: `${pf.rail} ${pf.railDir}`, type: "pf", key: "rail" });
      if (!tokens.length) {
        wrap.innerHTML = `<span class="pill" style="background:rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); color: var(--muted); cursor: default;">필터 없음</span>`;
        updateStatepathFilterCountBadge();
        return;
      }
      wrap.innerHTML = tokens
        .map(
          (t, idx) =>
            `<span class="pill" data-bc-idx="${idx}" title="${t.label} (x로 해제)">${t.label} ✕</span>`
        )
        .join(" ");
      wrap.querySelectorAll("[data-bc-idx]").forEach((el) => {
        const idx = Number(el.getAttribute("data-bc-idx"));
        const t = tokens[idx];
        el.addEventListener("click", () => {
          if (t.type === "segment") spState.segment = "전체";
          if (t.type === "tier2024") spState.tier2024 = [];
          if (t.type === "qf") {
            if (t.key === "companyDir") spState.quickFilters.companyDir = "all";
            else if (t.key === "seed") spState.quickFilters.seed = "all";
            else if (t.key === "railShift") spState.quickFilters.railShift = "all";
            else spState.quickFilters[t.key] = false;
          }
          if (t.type === "pf") {
            if (t.key === "company") {
              spState.patternFilter.companyFrom = null;
              spState.patternFilter.companyTo = null;
            } else if (t.key === "cell") {
              spState.patternFilter.cell = null;
              spState.patternFilter.cellEvent = null;
            } else if (t.key === "rail") {
              spState.patternFilter.rail = null;
              spState.patternFilter.railDir = null;
            }
          }
          spState.page = 0;
          computeStatepathDerived();
          renderStatePathSnapshots();
          renderStatePathPatterns();
          renderStatePathTable();
          renderBreadcrumbs();
          renderTier2024Filter();
        });
      });
      updateStatepathFilterCountBadge();
    }


    function renderStatePathTable() {
      const status = document.getElementById("statepathStatus");
      const wrap = document.getElementById("statepathTableWrap");
      if (!status || !wrap) return;
      const spState = state.statepath2425;
      if (spState.loading) {
        status.textContent = "불러오는 중...";
        wrap.innerHTML = "";
        return;
      }
      if (spState.error) {
        status.textContent = `오류: ${spState.error}`;
        wrap.innerHTML = "";
        return;
      }
      status.textContent = "";
      const itemsAll = spState.filteredItems && spState.filteredItems.length ? spState.filteredItems : spState.items || [];
      const pageSize = spState.pageSize || 200;
      const currentPage = spState.page || 0;
      const totalPages = Math.max(1, Math.ceil(itemsAll.length / pageSize));
      const page = Math.min(currentPage, totalPages - 1);
      spState.page = page;
      const items = itemsAll.slice(page * pageSize, page * pageSize + pageSize);
      const exportDisabled = !itemsAll.length;
      const exportTooltip = exportDisabled ? "복사할 데이터가 없습니다." : getGlossaryShort("export.table");
      const viewTooltip = exportDisabled ? "복사할 데이터가 없습니다." : getGlossaryShort("export.table");
      const rows = items
        .map((row) => {
          const orgId = row.orgId || row.org_id;
          const orgName = row.orgName || row.org_name || orgId || "-";
          const seg = row.segment || row.sizeGroup || row.size_raw || row.sizeRaw || "-";
          const amt24 = row.companyTotalEok2024 ?? row.company_total_eok_2024 ?? 0;
          const amt25 = row.companyTotalEok2025 ?? row.company_total_eok_2025 ?? 0;
          const bucket24 = row.companyBucket2024 || row.company_bucket_2024 || "Ø";
          const bucket25 = row.companyBucket2025 || row.company_bucket_2025 || "Ø";
          const delta = row.deltaEok ?? row.delta_eok ?? 0;
          const meta = computePatternMeta(row);
          const eventLabels = buildMajorEventLabels(meta);
          const displayed = eventLabels.slice(0, 3);
          const rest = eventLabels.length - displayed.length;
          const eventsHtml = `
            ${displayed.map((t) => `<span class="badge">${t}</span>`).join(" ")}
            ${rest > 0 ? `<span class="badge">+${rest}</span>` : ""}
          `;
          return `
          <tr data-org-id="${orgId || ""}">
            <td><span class="org-link" style="cursor:pointer; color: var(--accent); text-decoration: underline;">${orgName}</span></td>
            <td>${seg}</td>
            <td>${formatEok(amt24)} <span class="badge">${bucket24}</span></td>
            <td>${formatEok(amt25)} <span class="badge">${bucket25}</span></td>
            <td>${formatEok(delta)}</td>
            <td>${eventsHtml}</td>
          </tr>`;
        })
        .join("");
      const tableHtml = items.length
        ? `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>회사명</th>
                <th>세그먼트</th>
                <th>2024</th>
                <th>2025</th>
                <th>Δ(억)</th>
                <th>주요 이벤트</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `
        : `<div class="muted">데이터가 없습니다.</div>`;
      wrap.innerHTML = `
        <div class="control-row" style="margin-bottom:8px;">
          <h3 style="margin:0;">Accounts Table</h3>
          <div class="spacer"></div>
          <button type="button" id="statepathExportViewBtn" ${exportDisabled ? "disabled" : ""} title="${viewTooltip}">JSON 보기</button>
          <button type="button" id="statepathExportCopyBtn" ${exportDisabled ? "disabled" : ""} title="${exportTooltip}">JSON 복사</button>
          ${renderStatePathHelpButton("export")}
        </div>
        ${tableHtml}
        <div class="control-row" style="margin-top:8px;">
          <div class="muted">페이지 ${page + 1} / ${totalPages}</div>
          <div class="spacer"></div>
          <button type="button" id="statepathPrevPage" ${page <= 0 ? "disabled" : ""} title="${getGlossaryLong("pagination")}">Prev</button>
          <button type="button" id="statepathNextPage" ${page >= totalPages - 1 ? "disabled" : ""} title="${getGlossaryLong("pagination")}">Next</button>
          ${renderStatePathHelpButton("pagination")}
        </div>
      `;
      wrap.querySelectorAll("tr[data-org-id]").forEach((tr) => {
        tr.addEventListener("click", () => {
          const orgId = tr.getAttribute("data-org-id");
          state.selectedOrg = orgId;
          loadStatePath(orgId);
        });
      });
      const prevBtn = document.getElementById("statepathPrevPage");
      const nextBtn = document.getElementById("statepathNextPage");
      if (prevBtn) {
        prevBtn.addEventListener("click", () => {
          if (spState.page > 0) {
            spState.page -= 1;
            renderStatePathTable();
          }
        });
      }
      if (nextBtn) {
        nextBtn.addEventListener("click", () => {
          if (spState.page < totalPages - 1) {
            spState.page += 1;
            renderStatePathTable();
          }
        });
      }
      const exportCopyBtn = document.getElementById("statepathExportCopyBtn");
      if (exportCopyBtn) {
        exportCopyBtn.addEventListener("click", async () => {
          const exportObj = buildStatePathTableExportObject();
          if (!exportObj.row_count) {
            showToast("복사할 데이터가 없습니다.", "warning");
            return;
          }
          if (exportObj.row_count > 2000) {
            showToast("건수가 많아 복사가 무거울 수 있습니다. 필터로 줄여주세요.", "warning");
          }
          await copyJsonData(exportObj, `JSON 복사 완료 (${exportObj.row_count}건)`);
        });
      }
      const exportViewBtn = document.getElementById("statepathExportViewBtn");
      if (exportViewBtn) {
        exportViewBtn.addEventListener("click", () => {
          const exportObj = buildStatePathTableExportObject();
          if (!exportObj.row_count) {
            showToast("표시할 JSON이 없습니다.", "warning");
            return;
          }
          openJsonModal("StatePath 24→25 표 JSON", exportObj);
        });
      }
      bindStatePathHelpButtons(wrap);
    }

    async function loadStatePathPortfolio2425(force = false) {
      const spState = state.statepath2425;
      spState.search = "";
      spState.sort = "won2025_desc";
      const key = buildStatepathPortfolioKey(spState.segment, spState.search, spState.sort, spState.limit);
      if (!force && cache.statepathPortfolioByKey.has(key)) {
        const cached = cache.statepathPortfolioByKey.get(key);
        spState.items = cached.items || [];
        spState.summary = cached.summary || null;
      spState.error = null;
      spState.loading = false;
      computeStatepathDerived();
      renderStatePathTable();
      renderStatePathSnapshots();
      renderStatePathPatterns();
      renderBreadcrumbs();
      return;
    }
      spState.loading = true;
      spState.error = null;
      renderStatePathTable();
      const params = new URLSearchParams();
      params.set("segment", spState.segment || "전체");
      params.set("sort", "won2025_desc");
      params.set("limit", String(spState.limit || 500));
      try {
        const data = await fetchJson(`/statepath/portfolio-2425?${params.toString()}`);
        const items = data.items || [];
        spState.items = items;
        spState.summary = data.summary || null;
        spState.error = null;
        cache.statepathPortfolioByKey.set(key, { items, summary: spState.summary });
      } catch (err) {
        spState.error = err.message;
      } finally {
        spState.loading = false;
        computeStatepathDerived();
        renderStatePathTable();
        renderStatePathSnapshots();
        renderStatePathPatterns();
        renderBreadcrumbs();
      }
    }

    function normalizeUpperOrg(val) {
      const text = (val || "").trim();
      return text || "미입력";
    }

    function normalizeUpperForDisplay(val) {
      const text = normalizeUpperOrg(val);
      return text === "미입력" ? "" : text;
    }

    function clampValue(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    function debounce(fn, wait = 80) {
      let t = null;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    let _metricResizeBound = false;
    const applyEqualMetricColWidthsDebounced = debounce(() => {
      const tableEl = document.getElementById("rankCounterpartyDriTable");
      applyEqualMetricColWidths(tableEl);
    }, 80);

    function bindMetricResizeOnce() {
      if (_metricResizeBound) return;
      _metricResizeBound = true;
      window.addEventListener("resize", applyEqualMetricColWidthsDebounced);
    }

    function applyEqualMetricColWidths(tableEl) {
      if (!tableEl) return;
      const wrapper = tableEl.closest(".table-scroll-x") || tableEl.parentElement;
      if (!wrapper) return;
      const metricCols = tableEl.querySelectorAll("colgroup col[data-metric='1']");
      const metricThs = tableEl.querySelectorAll("thead th[data-metric='1']");
      if (metricCols.length !== 6 || metricThs.length !== 6) return;
      const ths = tableEl.querySelectorAll("thead th");
      if (!ths.length) return;

      const containerW = wrapper.clientWidth || tableEl.clientWidth;
      let nonMetricW = 0;
      ths.forEach((th) => {
        if (th.getAttribute("data-metric") === "1") return;
        nonMetricW += th.offsetWidth;
      });

      const MIN_W = 84;
      const MAX_W = 160;
      const remaining = containerW - nonMetricW;
      const ideal = Math.floor(remaining / 6);
      const w = clampValue(ideal, MIN_W, MAX_W);

      const needMinTotal = nonMetricW + 6 * MIN_W;
      if (containerW < needMinTotal) {
        tableEl.style.minWidth = `${needMinTotal}px`;
      } else {
        tableEl.style.minWidth = "";
      }

      metricCols.forEach((col) => {
        col.style.width = `${w}px`;
      });
    }

    function buildSalesmapLink(type, id) {
      if (!id || !SALESMAP_WORKSPACE_PATH) return null;
      const base = `https://salesmap.kr/${SALESMAP_WORKSPACE_PATH.replace(/^\/+/, "").replace(/\/+$/, "")}`;
      if (type === "deal") return `${base}/deal/${encodeURIComponent(id)}`;
      if (type === "person") return `${base}/contact/people/${encodeURIComponent(id)}`;
      return null;
    }

    function normalizeMemoText(text) {
      if (!text) return "";
      return String(text || "")
        .replace(/<br\s*\/?>/gi, "\n")
        .replace(/\r\n?/g, "\n")
        .trim();
    }

    function escapeHtml(text) {
      return String(text || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function setBreadcrumb() {
      const orgName = state.orgs.find((o) => o.id === state.selectedOrg)?.name || "-";
      const personName = state.selectedPerson && state.people.find((p) => p.id === state.selectedPerson)?.name || "-";
      const dealName = state.selectedDeal && state.deals.find((d) => d.id === state.selectedDeal)?.name || "-";
      document.getElementById("crumb-org").textContent = orgName;
      document.getElementById("crumb-person").textContent = personName;
      document.getElementById("crumb-deal").textContent = dealName;
    }

    function renderOrgSelect() {
      const sel = document.getElementById("orgSelect");
      if (!sel) return;
      if (!state.orgs.length) {
        sel.innerHTML = '<option value="">해당 조건의 회사가 없습니다.</option>';
        return;
      }
      const options = ['<option value="">회사를 선택하세요</option>'];
      options.push(
        ...state.orgs.map(
          (o) =>
            `<option value="${o.id}" ${o.id === state.selectedOrg ? "selected" : ""}>${o.name || o.id}</option>`
        )
      );
      sel.innerHTML = options.join("");
      sel.value = state.selectedOrg || "";
      state.orgs.forEach((o) => {
        if (o.id) cache.orgLookup.set(o.id, o);
      });
      if (DEBUG_ORG_SELECT) {
        console.debug("[orgSelect] renderOrgSelect", {
          optionCount: state.orgs.length,
          selectedOrg: state.selectedOrg,
          selectValue: sel.value,
        });
      }
    }

    async function getSizes() {
      if (cache.sizes) return cache.sizes;
      const data = await fetchJson("/sizes");
      const sizes = Array.from(new Set(["전체", ...(data.sizes || [])]));
      cache.sizes = sizes;
      return sizes;
    }

    function updateStatePathButton() {
      const btn = document.getElementById("statePathBtn");
      if (!btn) return;
      btn.disabled = !state.selectedOrg;
    }

    async function loadSizes() {
      try {
        const sizes = await getSizes();
        const sel = document.getElementById("sizeSelect");
        sel.innerHTML = sizes.map((s) => `<option value="${s}">${s}</option>`).join("");
        if (!sizes.includes(state.size)) {
          state.size = sizes[0] || "전체";
        }
        sel.value = state.size;
      } catch (err) {
        cache.sizes = null;
        showToast(`규모 목록을 불러오지 못했습니다: ${err.message}`, "error");
      }
    }

    async function loadOrgs(offset = 0, preselectOrgId = null, fallbackOrg = null, allowFallback = true) {
      const search = document.getElementById("orgSearch").value.trim();
      state.orgSearch = search;
      const params = new URLSearchParams({
        size: state.size,
        limit: ORG_LIMIT.toString(),
        offset: offset.toString(),
      });
      if (search) params.set("search", search);
      document.getElementById("orgMemoHint").textContent = "회사 목록 불러오는 중...";
      try {
        const data = await fetchJson(`/orgs?${params.toString()}`);
        state.orgs = data.items || [];
        if (!state.orgs.length && allowFallback && state.size !== "전체" && !search) {
          // If no orgs for this size and no search, fall back to 전체 once
          state.size = "전체";
          const sizeSelectEl = document.getElementById("sizeSelect");
          if (sizeSelectEl) sizeSelectEl.value = state.size;
          showToast("해당 규모에 회사가 없습니다. 전체로 전환합니다.", "info");
          return await loadOrgs(offset, preselectOrgId, fallbackOrg, false);
        }
        const prev = preselectOrgId || state.selectedOrg;
        const stillExists = state.orgs.find((o) => o.id === prev);
        state.selectedOrg = stillExists ? prev : null;
        if (DEBUG_ORG_SELECT) {
          console.debug("[orgSelect] loadOrgs done", {
            count: state.orgs.length,
            prev,
            stillExists: Boolean(stillExists),
            selectedOrg: state.selectedOrg,
          });
        }
        renderOrgSelect();
        if (state.selectedOrg) {
          await loadOrgDetail(state.selectedOrg);
          showToast("선택한 회사를 불러왔습니다.", "success");
        } else if (preselectOrgId && fallbackOrg) {
          // insert fallback org to list and select
          state.orgs = [fallbackOrg];
          renderOrgSelect();
          state.selectedOrg = fallbackOrg.id;
          document.getElementById("orgSelect").value = fallbackOrg.id;
          await loadOrgDetail(fallbackOrg.id);
          showToast("선택한 회사를 불러왔습니다.", "success");
        } else {
          clearOrgViews();
          if (preselectOrgId) {
            showToast("해당 회사를 찾을 수 없습니다.", "error");
          }
        }
      } catch (err) {
        showToast(`회사 목록 오류: ${err.message}`, "error");
        clearOrgViews();
        if (DEBUG_ORG_SELECT) {
          console.debug("[orgSelect] loadOrgs error", err);
        }
      }
      setBreadcrumb();
    }

    function clearOrgViews() {
      state.selectedUpperOrg = null;
      state.selectedPerson = null;
      state.selectedDeal = null;
      state.people = [];
      state.deals = [];
      state.orgMemos = [];
      state.personMemos = [];
      state.dealMemos = [];
      state.wonSummary = [];
      state.wonGroupJson = null;
      state.wonGroupJsonCompact = null;
      state.filteredWonGroupJson = null;
      state.filteredWonGroupJsonCompact = null;
      state.statePath = null;
      updateStatePathButton();
      renderOrgMemos([]);
      renderWonSummary([]);
      renderWonGroupJsonAll(null);
      renderWonGroupJsonFiltered(null);
      renderWonGroupJsonAllCompact(null);
      renderWonGroupJsonFilteredCompact(null);
      renderUpperOrgSection();
    }

    async function loadOrgDetail(orgId) {
      if (DEBUG_ORG_SELECT) console.debug("[orgSelect] loadOrgDetail start", orgId);
      state.selectedOrg = orgId;
      state.selectedUpperOrg = null;
      state.selectedPerson = null;
      state.selectedDeal = null;
      state.deals = [];
      state.personMemos = [];
      state.dealMemos = [];
      state.wonGroupJson = null;
      state.wonGroupJsonCompact = null;
      state.statePath = null;
      state.filteredWonGroupJson = null;
      state.filteredWonGroupJsonCompact = null;
      setBreadcrumb();
      renderWonGroupJsonAll(null);
      renderWonGroupJsonFiltered(null);
      renderWonGroupJsonAllCompact(null);
      renderWonGroupJsonFilteredCompact(null);

      const memoPromise = cache.orgMemos.get(orgId)
        ? Promise.resolve(cache.orgMemos.get(orgId))
        : fetchJson(`/orgs/${orgId}/memos`).then((d) => d.items || []);

      const peoplePromise = cache.peopleByOrg.get(orgId)
        ? Promise.resolve(cache.peopleByOrg.get(orgId))
        : fetchJson(`/orgs/${orgId}/people`).then((d) => d.items || []);

      const wonSummaryPromise = cache.wonSummary.get(orgId)
        ? Promise.resolve(cache.wonSummary.get(orgId))
        : fetchJson(`/orgs/${orgId}/won-summary`).then((d) => d.items || []);

      try {
        // 메모/People/Won 요약을 모두 병렬로 가져와 상위 조직 테이블과 People/Deal 섹션을 채운다.
        const [memos, peopleList, wonSummary] = await Promise.all([
          memoPromise,
          peoplePromise,
          wonSummaryPromise,
        ]);
        cache.orgMemos.set(orgId, memos);
        cache.peopleByOrg.set(orgId, peopleList);
        cache.wonSummary.set(orgId, wonSummary || []);

        state.orgMemos = memos;
        state.people = peopleList || [];
        state.wonSummary = wonSummary || [];
        updateStatePathButton();

        renderOrgMemos(memos);
        renderWonSummary(state.wonSummary);
        renderUpperOrgSection();
        setBreadcrumb();
        await loadWonGroupJson(orgId);
      } catch (err) {
        showToast(`회사 데이터 로드 오류: ${err.message}`, "error");
        clearOrgViews();
        if (DEBUG_ORG_SELECT) console.debug("[orgSelect] loadOrgDetail error", err);
      }
    }

    function renderWonSummary(summary) {
      const card = document.getElementById("wonSummaryCard");
      const table = document.getElementById("wonSummaryTable");
      const hint = document.getElementById("wonSummaryHint");
      if (!card || !table || !hint) return;

      if (!state.selectedOrg) {
        card.style.display = "none";
        table.innerHTML = "";
        hint.textContent = "";
        return;
      }

       if (state.wonSummaryCleared) {
        card.style.display = "";
        table.innerHTML = "";
        hint.textContent = "상위 조직을 선택하세요.";
        state.wonSummaryCleared = false;
        return;
      }

      if (!summary || !summary.length) {
        card.style.display = "";
        hint.textContent = "Won 딜이 없습니다.";
        table.innerHTML = "";
        return;
      }

      card.style.display = "";
      hint.textContent = "";

      const rowsHtml = summary
        .map((row) => {
          const contacts = (row.contacts || []).length ? row.contacts.join("<br>") : "-";
          const owners = (row.owners || []).length ? row.owners.join("<br>") : "-";
          const owners2025 = Array.isArray(row.owners2025) ? row.owners2025 : [];
          const ownerTeamPart = computeTeamPartSummary(owners2025);
          const fmt = (val) => formatAmount(val);
          const upper = row.upper_org || "미입력";
          return `
            <tr data-upper="${upper}">
              <td>${upper}</td>
              <td>${fmt(row.won2023)}</td>
              <td>${fmt(row.won2024)}</td>
              <td>${fmt(row.won2025)}</td>
              <td>${contacts}</td>
              <td>${owners}</td>
              <td>${ownerTeamPart.ownersText}</td>
              <td>${ownerTeamPart.teamPartText}</td>
              <td>${ownerTeamPart.dri}</td>
            </tr>
          `;
        })
        .join("");

      table.innerHTML = `
        <thead>
          <tr>
            <th>소속 상위 조직</th>
            <th>2023 Won(억)</th>
            <th>2024 Won(억)</th>
            <th>2025 Won(억)</th>
            <th>고객사 담당자 (팀/이름/직급/교육)</th>
            <th>데이원 담당자</th>
            <th>2025 담당자</th>
            <th>팀&파트</th>
            <th>DRI 가능</th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
      `;
      table.querySelectorAll("tbody tr").forEach((tr) => {
        const upper = tr.getAttribute("data-upper");
        if (upper && state.selectedUpperOrg === upper) {
          tr.classList.add("active");
        }
        tr.addEventListener("click", () => {
          state.selectedUpperOrg = upper;
          state.selectedPerson = null;
          state.selectedDeal = null;
          state.deals = [];
          state.personMemos = [];
          state.dealMemos = [];
          state.filteredWonGroupJson = filterWonGroupByUpper(state.wonGroupJson, upper);
          state.filteredWonGroupJsonCompact = filterWonGroupByUpper(state.wonGroupJsonCompact, upper);
          renderWonSummary(summary);
          renderWonGroupJsonFiltered(state.filteredWonGroupJson);
          renderWonGroupJsonFilteredCompact(state.filteredWonGroupJsonCompact);
          autoSelectFirstPersonForUpperOrg();
        });
      });
    }

    async function autoSelectFirstPersonForUpperOrg() {
      const peopleList = filterPeopleByUpperOrg();
      if (!peopleList.length) {
        state.selectedPerson = null;
        state.selectedDeal = null;
        state.deals = [];
        state.personMemos = [];
        state.dealMemos = [];
        renderUpperOrgSection();
        setBreadcrumb();
        return;
      }
      const first = peopleList[0];
      const personChanged = state.selectedPerson !== first.id;
      state.selectedPerson = first.id;
      state.selectedDeal = null;
      state.deals = [];
      state.personMemos = [];
      state.dealMemos = [];
      renderUpperOrgSection();
      setBreadcrumb();
      if (personChanged) {
        // Load person memos and deals (which will auto-select first deal and load its memos).
        await Promise.all([
          loadPersonMemos(first.id),
          loadDealsForPerson(first.id),
        ]);
      } else if (state.selectedDeal) {
        await loadDealMemos(state.selectedDeal);
      }
    }

    function filterWonGroupByUpper(data, upper) {
      if (!data || !upper) return null;
      const filtered = (data.groups || []).filter((g) => g.upper_org === upper);
      return {
        ...data,
        groups: filtered,
      };
    }

    function renderWonGroupJsonAll(data) {
      const hint = document.getElementById("wonGroupJsonHintAll");
      const viewBtn = document.getElementById("viewWonGroupJsonAllBtn");
      const copyBtn = document.getElementById("copyWonGroupJsonAllBtn");
      if (!hint || !viewBtn || !copyBtn) return;

      if (!state.selectedOrg) {
        hint.textContent = "회사를 선택하세요.";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      if (!data) {
        hint.textContent = "불러오는 중...";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      const groups = data.groups || [];
      hint.textContent = groups.length ? "" : "23/24/25 Won 딜이 있는 상위 조직이 없습니다.";
      viewBtn.disabled = false;
      copyBtn.disabled = false;
    }

    function renderWonGroupJsonAllCompact(data) {
      const hint = document.getElementById("wonGroupJsonHintAll");
      const viewBtn = document.getElementById("viewWonGroupJsonAllCompactBtn");
      const copyBtn = document.getElementById("copyWonGroupJsonAllCompactBtn");
      if (!hint || !viewBtn || !copyBtn) return;

      if (!state.selectedOrg) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      if (!data) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      const groups = data.groups || [];
      viewBtn.disabled = groups.length === 0;
      copyBtn.disabled = groups.length === 0;
    }

    function renderWonGroupJsonFiltered(data) {
      const hint = document.getElementById("wonGroupJsonHintFiltered");
      const viewBtn = document.getElementById("viewWonGroupJsonFilteredBtn");
      const copyBtn = document.getElementById("copyWonGroupJsonFilteredBtn");
      const label = document.getElementById("wonGroupJsonSelectedUpper");
      if (!hint || !viewBtn || !copyBtn) return;

      if (!state.selectedOrg) {
        hint.textContent = "회사를 선택하세요.";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        if (label) label.textContent = "";
        return;
      }
      if (!state.selectedUpperOrg) {
        hint.textContent = "아래 표에서 소속 상위 조직을 선택해주세요.";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        if (label) label.textContent = "";
        return;
      }
      if (!data) {
        hint.textContent = "불러오는 중...";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        if (label) label.textContent = `선택된 상위 조직: ${state.selectedUpperOrg}`;
        return;
      }
      const groups = data.groups || [];
      hint.textContent = groups.length ? "" : "선택한 상위 조직의 Won 딜이 없습니다.";
      viewBtn.disabled = groups.length === 0;
      copyBtn.disabled = groups.length === 0;
      if (label) label.textContent = `선택된 상위 조직: ${state.selectedUpperOrg}`;
    }

    function renderWonGroupJsonFilteredCompact(data) {
      const viewBtn = document.getElementById("viewWonGroupJsonFilteredCompactBtn");
      const copyBtn = document.getElementById("copyWonGroupJsonFilteredCompactBtn");
      const hint = document.getElementById("wonGroupJsonHintFiltered");
      const label = document.getElementById("wonGroupJsonSelectedUpper");
      if (!viewBtn || !copyBtn) return;

      if (!state.selectedOrg) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      if (!state.selectedUpperOrg) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      if (!data) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        if (label) label.textContent = `선택된 상위 조직: ${state.selectedUpperOrg}`;
        if (hint) hint.textContent = "불러오는 중...";
        return;
      }
      const groups = data.groups || [];
      const disabled = groups.length === 0;
      viewBtn.disabled = disabled;
      copyBtn.disabled = disabled;
    }

    async function loadWonGroupJson(orgId) {
      const card = document.getElementById("wonGroupJsonCardCombined");
      if (!card) return;
      if (!orgId) {
        state.wonGroupJson = null;
        state.wonGroupJsonCompact = null;
        state.filteredWonGroupJson = null;
        state.filteredWonGroupJsonCompact = null;
        renderWonGroupJsonAll(null);
        renderWonGroupJsonFiltered(null);
        renderWonGroupJsonAllCompact(null);
        renderWonGroupJsonFilteredCompact(null);
        return;
      }
      const cached = cache.wonGroupJsonByOrg.get(orgId);
      const cachedCompact = cache.wonGroupJsonCompactByOrg.get(orgId);
      state.wonGroupJson = null;
      state.wonGroupJsonCompact = null;
      state.filteredWonGroupJson = null;
      state.filteredWonGroupJsonCompact = null;
      renderWonGroupJsonAll(null);
      renderWonGroupJsonFiltered(null);
      renderWonGroupJsonAllCompact(null);
      renderWonGroupJsonFilteredCompact(null);
      try {
        const [rawRes, compactRes] = await Promise.allSettled([
          cached ? Promise.resolve(cached) : fetchJson(`/orgs/${orgId}/won-groups-json`),
          cachedCompact ? Promise.resolve(cachedCompact) : fetchJson(`/orgs/${orgId}/won-groups-json-compact`),
        ]);

        if (rawRes.status === "fulfilled") {
          const raw = rawRes.value;
          cache.wonGroupJsonByOrg.set(orgId, raw);
          state.wonGroupJson = raw;
          state.filteredWonGroupJson = filterWonGroupByUpper(raw, state.selectedUpperOrg);
          renderWonGroupJsonAll(raw);
          renderWonGroupJsonFiltered(state.filteredWonGroupJson);
        } else {
          throw rawRes.reason;
        }

        if (compactRes.status === "fulfilled") {
          const compact = compactRes.value;
          cache.wonGroupJsonCompactByOrg.set(orgId, compact);
          state.wonGroupJsonCompact = compact;
          state.filteredWonGroupJsonCompact = filterWonGroupByUpper(compact, state.selectedUpperOrg);
          renderWonGroupJsonAllCompact(compact);
          renderWonGroupJsonFilteredCompact(state.filteredWonGroupJsonCompact);
        } else {
          showToast(`간소화 JSON 오류: ${compactRes.reason?.message || compactRes.reason}`, "error");
        }

        renderUpperOrgSection();
      } catch (err) {
        showToast(`상위 조직 JSON 오류: ${err.message}`, "error");
        state.wonGroupJson = null;
        state.wonGroupJsonCompact = null;
        state.filteredWonGroupJson = null;
        state.filteredWonGroupJsonCompact = null;
        const hintAll = document.getElementById("wonGroupJsonHintAll");
        const hintFiltered = document.getElementById("wonGroupJsonHintFiltered");
        const buttons = [
          document.getElementById("viewWonGroupJsonAllBtn"),
          document.getElementById("copyWonGroupJsonAllBtn"),
          document.getElementById("viewWonGroupJsonFilteredBtn"),
          document.getElementById("copyWonGroupJsonFilteredBtn"),
          document.getElementById("viewWonGroupJsonAllCompactBtn"),
          document.getElementById("copyWonGroupJsonAllCompactBtn"),
          document.getElementById("viewWonGroupJsonFilteredCompactBtn"),
          document.getElementById("copyWonGroupJsonFilteredCompactBtn"),
        ];
        if (hintAll) hintAll.textContent = "오류가 발생했습니다.";
        if (hintFiltered) hintFiltered.textContent = "오류가 발생했습니다.";
        buttons.forEach((btn) => {
          if (btn) btn.disabled = true;
        });
      }
    }

    async function loadStatePath(orgId) {
      if (!orgId) {
        showToast("회사를 선택하세요.", "info");
        return;
      }
      const btn = document.getElementById("statePathBtn");
      if (btn) btn.disabled = true;
      try {
        const cached = cache.statePathByOrg.get(orgId);
        if (cached) {
          state.statePath = cached;
          openStatePathModal(cached);
          return;
        }
        const data = await fetchJson(`/orgs/${orgId}/statepath`);
        const item = data.item || data;
        cache.statePathByOrg.set(orgId, item);
        state.statePath = item;
        openStatePathModal(item);
      } catch (err) {
        showToast(`StatePath 로드 오류: ${err.message}`, "error");
      } finally {
        updateStatePathButton();
      }
    }

    function renderOrgMemos(memos) {
      const hint = document.getElementById("orgMemoHint");
      const table = document.getElementById("orgMemoTable");
      const card = document.getElementById("orgMemoCard");
      const status = document.getElementById("orgMemoStatus");
      if (!card || !table || !hint || !status) return; // DOM이 없으면 아무 것도 하지 않는다.
      status.textContent = memos.length ? `${memos.length}건` : "";
      if (!state.selectedOrg) {
        card.style.display = "none";
        hint.textContent = "";
        table.innerHTML = "";
        return;
      }
      if (!memos.length) {
        card.style.display = "none";
        hint.textContent = "";
        table.innerHTML = "";
        return;
      }
      card.style.display = "";
      hint.textContent = "";
      table.innerHTML = `
        <thead><tr><th>작성일</th><th>작성자</th><th>본문</th></tr></thead>
        <tbody>
          ${memos
            .map((m) => {
              const body = normalizeMemoText(m.text);
              const preview = body.slice(0, 140);
              return `<tr><td>${formatDate(m.createdAt)}</td><td>${m.ownerName || m.ownerId || "-"}</td><td class="memo-text" title="${body}">${preview}${body.length > 140 ? "…" : ""
                }</td></tr>`;
            })
            .join("")}
        </tbody>
      `;
      attachMemoRowClicks("orgMemoTable", memos);
    }

    function filterPeopleByUpperOrg() {
      if (!state.selectedUpperOrg) return [];
      return (state.people || []).filter(
        (p) => normalizeUpperOrg(p.upper_org) === state.selectedUpperOrg
      );
    }

    function renderUpperOrgSection() {
      const label = document.getElementById("upperOrgLabel");
      if (label) {
        label.textContent = state.selectedUpperOrg
          ? `소속 상위 조직: ${state.selectedUpperOrg}`
          : "상위 조직을 선택하세요.";
      }
      const peopleList = filterPeopleByUpperOrg();
      renderPeople(peopleList);
      renderDeals(state.deals);
      renderMemoTable("personMemoTable", "personMemos", Boolean(state.selectedPerson));
      renderMemoTable("dealMemoTable", "dealMemos", Boolean(state.selectedDeal));
    }

    function renderPeople(list) {
      const table = document.getElementById("peopleTable");
      const hint = document.getElementById("peopleHint");
      const countBadge = document.getElementById("peopleCount");
      if (!table || !hint || !countBadge) return;

      countBadge.textContent = list.length;
      if (!state.selectedOrg) {
        table.innerHTML = "";
        hint.textContent = "회사를 선택하세요.";
        return;
      }
      if (!state.selectedUpperOrg) {
        table.innerHTML = "";
        hint.textContent = "상위 조직을 선택하세요.";
        return;
      }
      if (!list.length) {
        table.innerHTML = "";
        hint.textContent = "사람이 없습니다.";
        return;
      }
      hint.textContent = "";
      table.innerHTML = `<thead><tr>
        <th>이름</th>
        <th>소속 상위 조직</th>
        <th>팀(명함/메일서명)</th>
        <th>직급(명함/메일서명)</th>
        <th>담당 교육 영역</th>
        <th>웹폼 내역</th>
      </tr></thead>`;
      const tbody = document.createElement("tbody");
      list.forEach((p) => {
        const tr = document.createElement("tr");
        if (state.selectedPerson === p.id) tr.classList.add("active");
        const personLink = buildSalesmapLink("person", p.id);
        const nameCell = personLink
          ? `<a href="${personLink}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: underline;">${p.name || "-"}</a>`
          : `${p.name || "-"}`;
        const webforms = getWebformsForPerson(p.id);
        const hasWebforms = Array.isArray(webforms) && webforms.length > 0;
        tr.innerHTML = `
          <td>${nameCell}</td>
          <td>${p.upper_org || "-"}</td>
          <td>${p.team_signature || "-"}</td>
          <td>${p.title_signature || "-"}</td>
          <td>${p.edu_area || "-"}</td>
          <td><button type="button" class="webform-btn" ${hasWebforms ? "" : "disabled"}>${hasWebforms ? "내역 확인" : "없음"}</button></td>
        `;
        tr.addEventListener("click", () => {
          state.selectedPerson = p.id;
          state.selectedDeal = null;
          state.deals = [];
          state.personMemos = [];
          state.dealMemos = [];
          renderPeople(list);
          renderDeals([]);
          renderMemoTable("personMemoTable", "personMemos", true);
          renderMemoTable("dealMemoTable", "dealMemos", false);
          loadDealsForPerson(p.id);
          loadPersonMemos(p.id);
          setBreadcrumb();
        });
        const wfBtn = tr.querySelector(".webform-btn");
        if (wfBtn) {
          wfBtn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            if (!hasWebforms) {
              showToast("웹폼 내역이 없습니다.", "info");
              return;
            }
            openWebformModal(p.name || "-", webforms);
          });
        }
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    async function loadDealsForPerson(personId) {
      const cacheHit = cache.deals.get(personId);
      const promise = cacheHit
        ? Promise.resolve(cacheHit)
        : fetchJson(`/people/${personId}/deals`).then((d) => d.items || []);
      try {
        const deals = await promise;
        cache.deals.set(personId, deals);
        state.deals = deals;
        state.selectedDeal = deals[0]?.id || null;
        renderDeals(deals);
        if (state.selectedDeal) {
          await loadDealMemos(state.selectedDeal);
        } else {
          renderMemoTable("dealMemoTable", "dealMemos", false);
        }
      } catch (err) {
        showToast(`딜 조회 오류: ${err.message}`, "error");
        state.deals = [];
        state.selectedDeal = null;
        renderDeals([]);
        renderMemoTable("dealMemoTable", "dealMemos", false);
      }
      setBreadcrumb();
    }

    function renderDeals(list) {
      const table = document.getElementById("dealTable");
      const hint = document.getElementById("dealHint");
      if (!table || !hint) return;

      if (!state.selectedOrg) {
        table.innerHTML = "";
        hint.textContent = "회사를 선택하세요.";
        return;
      }
      if (!state.selectedUpperOrg) {
        table.innerHTML = "";
        hint.textContent = "상위 조직을 선택하세요.";
        return;
      }
      if (!state.selectedPerson) {
        table.innerHTML = "";
        hint.textContent = "사람을 선택하세요.";
        return;
      }
      if (!list.length) {
        table.innerHTML = "";
        hint.textContent = "딜이 없습니다.";
        return;
      }
      hint.textContent = "";
      table.innerHTML = `<thead><tr><th>생성일</th><th>이름</th><th>상태</th><th>금액(억)</th><th>예상 체결액(억)</th><th>계약 체결일</th><th>담당자</th></tr></thead>`;
      const tbody = document.createElement("tbody");
      list.forEach((d) => {
        const tr = document.createElement("tr");
        if (state.selectedDeal === d.id) tr.classList.add("active");
        const dealLink = buildSalesmapLink("deal", d.id);
        const dealNameCell = dealLink
          ? `<a href="${dealLink}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: underline;">${d.name || "-"}</a>`
          : `${d.name || "-"}`;
        tr.innerHTML = `
          <td>${formatDate(d.created_at)}</td>
          <td>${dealNameCell}</td>
          <td>${d.status || "-"}</td>
          <td>${formatAmount(d.amount)}</td>
          <td>${formatAmount(d.expected_amount)}</td>
          <td>${formatDate(d.contract_date)}</td>
          <td>${d.ownerName || "-"}</td>
        `;
        tr.addEventListener("click", async () => {
          state.selectedDeal = d.id;
          renderDeals(list);
          await loadDealMemos(d.id);
          setBreadcrumb();
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    async function loadPersonMemos(personId) {
      const cacheHit = cache.personMemos.get(personId);
      const promise = cacheHit
        ? Promise.resolve(cacheHit)
        : fetchJson(`/people/${personId}/memos`).then((d) => d.items || []);
      try {
        const memos = await promise;
        cache.personMemos.set(personId, memos);
        state.personMemos = memos;
        renderMemoTable("personMemoTable", "personMemos", true);
      } catch (err) {
        showToast(`People 메모 오류: ${err.message}`, "error");
      }
    }

    async function loadDealMemos(dealId) {
      const cacheHit = cache.dealMemos.get(dealId);
      const promise = cacheHit ? Promise.resolve(cacheHit) : fetchJson(`/deals/${dealId}/memos`).then((d) => d.items || []);
      try {
        const memos = await promise;
        cache.dealMemos.set(dealId, memos);
        state.dealMemos = memos;
        renderMemoTable("dealMemoTable", "dealMemos", true);
      } catch (err) {
        showToast(`Deal 메모 오류: ${err.message}`, "error");
      }
    }

    function renderMemoTable(tableId, memoKey, hasSelection) {
      const table = document.getElementById(tableId);
      const memoList = state[memoKey] || [];
      if (!table) return;
      if (!hasSelection) {
        table.innerHTML = "";
        return;
      }
      if (!memoList.length) {
        table.innerHTML = `<tbody><tr><td class="muted">메모가 없습니다.</td></tr></tbody>`;
        return;
      }
      table.innerHTML = `
        <thead><tr><th>작성일</th><th>작성자</th><th>본문</th></tr></thead>
        <tbody>
          ${memoList
            .map(
              (m) => {
                const body = normalizeMemoText(m.text);
                const preview = body.slice(0, 120);
                return `<tr><td>${formatDate(m.createdAt)}</td><td>${m.ownerName || m.ownerId || "-"}</td><td class="memo-text" title="${body}">${preview}${body.length > 120 ? "…" : ""
                  }</td></tr>`;
              }
            )
            .join("")}
        </tbody>
      `;
      attachMemoRowClicks(tableId, memoList);
    }

    function getDefaultSize() {
      if (cache.sizes && cache.sizes.length) {
        if (cache.sizes.includes("대기업")) return "대기업";
        return cache.sizes[0];
      }
      return "대기업";
    }

    async function resetSelection() {
      state.orgSearch = "";
      const defaultSize = getDefaultSize();
      state.size = defaultSize;
      state.selectedOrg = null;
      state.selectedUpperOrg = null;
      state.selectedPerson = null;
      state.selectedDeal = null;
      state.orgs = [];
      state.orgMemos = [];
      state.people = [];
      state.deals = [];
      state.personMemos = [];
      state.dealMemos = [];
      state.wonSummary = [];
      state.statePath = null;
      state.filteredWonGroupJson = null;
      state.wonGroupJson = null;
      state.wonSummaryCleared = true;

      const searchInput = document.getElementById("orgSearch");
      if (searchInput) searchInput.value = "";
      const sizeSelect = document.getElementById("sizeSelect");
      if (sizeSelect) sizeSelect.value = defaultSize;
      const orgSelect = document.getElementById("orgSelect");
      if (orgSelect) orgSelect.value = "";

      clearOrgViews();
      setBreadcrumb();
      updateStatePathButton();
      await loadOrgs(0);
      state.wonSummaryCleared = false;
    }

    async function initOrgScreen() {
      bindGlobalModalsOnce();
      document.getElementById("apiBaseLabel").textContent = API_BASE;
      updateStatePathButton();
      document.getElementById("sizeSelect").addEventListener("change", async (e) => {
        state.size = e.target.value;
        await loadOrgs(0);
      });
      document.getElementById("orgSearchBtn").addEventListener("click", () => loadOrgs(0));
      document.getElementById("orgSearch").addEventListener("keypress", (e) => {
        if (e.key === "Enter") loadOrgs(0);
      });
      document.getElementById("orgSelect").addEventListener("change", async (e) => {
        const val = e.target.value;
        if (DEBUG_ORG_SELECT) console.debug("[orgSelect] change", { val });
        if (!val) {
          state.selectedOrg = null;
          state.statePath = null;
          clearOrgViews();
          setBreadcrumb();
          updateStatePathButton();
          return;
        }
        try {
          await loadOrgDetail(val);
        } catch (err) {
          showToast(`회사 로드 오류: ${err.message}`, "error");
          if (DEBUG_ORG_SELECT) console.debug("[orgSelect] change error", err);
        }
      });
      document.getElementById("orgSelect").addEventListener("click", (e) => {
        if (DEBUG_ORG_SELECT) {
          const val = e.target.value;
          console.debug("[orgSelect] click", { val, optionCount: state.orgs.length });
        }
      });
      document.getElementById("resetBtn").addEventListener("click", () => resetSelection());
      document.getElementById("statePathBtn").addEventListener("click", () => loadStatePath(state.selectedOrg));
      const viewAll = document.getElementById("viewWonGroupJsonAllBtn");
      const copyAll = document.getElementById("copyWonGroupJsonAllBtn");
      const viewFiltered = document.getElementById("viewWonGroupJsonFilteredBtn");
      const copyFiltered = document.getElementById("copyWonGroupJsonFilteredBtn");
      const viewAllCompact = document.getElementById("viewWonGroupJsonAllCompactBtn");
      const copyAllCompact = document.getElementById("copyWonGroupJsonAllCompactBtn");
      const viewFilteredCompact = document.getElementById("viewWonGroupJsonFilteredCompactBtn");
      const copyFilteredCompact = document.getElementById("copyWonGroupJsonFilteredCompactBtn");
      if (viewAll) viewAll.addEventListener("click", () => openJsonModal("상위 조직별 JSON (전체)", state.wonGroupJson));
      if (copyAll) copyAll.addEventListener("click", () => copyJsonData(state.wonGroupJson));
      if (viewFiltered) viewFiltered.addEventListener("click", () => openJsonModal("선택 상위 조직 JSON", state.filteredWonGroupJson));
      if (copyFiltered) copyFiltered.addEventListener("click", () => copyJsonData(state.filteredWonGroupJson));
      if (viewAllCompact) viewAllCompact.addEventListener("click", () => openJsonModal("상위 조직별 간소화 JSON (전체)", state.wonGroupJsonCompact));
      if (copyAllCompact) copyAllCompact.addEventListener("click", () => copyJsonData(state.wonGroupJsonCompact));
      if (viewFilteredCompact) viewFilteredCompact.addEventListener("click", () => openJsonModal("선택 상위 조직 간소화 JSON", state.filteredWonGroupJsonCompact));
      if (copyFilteredCompact) copyFilteredCompact.addEventListener("click", () => copyJsonData(state.filteredWonGroupJsonCompact));
      await loadSizes();
      const sizeSelect = document.getElementById("sizeSelect");
      if (sizeSelect) sizeSelect.value = state.size;
      const searchInput = document.getElementById("orgSearch");
      if (searchInput) searchInput.value = state.orgSearch || "";

      if (state.pendingOrgId) {
        await loadOrgs(0, state.pendingOrgId, state.pendingOrgFallback || undefined);
        state.pendingOrgId = null;
        state.pendingOrgFallback = null;
      } else {
        await loadOrgs(0);
      }
      setBreadcrumb();
    }

    async function renderOrgScreen(contentRoot) {
      contentRoot.innerHTML = `
        <header>
          <div class="control-row">
            <h1>조직/People/Deal 빠른 뷰어 (FastAPI)</h1>
            <div class="spacer"></div>
            <span class="pill">API: <span id="apiBaseLabel"></span></span>
          </div>
          <div class="control-row">
            <label class="muted">기업 규모</label>
            <select id="sizeSelect"></select>
            <label class="muted">회사 검색</label>
            <input id="orgSearch" type="text" placeholder="이름 또는 ID 검색 (상위 200건)" />
            <button id="orgSearchBtn" type="button">검색/새로고침</button>
            <label class="muted">회사</label>
            <select id="orgSelect"></select>
            <button id="resetBtn" type="button">선택 초기화</button>
            <button id="statePathBtn" type="button">StatePath 보기</button>
          </div>
        </header>

        <section class="card" id="wonGroupJsonCardCombined">
          <div class="control-row">
            <h2>상위 조직별 JSON</h2>
            <div class="spacer"></div>
            <span class="muted">좌: 전체 / 우: 선택 상위 조직</span>
          </div>
          <div class="json-grid">
            <div class="json-box">
              <div class="control-row">
                <h3 class="muted">전체</h3>
                <div class="spacer"></div>
                <button id="viewWonGroupJsonAllBtn" type="button">JSON 확인</button>
                <button id="copyWonGroupJsonAllBtn" type="button">JSON 복사</button>
                <button id="viewWonGroupJsonAllCompactBtn" type="button">간소화 JSON</button>
                <button id="copyWonGroupJsonAllCompactBtn" type="button">간소화 ver 복사</button>
              </div>
              <div class="muted" id="wonGroupJsonHintAll">회사를 선택하세요.</div>
            </div>
            <div class="json-box">
              <div class="control-row">
                <h3 class="muted">선택 상위 조직</h3>
                <div class="spacer"></div>
                <button id="viewWonGroupJsonFilteredBtn" type="button">JSON 확인</button>
                <button id="copyWonGroupJsonFilteredBtn" type="button">JSON 복사</button>
                <button id="viewWonGroupJsonFilteredCompactBtn" type="button">간소화 JSON</button>
                <button id="copyWonGroupJsonFilteredCompactBtn" type="button">간소화 ver 복사</button>
              </div>
              <div class="muted" id="wonGroupJsonSelectedUpper"></div>
              <div class="muted" id="wonGroupJsonHintFiltered">상위 조직을 선택하세요.</div>
            </div>
          </div>
        </section>

        <div class="breadcrumb" id="breadcrumb">
          <span>경로:</span>
          <span id="crumb-org">-</span>
          <span>›</span>
          <span id="crumb-person">-</span>
          <span>›</span>
          <span id="crumb-deal">-</span>
        </div>

        <section class="card" id="wonSummaryCard" style="display:none;">
          <h2>상위 조직별 Won 합계 (23/24/25)</h2>
          <div class="muted" id="wonSummaryHint">회사를 선택하세요.</div>
          <div class="table-wrap full">
            <table id="wonSummaryTable"></table>
          </div>
        </section>

        <section class="card" id="orgMemoCard">
          <h2>회사 메모 <span class="muted" id="orgMemoStatus"></span></h2>
          <div class="muted" id="orgMemoHint">회사를 선택하세요.</div>
          <div class="table-wrap full">
            <table id="orgMemoTable"></table>
          </div>
        </section>

        <main class="main-vertical">
          <section class="card">
            <div class="control-row">
              <h2>상위 조직 People/Deal</h2>
              <div class="spacer"></div>
              <span class="badge" id="peopleCount">0</span>
              <span class="muted" id="upperOrgLabel">상위 조직을 선택하세요.</span>
            </div>
            <div class="quad-grid">
              <div class="table-wrap">
                <div class="muted" id="peopleHint">회사를 선택하세요.</div>
                <table id="peopleTable"></table>
              </div>
              <div class="table-wrap">
                <div class="muted" id="dealHint">사람을 선택하세요.</div>
                <table id="dealTable"></table>
              </div>
              <div class="table-wrap">
                <table id="personMemoTable"></table>
              </div>
              <div class="table-wrap">
                <table id="dealMemoTable"></table>
              </div>
            </div>
          </section>
        </main>
      `;

      await initOrgScreen();
    }

    async function loadDealCheck(teamKey) {
      const cfg = DEALCHECK_TEAMS[teamKey];
      if (!cfg) throw new Error("Unknown teamKey: " + teamKey);
      if (cache.dealCheck[teamKey]) {
        state.dealCheck[teamKey].loading = false;
        state.dealCheck[teamKey].error = null;
        state.dealCheck[teamKey].items = cache.dealCheck[teamKey];
        return cache.dealCheck[teamKey];
      }
      state.dealCheck[teamKey].loading = true;
      try {
        const res = await fetch(`${API_BASE}${cfg.apiPath}`);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const data = await res.json();
        const items = data.items || [];
        cache.dealCheck[teamKey] = items;
        state.dealCheck[teamKey].items = items;
        state.dealCheck[teamKey].error = null;
        return items;
      } catch (e) {
        state.dealCheck[teamKey].error = String(e);
        showToast(`${cfg.label} 로드 오류: ${e}`, "error");
        return [];
      } finally {
        state.dealCheck[teamKey].loading = false;
      }
    }

    function bindGlobalModalsOnce() {
      if (state._globalModalsBound) return;
      state._globalModalsBound = true;

      state.modal.backdrop = document.getElementById("memoModalBackdrop");
      state.modal.close = document.getElementById("memoModalClose");
      state.modal.date = document.getElementById("memoModalDate");
      state.modal.author = document.getElementById("memoModalAuthor");
      state.modal.body = document.getElementById("memoModalBody");
      if (state.modal.backdrop) {
        state.modal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.modal.backdrop) closeMemoModal();
        });
      }
      if (state.modal.close) state.modal.close.addEventListener("click", closeMemoModal);

      state.jsonModal.backdrop = document.getElementById("jsonModalBackdrop");
      state.jsonModal.close = document.getElementById("jsonModalClose");
      state.jsonModal.title = document.getElementById("jsonModalTitle");
      state.jsonModal.body = document.getElementById("jsonModalBody");
      if (state.jsonModal.backdrop) {
        state.jsonModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.jsonModal.backdrop) closeJsonModal();
        });
      }
      if (state.jsonModal.close) state.jsonModal.close.addEventListener("click", closeJsonModal);

      state.webformModal.backdrop = document.getElementById("webformModalBackdrop");
      state.webformModal.close = document.getElementById("webformModalClose");
      state.webformModal.title = document.getElementById("webformModalTitle");
      state.webformModal.body = document.getElementById("webformModalBody");
      if (state.webformModal.backdrop) {
        state.webformModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.webformModal.backdrop) closeWebformModal();
        });
      }
      if (state.webformModal.close) state.webformModal.close.addEventListener("click", closeWebformModal);

      state.rankPeopleModal.backdrop = document.getElementById("dealsModalBackdrop");
      state.rankPeopleModal.close = document.getElementById("dealsModalClose");
      state.rankPeopleModal.title = document.getElementById("dealsModalTitle");
      state.rankPeopleModal.subtitle = document.getElementById("dealsModalSubtitle");
      state.rankPeopleModal.body = document.getElementById("dealsModalBody");
      if (state.rankPeopleModal.backdrop) {
        state.rankPeopleModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.rankPeopleModal.backdrop) closeDealsModal();
        });
      }
      if (state.rankPeopleModal.close) state.rankPeopleModal.close.addEventListener("click", closeDealsModal);

      state.dealMemoModal.backdrop = document.getElementById("dealMemoModalBackdrop");
      state.dealMemoModal.close = document.getElementById("dealMemoModalClose");
      state.dealMemoModal.title = document.getElementById("dealMemoModalTitle");
      state.dealMemoModal.body = document.getElementById("dealMemoModalBody");
      if (state.dealMemoModal.backdrop) {
        state.dealMemoModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.dealMemoModal.backdrop) closeDealMemoModal();
        });
      }
      if (state.dealMemoModal.close) state.dealMemoModal.close.addEventListener("click", closeDealMemoModal);

      state.statePathModal.backdrop = document.getElementById("statePathModalBackdrop");
      state.statePathModal.close = document.getElementById("statePathModalClose");
      state.statePathModal.title = document.getElementById("statePathModalTitle");
      state.statePathModal.body = document.getElementById("statePathModalBody");
      state.statePathModal.copyCoreBtn = document.getElementById("statePathCoreCopyBtn");
      if (state.statePathModal.backdrop) {
        state.statePathModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.statePathModal.backdrop) closeStatePathModal();
        });
      }
      if (state.statePathModal.close) state.statePathModal.close.addEventListener("click", closeStatePathModal);
      if (state.statePathModal.copyCoreBtn) {
        state.statePathModal.copyCoreBtn.addEventListener("click", () => {
          const detail = state.statePath;
          if (!detail) {
            showToast("상세 로딩 후 사용하세요.", "warning");
            return;
          }
          const core = stripRevOpsFromStatePath(detail);
          if (!core) {
            showToast("복사할 JSON이 없습니다.", "error");
            return;
          }
          copyJsonData(core, "Core JSON 복사 완료");
        });
      }

      state.statepathLegend.backdrop = document.getElementById("statePathLegendBackdrop");
      state.statepathLegend.close = document.getElementById("statePathLegendClose");
      state.statepathLegend.title = document.getElementById("statePathLegendTitle");
      state.statepathLegend.body = document.getElementById("statePathLegendBody");
      if (state.statepathLegend.backdrop) {
        state.statepathLegend.backdrop.addEventListener("click", (e) => {
          if (e.target === state.statepathLegend.backdrop) closeStatePathLegendModal();
        });
      }
      if (state.statepathLegend.close) state.statepathLegend.close.addEventListener("click", closeStatePathLegendModal);

      if (!state.modal.bound) {
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeMemoModal();
            closeJsonModal();
            closeDealsModal();
            closeWebformModal();
            closeDealMemoModal();
            closeStatePathModal();
            closeStatePathLegendModal();
          }
        });
        state.modal.bound = true;
      }
    }

    function computeTierFromWon2025Total(orgWon2025Total) {
      const eok = (Number(orgWon2025Total) || 0) / 1e8;
      if (eok <= 0) return "Ø";
      if (eok < 0.1) return "P5";
      if (eok < 0.25) return "P4";
      if (eok < 0.5) return "P3";
      if (eok < 1) return "P2";
      if (eok < 2) return "P1";
      if (eok < 10) return "P0";
      return "S0";
    }

    function renderDealCheckTable(teamKey, items, opts = {}) {
      const includeTier = Boolean(opts.includeTier);
      const inferPartFn = (owners) => inferPartFromOwners(teamKey, owners);
      const rows = (items || [])
        .map((row) => {
          const owners = Array.isArray(row.owners) ? row.owners.filter(Boolean) : [];
          const ownersText = owners.length ? owners.join(", ") : "-";
          const part = inferPartFn(owners);
          const dealName = row.dealName || "-";
          const dealNameEscaped = escapeHtml(dealName);
          const dealLink =
            row.dealId && row.dealId.trim()
              ? `<a class="sm-link dealcheck-deal-name" href="${salesmapDealUrl(row.dealId)}" target="_blank" rel="noopener noreferrer" title="${dealNameEscaped}">${dealNameEscaped}</a>`
              : `<span class="dealcheck-deal-name" title="${dealNameEscaped}">${dealNameEscaped}</span>`;
          const memoCell =
            row.memoCount && row.memoCount > 0
              ? `<button type="button" class="btn-memo btn-memo--active" data-action="deal-memo" data-deal-id="${row.dealId}">메모 확인</button>`
              : `<button type="button" class="btn-memo btn-memo--disabled" disabled aria-disabled="true" tabindex="-1">메모 없음</button>`;
          const orgLabel = row.orgName || row.orgId || "-";
          const orgCell =
            row.orgId && row.orgId.trim()
              ? `<a class="sm-link" href="${salesmapOrgUrl(row.orgId)}" target="_blank" rel="noopener noreferrer">${orgLabel}</a>`
              : orgLabel;
          const customerCell =
            row.personId && row.personId.trim()
              ? `<a class="sm-link" href="${salesmapPeopleUrl(row.personId)}" target="_blank" rel="noopener noreferrer">${row.personName || row.personId}</a>`
              : row.personName || "-";
          const tierVal = row._tier || computeTierFromWon2025Total(row.orgWon2025Total);
          const tierCell = includeTier ? `<td data-col="tier">${tierVal}</td>` : "";
          return `
            <tr>
              ${tierCell}
              <td data-col="orgName">${orgCell}</td>
              <td data-col="upperOrg">${row.upperOrg || "-"}</td>
              <td data-col="teamSignature">${row.teamSignature || "-"}</td>
              <td data-col="personName">${customerCell}</td>
              <td data-col="createdAt">${formatDateYYMMDD(row.createdAt)}</td>
              <td data-col="dealName">${dealLink}</td>
              <td data-col="courseFormat">${row.courseFormat || "-"}</td>
              <td data-col="part">${part}</td>
              <td data-col="owners">${ownersText}</td>
              <td data-col="probability">${formatProbability(row.probability)}</td>
              <td data-col="expectedCloseDate">${formatDateYYMMDD(row.expectedCloseDate)}</td>
              <td data-col="expectedAmount">${formatAmount(row.expectedAmount)}</td>
              <td data-col="memo">${memoCell}</td>
            </tr>
          `;
        })
        .join("");

      const tierColgroup = includeTier
        ? '<col data-col="tier" />'
        : "";
      const tierHead = includeTier
        ? '<th data-col="tier">티어</th>'
        : "";

      return `
        <div class="table-wrap full dealcheck-table-wrap">
          <table class="dealcheck-table">
            <colgroup>
              ${tierColgroup}
              <col data-col="orgName" style="width:15ch; min-width:15ch; max-width:15ch;" />
              <col data-col="upperOrg" style="width:15ch; min-width:15ch; max-width:15ch;" />
              <col data-col="teamSignature" style="width:15ch; min-width:15ch; max-width:15ch;" />
              <col data-col="personName" style="width:8ch; min-width:8ch; max-width:8ch;" />
              <col data-col="createdAt" />
              <col data-col="dealName" />
              <col data-col="courseFormat" />
              <col data-col="part" />
              <col data-col="owners" />
              <col data-col="probability" />
              <col data-col="expectedCloseDate" />
              <col data-col="expectedAmount" />
              <col data-col="memo" />
            </colgroup>
            <thead>
              <tr>
                ${tierHead}
                <th data-col="orgName">기업명</th>
                <th data-col="upperOrg">소속 상위 조직</th>
                <th data-col="teamSignature">팀(명함/메일서명)</th>
                <th data-col="personName">담당자</th>
                <th data-col="createdAt">생성 날짜</th>
                <th data-col="dealName">딜 이름</th>
                <th data-col="courseFormat">과정포맷</th>
                <th data-col="part">파트</th>
                <th data-col="owners">데이원</th>
                <th data-col="probability">가능성</th>
                <th data-col="expectedCloseDate">수주 예정일</th>
                <th data-col="expectedAmount">예상</th>
                <th data-col="memo">메모</th>
              </tr>
            </thead>
            <tbody>${rows || ""}</tbody>
          </table>
        </div>
      `;
    }

    async function renderDealCheckScreen(teamKey, contentRoot, options = {}) {
      const cfg = DEALCHECK_TEAMS[teamKey];
      if (!cfg) {
        contentRoot.innerHTML = `<div class="muted">알 수 없는 팀(${teamKey})입니다.</div>`;
        return;
      }
      const displayLabel = options.label || (cfg ? cfg.label : `${teamKey} 딜체크`);
      const partFilter = options.partFilter || null;
      const partFilterLabel =
        partFilter === "part1"
          ? "1파트"
          : partFilter === "part2"
          ? "2파트"
          : partFilter === "online"
          ? "온라인셀"
          : "";
      const partFilterHint = partFilterLabel ? ` · 추가 필터: ${partFilterLabel}` : "";
      contentRoot.innerHTML = `
        <div class="dealcheck-screen" data-team="${teamKey}">
        <section class="card" id="${teamKey}SummaryCard">
          <div class="control-row">
            <h2>${displayLabel}</h2>
            <div class="spacer"></div>
            <span class="pill muted" id="${teamKey}SummaryCount">R(S0~P2-비온라인) 0 / R(S0~P2-온라인) 0 / N(온라인) 0 / R(P3~P5-온라인) 0 / R(P3~P5-비온라인) 0 / N(비온라인) 0</span>
          </div>
          <div class="muted">상태=SQL이며 딜 담당자 중 ${cfg.partTeamKey} 담당자가 포함된 딜만 노출됩니다.${partFilterHint}</div>
        </section>
        <section class="card" id="${teamKey}RetHighOfflineCard">
          <div class="control-row">
            <h2 class="dealcheck-retention-title">리텐션 고객 - S0/P0/P1/P2 - 비온라인</h2>
            <div class="spacer"></div>
            <span class="muted" id="${teamKey}RetHighOfflineCount">0건</span>
          </div>
          <div id="${teamKey}RetHighOfflineBody" class="muted">불러오는 중...</div>
        </section>
        <section class="card" id="${teamKey}RetHighOnlineCard">
          <div class="control-row">
            <h2 class="dealcheck-retention-title">리텐션 고객 - S0/P0/P1/P2 - 온라인</h2>
            <div class="spacer"></div>
            <span class="muted" id="${teamKey}RetHighOnlineCount">0건</span>
          </div>
          <div id="${teamKey}RetHighOnlineBody" class="muted">불러오는 중...</div>
        </section>
        <section class="card" id="${teamKey}NewOnlineCard">
          <div class="control-row">
            <h2 class="dealcheck-new-title">신규 고객 - 온라인</h2>
            <div class="spacer"></div>
            <span class="muted" id="${teamKey}NewOnlineCount">0건</span>
          </div>
          <div id="${teamKey}NewOnlineBody" class="muted">불러오는 중...</div>
        </section>
        <section class="card" id="${teamKey}RetLowOnlineCard">
          <div class="control-row">
            <h2 class="dealcheck-retention-title">리텐션 고객 - P3/P4/P5 - 온라인</h2>
            <div class="spacer"></div>
            <span class="muted" id="${teamKey}RetLowOnlineCount">0건</span>
          </div>
          <div id="${teamKey}RetLowOnlineBody" class="muted">불러오는 중...</div>
        </section>
        <section class="card" id="${teamKey}RetLowOfflineCard">
          <div class="control-row">
            <h2 class="dealcheck-retention-title">리텐션 고객 - P3/P4/P5 - 비온라인</h2>
            <div class="spacer"></div>
            <span class="muted" id="${teamKey}RetLowOfflineCount">0건</span>
          </div>
          <div id="${teamKey}RetLowOfflineBody" class="muted">불러오는 중...</div>
        </section>
        <section class="card" id="${teamKey}NewOfflineCard">
          <div class="control-row">
            <h2 class="dealcheck-new-title">신규 고객 - 비온라인</h2>
            <div class="spacer"></div>
            <span class="muted" id="${teamKey}NewOfflineCount">0건</span>
          </div>
          <div id="${teamKey}NewOfflineBody" class="muted">불러오는 중...</div>
        </section>
        </div>
      `;

      const summaryCount = document.getElementById(`${teamKey}SummaryCount`);
      const retHighOfflineCount = document.getElementById(`${teamKey}RetHighOfflineCount`);
      const retHighOnlineCount = document.getElementById(`${teamKey}RetHighOnlineCount`);
      const newOnlineCount = document.getElementById(`${teamKey}NewOnlineCount`);
      const retLowOnlineCount = document.getElementById(`${teamKey}RetLowOnlineCount`);
      const retLowOfflineCount = document.getElementById(`${teamKey}RetLowOfflineCount`);
      const newOfflineCount = document.getElementById(`${teamKey}NewOfflineCount`);
      const retHighOfflineBody = document.getElementById(`${teamKey}RetHighOfflineBody`);
      const retHighOnlineBody = document.getElementById(`${teamKey}RetHighOnlineBody`);
      const newOnlineBody = document.getElementById(`${teamKey}NewOnlineBody`);
      const retLowOnlineBody = document.getElementById(`${teamKey}RetLowOnlineBody`);
      const retLowOfflineBody = document.getElementById(`${teamKey}RetLowOfflineBody`);
      const newOfflineBody = document.getElementById(`${teamKey}NewOfflineBody`);

      const attachHandlers = (container) => {
        container.querySelectorAll('button[data-action="deal-memo"]').forEach((btn) => {
          if (btn.disabled) return;
          btn.addEventListener("click", async () => {
            const dealId = btn.getAttribute("data-deal-id");
            if (!dealId) return;
            await openDealMemoModal(dealId, btn);
          });
        });
      };

      const inferPartFn = (owners) => inferPartFromOwners(teamKey, owners);

      const renderAll = (items) => {
        const retentionItems = sortDealCheckItems(items.filter((row) => row.isRetention));
        const newItems = sortDealCheckItems(items.filter((row) => !row.isRetention));

        const retentionHighAll = [];
        const retentionLowAll = [];
        retentionItems.forEach((row) => {
          const tier = computeTierFromWon2025Total(row.orgWon2025Total);
          row._tier = tier;
          if (["S0", "P0", "P1", "P2"].includes(tier)) retentionHighAll.push(row);
          else retentionLowAll.push(row);
        });

        const retHighOffline = [];
        const retHighOnline = [];
        retentionHighAll.forEach((row) => {
          if (isOnlineCourseFormat(row.courseFormat)) retHighOnline.push(row);
          else retHighOffline.push(row);
        });

        const retLowOnline = [];
        const retLowOffline = [];
        retentionLowAll.forEach((row) => {
          if (isOnlineCourseFormat(row.courseFormat)) retLowOnline.push(row);
          else retLowOffline.push(row);
        });

        const newOnline = [];
        const newOffline = [];
        newItems.forEach((row) => {
          if (isOnlineCourseFormat(row.courseFormat)) newOnline.push(row);
          else newOffline.push(row);
        });

        summaryCount.textContent = `R(S0~P2-비온라인) ${retHighOffline.length} / R(S0~P2-온라인) ${retHighOnline.length} / N(온라인) ${newOnline.length} / R(P3~P5-온라인) ${retLowOnline.length} / R(P3~P5-비온라인) ${retLowOffline.length} / N(비온라인) ${newOffline.length}`;
        retHighOfflineCount.textContent = `${retHighOffline.length}건`;
        retHighOnlineCount.textContent = `${retHighOnline.length}건`;
        newOnlineCount.textContent = `${newOnline.length}건`;
        retLowOnlineCount.textContent = `${retLowOnline.length}건`;
        retLowOfflineCount.textContent = `${retLowOffline.length}건`;
        newOfflineCount.textContent = `${newOffline.length}건`;

        const sections = [
          { key: "ret-high-offline", items: retHighOffline, includeTier: true, body: retHighOfflineBody },
          { key: "ret-high-online", items: retHighOnline, includeTier: true, body: retHighOnlineBody },
          { key: "new-online", items: newOnline, includeTier: false, body: newOnlineBody },
          { key: "ret-low-online", items: retLowOnline, includeTier: true, body: retLowOnlineBody },
          { key: "ret-low-offline", items: retLowOffline, includeTier: true, body: retLowOfflineBody },
          { key: "new-offline", items: newOffline, includeTier: false, body: newOfflineBody },
        ];

        // Clear containers
        retHighOfflineBody.innerHTML = "";
        retHighOnlineBody.innerHTML = "";
        newOnlineBody.innerHTML = "";
        retLowOnlineBody.innerHTML = "";
        retLowOfflineBody.innerHTML = "";
        newOfflineBody.innerHTML = "";

        const renderSection = (section) => {
          const { key, items: sectItems, includeTier, body } = section;
          const idSuffix = `${teamKey}-${key}-table`;
          const html = sectItems.length
            ? renderDealCheckTable(teamKey, sectItems, { includeTier })
            : '<div class="muted">해당 딜이 없습니다.</div>';
          body.innerHTML = html;
          const tableEl = body.querySelector("table.dealcheck-table");
          if (tableEl && sectItems.length) {
            fitColumnsToContent(tableEl, sectItems, { inferPartFn, includeTier });
            applyMemoColumnWidth(tableEl);
            tableEl.id = idSuffix;
            tableEl.querySelectorAll('button[data-action="deal-memo"]').forEach((btn) => {
              if (btn.disabled) return;
              btn.addEventListener("click", async () => {
                const dealId = btn.getAttribute("data-deal-id");
                if (!dealId) return;
                await openDealMemoModal(dealId, btn);
              });
            });
          }
        };

        sections.forEach(renderSection);
      };

      try {
        const rawItems = await loadDealCheck(teamKey);
        const filteredItems = Array.isArray(rawItems)
          ? rawItems.filter((row) => matchDealCheckPartFilter(teamKey, row.owners, partFilter))
          : [];
        renderAll(filteredItems);
      } catch (err) {
        console.error(err);
        const bodies = [
          retHighOfflineBody,
          retHighOnlineBody,
          newOnlineBody,
          retLowOnlineBody,
          retLowOfflineBody,
          newOfflineBody,
        ];
        bodies.forEach((el) => {
          if (el) el.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        });
        if (summaryCount) summaryCount.textContent = "딜체크 데이터를 불러오는 중 오류가 발생했습니다.";
      }
    }

    // ===== Counterparty Risk Daily (D5) =====
    function formatPercent(val) {
      if (val === null || val === undefined || Number.isNaN(val)) return "–";
      return (Number(val) * 100).toFixed(1) + "%";
    }

    function todayIso() {
      return new Date().toISOString().slice(0, 10);
    }

    function fetchCounterpartyRiskReport(date, { force = false } = {}) {
      const key = date || "today";
      const cache = state.counterpartyRisk.cache;
      if (!force && cache.has(key)) return cache.get(key);
      const params = new URLSearchParams();
      if (date) params.set("date", date);
      const promise = fetchJson(`/report/counterparty-risk${params.toString() ? `?${params}` : ""}`);
      cache.set(key, promise);
      return promise;
    }

    function applyCounterpartyRiskFilters(items) {
      const filters = state.counterpartyRisk.filters;
      const search = (filters.search || "").toLowerCase();
      return items.filter((row) => {
        if (filters.tiers.size && !filters.tiers.has(row.tier)) return false;
        if (filters.risks.size && !filters.risks.has(row.risk_level_rule)) return false;
        if (filters.pipelineOnly && !row.pipeline_zero) return false;
        if (search) {
          const text = `${row.organizationName || ""} ${row.counterpartyName || ""}`.toLowerCase();
          if (!text.includes(search)) return false;
        }
        return true;
      });
    }

    function renderCounterpartyRiskDaily(root) {
      const wrapper = document.createElement("div");
      wrapper.className = "card";
      wrapper.innerHTML = `
        <div class="cpr-header">
          <div>
            <h2 style="margin:0;">2026 Daily Report(WIP)</h2>
            <div class="muted" style="font-size:12px;">(구: 카운터파티 리스크(일간)) · DB 교체 시 새로고침 필요(프런트 캐시 무효화 없음)</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <label class="pill muted">기준일
              <input id="cprDateInput" type="date" style="background:transparent;border:1px solid var(--border);color:var(--text);padding:4px 6px;border-radius:8px;" />
            </label>
            <span id="cprDbVersion" class="pill muted"></span>
            <button id="cprRefreshBtn" class="pill">새로고침</button>
          </div>
        </div>
        <div id="cprSummary" class="cpr-summary-grid" style="margin-top:10px;"></div>
        <div id="cprChips" class="cpr-chip-row"></div>
        <div class="cpr-filter-row">
          <label class="pill">티어
            <select id="cprTierSelect" multiple size="4" style="min-width:110px;background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:4px;">
              <option value="S0" selected>S0</option>
              <option value="P0" selected>P0</option>
              <option value="P1" selected>P1</option>
              <option value="P2" selected>P2</option>
            </select>
          </label>
          <label class="pill">리스크
            <select id="cprRiskSelect" multiple size="3" style="min-width:100px;background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:4px;">
              <option value="심각" selected>심각</option>
              <option value="보통" selected>보통</option>
              <option value="양호" selected>양호</option>
            </select>
          </label>
          <label class="pill"><input id="cprPipelineOnly" type="checkbox" /> pipeline_zero만</label>
          <input id="cprSearch" type="search" placeholder="고객사/카운터파티 검색" style="flex:1;min-width:160px;background:var(--panel-2);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:10px;" />
          <button id="cprClear" class="pill muted">필터 초기화</button>
        </div>
        <div id="cprBody" class="muted">불러오는 중...</div>
        <div id="cprDQ" class="muted" style="margin-top:10px;"></div>
      `;
      root.innerHTML = "";
      root.appendChild(wrapper);

      const dateInput = wrapper.querySelector("#cprDateInput");
      const refreshBtn = wrapper.querySelector("#cprRefreshBtn");
      const chipRow = wrapper.querySelector("#cprChips");
      const summaryEl = wrapper.querySelector("#cprSummary");
      const bodyEl = wrapper.querySelector("#cprBody");
      const dqEl = wrapper.querySelector("#cprDQ");
      const tierSelect = wrapper.querySelector("#cprTierSelect");
      const riskSelect = wrapper.querySelector("#cprRiskSelect");
      const pipelineOnly = wrapper.querySelector("#cprPipelineOnly");
      const searchInput = wrapper.querySelector("#cprSearch");
      const clearBtn = wrapper.querySelector("#cprClear");
      const dbVersionEl = wrapper.querySelector("#cprDbVersion");

      const setFiltersFromInputs = () => {
        const tiers = new Set(Array.from(tierSelect.selectedOptions).map((o) => o.value));
        const risks = new Set(Array.from(riskSelect.selectedOptions).map((o) => o.value));
        state.counterpartyRisk.filters.tiers = tiers;
        state.counterpartyRisk.filters.risks = risks;
        state.counterpartyRisk.filters.pipelineOnly = pipelineOnly.checked;
        state.counterpartyRisk.filters.search = searchInput.value || "";
      };

      const resetFilters = () => {
        ["S0", "P0", "P1", "P2"].forEach((v, idx) => (tierSelect.options[idx].selected = true));
        ["심각", "보통", "양호"].forEach((v, idx) => (riskSelect.options[idx].selected = true));
        pipelineOnly.checked = false;
        searchInput.value = "";
        setFiltersFromInputs();
        renderData();
      };

      const renderSummary = (data) => {
        const t1 = data.summary.tier_groups["S0_P0_P1"] || {};
        const t2 = data.summary.tier_groups["P2"] || {};
        const card = (title, g) => `
          <div class="cpr-card">
            <h3>${title}</h3>
            <div class="cpr-kpi-row">
              <span class="cpr-kpi">target ${formatAmount(g.target || 0)}</span>
              <span class="cpr-kpi">coverage ${formatAmount(g.coverage || 0)}</span>
              <span class="cpr-kpi">gap ${formatAmount(g.gap || 0)}</span>
              <span class="cpr-kpi">cov ${formatPercent(g.coverage_ratio)}</span>
            </div>
          </div>
        `;
        summaryEl.innerHTML = card("S0~P1", t1) + card("P2", t2);
      };

      const renderChips = (data) => {
        const counts = data.summary.counts || {};
        const chips = [
          { key: "심각", label: `심각 ${counts.severe || 0}` },
          { key: "보통", label: `보통 ${counts.normal || 0}` },
          { key: "양호", label: `양호 ${counts.good || 0}` },
          { key: "pipeline", label: `pipeline_zero ${counts.pipeline_zero || 0}` },
        ];
        chipRow.innerHTML = chips
          .map((c) => `<button class="cpr-chip ${c.key === "pipeline" ? (state.counterpartyRisk.filters.pipelineOnly ? "active" : "") : state.counterpartyRisk.filters.risks.has(c.key) ? "active" : ""}" data-key="${c.key}">${c.label}</button>`)
          .join("");
        chipRow.querySelectorAll(".cpr-chip").forEach((btn) => {
          btn.addEventListener("click", () => {
            const key = btn.getAttribute("data-key");
            if (key === "pipeline") {
              state.counterpartyRisk.filters.pipelineOnly = !state.counterpartyRisk.filters.pipelineOnly;
            } else {
              const set = state.counterpartyRisk.filters.risks;
              if (set.has(key)) set.delete(key);
              else set.add(key);
            }
            renderData();
          });
        });
      };

      const renderDQ = (data) => {
        const dq = data.data_quality || {};
        dqEl.innerHTML = `
          <div class="pill muted">연도 미정 딜: ${dq.unknown_year_deals || 0}</div>
          <div class="pill muted">금액 미정/파싱 실패: ${dq.unknown_amount_deals || 0}</div>
          <div class="pill muted">미분류 카운터파티: ${dq.uncategorized_counterparties || 0}</div>
        `;
      };

      const renderSections = (data) => {
        const filtered = applyCounterpartyRiskFilters(data.counterparties || []);
        const byRisk = { 심각: [], 보통: [], 양호: [] };
        filtered.forEach((row) => {
          if (byRisk[row.risk_level_rule]) byRisk[row.risk_level_rule].push(row);
        });

        const sectionOrder = ["심각", "보통", "양호"];
        const section = (level) => {
          const rows = byRisk[level] || [];
          const open = state.counterpartyRisk.sectionOpen[level] ?? (level !== "양호");
          const rowsHtml = rows
            .map((row, idx) => {
              const coveragePct = row.target_2026 > 0 ? formatPercent(row.coverage_2026 / row.target_2026) : "–";
              const tier = row.tier || "-";
              const pipelineBadge = row.pipeline_zero ? '<span class="cpr-pill error">pipeline_zero</span>' : "";
              return `
                <tr data-key="${row.organizationId}__${row.counterpartyName}" class="cpr-row">
                  <td>${idx + 1}</td>
                  <td>${row.organizationName || "-"}</td>
                  <td>${row.counterpartyName}</td>
                  <td>${tier}</td>
                  <td class="num">${formatAmount(row.target_2026)}</td>
                  <td class="num">${formatAmount(row.confirmed_2026)}</td>
                  <td class="num">${formatAmount(row.expected_2026)}</td>
                  <td class="num">${coveragePct}</td>
                  <td class="num">${formatAmount(row.gap)}</td>
                  <td>${pipelineBadge}</td>
                  <td><button class="pill" data-action="toggle-detail">상세</button></td>
                </tr>
                <tr class="cpr-detail-row" style="display:none;">
                  <td colspan="10">
                    <div class="cpr-row-detail">
                      <div>
                        <div class="muted" style="font-size:12px;">근거</div>
                        <ul>${(row.evidence_bullets && row.evidence_bullets.length ? row.evidence_bullets : ["(아직 생성 전)"]).map((t) => `<li>${t}</li>`).join("")}</ul>
                      </div>
                      <div>
                        <div class="muted" style="font-size:12px;">추천 액션</div>
                        <ul>${(row.recommended_actions && row.recommended_actions.length ? row.recommended_actions : ["(아직 생성 전)"]).map((t) => `<li>${t}</li>`).join("")}</ul>
                      </div>
                    </div>
                  </td>
                </tr>
              `;
            })
            .join("");

          return `
            <details class="cpr-section" ${open ? "open" : ""} data-level="${level}">
              <summary>${level} (${rows.length})</summary>
              <div class="table-wrap">
                <table class="cpr-table">
                  <thead>
                    <tr>
                      <th style="width:46px;">#</th>
                      <th>고객사</th>
                      <th>카운터파티</th>
                      <th>티어</th>
                      <th class="num">target</th>
                      <th class="num">확정</th>
                      <th class="num">예상</th>
                      <th class="num">coverage%</th>
                      <th class="num">gap</th>
                      <th>플래그</th>
                      <th>액션</th>
                    </tr>
                  </thead>
                  <tbody>${rowsHtml || `<tr><td colspan="11" class="muted">데이터 없음</td></tr>`}</tbody>
                </table>
              </div>
            </details>
          `;
        };

        bodyEl.innerHTML = sectionOrder.map((lv) => section(lv)).join("");
        bodyEl.querySelectorAll("details.cpr-section").forEach((el) => {
          el.addEventListener("toggle", () => {
            const lvl = el.getAttribute("data-level");
            state.counterpartyRisk.sectionOpen[lvl] = el.open;
          });
        });
        bodyEl.querySelectorAll('button[data-action="toggle-detail"]').forEach((btn) => {
          btn.addEventListener("click", () => {
            const row = btn.closest("tr");
            if (!row) return;
            const detail = row.nextElementSibling;
            if (!detail) return;
            const isHidden = detail.style.display === "none";
            detail.style.display = isHidden ? "table-row" : "none";
          });
        });
      };

      const renderData = () => {
        const data = state.counterpartyRisk.data;
        if (!data) return;
        renderSummary(data);
        renderChips(data);
        renderSections(data);
        renderDQ(data);
        dbVersionEl.textContent = data.meta?.db_version ? `DB: ${data.meta.db_version}` : "";
      };

      const loadData = async (force = false) => {
        state.counterpartyRisk.loading = true;
        bodyEl.innerHTML = '<div class="muted">불러오는 중...</div>';
        try {
          const dateVal = dateInput.value || todayIso();
          state.counterpartyRisk.date = dateVal;
          const data = await fetchCounterpartyRiskReport(dateVal, { force });
          state.counterpartyRisk.data = data;
          state.counterpartyRisk.error = null;
          renderData();
        } catch (err) {
          console.error(err);
          state.counterpartyRisk.error = err;
          bodyEl.innerHTML = `<div class="pill error">오류 발생: ${err}</div>`;
        } finally {
          state.counterpartyRisk.loading = false;
        }
      };

      dateInput.value = state.counterpartyRisk.date || todayIso();
      setFiltersFromInputs();
      refreshBtn.addEventListener("click", () => loadData(true));
      tierSelect.addEventListener("change", () => {
        setFiltersFromInputs();
        renderData();
      });
      riskSelect.addEventListener("change", () => {
        setFiltersFromInputs();
        renderData();
      });
      pipelineOnly.addEventListener("change", () => {
        setFiltersFromInputs();
        renderData();
      });
      searchInput.addEventListener("input", () => {
        setFiltersFromInputs();
        renderData();
      });
      clearBtn.addEventListener("click", resetFilters);
      chipRow.innerHTML = "";

      loadData();
    }

    function sortDealCheckItems(items) {
      const list = Array.isArray(items) ? items.slice() : [];
      const num = (val) => (Number.isFinite(Number(val)) ? Number(val) : 0);
      return list.sort((a, b) => {
        const totalDiff = num(b.orgWon2025Total) - num(a.orgWon2025Total);
        if (totalDiff) return totalDiff;
        const dateA = a.createdAt || "";
        const dateB = b.createdAt || "";
        if (dateA < dateB) return -1;
        if (dateA > dateB) return 1;
        const idA = a.dealId || "";
        const idB = b.dealId || "";
        return idA.localeCompare(idB);
      });
    }

    async function loadRankData(size) {
      const key = size && size !== "전체" ? size : "전체";
      const cached = cache.rank2025BySize.get(key);
      const params = new URLSearchParams();
      if (size && size !== "전체") params.set("size", size);
      const query = params.toString();
      try {
        const data = await fetchJson(`/rank/2025-deals${query ? `?${query}` : ""}`);
        const items = data.items || [];
        cache.rank2025BySize.set(key, items);
        return items;
      } catch (err) {
        if (cached) {
          showToast(`랭킹 데이터를 불러오지 못했습니다(캐시 사용): ${err.message}`, "error");
          return cached;
        }
        throw err;
      }
    }

    async function loadRankPeopleData(size) {
      const key = size && size !== "전체" ? size : "전체";
      const cached = cache.rank2025PeopleBySize.get(key);
      if (cached) return cached;
      const params = new URLSearchParams();
      if (size && size !== "전체") params.set("size", size);
      const query = params.toString();
      const data = await fetchJson(`/rank/2025-deals-people${query ? `?${query}` : ""}`);
      const items = data.items || [];
      cache.rank2025PeopleBySize.set(key, items);
      return items;
    }

    async function loadRankCounterpartyDriData(size) {
      const key = size && size !== "전체" ? size : "대기업";
      const cached = cache.rank2025CounterpartyDriBySize.get(key);
      if (cached) return cached;
      const params = new URLSearchParams();
      if (size && size !== "전체") params.set("size", size);
      const query = params.toString();
      const data = await fetchJson(`/rank/2025-top100-counterparty-dri${query ? `?${query}` : ""}`);
      cache.rank2025CounterpartyDriBySize.set(key, data);
      return data;
    }

    async function loadMismatchData(size) {
      const key = size && size !== "전체" ? size : "전체";
      const cached = cache.mismatch2025BySize.get(key);
      if (cached) return cached;
      const params = new URLSearchParams();
      if (size && size !== "전체") params.set("size", size);
      const query = params.toString();
      const data = await fetchJson(`/rank/mismatched-deals${query ? `?${query}` : ""}`);
      const items = data.items || [];
      cache.mismatch2025BySize.set(key, items);
      return items;
    }

    async function loadYearlyTotals() {
      if (cache.yearlyTotals) return cache.yearlyTotals;
      const data = await fetchJson("/rank/won-yearly-totals");
      cache.yearlyTotals = data.items || [];
      return cache.yearlyTotals;
    }

    async function getWonGroupsJsonCached(orgId) {
      if (!orgId) return null;
      if (cache.wonGroupJsonByOrg.has(orgId)) return cache.wonGroupJsonByOrg.get(orgId);
      const data = await fetchJson(`/orgs/${orgId}/won-groups-json`);
      cache.wonGroupJsonByOrg.set(orgId, data);
      return data;
    }

    async function getPeopleByOrgCached(orgId) {
      if (!orgId) return [];
      if (cache.peopleByOrg.has(orgId)) return cache.peopleByOrg.get(orgId);
      const data = await fetchJson(`/orgs/${orgId}/people`);
      const items = data.items || [];
      cache.peopleByOrg.set(orgId, items);
      return items;
    }

    function isSamsung(row) {
      const name = (row.orgName || row.orgId || "").trim();
      return name === "삼성전자";
    }

    function computeTargets(items) {
      const multipliers = state.rankMultipliers || {};
      return (items || []).map((row) => {
        const total2025 = row.totalAmount || 0;
        const online2025 = row.onlineAmount || 0;
        const offline2025 = row.offlineAmount || 0;
        const grade = row.grade;
        const multiplier = Number(multipliers[grade]) || 1;
        let offlineTarget2026 = offline2025 * multiplier;
        let onlineTarget2026 = online2025;
        let target2026 = onlineTarget2026 + offlineTarget2026;
        if (row.orgName === "삼성전자" || row.orgId === "삼성전자") {
          target2026 = 50 * 1e8; // 50억 하드코딩
          onlineTarget2026 = online2025; // keep online as-is
          offlineTarget2026 = target2026 - onlineTarget2026;
        }
        const total2024 = row.totalAmount2024 || 0;
        const ratio2025to2024 = total2024 ? total2025 / total2024 : null;
        return { ...row, target2026, ratio2025to2024, target2026Online: onlineTarget2026, target2026Offline: offlineTarget2026 };
      });
    }

    function renderRankTable(items) {
      if (!items || !items.length) {
        return `<div class="muted">데이터가 없습니다.</div>`;
      }
      return `
        <div class="table-wrap full">
            <table>
              <thead>
                <tr>
                  <th>순위</th>
                  <th>회사</th>
                  <th>25 티어</th>
                  <th>24 티어</th>
                  <th>24년 총액</th>
                  <th>24→25 배수</th>
                  <th>25년 총액</th>
                  <th>25년 온라인</th>
                  <th>25년 비온라인</th>
                  <th>26년 타겟</th>
                  <th>26 온라인</th>
                  <th>26 비온라인</th>
                </tr>
              </thead>
              <tbody>
                ${items
                  .map(
                    (row, idx) =>
                      `<tr>
                        <td>${idx + 1}</td>
                        <td><span class="org-link" data-idx="${idx}" style="cursor:pointer; color: var(--accent); text-decoration: underline;">${row.orgName || row.orgId || "-"}</span></td>
                        <td>${row.grade || "-"}</td>
                        <td>${row.grade2024 || "-"}</td>
                        <td>${formatAmount(row.totalAmount2024)}</td>
                        <td>${formatRatio(row.ratio2025to2024)}</td>
                        <td>${formatAmount(row.totalAmount)}</td>
                        <td>${formatAmount(row.onlineAmount)}</td>
                        <td>${formatAmount(row.offlineAmount)}</td>
                        <td>${formatAmount(row.target2026)}</td>
                        <td>${formatAmount(row.target2026Online)}</td>
                      <td>${formatAmount(row.target2026Offline)}</td>
                    </tr>`
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderMismatchTable(items) {
      if (!items || !items.length) {
        return `<div class="muted">딜 회사와 People 회사가 다른 데이터가 없습니다.</div>`;
      }
      return `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>딜 회사(랭킹)</th>
                <th>고객 회사(People)</th>
                <th>딜</th>
                <th>고객</th>
                <th>계약일</th>
                <th>금액(억)</th>
              </tr>
            </thead>
            <tbody>
              ${items
                .map(
                  (row, idx) => `
                    <tr>
                      <td><span class="org-link" data-idx="${idx}" data-org-id="${row.dealOrgId || ""}" style="cursor:pointer; color: #2563eb; text-decoration: underline;">${row.dealOrgName || row.dealOrgId || "-"}</span></td>
                      <td><span class="org-link alt" data-idx="${idx}" data-org-id="${row.personOrgId || ""}" style="cursor:pointer; color: #10b981; text-decoration: underline;">${row.personOrgName || row.personOrgId || "-"}</span></td>
                      <td>
                        <div>${
                          buildSalesmapLink("deal", row.dealId)
                            ? `<a href="${buildSalesmapLink("deal", row.dealId)}" target="_blank" rel="noopener" style="color:#2563eb;">${row.dealName || "-"}</a>`
                            : `<span style="color:#2563eb;">${row.dealName || "-"}</span>`
                        }</div>
                        <div class="muted" style="font-size:11px;">${row.dealId || ""}</div>
                      </td>
                      <td>
                        <div>${
                          buildSalesmapLink("person", row.personId)
                            ? `<a href="${buildSalesmapLink("person", row.personId)}" target="_blank" rel="noopener" style="color:#10b981;">${row.personName || "-"}</a>`
                            : `<span style="color:#10b981;">${row.personName || "-"}</span>`
                        }</div>
                        <div class="muted" style="font-size:11px;">${row.personId || ""}</div>
                      </td>
                      <td>${formatDate(row.contract_date)}</td>
                      <td>${formatAmount(row.amount)}</td>
                    </tr>
                  `
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function computeIndustrySummary(items) {
      const summaryMap = new Map();
      items.forEach((row) => {
        const key = (row.industryMajor || "미입력").trim() || "미입력";
        const entry = summaryMap.get(key) || { industry: key, total: 0, orgCount: 0 };
        const val = Number(row.totalAmount) || 0;
        entry.total += val;
        entry.orgCount += 1;
        summaryMap.set(key, entry);
      });
      return Array.from(summaryMap.values()).sort((a, b) => b.total - a.total);
    }

    function renderIndustryTable(container, summary) {
      if (!container) return;
      if (!summary || !summary.length) {
        container.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
        return;
      }
      container.innerHTML = `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>업종 구분(대)</th>
                <th>총액(억)</th>
                <th>회사 수</th>
              </tr>
            </thead>
            <tbody>
              ${summary
                .map(
                  (row) =>
                    `<tr>
                      <td>${row.industry}</td>
                      <td>${formatAmount(row.total)}</td>
                      <td>${row.orgCount}</td>
                    </tr>`
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderSizeTotalsTable(totals) {
      if (!totals || !totals.length) {
        return `<div class="muted">데이터가 없습니다.</div>`;
      }
      return `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>기업 규모</th>
                <th>2023 Won(억)</th>
                <th>2024 Won(억)</th>
                <th>2025 Won(억)</th>
              </tr>
            </thead>
            <tbody>
              ${totals
                .map(
                  (row) =>
                    `<tr>
                      <td>${row.size}</td>
                      <td>${formatAmount(row.won2023)}</td>
                      <td>${formatAmount(row.won2024)}</td>
                      <td>${formatAmount(row.won2025)}</td>
                    </tr>`
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderRankPeopleTable(items) {
      if (!items || !items.length) {
        return `<div class="muted">데이터가 없습니다.</div>`;
      }
      return `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>회사</th>
                <th>소속 상위 조직</th>
                <th>팀</th>
                <th>이름</th>
                <th>직급</th>
                <th>담당 교육 영역</th>
                <th>딜 목록</th>
              </tr>
            </thead>
            <tbody>
              ${items
                .map(
                  (row, idx) => `
                    <tr>
                      <td><span class="org-link" data-idx="${idx}" style="cursor:pointer; color: var(--accent); text-decoration: underline;">${row.orgName || row.orgId || "-"}</span></td>
                      <td>${normalizeUpperForDisplay(row.upper_org) || "-"}</td>
                      <td>${row.team_signature === "미입력" ? "-" : (row.team_signature || "-")}</td>
                      <td>${(() => {
                        const link = buildSalesmapLink("person", row.personId);
                        const name = row.personName || "(연결 안 됨)";
                        return link
                          ? `<a href="${link}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: underline;">${name}</a>`
                          : name;
                      })()}</td>
                      <td>${row.title_signature || "-"}</td>
                      <td>${row.edu_area || "-"}</td>
                      <td>
                        <button class="secondary" data-idx="${idx}" data-action="deals">딜 보기</button>
                      </td>
                    </tr>
                  `
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderBizPerfCard(segment, months = []) {
      const headerCells = months.map((m) => `<th>${m}</th>`).join("");
      const bodyRows =
        (segment.rows || [])
          .map((row) => {
            const vals = row.byMonth || {};
            return `
              <tr>
                <td class="sticky-col">${row.label || row.key}</td>
                ${months
                  .map((m) => {
                    const v = vals[m] || 0;
                    const cnt = (row.dealCountByMonth || {})[m] || 0;
                    const disabled = cnt === 0;
                    return `
                      <td>
                        ${disabled
                          ? `<span class="mp-cell-btn is-zero">${formatEok1(0)}</span>`
                          : `<button type="button" class="mp-cell-btn" data-perf-cell="1" data-segment="${segment.key}" data-row="${row.key}" data-month="${m}">${formatEok1(v)}</button>`}
                      </td>
                    `;
                  })
                  .join("")}
              </tr>
            `;
          })
          .join("") || `<tr><td class="sticky-col muted" colspan="${months.length + 1}">데이터가 없습니다.</td></tr>`;

      return `
        <section class="card">
          <div class="control-row">
            <h3>${segment.label || segment.key}</h3>
            <div class="spacer"></div>
            <span class="pill muted">${segment.key}</span>
          </div>
          <div class="table-wrap full perf-table-wrap">
            <table class="perf-table mp-monthly-table">
              <thead>
                <tr>
                  <th class="sticky-col mp-kind">구분</th>
                  ${headerCells}
                </tr>
              </thead>
              <tbody>
                ${bodyRows}
              </tbody>
            </table>
          </div>
        </section>
      `;
    }

    function formatPerfMonthLabel(key) {
      if (!key) return "-";
      const text = String(key);
      if (text.length === 4) {
        return `20${text.slice(0, 2)}-${text.slice(2)}`;
      }
      return text;
    }

    async function openBizPerfDealsModal(segmentKey, rowKey, monthKey) {
      bindGlobalModalsOnce();
      if (!state.rankPeopleModal.backdrop || !state.rankPeopleModal.title || !state.rankPeopleModal.body) {
        showToast("딜 모달을 초기화할 수 없습니다.", "error");
        return;
      }
      state.rankPeopleModal.backdrop.style.display = "flex";
      state.rankPeopleModal.title.textContent = "월별 체결액 딜 목록";
      if (state.rankPeopleModal.subtitle) state.rankPeopleModal.subtitle.textContent = "";
      state.rankPeopleModal.body.innerHTML = `<div class="muted" style="padding:12px;">불러오는 중...</div>`;
      try {
        const data = await loadBizPerfDeals(segmentKey, rowKey, monthKey);
        const titleLabel = `${(data.segment && data.segment.label) || segmentKey} · ${formatPerfMonthLabel(data.month)} · ${(data.row && data.row.label) || rowKey}`;
        state.rankPeopleModal.title.textContent = `월별 체결액 - ${titleLabel}`;
        if (state.rankPeopleModal.subtitle) state.rankPeopleModal.subtitle.textContent = `${formatPerfMonthLabel(data.month)} · ${(data.segment && data.segment.label) || segmentKey} · ${(data.row && data.row.label) || rowKey}`;
        const items = (data.items || []).slice();
        const sortKey = (it) => {
          const a = Number(it.amount);
          const e = Number(it.expectedAmount);
          if (Number.isFinite(a) && a > 0) return a;
          if (Number.isFinite(e) && e > 0) return e;
          return 0;
        };
        items.sort((x, y) => {
          const diff = sortKey(y) - sortKey(x);
          if (diff !== 0) return diff;
          return String(x.dealName || "").localeCompare(String(y.dealName || ""), "ko");
        });
        const rowsHtml =
          items
            .map((item) => {
              const dealLink = buildSalesmapLink("deal", item.dealId);
              const owners = Array.isArray(item.day1OwnerNames) ? item.day1OwnerNames.filter(Boolean).join(", ") : item.day1OwnerNames || "-";
              const fmtAmt = (v) => (Number(v) > 0 ? formatEok1(v) : "-");
              return `
                <tr>
                  <td class="align-left txt">${item.orgName || "-"}</td>
                  <td class="align-left txt">${normalizeUpperOrg(item.upperOrg)}</td>
                  <td class="align-left txt">${item.customerPersonName || "-"}</td>
                  <td class="deal-name-cell align-left txt">${dealLink ? `<a class="deal-name-link" href="${dealLink}" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: underline;">${item.dealName || item.dealId || "-"}</a>` : `<span class="deal-name-link">${item.dealName || item.dealId || "-"}</span>`}</td>
                  <td class="auto-fit txt">${item.courseFormat || "-"}</td>
                  <td class="auto-fit txt">${owners || "-"}</td>
                  <td class="auto-fit txt">${item.status || "-"}</td>
                  <td class="auto-fit txt">${formatProbability(item.probability)}</td>
                  <td class="auto-fit txt">${formatDate(item.expectedCloseDate)}</td>
                  <td class="auto-fit num"><span class="pnl-num">${fmtAmt(item.expectedAmount)}</span></td>
                  <td class="auto-fit txt">${formatDate(item.startDate)}</td>
                  <td class="auto-fit txt">${formatDate(item.endDate)}</td>
                  <td class="auto-fit txt">${item.courseId || "-"}</td>
                  <td class="auto-fit txt">${formatDate(item.contractDate)}</td>
                  <td class="auto-fit num"><span class="pnl-num">${fmtAmt(item.amount)}</span></td>
                </tr>
              `;
            })
            .join("") || `<tr><td colspan="15" class="muted">딜이 없습니다.</td></tr>`;

        state.rankPeopleModal.body.innerHTML = `
          <div class="table-wrap full deals-modal-scroll">
            <table class="perf-table mp-monthly-table mp-deals-table">
              <colgroup>
                <col style="width:14em" />
                <col style="width:14em" />
                <col style="width:8em" />
                <col style="width:20em" />
              </colgroup>
              <thead>
                <tr>
                  <th class="align-left txt">기업명</th>
                  <th class="align-left txt">소속 상위 조직</th>
                  <th class="align-left txt">담당자</th>
                  <th class="align-left txt">딜이름</th>
                  <th class="auto-fit txt">과정포맷</th>
                  <th class="auto-fit txt">데이원</th>
                  <th class="auto-fit txt">상태</th>
                  <th class="auto-fit txt">가능성</th>
                  <th class="auto-fit txt">수주 예정일</th>
                  <th class="auto-fit num">예상 체결액</th>
                  <th class="auto-fit txt">수강시작일</th>
                  <th class="auto-fit txt">수강종료일</th>
                  <th class="auto-fit txt">코스 ID</th>
                  <th class="auto-fit txt">계약체결일</th>
                  <th class="auto-fit num">금액</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        `;
      } catch (err) {
        state.rankPeopleModal.body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        showToast(`딜 목록을 불러오지 못했습니다: ${err.message}`, "error");
      }
    }

    async function renderBizPerfMonthly(contentRoot) {
      state.perfMonthly.loading = true;
      state.perfMonthly.error = null;
      contentRoot.innerHTML = `
        <section class="card compact-header">
          <div class="control-row">
            <div>
              <h1>월별 체결액</h1>
              <div class="muted" id="perfMonthlyMeta">단위: 억(표기 생략) / 클릭 시 딜 목록 표시</div>
            </div>
            <div class="spacer"></div>
            <span class="pill muted">2025-01 ~ 2026-12</span>
          </div>
        </section>
        <div id="perfMonthlyCards" style="display:flex; flex-direction:column; gap:12px;">
          <div class="muted">불러오는 중...</div>
        </div>
      `;

      const cardsRoot = document.getElementById("perfMonthlyCards");
      const metaEl = document.getElementById("perfMonthlyMeta");

      const attachCellHandlers = () => {
        cardsRoot.querySelectorAll("[data-perf-cell]").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const segment = e.currentTarget.getAttribute("data-segment");
            const row = e.currentTarget.getAttribute("data-row");
            const month = e.currentTarget.getAttribute("data-month");
            await openBizPerfDealsModal(segment, row, month);
          });
        });
      };

      const renderCards = (data) => {
        if (!data || !data.segments || !data.segments.length) {
          cardsRoot.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
          return;
        }
        const snapshot = data.meta && data.meta.snapshot_version ? ` · ${data.meta.snapshot_version}` : "";
        if (metaEl) {
          metaEl.textContent = `단위: 억(표기 생략) / 클릭 시 딜 목록 표시${snapshot}`;
        }
        cardsRoot.innerHTML = data.segments.map((seg) => renderBizPerfCard(seg, data.months || [])).join("");
        attachCellHandlers();
      };

      try {
        const data = await loadBizPerfSummary();
        renderCards(data);
      } catch (err) {
        state.perfMonthly.error = err;
        if (cardsRoot) cardsRoot.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        showToast(`월별 체결액을 불러오지 못했습니다: ${err.message}`, "error");
      } finally {
        state.perfMonthly.loading = false;
      }
    }

    async function openPlProgressDealsModal({ month, rail, variant = "E" }) {
      bindGlobalModalsOnce();
      if (!state.rankPeopleModal.backdrop || !state.rankPeopleModal.title || !state.rankPeopleModal.body) {
        showToast("딜 모달을 초기화할 수 없습니다.", "error");
        return;
      }
      state.rankPeopleModal.backdrop.style.display = "flex";
      state.rankPeopleModal.title.textContent = "2026 P&L 진행율매출 딜 목록";
      if (state.rankPeopleModal.subtitle) state.rankPeopleModal.subtitle.textContent = "";
      state.rankPeopleModal.body.innerHTML = `<div class="muted" style="padding:12px;">불러오는 중...</div>`;
      try {
        const data = await loadPlProgress2026Deals({ year: 2026, month, rail, variant });
        const titleLabel = `${month} · ${rail} · ${variant}`;
        state.rankPeopleModal.title.textContent = `2026 P&L 진행율매출 - ${titleLabel}`;
        if (state.rankPeopleModal.subtitle)
          state.rankPeopleModal.subtitle.textContent = `${formatPerfMonthLabel(month)} · ${rail} · 가능성(높음/확정)`;
        const items = (data.items || []).slice();
        items.sort((a, b) => {
          const recDiff = Number(b.recognizedAmount || 0) - Number(a.recognizedAmount || 0);
          if (recDiff !== 0) return recDiff;
          const amtDiff = Number(b.amountUsed || 0) - Number(a.amountUsed || 0);
          if (amtDiff !== 0) return amtDiff;
          return String(a.dealName || "").localeCompare(String(b.dealName || ""), "ko");
        });
        const rowsHtml =
          items
            .map((item) => {
              const dealLink = buildSalesmapLink("deal", item.dealId);
              const owners = Array.isArray(item.day1OwnerNames) ? item.day1OwnerNames.filter(Boolean).join(", ") : item.day1OwnerNames || "-";
              const fmtWon = (v) => (Number(v) > 0 ? formatEok1(v) : "-");
              const fmtRec = (v) => (Number(v) > 0 ? formatEokMax2(v) : "-");
              const overlap = item.overlapDays && item.totalDays ? `${item.overlapDays}/${item.totalDays}` : "-";
              return `
                <tr>
                  <td class="align-left txt">${item.orgName || "-"}</td>
                  <td class="align-left txt">${normalizeUpperOrg(item.upperOrg)}</td>
                  <td class="align-left txt">${item.customerPersonName || "-"}</td>
                  <td class="deal-name-cell align-left txt">${dealLink ? `<a class="deal-name-link" href="${dealLink}" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: underline;">${item.dealName || item.dealId || "-"}</a>` : `<span class="deal-name-link">${item.dealName || item.dealId || "-"}</span>`}</td>
                  <td class="auto-fit txt">${item.courseFormat || "-"}</td>
                  <td class="auto-fit txt">${owners || "-"}</td>
                  <td class="auto-fit txt">${item.status || "-"}</td>
                  <td class="auto-fit txt">${formatProbability(item.probability)}</td>
                  <td class="auto-fit txt">${formatDate(item.expectedCloseDate)}</td>
                  <td class="auto-fit num"><span class="pnl-num">${fmtWon(item.expectedAmount)}</span></td>
                  <td class="auto-fit txt">${formatDate(item.startDate)}</td>
                  <td class="auto-fit txt">${formatDate(item.endDate)}</td>
                  <td class="auto-fit txt">${formatDate(item.contractDate)}</td>
                  <td class="auto-fit num"><span class="pnl-num">${fmtWon(item.amount)}</span></td>
                  <td class="auto-fit num"><span class="pnl-num">${fmtRec(item.recognizedAmount)}</span></td>
                  <td class="auto-fit num"><span class="pnl-num">${overlap}</span></td>
                </tr>
              `;
            })
            .join("") ||
          `<tr><td class="muted" colspan="16">데이터가 없습니다.</td></tr>`;

        state.rankPeopleModal.body.innerHTML = `
          <div class="table-wrap full" style="max-height:60vh; overflow:auto; padding: 0 12px 12px;">
            <table class="perf-table mp-monthly-table mp-deals-table">
              <thead>
                <tr>
                  <th class="align-left txt">기업명</th>
                  <th class="align-left txt">소속 상위 조직</th>
                  <th class="align-left txt">담당자</th>
                  <th class="align-left txt">딜이름</th>
                  <th class="auto-fit txt">과정포맷</th>
                  <th class="auto-fit txt">데이원</th>
                  <th class="auto-fit txt">상태</th>
                  <th class="auto-fit txt">가능성</th>
                  <th class="auto-fit txt">수주 예정일</th>
                  <th class="auto-fit num">예상 체결액</th>
                  <th class="auto-fit txt">수강시작일</th>
                  <th class="auto-fit txt">수강종료일</th>
                  <th class="auto-fit txt">계약체결일</th>
                  <th class="auto-fit num">금액</th>
                  <th class="auto-fit num">진행율매출(해당월)</th>
                  <th class="auto-fit num">일수</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        `;
      } catch (err) {
        state.rankPeopleModal.body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        showToast(`딜 목록을 불러오지 못했습니다: ${err.message}`, "error");
      }
    }

    async function renderBizPerfPlProgress2026(contentRoot) {
      state.perfPlProgress2026.loading = true;
      state.perfPlProgress2026.error = null;
      contentRoot.innerHTML = `
        <section class="card compact-header">
          <div class="control-row">
            <div>
              <h1>2026 P&L 진행율매출</h1>
              <div class="muted" id="plProgressMeta">단위: 억</div>
            </div>
            <div class="spacer"></div>
            <span class="pill muted">2026-01 ~ 2026-12</span>
          </div>
          <div id="pnlAssumptionsBar"></div>
        </section>
        <section class="card">
          <div id="plProgressTableWrap" class="muted">불러오는 중...</div>
        </section>
        <div id="pnlAssumpModalBackdrop">
          <div class="pnl-assump-modal">
            <div class="modal-header">
              <div class="modal-title">가정 확인</div>
              <button class="modal-x" id="pnlAssumpModalClose" aria-label="닫기">✕</button>
            </div>
            <div class="modal-body" id="pnlAssumpModalBody"></div>
          </div>
        </div>
      `;

      const tableWrap = document.getElementById("plProgressTableWrap");
      const metaEl = document.getElementById("plProgressMeta");
      const assumptionsBar = document.getElementById("pnlAssumptionsBar");
      const assumpModal = document.getElementById("pnlAssumpModalBackdrop");
      const assumpModalBody = document.getElementById("pnlAssumpModalBody");
      const assumpModalClose = document.getElementById("pnlAssumpModalClose");
      let assumpEscHandler = null;

      const closeAssumpModal = () => {
        assumpModal.classList.remove("show");
        if (assumpEscHandler) {
          document.removeEventListener("keydown", assumpEscHandler);
          assumpEscHandler = null;
        }
      };

      const openAssumpModal = () => {
        if (!assumpModal || !assumpModalBody) return;
        const meta = (state.perfPlProgress2026.summary && state.perfPlProgress2026.summary.meta) || {};
        const excluded = meta.excluded || {};
        const lines = [];
        lines.push("임대료=인건비×15% · 기타비용=1억/월+출강×5%");
        const metaTokens = [];
        metaTokens.push("(T)=Target, (E)=Expected(가능성 높음·확정 딜만)");
        metaTokens.push(`제외: 날짜 ${excluded.missing_dates || 0}, 금액 ${excluded.missing_amount || 0}, 기간 ${excluded.invalid_date_range || 0}`);
        if (meta.snapshot_version) metaTokens.push(meta.snapshot_version);
        if (meta.generated_at) metaTokens.push(`generated_at:${meta.generated_at}`);
        lines.push(metaTokens.filter(Boolean).join(" · "));
        const a = state.perfPlProgress2026.assumptions;
        lines.push(
          `공헌이익률 온라인 ${((a.onlineContribMarginRate ?? 0) * 100).toFixed(1)}% · 출강 ${(
            (a.offlineContribMarginRate ?? 0) * 100
          ).toFixed(1)}%`
        );
        lines.push(
          `월 제작비 ${Number(a.monthlyProdCost || 0).toFixed(1)}억 · 마케팅비 ${Number(a.monthlyMktCost || 0).toFixed(
            1
          )}억 · 인건비 ${Number(a.monthlyLaborCost || 0).toFixed(1)}억`
        );
        assumpModalBody.innerHTML = lines
          .filter(Boolean)
          .map((ln) => `<div class="small muted">${ln}</div>`)
          .join("");
        assumpModal.classList.add("show");
        assumpEscHandler = (e) => {
          if (e.key === "Escape") closeAssumpModal();
        };
        document.addEventListener("keydown", assumpEscHandler);
      };
      if (assumpModal) {
        assumpModal.addEventListener("click", (e) => {
          if (e.target === assumpModal) closeAssumpModal();
        });
      }
      if (assumpModalClose) {
        assumpModalClose.addEventListener("click", () => closeAssumpModal());
      }

      const renderWithAssumptions = () => {
        if (!state.perfPlProgress2026.summary) return;
        const adjusted = applyAssumptionsToPnlData(
          state.perfPlProgress2026.summary,
          state.perfPlProgress2026.assumptions
        );
        renderTable(adjusted);
      };

      const renderAssumptionsUI = () => {
        if (!assumptionsBar) return;
        const a = state.perfPlProgress2026.assumptions;
        const draft = state.perfPlProgress2026.assumptionDraft || getDefaultPnlDrafts();
        state.perfPlProgress2026.assumptionDraft = draft;
        const fields = [
          { key: "onlineContribMarginRate", label: "공헌이익률(온라인)", unit: "%", type: "rate" },
          { key: "offlineContribMarginRate", label: "공헌이익률(출강)", unit: "%", type: "rate" },
          { key: "monthlyProdCost", label: "월 제작비", unit: "억", type: "amount" },
          { key: "monthlyMktCost", label: "월 마케팅비", unit: "억", type: "amount" },
          { key: "monthlyLaborCost", label: "월 인건비", unit: "억", type: "amount" },
        ];
        const formatDraft = (key, type) => {
          const currentDraft = draft[key];
          if (typeof currentDraft === "string") return currentDraft;
          const val = a[key] ?? DEFAULT_PNL_ASSUMPTIONS[key];
          return type === "rate" ? (Number(val) * 100 || 0).toFixed(1) : Number(val || 0).toFixed(1);
        };
        const fieldHtml = fields.map((f) => {
          const display = formatDraft(f.key, f.type);
          const dirty = Math.abs((a[f.key] ?? 0) - DEFAULT_PNL_ASSUMPTIONS[f.key]) > 1e-9;
          return `
            <div class="pnl-field${dirty ? " is-dirty" : ""}">
              <div class="label">${f.label}</div>
              <div class="pnl-ctrl">
                <button class="pnl-step" type="button" data-pnl-step="-0.1" data-pnl-key="${f.key}" data-pnl-type="${f.type}">−</button>
                <input type="text" inputmode="decimal" autocomplete="off" spellcheck="false" value="${display}" data-pnl-key="${f.key}" data-pnl-type="${f.type}" />
                <button class="pnl-step" type="button" data-pnl-step="0.1" data-pnl-key="${f.key}" data-pnl-type="${f.type}">+</button>
                <span class="unit">${f.unit}</span>
              </div>
            </div>
          `;
        });

        const gridItems = `
          <div class="pnl-assump-row">
            ${fieldHtml[0]}
            ${fieldHtml[1]}
            ${fieldHtml[2]}
            ${fieldHtml[3]}
            ${fieldHtml[4]}
            <div class="pnl-actions-stack">
              <button class="pnl-action-btn" id="pnlAssumpInfoBtn" type="button">가정 확인</button>
              <button class="pnl-action-btn" id="pnlResetAssumptionsBtn" type="button">리셋</button>
            </div>
          </div>
        `;

        assumptionsBar.innerHTML = `
          <div class="pnl-assumptions">
            <div class="pnl-top-split">
              <div class="pnl-top-left">
                ${gridItems}
              </div>
              <div class="pnl-top-right"></div>
            </div>
          </div>
        `;

        const inputs = assumptionsBar.querySelectorAll("input[data-pnl-key]");
        const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
        const setDirty = (key, fieldEl) => {
          const isDirty = Math.abs((state.perfPlProgress2026.assumptions[key] ?? 0) - DEFAULT_PNL_ASSUMPTIONS[key]) > 1e-9;
          if (fieldEl) fieldEl.classList.toggle("is-dirty", isDirty);
        };
        const commitDraft = (key, type, sourceEl, { format = false } = {}) => {
          const raw = state.perfPlProgress2026.assumptionDraft[key] ?? "";
          const parsed = parseFloat(raw);
          if (!Number.isFinite(parsed)) {
            if (format && sourceEl) {
              const val = state.perfPlProgress2026.assumptions[key] ?? DEFAULT_PNL_ASSUMPTIONS[key];
              const display = type === "rate" ? (Number(val) * 100 || 0).toFixed(1) : Number(val || 0).toFixed(1);
              sourceEl.value = display;
              state.perfPlProgress2026.assumptionDraft[key] = display;
            }
            return;
          }
          let num = parsed;
          if (type === "rate") num = num / 100;
          num = type === "rate" ? clamp(num, 0, 1) : clamp(num, 0, 999);
          state.perfPlProgress2026.assumptions[key] = num;
          if (format && sourceEl) {
            const display = type === "rate" ? (num * 100).toFixed(1) : num.toFixed(1);
            sourceEl.value = display;
            state.perfPlProgress2026.assumptionDraft[key] = display;
          }
          setDirty(key, sourceEl?.closest(".pnl-field"));
        };
        const scheduleRender = () => {
          clearTimeout(pnlAssumptionTimer);
          pnlAssumptionTimer = setTimeout(() => renderWithAssumptions(), 200);
        };

        inputs.forEach((input) => {
          input.addEventListener("input", (e) => {
            const key = e.currentTarget.getAttribute("data-pnl-key");
            if (!key) return;
            state.perfPlProgress2026.assumptionDraft[key] = e.currentTarget.value;
            const type = e.currentTarget.getAttribute("data-pnl-type");
            if (!type) return;
            commitDraft(key, type, e.currentTarget, { format: false });
            setDirty(key, e.currentTarget.closest(".pnl-field"));
            scheduleRender();
          });
          input.addEventListener("blur", (e) => {
            const key = e.currentTarget.getAttribute("data-pnl-key");
            const type = e.currentTarget.getAttribute("data-pnl-type");
            if (!key || !type) return;
            commitDraft(key, type, e.currentTarget, { format: true });
            scheduleRender();
          });
        });

        assumptionsBar.querySelectorAll(".pnl-step").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const key = e.currentTarget.getAttribute("data-pnl-key");
            const type = e.currentTarget.getAttribute("data-pnl-type");
            const deltaBase = parseFloat(e.currentTarget.getAttribute("data-pnl-step") || "0");
            if (!key || !type || !Number.isFinite(deltaBase)) return;
            const multiplier = e.shiftKey ? 10 : 1;
            const currentVal = state.perfPlProgress2026.assumptions[key] ?? DEFAULT_PNL_ASSUMPTIONS[key];
            const basePercent = type === "rate" ? currentVal * 100 : currentVal;
            let next = basePercent + deltaBase * multiplier;
            next = type === "rate" ? clamp(next, 0, 100) : clamp(next, 0, 999);
            state.perfPlProgress2026.assumptions[key] = type === "rate" ? next / 100 : next;
            state.perfPlProgress2026.assumptionDraft[key] = next.toFixed(1);
            const inputEl = assumptionsBar.querySelector(`input[data-pnl-key="${key}"]`);
            if (inputEl) {
              inputEl.value = next.toFixed(1);
              setDirty(key, inputEl.closest(".pnl-field"));
            }
            renderWithAssumptions();
          });
        });

        const resetBtn = document.getElementById("pnlResetAssumptionsBtn");
        if (resetBtn) {
          resetBtn.addEventListener("click", () => {
            state.perfPlProgress2026.assumptions = { ...DEFAULT_PNL_ASSUMPTIONS };
            state.perfPlProgress2026.assumptionDraft = getDefaultPnlDrafts();
            inputs.forEach((input) => {
              const key = input.getAttribute("data-pnl-key");
              const type = input.getAttribute("data-pnl-type");
              if (!key || !type) return;
              const display = type === "rate" ? (DEFAULT_PNL_ASSUMPTIONS[key] * 100).toFixed(1) : DEFAULT_PNL_ASSUMPTIONS[key].toFixed(1);
              input.value = display;
              const field = input.closest(".pnl-field");
              if (field) field.classList.remove("is-dirty");
            });
            renderWithAssumptions();
          });
        }

        const infoBtn = document.getElementById("pnlAssumpInfoBtn");
        if (infoBtn) {
          infoBtn.addEventListener("click", () => openAssumpModal());
        }
      };

      const renderTable = (data) => {
        if (!data || !data.rows || !data.rows.length) {
          tableWrap.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
          return;
        }
        const columns = data.columns || [];
        const yearCols = columns.filter((c) => c.kind === "YEAR");
        const monthCols = (data.months || []).flatMap((m) => columns.filter((c) => c.month === m));
        const orderedCols = [...yearCols, ...monthCols];

        const now = new Date();
        const currentYYMM = `${String(now.getFullYear()).slice(-2)}${String(now.getMonth() + 1).padStart(2, "0")}`;

        const headerRow1 = [
          `<th class="col-item mp-kind sticky-col" rowspan="2">항목</th>`,
          `<th class="group col-year year-group" colspan="${yearCols.length}">${data.year || 2026} 전체</th>`,
          ...data.months.map((m) => {
            const cls = m === currentYYMM ? "group col-month month-group is-current-month-group" : "group col-month month-group";
            return `<th class="${cls}" colspan="2">${m}</th>`;
          }),
        ].join("");

        const headerRow2 = orderedCols
          .map((col) => {
            const isYear = col.kind === "YEAR";
            const isT = col.variant === "T";
            const isE = col.variant === "E";
            const extra = [];
            if (isYear && isT) extra.push("year-start");
            if (isYear && isE) extra.push("year-end");
            if (!isYear && isT) extra.push("month-start");
            if (col.month === currentYYMM) {
              extra.push("is-current-month");
              if (isT) extra.push("current-month-start");
              if (isE) extra.push("current-month-end");
            }
            const badge = isT ? '<span class="badge badge-t">T</span>' : '<span class="badge badge-e">E</span>';
            return `<th class="${["col-year", "col-month", isT ? "col-t" : "col-e", ...extra].filter(Boolean).join(" ")}"><div class="pnl-head-right">${badge}</div></th>`;
          })
          .join("");

        const bodyRows =
          data.rows
            .map((row) => {
              const cells = orderedCols
                .map((col) => {
                  const val = row.values ? row.values[col.key] : null;
                  const isClickable =
                    col.variant === "E" &&
                    col.kind !== "YEAR" &&
                    (row.key === "REV_TOTAL" || row.key === "REV_ONLINE" || row.key === "REV_OFFLINE");
                  const display = row.format === "percent" ? formatPercentValue(val) : formatEokMax2(val);
                  const rail = row.key === "REV_TOTAL" ? "TOTAL" : row.key === "REV_ONLINE" ? "ONLINE" : "OFFLINE";
                  const isZero = !Number.isFinite(Number(val)) || Number(val) <= 0;
                  const classes = [
                    col.kind === "YEAR" ? "col-year" : "",
                    col.kind === "YEAR" && col.variant === "T" ? "year-start" : "",
                    col.kind === "YEAR" && col.variant === "E" ? "year-end" : "",
                    col.variant === "T" ? "col-t" : "col-e",
                    col.kind !== "YEAR" && col.variant === "T" ? "month-start" : "",
                    col.month === currentYYMM ? "is-current-month" : "",
                    col.month === currentYYMM && col.variant === "T" ? "current-month-start" : "",
                    col.month === currentYYMM && col.variant === "E" ? "current-month-end" : "",
                  ]
                    .filter(Boolean)
                    .join(" ");
                  if (isClickable) {
                    return `<td class="${classes} mp-num clickable">${isZero ? `<span class="mp-cell-btn is-zero">${formatEokMax2(0)}</span>` : `<button type="button" class="mp-cell-btn" data-pl-cell="1" data-month="${col.month}" data-rail="${rail}"><span class="pnl-num">${display}</span></button>`}</td>`;
                  }
                  return `<td class="${classes} mp-num"><span class="pnl-num">${display}</span></td>`;
                })
                .join("");
              const labelCls = row.level ? `row-label level-${row.level} col-item` : "row-label col-item";
              return `<tr><td class="${labelCls} sticky-col"><span class="pnl-item">${row.label}</span></td>${cells}</tr>`;
            })
            .join("");

        tableWrap.innerHTML = `
          <div class="table-wrap full perf-table-wrap">
            <table class="perf-table mp-monthly-table pl-progress-table pnl-table" style="--item-col-w: 190px; --year-col-w: 110px;">
              <thead>
                <tr>${headerRow1}</tr>
                <tr>${headerRow2}</tr>
              </thead>
              <tbody>
                ${bodyRows}
              </tbody>
            </table>
          </div>
        `;

        tableWrap.querySelectorAll("[data-pl-cell]").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const month = e.currentTarget.getAttribute("data-month");
            const rail = e.currentTarget.getAttribute("data-rail");
            await openPlProgressDealsModal({ month, rail, variant: "E" });
          });
        });

        if (metaEl) {
          metaEl.textContent = `단위: 억 · (T)=Target / (E)=Expected`;
        }
      };

      renderAssumptionsUI();

      try {
        const data = await loadPlProgress2026Summary(2026);
        state.perfPlProgress2026.summary = data;
        renderWithAssumptions();
      } catch (err) {
        state.perfPlProgress2026.error = err;
        if (tableWrap) tableWrap.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        showToast(`P&L 진행율매출을 불러오지 못했습니다: ${err.message}`, "error");
      } finally {
        state.perfPlProgress2026.loading = false;
      }
    }

    async function renderRank2025Screen(contentRoot) {
      contentRoot.innerHTML = `
        <section class="card compact-header">
          <div class="control-row">
            <h2>등급/목표 설정</h2>
            <div class="spacer"></div>
            <button id="openGradeGuide" type="button">등급 구간 확인하기</button>
            <button id="openMultiplierModal" type="button">등급별 배수 설정</button>
          </div>
        </section>
        <section class="card compact-header">
          <div class="control-row">
            <h2>2025년 체결액 순위 (Won 상태)</h2>
            <div class="spacer"></div>
            <label class="muted">기업 규모</label>
            <select id="rankSizeSelect"></select>
          </div>
          <div id="rankBody" class="muted">불러오는 중...</div>
        </section>
      `;

      ensureRankModals();

      const target = document.getElementById("rankBody");
      const sizeSelect = document.getElementById("rankSizeSelect");
      const btnGuide = document.getElementById("openGradeGuide");
      const btnMultiplier = document.getElementById("openMultiplierModal");

      let currentItems = [];

      const renderAll = (items) => {
        currentItems = computeTargets(items);
        target.innerHTML = renderRankTable(currentItems);
        target.querySelectorAll(".org-link").forEach((cell) => {
          cell.addEventListener("click", async () => {
            const idx = Number(cell.getAttribute("data-idx"));
            const row = currentItems[idx];
            if (!row) return;
            await navigateToOrg(row.orgId);
          });
        });
      };

      const refresh = async () => {
        if (target) target.textContent = "불러오는 중...";
        try {
          const items = await loadRankData(state.rankSize);
          renderAll(items);
        } catch (err) {
          if (target) target.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
          showToast(`랭킹 데이터를 불러오지 못했습니다: ${err.message}`, "error");
        }
      };

      try {
        const sizes = await getSizes();
        sizeSelect.innerHTML = sizes.map((s) => `<option value="${s}">${s}</option>`).join("");
        if (!sizes.includes(state.rankSize)) {
          state.rankSize = sizes[0] || "전체";
        }
        sizeSelect.value = state.rankSize;
      } catch (err) {
        if (target) target.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        showToast(`랭킹 규모 목록 오류: ${err.message}`, "error");
        return;
      }

      sizeSelect.addEventListener("change", async (e) => {
        state.rankSize = e.target.value || "전체";
        await refresh();
      });

      if (btnGuide) {
        btnGuide.addEventListener("click", () => openGradeGuideModal());
      }
      if (btnMultiplier) {
        btnMultiplier.addEventListener("click", () => openMultiplierModal(() => refresh()));
      }

      bindMetricResizeOnce();
      await refresh();
    }

    async function renderRankCounterpartyDriScreen(contentRoot) {
      const stateDri = state.rankCounterpartyDri;
      const ORG_PAGE_SIZE = 100;
      contentRoot.innerHTML = `
        <section class="card compact">
          <div class="control-row">
            <h2>2026 카운터파티 DRI</h2>
            <span class="muted" style="font-size:12px;">(구: 2025 카운터파티 DRI · 기준은 2025 체결 기반)</span>
            <div class="spacer"></div>
            <label class="muted">기업 규모</label>
            <select id="rankCounterpartySizeSelect"></select>
            <span class="pill muted">DB 교체 시 새로고침 필요 (캐시 무효화 없음)</span>
          </div>
          <div class="control-row tight" style="flex-wrap:wrap;">
            <label class="muted">검색</label>
            <input id="rankCounterpartySearch" type="text" placeholder="기업/카운터파티/담당자 검색" style="min-width:220px;" />
            <label class="muted">DRI</label>
            <select id="rankCounterpartyDriFilter">
              <option value="all">전체</option>
              <option value="O">O만</option>
              <option value="X">X만</option>
            </select>
            <label class="muted">팀&파트</label>
            <select id="rankCounterpartyTeamPartFilter"></select>
            <label><input type="checkbox" id="rankCounterpartyHideMissing" /> 미입력 upper_org 숨김</label>
            <label class="muted">정렬</label>
            <select id="rankCounterpartySort">
              <option value="default">기업총액↓ → CP총액↓(기본)</option>
              <option value="cp_online_desc">CP 온라인↓</option>
              <option value="cp_offline_desc">CP 비온라인↓</option>
            </select>
          </div>
        </section>
        <section class="card">
          <div id="rankCounterpartyStatus" class="muted">불러오는 중...</div>
          <div id="rankCounterpartyOrgPager"></div>
          <div id="rankCounterpartyTable"></div>
        </section>
        <div class="modal-backdrop" id="counterpartyModal" style="display:none;">
          <div class="modal xl" role="dialog" aria-modal="true" aria-labelledby="counterpartyModalTitle">
            <header class="control-row">
              <h3 id="counterpartyModalTitle">카운터파티 상세</h3>
              <div class="spacer"></div>
              <button type="button" id="counterpartyModalClose" class="close-btn" aria-label="닫기">닫기</button>
            </header>
            <div id="rankCounterpartyDetail" class="muted" style="padding:8px; max-height:70vh; overflow:auto;">행을 클릭하면 상세를 표시합니다.</div>
          </div>
        </div>
      `;

      const sizeSelect = document.getElementById("rankCounterpartySizeSelect");
      const statusEl = document.getElementById("rankCounterpartyStatus");
      const tableWrap = document.getElementById("rankCounterpartyTable");
      const detailWrap = document.getElementById("rankCounterpartyDetail");
      const modal = document.getElementById("counterpartyModal");
      const modalClose = document.getElementById("counterpartyModalClose");
      const searchInput = document.getElementById("rankCounterpartySearch");
      const driSelect = document.getElementById("rankCounterpartyDriFilter");
      const teamPartSelect = document.getElementById("rankCounterpartyTeamPartFilter");
      const hideMissingChk = document.getElementById("rankCounterpartyHideMissing");
      const sortSelect = document.getElementById("rankCounterpartySort");

      const applyFilters = () => {
        const rows = stateDri.rows || [];
        const term = (stateDri.search || "").trim();
        const driFilter = stateDri.dri || "all";
        const hideMissing = stateDri.hideMissingUpper;
        const sort = stateDri.sort || "default";
        const teamPartFilter = stateDri.teamPart || "all";

        let filtered = rows.filter((r) => {
          if (hideMissing && (!r.upperOrg || normalizeUpperOrg(r.upperOrg) === "미입력")) return false;
          return true;
        });
        filtered = filtered.filter((r) => {
          if (driFilter !== "all") {
            const tp = computeTeamPartSummary(r.owners2025 || []);
            if (tp.dri !== driFilter) return false;
          }
          return true;
        });
        if (teamPartFilter !== "all") {
          filtered = filtered.filter((r) => {
            const tp = computeTeamPartSummary(r.owners2025 || []);
            return (tp.teamPartText || "-") === teamPartFilter;
          });
        }
        if (term) {
          filtered = filtered.filter((r) => {
            const owners = (r.owners2025 || []).join(" ");
            return (
              String(r.orgName || "").includes(term) ||
              String(r.upperOrg || "").includes(term) ||
              owners.includes(term)
            );
          });
        }
        if (sort === "cp_online_desc") {
          filtered.sort((a, b) => (b.cpOnline2025 || 0) - (a.cpOnline2025 || 0));
        } else if (sort === "cp_offline_desc") {
          filtered.sort((a, b) => (b.cpOffline2025 || 0) - (a.cpOffline2025 || 0));
        } else {
          filtered.sort((a, b) => {
            if ((b.orgWon2025 || 0) !== (a.orgWon2025 || 0)) return (b.orgWon2025 || 0) - (a.orgWon2025 || 0);
            return (b.cpTotal2025 || 0) - (a.cpTotal2025 || 0);
          });
        }
        return filtered;
      };

      const renderTable = () => {
        const allRows = applyFilters();
        stateDri.filtered = allRows;
        const rows = allRows;
        if (!rows.length) {
          tableWrap.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
          return;
        }
        const tpOptions = new Set(["all"]);
        rows.forEach((row) => {
          const tp = computeTeamPartSummary(row.owners2025 || []);
          const label = tp.teamPartText || "-";
          tpOptions.add(label);
        });
        stateDri.teamPartOptions = Array.from(tpOptions);
        if (teamPartSelect) {
          const opts = stateDri.teamPartOptions
            .map((opt) => `<option value="${opt}">${opt === "all" ? "전체" : opt}</option>`)
            .join("");
          const currentVal = teamPartSelect.value || "all";
          teamPartSelect.innerHTML = opts;
          if (!stateDri.teamPartOptions.includes(currentVal)) {
            stateDri.teamPart = "all";
            teamPartSelect.value = "all";
          } else {
            teamPartSelect.value = currentVal;
          }
        }
            const htmlRows = rows
          .map((row, idx) => {
            const ownerList = Array.isArray(row.owners2025) ? row.owners2025.map((s) => (s || "").trim()).filter(Boolean) : [];
            const owners = ownerList.length ? ownerList.join(", ") : "미입력";
            const ownersDisplay =
              ownerList.length >= 3 ? `${ownerList[0]} 외 ${ownerList.length - 1}명` : ownerList.join(", ") || "미입력";
            const upperRaw = row.upperOrg || "미입력";
            const isAsciiUpper = /^[A-Za-z0-9\s]+$/.test(upperRaw);
            const upperLimit = isAsciiUpper ? 20 : 12;
            const upperDisplay = upperRaw.length > upperLimit ? `${upperRaw.slice(0, upperLimit)}...` : upperRaw;
            const tp = computeTeamPartSummary(row.owners2025 || []);
            const ownersText = owners === "미입력" ? "미입력" : owners.split(",").map((s) => s.trim()).join(", ");
            const tier = row.orgTier || "미입력";
            const online2025 = Number(row.cpOnline2025 || 0);
            const offline2025 = Number(row.cpOffline2025 || 0);
            const online26 = Number(row.cpOnline2026 || 0);
            const offline26 = Number(row.cpOffline2026 || 0);
            const target26 = (row.cpOffline2025 || 0) * tierMultiplier(tier);
            const target26Online = online2025; // multiplier 1.0
            const fmtOnline25 = formatEok(online2025 / 1e8);
            const fmtOffline25 = formatEok(offline2025 / 1e8);
            const fmtTarget26Online = formatEok(target26Online / 1e8);
            const fmtTarget26 = formatEok(target26 / 1e8);
            const fmtOnline26 = formatEok(online26 / 1e8);
            const fmtOffline26 = formatEok(offline26 / 1e8);
            return `
              <tr data-idx="${idx}">
                <td>${tier}</td>
                <td><span class="org-link" data-org-link="${idx}" style="cursor:pointer; color: var(--accent); text-decoration: underline;">${row.orgName || row.orgId || "-"}</span></td>
                <td title="${upperRaw}">${upperDisplay}</td>
                <td class="nowrap-ellipsis" title="${owners}">${ownersDisplay}</td>
                <td>${tp.teamPartText || "-"}</td>
                <td class="dri">${tp.dri || "X"}</td>
                <td class="num">${fmtOffline25}</td>
                <td class="num">${fmtTarget26}</td>
                <td class="num">${fmtOffline26}</td>
                <td class="num">${fmtOnline25}</td>
                <td class="num">${fmtTarget26Online}</td>
                <td class="num">${fmtOnline26}</td>
              </tr>
            `;
          })
          .join("");
        tableWrap.innerHTML = `
          <div class="table-wrap full table-scroll-x">
            <table class="cpr-table" id="rankCounterpartyDriTable">
              <colgroup>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col>
                <col data-metric="1">
                <col data-metric="1">
                <col data-metric="1">
                <col data-metric="1">
                <col data-metric="1">
                <col data-metric="1">
              </colgroup>
              <thead>
                <tr>
                  <th>티어</th>
                  <th>기업명</th>
                  <th>카운터파티</th>
                  <th>담당자</th>
                  <th>팀&파트</th>
                  <th class="dri">DRI</th>
                  <th class="num" data-metric="1">25 출강</th>
                  <th class="num" data-metric="1">26 출강 타겟</th>
                  <th class="num" data-metric="1">26 출강 체결</th>
                  <th class="num" data-metric="1">25 온라인</th>
                  <th class="num" data-metric="1">26 온라인 타겟</th>
                  <th class="num" data-metric="1">26 온라인 체결</th>
                </tr>
              </thead>
              <tbody>${htmlRows}</tbody>
            </table>
          </div>
        `;
        requestAnimationFrame(() => {
          applyEqualMetricColWidths(document.getElementById("rankCounterpartyDriTable"));
        });
        tableWrap.querySelectorAll("tr[data-idx]").forEach((tr) => {
          tr.addEventListener("click", () => {
            const idx = Number(tr.getAttribute("data-idx"));
            const row = rows[idx];
            if (!row) return;
            stateDri.selected = row;
            loadCounterpartyDetail(row);
          });
        });
        tableWrap.querySelectorAll("[data-org-link]").forEach((el) => {
          el.addEventListener("click", async (e) => {
            e.stopPropagation();
            const idx = Number(el.getAttribute("data-org-link"));
            const row = rows[idx];
            if (!row) return;
            await navigateToOrg(row.orgId);
          });
        });
      };

      const loadData = async () => {
        stateDri.loading = true;
        stateDri.error = null;
        statusEl.textContent = "불러오는 중...";
        tableWrap.innerHTML = "";
        try {
          const data = await loadCounterpartyRows(stateDri.size || "대기업", stateDri.offset || 0, ORG_PAGE_SIZE);
          stateDri.rows = data.rows || [];
          stateDri.meta = data.meta || {};
          statusEl.textContent = `${stateDri.size || "대기업"} / org ${data.meta?.orgCount ?? "-"}개 · row ${data.meta?.rowCount ?? "-"} · offset ${(stateDri.offset || 0) + 1}`;
          renderTable();
          detailWrap.textContent = "행을 클릭하면 상세를 표시합니다.";
          stateDri.selected = null;
          stateDri.detail = null;
        } catch (err) {
          stateDri.error = err.message;
          statusEl.textContent = `오류: ${err.message}`;
        } finally {
          stateDri.loading = false;
        }
      };

      try {
        const sizes = await getSizes();
        sizeSelect.innerHTML = sizes.map((s) => `<option value="${s}">${s}</option>`).join("");
        if (!sizes.includes(stateDri.size)) {
          stateDri.size = sizes.find((s) => s === "대기업") || sizes[0] || "대기업";
        }
        sizeSelect.value = stateDri.size;
      } catch (err) {
        sizeSelect.innerHTML = `<option value="대기업">대기업</option>`;
      }

      sizeSelect.addEventListener("change", async (e) => {
        stateDri.size = e.target.value || "대기업";
        stateDri.offset = 0;
        await loadData();
        renderOrgPager();
      });

      const closeCounterpartyModal = () => {
        if (modal) modal.style.display = "none";
        if (detailWrap) detailWrap.innerHTML = "행을 클릭하면 상세를 표시합니다.";
        stateDri.detail = null;
        stateDri.selected = null;
      };
      if (modalClose && modal) {
        modalClose.addEventListener("click", closeCounterpartyModal);
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeCounterpartyModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.style.display === "flex") {
            closeCounterpartyModal();
          }
        });
      }
      if (searchInput) {
        searchInput.value = stateDri.search || "";
        let timer = null;
        searchInput.addEventListener("input", () => {
          stateDri.search = searchInput.value || "";
          if (timer) clearTimeout(timer);
          timer = setTimeout(renderTable, 300);
        });
      }
      if (driSelect) {
        driSelect.value = stateDri.dri || "all";
        driSelect.addEventListener("change", () => {
          stateDri.dri = driSelect.value || "all";
          renderTable();
        });
      }
      if (teamPartSelect) {
        teamPartSelect.addEventListener("change", () => {
          stateDri.teamPart = teamPartSelect.value || "all";
          renderTable();
        });
      }
      if (hideMissingChk) {
        hideMissingChk.checked = !!stateDri.hideMissingUpper;
        hideMissingChk.addEventListener("change", () => {
          stateDri.hideMissingUpper = hideMissingChk.checked;
          renderTable();
        });
      }
      if (sortSelect) {
        sortSelect.value = stateDri.sort || "default";
        sortSelect.addEventListener("change", () => {
          stateDri.sort = sortSelect.value || "default";
          renderTable();
        });
      }

      // Org-level pagination (fetch next 100 orgs)
      const renderOrgPager = () => {
        const pager = document.getElementById("rankCounterpartyOrgPager");
        if (!pager) return;
        const offset = stateDri.offset || 0;
        const meta = stateDri.meta || {};
        const hasPrev = offset > 0;
        const hasNext = (meta.orgCount || 0) >= ORG_PAGE_SIZE; // optimistic when total unknown
        pager.innerHTML = `
          <div class="control-row" style="margin-top:6px;">
            <div class="muted">Org ${offset + 1} ~ ${offset + (meta.orgCount || stateDri.rows.length || 0)}</div>
            <div class="spacer"></div>
            <button type="button" id="rankCpOrgPrev" ${hasPrev ? "" : "disabled"}>Prev 100</button>
            <button type="button" id="rankCpOrgNext" ${hasNext ? "" : "disabled"}>Next 100</button>
          </div>
        `;
        const prevBtn = document.getElementById("rankCpOrgPrev");
        const nextBtn = document.getElementById("rankCpOrgNext");
        if (prevBtn) {
          prevBtn.addEventListener("click", async () => {
            stateDri.offset = Math.max(0, offset - ORG_PAGE_SIZE);
            await loadData();
            renderOrgPager();
          });
        }
        if (nextBtn) {
          nextBtn.addEventListener("click", async () => {
            stateDri.offset = offset + ORG_PAGE_SIZE;
            await loadData();
            renderOrgPager();
          });
        }
      };

      const loadCounterpartyDetail = async (row) => {
        if (!detailWrap) return;
        if (!row) {
          detailWrap.textContent = "행을 클릭하면 상세를 표시합니다.";
          return;
        }
        if (modal) modal.style.display = "flex";
        detailWrap.textContent = "불러오는 중...";
        try {
          const orgId = row.orgId;
          const upper = normalizeUpperOrg(row.upperOrg);
          const detail = await fetchJson(`/rank/2025-counterparty-dri/detail?orgId=${encodeURIComponent(orgId)}&upperOrg=${encodeURIComponent(upper)}`);
          const deals = detail.deals || [];
          console.debug("[counterparty detail] org", orgId, "upper", upper, "deals", deals.length, deals);
          const onlineSet = COUNTERPARTY_ONLINE_FORMATS;
          const ownersLine = Array.isArray(row.owners2025) && row.owners2025.length ? row.owners2025.join(", ") : "미입력";
          const tp = computeTeamPartSummary(row.owners2025 || []);

          const parseYear = (v) => {
            if (!v) return null;
            const s = String(v).trim();
            return s && s.length >= 4 && /^\d{4}/.test(s) ? s.slice(0, 4) : null;
          };
          const yearFromDates = (contract, expected) => {
            const y = parseYear(contract);
            return y || parseYear(expected);
          };
          const primaryDate = (d) => (d.contract_date || d.expected_date || "").trim();
          const pickAmount = (d) => {
            const amt = Number(d.amount || 0);
            if (Number.isFinite(amt) && amt > 0) return amt;
            const exp = Number(d.expected_amount || 0);
            if (Number.isFinite(exp) && exp > 0) return exp;
            return 0;
          };
          const isOnline = (fmt) => onlineSet.has((fmt || "").trim());
          const isOffline = (fmt) => !isOnline(fmt);
          const isHighProb = (p, status) => {
            const fallbackWon = (status || "").trim() === "Won";
            if (p === null || p === undefined || p === "") return fallbackWon;
            const text = (p || "").trim();
            if (text === "확정" || text === "높음") return true;
            try {
              const parsed = JSON.parse(p);
              if (Array.isArray(parsed)) {
                return parsed.some((v) => {
                  const t = String(v || "").trim();
                  return t === "확정" || t === "높음";
                });
              }
            } catch (_) {
              // ignore JSON parse errors
            }
            return fallbackWon;
          };

          const extractOwnerNames = (d) => {
            const names = [];
            const pushName = (v) => {
              const t = String(v || "").trim();
              if (t) names.push(t);
            };
            if (d.owner_json) {
              try {
                const parsed = typeof d.owner_json === "string" ? JSON.parse(d.owner_json) : d.owner_json;
                if (Array.isArray(parsed)) {
                  parsed.forEach((o) => pushName(o?.name || o));
                } else if (parsed && parsed.name) {
                  pushName(parsed.name);
                }
              } catch (_) {
                // ignore
              }
            }
            if (Array.isArray(d.owners)) {
              d.owners.forEach((o) => pushName(o?.name || o));
            }
            if (d.owner) {
              try {
                const parsedOwner = JSON.parse(d.owner);
                if (Array.isArray(parsedOwner)) {
                  parsedOwner.forEach((o) => pushName(o?.name || o));
                } else if (parsedOwner && parsedOwner.name) {
                  pushName(parsedOwner.name);
                }
              } catch (_) {
                // treat as plain string
                pushName(d.owner);
              }
            }
            if (!names.length && d.ownerName) pushName(d.ownerName);
            const unique = Array.from(new Set(names));
            return unique.length ? unique.join(" · ") : "미입력";
          };

          const sortDeals = (arr) =>
            (arr || []).slice().sort((a, b) => {
              const ad = primaryDate(a) || "";
              const bd = primaryDate(b) || "";
              if (ad !== bd) return bd.localeCompare(ad);
              const aa = pickAmount(b) - pickAmount(a);
              if (aa !== 0) return aa;
              return String(a.name || "").localeCompare(String(b.name || ""));
            });

          const onlineDeals2025 = detail.online25_deals || deals.filter((d) => {
            const year = yearFromDates(d.contract_date, d.expected_date);
            const startYear = parseYear(d.start_date);
            return isHighProb(d.probability, d.status) && year === "2025" && isOnline(d.course_format) && startYear !== "2026";
          });

          const offlineDeals2025 = detail.offline25_deals || deals.filter((d) => {
            const year = yearFromDates(d.contract_date, d.expected_date);
            const startYear = parseYear(d.start_date);
            return isHighProb(d.probability, d.status) && year === "2025" && isOffline(d.course_format) && startYear !== "2026";
          });

          const online26 = detail.online26_deals || deals.filter((d) => {
            const year = yearFromDates(d.contract_date, d.expected_date);
            const startYear = parseYear(d.start_date);
            const isHigh = isHighProb(d.probability, d.status);
            const amt = pickAmount(d);
            if (!amt || !isOnline(d.course_format)) return false;
            if (isHigh && year === "2026") return true;
            if (isHigh && year === "2025" && startYear === "2026") return true;
            return false;
          });

          const offline26 = detail.offline26_deals || deals.filter((d) => {
            const year = yearFromDates(d.contract_date, d.expected_date);
            const startYear = parseYear(d.start_date);
            const prob = (d.probability || "").trim();
            const isHigh = isHighProb(prob, d.status);
            const amt = pickAmount(d);
            if (!amt || !isOffline(d.course_format)) return false;
            if (isHigh && year === "2026") return true;
            if (isHigh && year === "2025" && startYear === "2026") return true;
            return false;
          });

          const renderDealTable = (title, rows) => {
            if (!rows || !rows.length) {
              return `<h4>${title}</h4><div class="muted">데이터가 없습니다.</div>`;
            }
            const sorted = sortDeals(rows);
            const body = sorted
              .map((d) => {
                const owners = extractOwnerNames(d);
                const dealName = d.name || "-";
                const dealLink =
                  d.id && d.id.trim()
                    ? `<a class="sm-link" href="${salesmapDealUrl(d.id)}" target="_blank" rel="noopener noreferrer">${dealName}</a>`
                    : dealName;
                const personLink =
                  d.people_id && d.people_id.trim()
                    ? `<a class="sm-link" href="${salesmapPeopleUrl(d.people_id)}" target="_blank" rel="noopener noreferrer">${d.people_name || d.people_id}</a>`
                    : d.people_name || "-";
                return `
                  <tr>
                    <td>${dealLink}</td>
                    <td>${d.upper_org || "-"}</td>
                    <td>${personLink}</td>
                    <td>${owners}</td>
                    <td>${formatAmount(pickAmount(d))}</td>
                    <td>${d.course_format || "-"}</td>
                    <td>${formatDate(d.contract_date || d.expected_date)}</td>
                    <td>${formatDate(d.start_date)}</td>
                    <td>${d.status || "-"}</td>
                    <td>${d.probability || "-"}</td>
                    <td>${formatDate(d.created_at)}</td>
                  </tr>
                `;
              })
              .join("");
            return `
              <h4>${title}</h4>
              <div class="table-wrap full">
                <table>
                  <thead>
                    <tr>
                      <th>이름</th>
                      <th>상위 조직</th>
                      <th>교담자</th>
                      <th>담당자</th>
                      <th>금액</th>
                      <th>과정포맷</th>
                      <th>계약/예정일</th>
                      <th>수강시작일</th>
                      <th>상태</th>
                      <th>성사가능성</th>
                      <th>생성일</th>
                    </tr>
                  </thead>
                  <tbody>${body}</tbody>
                </table>
              </div>
            `;
          };

          detailWrap.innerHTML = `
            <div style="margin-bottom:6px;">${row.orgName || row.orgId || "-"} / ${upper}</div>
            <div class="pill" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding:10px; font-size:14px;">
              <span><strong>25 담당자:</strong> ${ownersLine}</span>
              <span><strong>팀&파트:</strong> ${tp.teamPartText || "-"}</span>
              <span><strong>DRI:</strong> <span style="font-weight:700; color:${tp.dri === "O" ? "var(--success)" : "var(--error)"};">${tp.dri || "X"}</span></span>
            </div>
            ${renderDealTable("25 출강", offlineDeals2025)}
            ${renderDealTable("26 출강 체결", offline26)}
            ${renderDealTable("25 온라인", onlineDeals2025)}
            ${renderDealTable("26 온라인 체결", online26)}
          `;
          if (modal) modal.style.display = "flex";
        } catch (err) {
          detailWrap.innerHTML = `<div class="muted">상세 로드 오류: ${err.message}</div>`;
          if (modal) modal.style.display = "flex";
        }
      };

      await loadData();
      renderOrgPager();
    }

    async function renderTarget2026Screen(contentRoot) {
      bindGlobalModalsOnce();
      const sizes = ["대기업", "중견기업", "중소기업"];
      contentRoot.innerHTML = `
        <section class="card target2026-wrap">
          <div class="target2026-header">
            <div class="target2026-title">2026 출강 체결액 Target</div>
            <div class="target2026-sub">26 출강 체결 / 26 출강 타겟 (억)</div>
          </div>
          <div id="target2026Body" class="target2026-grid-wrap"><div class="target2026-grid"></div></div>
        </section>
      `;
      const bodyEl = document.getElementById("target2026Body");
      if (!bodyEl) return;
      bodyEl.innerHTML = `<div class="muted">불러오는 중...</div>`;
      try {
        const source = await loadTarget2026SourceRows();
        const allRows = [...(source.big || []), ...(source.mid || []), ...(source.small || [])];
        if (!allRows.length) {
          bodyEl.innerHTML = `<div class="muted">데이터가 없습니다. (DRI 데이터 없음)</div>`;
          return;
        }
        const kpis = buildTarget2026Kpis(source);
        const cards = kpis
          .map((kpi) => {
            const wonText = `${formatEokNumberOnly(kpi.won26 / 1e8)}억`;
            const tgtText = `${formatEokNumberOnly(kpi.target26 / 1e8)}억`;
            return `
              <div class="target2026-card ${kpi.rowClass}">
                <div class="target2026-card-title">${kpi.title}</div>
                <div class="target2026-card-metric">${wonText} / ${tgtText}</div>
              </div>
            `;
          })
          .join("");
        const grid = bodyEl.querySelector(".target2026-grid");
        if (grid) {
          grid.innerHTML = cards;
        } else {
          bodyEl.innerHTML = `<div class="target2026-grid">${cards}</div>`;
        }
      } catch (err) {
        bodyEl.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        showToast(`2026 체결액 Target 조회 오류: ${err.message}`, "error");
      }
    }

    async function renderDealQcR1R15Screen(contentRoot) {
      const modalId = "qcModalBackdrop";
      let modal = document.getElementById(modalId);
      if (!modal) {
        modal = document.createElement("div");
        modal.id = modalId;
        modal.className = "modal-backdrop qc-modal";
        modal.style.display = "none";
        modal.innerHTML = `
          <div class="modal xl" role="dialog" aria-modal="true">
            <div class="modal-header">
              <h3 id="qcModalTitle">담당자 상세</h3>
              <button type="button" class="close-btn" aria-label="닫기">&times;</button>
            </div>
            <div class="modal-body" id="qcModalBody"></div>
          </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener("click", (e) => {
          if (e.target === modal || e.target.classList.contains("close-btn")) {
            modal.style.display = "none";
          }
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.style.display === "flex") {
            modal.style.display = "none";
          }
        });
      }

      contentRoot.innerHTML = `
        <section class="card">
          <div class="control-row">
            <h2>개인별 세일즈맵 검수</h2>
          </div>
          <div class="muted" id="qcHint">since 2024-10-01 기준 · 총이슈 내림차순 (교육1/교육2/공공)</div>
          <div id="qcSummaryBody" class="muted">불러오는 중...</div>
        </section>
      `;

      const body = document.getElementById("qcSummaryBody");
      const modalBody = document.getElementById("qcModalBody");
      const modalTitle = document.getElementById("qcModalTitle");

      const renderSummaryTable = (teamLabel, people, teamKey) => {
        if (!people.length) return `<div class="muted">데이터가 없습니다.</div>`;
        const rows = people
          .map(
            (p, idx) => `
            <tr data-owner="${escapeHtml(p.ownerName)}" data-team="${teamKey}">
              <td>${idx + 1}</td>
              <td>${escapeHtml(p.ownerName)}</td>
              <td class="num">${p.totalIssues}</td>
            </tr>`
          )
          .join("");
        return `
          <div class="card" style="margin:0;">
            <div class="control-row" style="margin-bottom:8px;">
              <h3 style="margin:0;">${teamLabel}</h3>
              <div class="spacer"></div>
              <span class="muted">담당자 ${people.length}명</span>
            </div>
            <div class="qc-table-wrap">
              <table class="qc-table sticky">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>담당자</th>
                    <th class="num">총이슈</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>
        `;
      };

      const loadSummary = async () => {
        body.textContent = "불러오는 중...";
        state.dealQc.loading = true;
        state.dealQc.error = null;
        try {
          const teams = [
            { key: "edu1", label: "기업교육 1팀" },
            { key: "edu2", label: "기업교육 2팀" },
            { key: "public", label: "공공교육팀" },
          ];
          const timeout = (ms) =>
            new Promise((_, rej) => setTimeout(() => rej(new Error("요약 조회가 지연되고 있습니다.")), ms));
          const results = await Promise.race([
            Promise.all(
              teams.map(async (t) => {
                const data = await fetchJson(`/qc/deal-errors/summary?team=${t.key}`);
                const people = (data.people || []).slice().sort((a, b) => {
                  if (b.totalIssues !== a.totalIssues) return b.totalIssues - a.totalIssues;
                  return (a.ownerName || "").localeCompare(b.ownerName || "");
                });
                return { ...t, people };
              })
            ),
            timeout(15000),
          ]);
          const grid = results
            .map((r) => `<div>${renderSummaryTable(r.label, r.people, r.key)}</div>`)
            .join("");
          body.innerHTML = `<div class="qc-three-col">${grid}</div>`;
          body.querySelectorAll("tbody tr").forEach((tr) => {
            tr.addEventListener("click", async () => {
              const owner = tr.getAttribute("data-owner") || "";
              const teamKey = tr.getAttribute("data-team") || "all";
              await openDetail(owner, teamKey);
            });
          });
        } catch (err) {
          state.dealQc.error = err;
          body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
          showToast(`QC 요약 불러오기 실패: ${err.message}`, "error");
        } finally {
          state.dealQc.loading = false;
        }
      };

      const openDetail = async (owner, teamKey) => {
        state.dealQc.owner = owner;
        state.dealQc.team = teamKey;
        state.dealQc.detailLoading = true;
        state.dealQc.detailError = null;
        modalTitle.textContent = `${owner} 상세`;
        modalBody.innerHTML = `<div class="muted">불러오는 중...</div>`;
        modal.style.display = "flex";
        try {
          const detail = await fetchJson(
            `/qc/deal-errors/person?owner=${encodeURIComponent(owner)}&team=${encodeURIComponent(teamKey)}`
          );
          const items = detail.items || [];
          if (!items.length) {
            modalBody.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
            return;
          }
          const guidanceMap = {
            R1: "계약 체결일 입력",
            R2: "금액 입력",
            R3: "수강 시작/종료일 입력",
            R4: "코스 ID 입력",
            R5: "성사 가능성=확정으로 보정",
            R6: "상태=Lost이면 성사=LOST 보정",
            R7: "계약/수강일 순서 확인",
            R8: "카테고리 입력",
            R9: "과정포맷 입력",
            R10: "수주 예정일 입력",
            R11: "Convert 상태 확인",
            R12: "금액 또는 예상액 입력",
            R13: "상위조직/팀/직급/교육영역 입력",
            R14: "온라인 입과 주기/첫 회차 입력",
            R15: "강사 이름/강사비 입력",
          };
          const orgMaxLen = Math.max(
            0,
            ...items.map((d) => ((d.organizationName || d.organizationId || "").toString().length))
          );
          const peopleMaxLen = Math.max(
            0,
            ...items.map((d) => ((d.peopleName || d.peopleId || "").toString().length))
          );
          const orgMinCh = Math.min(60, Math.max(12, orgMaxLen + 2));
          const peopleMinCh = Math.min(60, Math.max(12, peopleMaxLen + 2));
          const dealMinCh = 16;
          const ruleOrder = ["R1","R2","R3","R4","R5","R6","R7","R8","R9","R10","R11","R12","R13","R14","R15"];
          const byRule = {};
          ruleOrder.forEach((r) => (byRule[r] = []));
          items.forEach((d) => {
            (d.issueCodes || []).forEach((code) => {
              if (byRule[code]) byRule[code].push(d);
            });
          });
          const sectionsArr = ruleOrder
            .map((code) => {
              const sectionItems = byRule[code] || [];
              if (!sectionItems.length) return "";
              const subtitle = guidanceMap[code] || "해당 규칙 확인";
              const rows = sectionItems
                .map((d) => {
                  const dealLink = d.dealId
                    ? `<a class="sm-link qc-deal-name qc-cell" href="${salesmapDealUrl(d.dealId)}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(d.dealName || d.dealId)}">${escapeHtml(d.dealName || d.dealId)}</a>`
                    : `<span class="qc-cell">${escapeHtml(d.dealName || d.dealId || "")}</span>`;
                  const orgLink = d.organizationId
                    ? `<a class="sm-link qc-cell" href="${salesmapOrgUrl(d.organizationId)}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(d.organizationName || d.organizationId)}">${escapeHtml(d.organizationName || d.organizationId)}</a>`
                    : `<span class="qc-cell">${escapeHtml(d.organizationName || d.organizationId || "")}</span>`;
                  const peopleLink = d.peopleId
                    ? `<a class="sm-link qc-cell" href="${salesmapPeopleUrl(d.peopleId)}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(d.peopleName || d.peopleId)}">${escapeHtml(d.peopleName || d.peopleId)}</a>`
                    : `<span class="qc-cell">${escapeHtml(d.peopleName || d.peopleId || "")}</span>`;
                  return `
                    <tr>
                      <td>${dealLink}</td>
                      <td>${orgLink}</td>
                      <td>${peopleLink}</td>
                    </tr>
                  `;
                })
                .join("");
              return `
                <section class="qc-rule-section">
                  <h4>${code} · ${subtitle}</h4>
                  <div class="qc-table-wrap">
                    <table class="qc-table sticky">
                      <colgroup>
                        <col style="min-width:${dealMinCh}ch;">
                        <col style="min-width:${orgMinCh}ch;">
                        <col style="min-width:${peopleMinCh}ch;">
                      </colgroup>
                      <thead>
                        <tr>
                          <th>Deal</th>
                          <th>Organization</th>
                          <th>People</th>
                        </tr>
                      </thead>
                      <tbody>${rows}</tbody>
                    </table>
                  </div>
                </section>
              `;
            })
            .filter(Boolean);
          if (!sectionsArr.length) {
            modalBody.innerHTML = `<div class="muted">위배된 규칙이 없습니다.</div>`;
          } else {
            modalBody.innerHTML = sectionsArr.join("");
          }
        } catch (err) {
          state.dealQc.detailError = err;
          modalBody.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
          showToast(`QC 상세 불러오기 실패: ${err.message}`, "error");
        } finally {
          state.dealQc.detailLoading = false;
        }
      };

      await loadSummary();
    }

    async function renderMismatch2025Screen(contentRoot) {
      contentRoot.innerHTML = `
        <section class="card">
          <div class="control-row">
            <h2>고객사 불일치 (Deal vs People)</h2>
            <div class="spacer"></div>
            <label class="muted">기업 규모</label>
            <select id="mismatchSizeSelect"></select>
          </div>
          <div class="muted">딜이 연결된 회사와 People이 연결된 회사가 다른 모든 딜을 보여줍니다. 딜/고객명을 클릭하면 Salesmap 원본으로 이동합니다.</div>
          <div id="mismatchBody" class="muted">불러오는 중...</div>
        </section>
      `;

      const sizeSelect = document.getElementById("mismatchSizeSelect");
      const body = document.getElementById("mismatchBody");

      try {
        const sizes = await getSizes();
        sizeSelect.innerHTML = sizes.map((s) => `<option value="${s}">${s}</option>`).join("");
        if (!sizes.includes(state.mismatchSize)) {
          state.mismatchSize = sizes.find((s) => s === "대기업") || sizes[0] || "전체";
        }
        sizeSelect.value = state.mismatchSize;
      } catch (err) {
        body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        showToast(`규모 목록을 불러오지 못했습니다: ${err.message}`, "error");
        return;
      }

      const refresh = async () => {
        body.textContent = "불러오는 중...";
        try {
          const items = await loadMismatchData(state.mismatchSize);
          body.innerHTML = renderMismatchTable(items);
          body.querySelectorAll(".org-link").forEach((cell) => {
            const orgId = cell.getAttribute("data-org-id");
            if (!orgId) return;
            cell.addEventListener("click", async () => {
              await navigateToOrg(orgId);
            });
          });
        } catch (err) {
          body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
          showToast(`불일치 목록을 불러오지 못했습니다: ${err.message}`, "error");
        }
      };

      sizeSelect.addEventListener("change", async (e) => {
        state.mismatchSize = e.target.value;
        await refresh();
      });

      await refresh();
    }

    async function renderRank2025PeopleScreen(contentRoot) {
      contentRoot.innerHTML = `
        <section class="card">
          <div class="control-row">
            <h2>2025 대기업 딜·People 매핑</h2>
            <div class="spacer"></div>
            <label class="muted">기업 규모</label>
            <select id="rankPeopleSizeSelect"></select>
            <label class="muted">회사</label>
            <select id="rankPeopleOrgSelect"></select>
            <label class="muted">상위 조직</label>
            <select id="rankPeopleUpperSelect"></select>
            <button id="rankPeopleReset" type="button">필터 리셋</button>
          </div>
          <div class="muted" id="rankPeopleHint">불러오는 중...</div>
          <div id="rankPeopleBody" class="muted">불러오는 중...</div>
        </section>
      `;

      const sizeSelect = document.getElementById("rankPeopleSizeSelect");
      const orgSelect = document.getElementById("rankPeopleOrgSelect");
      const upperSelect = document.getElementById("rankPeopleUpperSelect");
      const resetBtn = document.getElementById("rankPeopleReset");
      const hint = document.getElementById("rankPeopleHint");
      const body = document.getElementById("rankPeopleBody");
      let currentItems = [];

      const applyFilters = () => {
        const eligible = currentItems.filter((row) => {
          const upper = normalizeUpperOrg(row.upper_org);
          const team = (row.team_signature || "").trim();
          // 상위 조직과 팀이 모두 미입력일 때만 제외
          return !(upper === "미입력" && (!team || team === "미입력"));
        });
        const orgOptions = currentItems.reduce((acc, row) => {
          if (row.orgId) {
            const label = row.orgName || row.orgId || "미입력";
            acc.set(row.orgId, label);
          }
          return acc;
        }, new Map());
        const upperOptions = Array.from(
          new Set(
            eligible
              .map((row) => normalizeUpperForDisplay(row.upper_org))
              .filter((u) => u && u !== "미입력")
          )
        );

        const orgOptionsHtml = ['<option value="">전체</option>'];
        Array.from(orgOptions.entries())
          .sort((a, b) => String(a[1] || "").localeCompare(String(b[1] || "")))
          .forEach(([id, name]) => orgOptionsHtml.push(`<option value="${id}">${name || "미입력"}</option>`));
        orgSelect.innerHTML = orgOptionsHtml.join("");
        if (state.rankPeopleOrgFilter && !orgOptions.has(state.rankPeopleOrgFilter)) {
          state.rankPeopleOrgFilter = "";
        }
        orgSelect.value = state.rankPeopleOrgFilter;

        const upperOptionsHtml = ['<option value="">전체</option>'];
        upperOptions.sort().forEach((u) => upperOptionsHtml.push(`<option value="${u}">${u}</option>`));
        upperSelect.innerHTML = upperOptionsHtml.join("");
        if (state.rankPeopleUpperFilter && !upperOptions.includes(state.rankPeopleUpperFilter)) {
          state.rankPeopleUpperFilter = "";
        }
        upperSelect.value = state.rankPeopleUpperFilter;

        const filtered = eligible.filter((row) => {
          if (state.rankPeopleOrgFilter && row.orgId !== state.rankPeopleOrgFilter) return false;
          if (
            state.rankPeopleUpperFilter &&
            normalizeUpperForDisplay(row.upper_org) !== state.rankPeopleUpperFilter
          )
            return false;
          return true;
        });

        hint.textContent = `총 ${filtered.length}명 · 회사 ${orgOptions.size}곳`;
        body.innerHTML = renderRankPeopleTable(filtered);
        body.querySelectorAll(".org-link").forEach((cell) => {
          cell.addEventListener("click", async () => {
            const idx = Number(cell.getAttribute("data-idx"));
            const row = filtered[idx];
            if (!row) return;
            await navigateToOrg(row.orgId);
          });
        });
        body.querySelectorAll('button[data-action="deals"]').forEach((btn) => {
          btn.addEventListener("click", () => {
            const idx = Number(btn.getAttribute("data-idx"));
            const row = filtered[idx];
            if (!row) return;
            const label = `${row.personName || "(연결 안 됨)"} @ ${row.orgName || row.orgId || "-"}`;
            openDealsModal(label, row.deals || []);
          });
        });
        resetBtn.disabled =
          !state.rankPeopleOrgFilter && !state.rankPeopleUpperFilter && state.rankPeopleSize === (sizeSelect.value || "");
      };

      const refreshSize = async () => {
        body.textContent = "불러오는 중...";
        hint.textContent = "불러오는 중...";
        try {
          currentItems = await loadRankPeopleData(state.rankPeopleSize);
          applyFilters();
        } catch (err) {
          body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
          hint.textContent = "데이터를 불러오지 못했습니다.";
          showToast(`2025 딜·People 조회 오류: ${err.message}`, "error");
        }
      };

      try {
        const sizes = await getSizes();
        sizeSelect.innerHTML = sizes.map((s) => `<option value="${s}">${s}</option>`).join("");
        if (!sizes.includes(state.rankPeopleSize)) {
          state.rankPeopleSize = sizes.find((s) => s === "대기업") || sizes[0] || "전체";
        }
        sizeSelect.value = state.rankPeopleSize;
      } catch (err) {
        body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        hint.textContent = "규모 목록을 불러오지 못했습니다.";
        showToast(`규모 목록 오류: ${err.message}`, "error");
        return;
      }

      sizeSelect.addEventListener("change", async (e) => {
        state.rankPeopleSize = e.target.value;
        state.rankPeopleOrgFilter = "";
        state.rankPeopleUpperFilter = "";
        await refreshSize();
      });

      orgSelect.addEventListener("change", () => {
        state.rankPeopleOrgFilter = orgSelect.value;
        applyFilters();
      });

      upperSelect.addEventListener("change", () => {
        state.rankPeopleUpperFilter = upperSelect.value;
        applyFilters();
      });

      resetBtn.addEventListener("click", () => {
        state.rankPeopleOrgFilter = "";
        state.rankPeopleUpperFilter = "";
        orgSelect.value = "";
        upperSelect.value = "";
        applyFilters();
      });

      await refreshSize();
    }

    async function renderStatePathMenu(contentRoot) {
      contentRoot.innerHTML = `
        <section class="card sp-header-card sp-card">
          <div class="sp-header-row">
            <button id="statepathOpenFilterDrawer" class="sp-filter-cta" type="button" title="필터 열기" aria-haspopup="dialog" aria-controls="statepathFilterDrawer">
              <span class="sp-filter-cta__icon" aria-hidden="true">⛭</span>
              <span class="sp-filter-cta__text">필터</span>
              <span id="statepathFilterCount" class="sp-filter-cta__badge">0</span>
            </button>
            <div id="statepathAppliedBar" class="sp-applied-bar"></div>
            <button id="statepathClearAll" class="sp-clear-btn" type="button" title="필터 전체 해제">전체 해제</button>
          </div>
        </section>
        <section class="card sp-snap-card sp-card">
          <div class="control-row">
            <h2>Snapshot</h2>
            <div class="spacer"></div>
            ${renderStatePathHelpButton("snapshot")}
          </div>
          <div id="statepathSnapshots"></div>
        </section>
        <section class="card sp-card">
          <div class="control-row">
            <h2>Pattern Explorer</h2>
            <div class="spacer"></div>
            ${renderStatePathHelpButton("pattern")}
          </div>
          <div id="statepathTransitionMatrix"></div>
          <div id="statepathCellMatrix" style="margin-top:10px;"></div>
          <div id="statepathRailSummary" style="margin-top:10px;"></div>
          <div id="statepathTopPatterns"></div>
        </section>
        <section class="card sp-card">
          <div id="statepathStatus" class="muted">불러오는 중...</div>
          <div id="statepathTableWrap"></div>
        </section>
        <div id="statepathFilterBackdrop" class="sp-drawer-backdrop"></div>
        <aside id="statepathFilterDrawer" class="sp-drawer" role="dialog" aria-modal="true" aria-label="StatePath Filters">
          <div class="sp-drawer__header">
            <div>
              <div style="font-weight:700;">필터</div>
              <div class="sp-drawer__hint">변경 즉시 테이블/스냅샷이 갱신됩니다. (서버 재호출 없음)</div>
              <div class="sp-drawer__hint">DB를 교체했다면 브라우저 새로고침이 필요합니다. (클라이언트 캐시 무효화 없음)</div>
            </div>
            <button id="statepathCloseFilterDrawer" class="sp-icon-btn" aria-label="닫기">✕</button>
          </div>
          <div class="sp-drawer__body">
            <div class="sp-drawer__section">
              <div class="sp-drawer__title">기업 규모</div>
              <div class="sp-drawer__hint">변경 시 서버에서 목록을 다시 불러옵니다.</div>
              <div id="statepathSegmentPicker"></div>
            </div>
            <div class="sp-drawer__section">
              <div class="sp-drawer__title">2024 티어</div>
              <div id="statepathTier2024Wrap"></div>
            </div>
            <div class="sp-drawer__section">
              <div class="sp-drawer__title">Quick Filters</div>
              <div class="sp-drawer__hint">자주 쓰는 필터(위험/오픈/성장 방향 등)</div>
              <div id="statepathQuickFilters"></div>
            </div>
          </div>
        </aside>
      `;

      const spState = state.statepath2425;
      spState.search = "";
      spState.sort = "won2025_desc";
      bindStatepathFilterDrawerEvents();
      renderSegmentPickerInDrawer();

      if (typeof sessionStorage !== "undefined") {
        const hintKey = "sp_filter_hint_shown";
        const btn = document.getElementById("statepathOpenFilterDrawer");
        try {
          const shown = sessionStorage.getItem(hintKey);
          if (!shown && btn) {
            btn.classList.add("hint-pulse");
            setTimeout(() => btn.classList.remove("hint-pulse"), 2400);
            sessionStorage.setItem(hintKey, "1");
          }
        } catch (e) {
          if (btn) {
            btn.classList.add("hint-pulse");
            setTimeout(() => btn.classList.remove("hint-pulse"), 2400);
          }
        }
      }
      const clearBtn = document.getElementById("statepathClearAll");
      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          resetStatepathClientFilters();
          spState.segment = "전체";
          renderSegmentPickerInDrawer();

      if (typeof sessionStorage !== "undefined") {
        const hintKey = "sp_filter_hint_shown";
        const btn = document.getElementById("statepathOpenFilterDrawer");
        try {
          const shown = sessionStorage.getItem(hintKey);
          if (!shown && btn) {
            btn.classList.add("hint-pulse");
            setTimeout(() => btn.classList.remove("hint-pulse"), 2400);
            sessionStorage.setItem(hintKey, "1");
          }
        } catch (e) {
          if (btn) {
            btn.classList.add("hint-pulse");
            setTimeout(() => btn.classList.remove("hint-pulse"), 2400);
          }
        }
      }
          loadStatePathPortfolio2425(true);
        });
      }
      updateStatepathFilterCountBadge();
      renderTier2024Filter();
      renderStatePathTable();
      renderStatePathSnapshots();
      renderStatePathPatterns();
      renderBreadcrumbs();
      bindStatePathHelpButtons(contentRoot);
      await loadStatePathPortfolio2425(false);
    }


    async function renderIndustryMenu(contentRoot) {
      contentRoot.innerHTML = `
        <section class="card">
          <div class="control-row">
            <h2>업종별 매출 (23/24/25 Won)</h2>
            <div class="spacer"></div>
            <span class="muted">업종 구분(대)별 연도별 Won 합계</span>
          </div>
          <div class="quad-grid">
            <div>
              <h3 class="muted">대기업</h3>
              <div id="industryLargeBody"></div>
            </div>
            <div>
              <h3 class="muted">중견기업</h3>
              <div id="industryMidBody"></div>
            </div>
          </div>
        </section>
      `;
      const largeBody = document.getElementById("industryLargeBody");
      const midBody = document.getElementById("industryMidBody");

      const renderSummary = (container, items) => {
        if (!container) return;
        if (!items || !items.length) {
          container.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
          return;
        }
        container.innerHTML = `
          <div class="table-wrap full">
            <table>
              <thead>
                <tr>
                  <th>업종 구분(대)</th>
                  <th>2023 Won(억)</th>
                  <th>2024 Won(억)</th>
                  <th>2025 Won(억)</th>
                  <th>회사 수</th>
                </tr>
              </thead>
              <tbody>
                ${items
                  .map(
                    (row) =>
                      `<tr>
                        <td>${row.industry}</td>
                        <td>${formatAmount(row.won2023)}</td>
                        <td>${formatAmount(row.won2024)}</td>
                        <td>${formatAmount(row.won2025)}</td>
                        <td>${row.orgCount || 0}</td>
                      </tr>`
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
      };

      try {
        const [largeItems, midItems] = await Promise.all([
          fetchJson("/rank/won-industry-summary?size=대기업").then((d) => d.items || []),
          fetchJson("/rank/won-industry-summary?size=중견기업").then((d) => d.items || []),
        ]);
        renderSummary(largeBody, largeItems);
        renderSummary(midBody, midItems);
      } catch (err) {
        renderSummary(largeBody, []);
        renderSummary(midBody, []);
        showToast(`업종별 매출 조회 오류: ${err.message}`, "error");
      }
    }

    function initApp() {
      bindGlobalModalsOnce();
      renderSidebar();
      renderContent();
    }

    document.addEventListener("DOMContentLoaded", initApp);

  </script>
</body>

</html>
