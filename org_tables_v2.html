<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>조직/People/Deal 빠른 뷰어 (FastAPI)</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --panel-2: #0c1424;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --accent-2: #f97316;
      --success: #22c55e;
      --error: #f87171;
      --shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Pretendard', 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 18% 12%, rgba(56, 189, 248, 0.08), transparent 28%),
        radial-gradient(circle at 84% 8%, rgba(249, 115, 22, 0.07), transparent 26%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      background: linear-gradient(145deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 12px;
      align-items: start;
    }

    .sidebar {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 200px;
    }

    .menu-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .menu-title {
      color: var(--muted);
      font-size: 13px;
      letter-spacing: 0.01em;
    }

    .menu-item {
      width: 100%;
      text-align: left;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1d30;
      color: var(--text);
      padding: 10px;
      cursor: pointer;
      transition: border-color 0.15s ease, background 0.15s ease;
    }

    .menu-item:hover {
      border-color: var(--accent);
    }

    .menu-item.active {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.12);
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.01em;
    }

    .control-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .spacer {
      flex: 1;
    }

    select,
    button,
    input {
      background: #0c182c;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px 11px;
      font-size: 14px;
    }

    input[type="text"] {
      min-width: 220px;
    }

    button {
      background: linear-gradient(120deg, #0f213a, #122a49);
      cursor: pointer;
      transition: border-color 0.15s ease, transform 0.1s ease;
    }

    button:hover {
      border-color: var(--accent);
    }

    button:active {
      transform: translateY(1px);
    }

    .main-vertical {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 220px;
    }

    .card h2 {
      margin: 0;
      font-size: 15px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quad-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
      align-items: stretch;
      min-height: 320px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .code-block {
      background: #0c182c;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 320px;
      overflow: auto;
    }

    .json-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: start;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .col {
      flex: 1 1 0;
      min-width: 280px;
    }


    .json-box {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0c182c;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 120px;
    }

    th,
    td {
      padding: 8px 9px;
      border-bottom: 1px solid var(--border);
    }

    th {
      text-align: left;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    tr:hover {
      background: rgba(56, 189, 248, 0.08);
    }

    tr.active {
      background: rgba(56, 189, 248, 0.14);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .table-wrap {
      overflow: auto;
      max-height: 320px;
      border: 1px solid var(--border);
      border-radius: 10px;
      height: 100%;
    }

    .table-wrap.full {
      max-height: none;
    }

    .table-wrap.half {
      max-height: none;
    }

    .breadcrumb {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #0c182c;
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.15);
      color: var(--accent);
      font-size: 11px;
      letter-spacing: 0.02em;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
    }

    .status.good {
      color: var(--success);
    }

    .status.bad {
      color: var(--error);
    }
    .memo-text {
      white-space: pre-wrap;
    }

    .toast {
      position: fixed;
      bottom: 18px;
      right: 18px;
      background: #111827;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      min-width: 220px;
      max-width: 340px;
      font-size: 13px;
      color: var(--text);
      display: none;
    }

    .toast.error {
      border-color: rgba(248, 113, 113, 0.4);
      color: var(--error);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 16px;
    }

    .modal {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      max-width: 520px;
      width: 100%;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal header {
      background: none;
      border: none;
      box-shadow: none;
      padding: 0;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }

    .modal h3 {
      margin: 0;
      font-size: 16px;
      color: var(--text);
    }

    .modal .meta {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .modal .body {
      background: #0c182c;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      white-space: pre-wrap;
      line-height: 1.45;
      max-height: 360px;
      overflow: auto;
    }

    .modal .code-body {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      word-break: break-all;
    }

    .json-modal {
      max-width: 1040px;
      width: 100%;
    }

    .json-modal .body {
      max-height: 720px;
    }

    .webform-modal {
      max-width: 1040px;
      width: 100%;
    }

    .webform-modal .body {
      max-height: 540px;
      white-space: normal;
      overflow: auto;
    }

    .close-btn {
      background: #1f2937;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        flex-direction: row;
        flex-wrap: wrap;
      }
      .menu-item {
        flex: 1;
        min-width: 140px;
        text-align: center;
      }
      .quad-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
      }
      .table-wrap {
        max-height: 260px;
      }
      .json-grid {
        grid-template-columns: 1fr;
      }
    }

  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="menu-title">메뉴</div>
      <ul id="menuList" class="menu-list"></ul>
    </aside>

    <div class="content">
      <div id="contentRoot"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal-backdrop" id="memoModalBackdrop">
    <div class="modal">
      <header>
        <h3>메모 상세</h3>
        <button class="close-btn" id="memoModalClose" type="button">닫기</button>
      </header>
      <div class="meta">
        <span id="memoModalDate">-</span>
        <span id="memoModalAuthor">-</span>
      </div>
      <div class="body" id="memoModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="jsonModalBackdrop">
    <div class="modal json-modal">
      <header>
        <h3 id="jsonModalTitle">JSON 보기</h3>
        <button class="close-btn" id="jsonModalClose" type="button">닫기</button>
      </header>
      <div class="body code-body" id="jsonModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="webformModalBackdrop">
    <div class="modal webform-modal">
      <header>
        <h3 id="webformModalTitle">웹폼 내역</h3>
        <button class="close-btn" id="webformModalClose" type="button">닫기</button>
      </header>
      <div class="body" id="webformModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="dealsModalBackdrop">
    <div class="modal json-modal">
      <header>
        <h3 id="dealsModalTitle">딜 목록</h3>
        <button class="close-btn" id="dealsModalClose" type="button">닫기</button>
      </header>
      <div class="body code-body" id="dealsModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="statePathModalBackdrop">
    <div class="modal json-modal">
      <header>
        <h3 id="statePathModalTitle">StatePath</h3>
        <button class="close-btn" id="statePathModalClose" type="button">닫기</button>
      </header>
      <div class="body" id="statePathModalBody"></div>
    </div>
  </div>

  <script>
    const API_BASE = (() => {
      const origin = window.location.origin;
      if (origin && origin !== "null" && origin.startsWith("http")) {
        return origin.replace(/\/$/, "") + "/api";
      }
      return "http://localhost:8000/api";
    })();
    const PART_STRUCTURE = {
      "기업교육 1팀": {
        "1파트": ["김솔이", "황초롱", "김정은", "김동찬", "정태윤", "서정연", "오진선"],
        "2파트": ["강지선", "정하영", "박범규", "하승민", "이은서", "김세연"],
      },
      "기업교육 2팀": {
        "1파트": ["권노을", "이윤지B", "이현진", "김민선", "강연정", "방신우", "홍제환"],
        "2파트": ["정다혜", "임재우", "송승희", "손승완", "김윤지", "손지훈", "홍예진"],
        "온라인셀": ["강진우", "강다현", "이수빈"],
      },
    };
    const SALESMAP_WORKSPACE_PATH = "64cb5beda5a78ae225d7815b"; // update if workspace path changes
    const ORG_LIMIT = 200;
    let DEBUG_ORG_SELECT = Boolean(window.DEBUG_ORG_SELECT);
    window.setOrgSelectDebug = (flag) => {
      DEBUG_ORG_SELECT = Boolean(flag);
      window.DEBUG_ORG_SELECT = DEBUG_ORG_SELECT;
      console.log("[orgSelect] debug mode:", DEBUG_ORG_SELECT);
    };

    const menuConfig = [
      { id: "rank-2025", label: "2025년 체결액 순위", render: renderRank2025Screen },
      { id: "rank-2025-people", label: "2025 대기업 딜·People", render: renderRank2025PeopleScreen },
      { id: "mismatch-2025", label: "고객사 불일치", render: renderMismatch2025Screen },
      { id: "industry-2025", label: "업종별 매출", render: renderIndustryMenu },
      { id: "org-view", label: "조직/People/Deal 뷰어", render: renderOrgScreen },
    ];

    const state = {
      activeMenuId: "org-view",
      size: "대기업",
      rankSize: "전체",
      rankPeopleSize: "대기업",
      rankPeopleOrgFilter: "",
      rankPeopleUpperFilter: "",
      mismatchSize: "대기업",
      rankMultipliers: {
        S0: 1.2,
        P0: 1.3,
        P1: 1.5,
        P2: 1.5,
        P3: 1.75,
        P4: 2.0,
        P5: 2.0,
      },
      rankPeopleModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
        bound: false,
      },
      orgs: [],
      orgSearch: "",
      selectedOrg: null,
      wonGroupJson: null,
      wonGroupJsonCompact: null,
      filteredWonGroupJson: null,
      filteredWonGroupJsonCompact: null,
      statePath: null,
      selectedUpperOrg: null,
      people: [],
      selectedPerson: null,
      deals: [],
      selectedDeal: null,
      orgMemos: [],
      personMemos: [],
      dealMemos: [],
      wonSummary: [],
      modal: {
        backdrop: null,
        close: null,
        date: null,
        author: null,
        body: null,
        bound: false,
      },
      webformModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
      },
      jsonModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
        bound: false,
      },
      statePathModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
      },
      rankPeopleModal: {
        backdrop: null,
        close: null,
        title: null,
        body: null,
        bound: false,
      },
      pendingOrgId: null,
      pendingOrgFallback: null,
      wonSummaryCleared: false,
    };

    const cache = {
      sizes: null,
      wonGroupJsonByOrg: new Map(),
      wonGroupJsonCompactByOrg: new Map(),
      statePathByOrg: new Map(),
      orgMemos: new Map(),
      peopleByOrg: new Map(),
      deals: new Map(),
      personMemos: new Map(),
      dealMemos: new Map(),
      rank2025BySize: new Map(),
      rank2025PeopleBySize: new Map(),
      mismatch2025BySize: new Map(),
      orgLookup: new Map(),
      wonSummary: new Map(),
      yearlyTotals: null,
    };
    const NAME_TO_TEAM_PART = buildNameToTeamPartIndex(PART_STRUCTURE);

    function showToast(message, tone = "info") {
      const el = document.getElementById("toast");
      el.textContent = message;
      el.className = `toast ${tone === "error" ? "error" : ""}`;
      el.style.display = "block";
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => {
        el.style.display = "none";
      }, 3200);
    }

    function buildNameToTeamPartIndex(structure) {
      const index = new Map();
      const add = (name, team, part) => {
        const key = (name || "").trim();
        if (!key) return;
        const existing = index.get(key);
        if (existing && (existing.team !== team || existing.part !== part)) {
          index.set(key, { ambiguous: true });
          return;
        }
        if (!existing) {
          index.set(key, { team, part });
        }
      };
      Object.entries(structure || {}).forEach(([team, parts]) => {
        Object.entries(parts || {}).forEach(([part, names]) => {
          (names || []).forEach((n) => add(n, team, part));
        });
      });
      return index;
    }

    function stripTrailingLetter(name) {
      if (!name) return "";
      const trimmed = name.trim();
      if (/^[\s]*$/.test(trimmed)) return "";
      if (/[A-Za-z]$/.test(trimmed)) {
        return trimmed.slice(0, -1);
      }
      return trimmed;
    }

    function resolveOwnerTeamPart(name) {
      const trimmed = (name || "").trim();
      if (!trimmed) return { team: null, part: null, ambiguous: false, missing: true };
      const entry = NAME_TO_TEAM_PART.get(trimmed);
      if (entry) {
        if (entry.ambiguous) return { team: null, part: null, ambiguous: true, missing: false };
        return { team: entry.team, part: entry.part, ambiguous: false, missing: false };
      }
      const base = stripTrailingLetter(trimmed);
      if (base && base !== trimmed) {
        const alt = NAME_TO_TEAM_PART.get(base);
        if (alt) {
          if (alt.ambiguous) return { team: null, part: null, ambiguous: true, missing: false };
          return { team: alt.team, part: alt.part, ambiguous: false, missing: false };
        }
      }
      return { team: null, part: null, ambiguous: false, missing: true };
    }

    function computeTeamPartSummary(owners) {
      const names = Array.isArray(owners) ? owners.filter(Boolean) : [];
      if (!names.length) {
        return { ownersText: "-", teamPartText: "-", dri: "X" };
      }

      const unknownNames = [];
      const comboCounts = new Map();
      const comboMeta = new Map();
      names.forEach((name) => {
        const resolved = resolveOwnerTeamPart(name);
        if (resolved.ambiguous || resolved.missing || !resolved.team || !resolved.part) {
          unknownNames.push(name);
          return;
        }
        const key = `${resolved.team} ${resolved.part}`;
        comboCounts.set(key, (comboCounts.get(key) || 0) + 1);
        if (!comboMeta.has(key)) comboMeta.set(key, { team: resolved.team, part: resolved.part });
      });

      const ownersText = names.join(", ");

      if (unknownNames.length) {
        return {
          ownersText,
          teamPartText: `미확인(${unknownNames.join(", ")})`,
          dri: "X",
        };
      }

      if (!comboCounts.size) {
        return { ownersText, teamPartText: "-", dri: "X" };
      }

      const combos = Array.from(comboCounts.entries()).map(([key, count]) => {
        const meta = comboMeta.get(key) || { team: "", part: "" };
        return { key, count, team: meta.team, part: meta.part };
      });
      combos.sort((a, b) => {
        if (b.count !== a.count) return b.count - a.count;
        if (a.team !== b.team) return a.team.localeCompare(b.team);
        return a.part.localeCompare(b.part);
      });

      const displayCombos = combos.map((c) => c.key);
      let teamPartText = "";
      if (displayCombos.length === 1) {
        teamPartText = displayCombos[0];
      } else if (displayCombos.length === 2) {
        teamPartText = `${displayCombos[0]} / ${displayCombos[1]}`;
      } else {
        const extra = displayCombos.length - 2;
        teamPartText = `${displayCombos[0]} / ${displayCombos[1]} 외 ${extra}`;
      }

      const dri =
        displayCombos.length === 1 && !displayCombos[0].includes("셀")
          ? "O"
          : "X";

      return { ownersText, teamPartText, dri };
    }

    function openStatePathModal(item) {
      if (!state.statePathModal.backdrop || !state.statePathModal.body) return;
      const body = state.statePathModal.body;
      if (state.statePathModal.title) {
        state.statePathModal.title.textContent = `StatePath - ${item.company_name || state.selectedOrg || ""}`;
      }
      const rowsYear = ["2024", "2025"]
        .map((y) => {
          const st = item.year_states?.[y] || {};
          return `<tr>
            <td>${y}</td>
            <td>${formatEok(st.total_eok || 0)} (${st.bucket || "-"})</td>
            <td>${formatEok(st.online_eok || 0)} (${st.bucket_online || "-"})</td>
            <td>${formatEok(st.offline_eok || 0)} (${st.bucket_offline || "-"})</td>
            <td>${formatEok(st.hrd_eok || 0)}</td>
            <td>${formatEok(st.bu_eok || 0)}</td>
          </tr>`;
        })
        .join("");

      const cells = ["HRD_ONLINE", "HRD_OFFLINE", "BU_ONLINE", "BU_OFFLINE"]
        .map((cell) => {
          const c24 = item.year_states?.["2024"]?.cells?.[cell] || {};
          const c25 = item.year_states?.["2025"]?.cells?.[cell] || {};
          return `<tr>
            <td>${cell}</td>
            <td>${formatEok(c24.amt_eok || 0)} (${c24.bucket || "-"})</td>
            <td>${formatEok(c25.amt_eok || 0)} (${c25.bucket || "-"})</td>
          </tr>`;
        })
        .join("");

      const events = item.path_2024_to_2025?.events || [];
      const eventsHtml = events.length
        ? events
            .map(
              (ev) =>
                `<li><strong>${ev.type}</strong> ${ev.cell ? ev.cell + ": " : ""}${ev.from || ""} → ${ev.to || ""} ${ev.rail ? `(${ev.rail})` : ""}</li>`
            )
            .join("")
        : "<li>변화 이벤트 없음</li>";

      const reco = item.ops_reco || {};
      const targets = (reco.target_counterparties || [])
        .map(
          (t) =>
            `<tr><td>${t.rank}</td><td>${t.upper_org || "-"}</td><td>${t.lane || "-"}</td><td>${formatEok(t.amt_2024_eok || 0)}</td><td>${formatEok(t.amt_2025_eok || 0)}</td></tr>`
        )
        .join("");
      const plays = (reco.action_play_top3 || [])
        .map((p) => `<li><strong>${p.type}</strong>: ${p.text}</li>`)
        .join("") || "<li>추천 없음</li>";

      body.innerHTML = `
        <section class="card">
          <h3>연도별 요약</h3>
          <div class="table-wrap full">
            <table>
              <thead><tr><th>연도</th><th>총액(억)</th><th>온라인(억)</th><th>오프라인(억)</th><th>HRD(억)</th><th>BU(억)</th></tr></thead>
              <tbody>${rowsYear}</tbody>
            </table>
          </div>
        </section>
        <section class="card">
          <h3>4셀 비교</h3>
          <div class="table-wrap full">
            <table>
              <thead><tr><th>셀</th><th>2024</th><th>2025</th></tr></thead>
              <tbody>${cells}</tbody>
            </table>
          </div>
        </section>
        <section class="card">
          <h3>Path 이벤트 (Seed: ${item.path_2024_to_2025?.seed || "-"})</h3>
          <ul>${eventsHtml}</ul>
        </section>
        <section class="card">
          <h3>RevOps 추천</h3>
          <div>Objective: <strong>${reco.next_objective_type || "-"}</strong>, Target Cell: <strong>${reco.next_target_cell || "-"}</strong></div>
          <div class="table-wrap full">
            <table>
              <thead><tr><th>랭크</th><th>상위 조직</th><th>Lane</th><th>2024(억)</th><th>2025(억)</th></tr></thead>
              <tbody>${targets}</tbody>
            </table>
          </div>
          <ul>${plays}</ul>
        </section>
      `;
      if (state.statePathModal.backdrop) state.statePathModal.backdrop.style.display = "flex";
    }

    function closeStatePathModal() {
      if (state.statePathModal.backdrop) state.statePathModal.backdrop.style.display = "none";
    }

    function toJsonText(data) {
      if (data === null || data === undefined) return "";
      try {
        return JSON.stringify(data, null, 2);
      } catch (_) {
        return "";
      }
    }

    async function copyJsonData(data) {
      const text = toJsonText(data);
      if (!text.trim()) {
        showToast("복사할 JSON이 없습니다.", "error");
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        showToast("JSON을 복사했습니다.", "success");
      } catch (_) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        showToast("JSON을 복사했습니다.", "success");
      }
    }

    function openJsonModal(title, data) {
      if (!state.jsonModal.backdrop || !state.jsonModal.body || !state.jsonModal.title) return;
      const text = toJsonText(data);
      if (!text.trim()) {
        showToast("표시할 JSON이 없습니다.", "error");
        return;
      }
      state.jsonModal.title.textContent = title || "JSON 보기";
      state.jsonModal.body.textContent = text;
      state.jsonModal.backdrop.style.display = "flex";
    }

    function openDealsModal(personLabel, deals) {
      if (!state.rankPeopleModal.backdrop || !state.rankPeopleModal.title || !state.rankPeopleModal.body) return;
      const list = Array.isArray(deals) ? deals : [];
      const body = state.rankPeopleModal.body;
      if (!list.length) {
        body.innerHTML = `<div class="muted">딜이 없습니다.</div>`;
      } else {
        body.innerHTML = `
          <div class="table-wrap full">
            <table>
              <thead>
                <tr>
                  <th>생성일</th>
                  <th>딜 이름</th>
                  <th>상태</th>
                  <th>금액(억)</th>
                  <th>계약 체결일</th>
                  <th>과정포맷</th>
                </tr>
              </thead>
              <tbody>
                ${list
                  .map(
                    (d) => `
                      <tr>
                        <td>${formatDate(d.created_at)}</td>
                        <td>${d.dealName || "-"}</td>
                        <td>${d.status || "-"}</td>
                        <td>${formatAmount(d.amount)}</td>
                        <td>${formatDate(d.contract_date)}</td>
                        <td>${d.course_format || "-"}</td>
                      </tr>
                    `
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
      }
      state.rankPeopleModal.title.textContent = personLabel || "딜 목록";
      state.rankPeopleModal.backdrop.style.display = "flex";
    }

    function closeDealsModal() {
      if (!state.rankPeopleModal.backdrop) return;
      state.rankPeopleModal.backdrop.style.display = "none";
    }

    function closeJsonModal() {
      if (!state.jsonModal.backdrop) return;
      state.jsonModal.backdrop.style.display = "none";
    }

    function ensureRankModals() {
      let guide = document.getElementById("rankGuideModalBackdrop");
      let mult = document.getElementById("rankMultiplierModalBackdrop");
      if (!guide) {
        const tpl = document.createElement("div");
        tpl.innerHTML = `
          <div class="modal-backdrop" id="rankGuideModalBackdrop" style="display:none;">
            <div class="modal">
              <div class="modal-header">
                <h3>등급 구간</h3>
                <button id="rankGuideModalClose" type="button">닫기</button>
              </div>
              <div class="modal-body" id="rankGuideModalBody"></div>
            </div>
          </div>
          <div class="modal-backdrop" id="rankMultiplierModalBackdrop" style="display:none;">
            <div class="modal">
              <div class="modal-header">
                <h3>등급별 배수 설정</h3>
                <button id="rankMultiplierModalClose" type="button">닫기</button>
              </div>
              <div class="modal-body" id="rankMultiplierModalBody"></div>
              <div class="control-row" style="margin-top:10px; justify-content:flex-end;">
                <button id="applyRankMultipliers" type="button">연산</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(tpl);
      }
      // cache references
      state.rankGuideModal = {
        backdrop: document.getElementById("rankGuideModalBackdrop"),
        close: document.getElementById("rankGuideModalClose"),
        body: document.getElementById("rankGuideModalBody"),
      };
      state.rankMultiplierModal = {
        backdrop: document.getElementById("rankMultiplierModalBackdrop"),
        close: document.getElementById("rankMultiplierModalClose"),
        body: document.getElementById("rankMultiplierModalBody"),
        apply: document.getElementById("applyRankMultipliers"),
      };
      if (state.rankGuideModal.close && state.rankGuideModal.backdrop) {
        state.rankGuideModal.close.addEventListener("click", () => closeRankGuideModal());
        state.rankGuideModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.rankGuideModal.backdrop) closeRankGuideModal();
        });
      }
      if (state.rankMultiplierModal.close && state.rankMultiplierModal.backdrop) {
        state.rankMultiplierModal.close.addEventListener("click", () => closeMultiplierModal());
        state.rankMultiplierModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.rankMultiplierModal.backdrop) closeMultiplierModal();
        });
      }
    }

    function openGradeGuideModal() {
      const modal = state.rankGuideModal;
      if (!modal || !modal.body || !modal.backdrop) return;
      modal.body.innerHTML = `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr><th>등급</th><th>구간(억, 이상~미만)</th></tr>
            </thead>
            <tbody>
              <tr><td>S0</td><td>10 이상</td></tr>
              <tr><td>P0</td><td>2 이상 ~ 10 미만</td></tr>
              <tr><td>P1</td><td>1 이상 ~ 2 미만</td></tr>
              <tr><td>P2</td><td>0.5 이상 ~ 1 미만</td></tr>
              <tr><td>P3</td><td>0.25 이상 ~ 0.5 미만</td></tr>
              <tr><td>P4</td><td>0.1 이상 ~ 0.25 미만</td></tr>
              <tr><td>P5</td><td>0.1 미만</td></tr>
            </tbody>
          </table>
        </div>
      `;
      modal.backdrop.style.display = "flex";
    }

    function openMultiplierModal(onApplied) {
      const modal = state.rankMultiplierModal;
      if (!modal || !modal.body || !modal.backdrop) return;
      modal.body.innerHTML = `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr><th>등급</th><th>배수</th></tr>
            </thead>
            <tbody>
              ${["S0","P0","P1","P2","P3","P4","P5"].map((g) => `
                <tr>
                  <td>${g}</td>
                  <td><input id="multiplier-${g}" type="number" step="0.01" min="0" style="width: 80px;" value="${state.rankMultipliers[g] ?? ""}" /></td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
      if (modal.apply) {
        modal.apply.onclick = () => {
          const next = { ...state.rankMultipliers };
          ["S0","P0","P1","P2","P3","P4","P5"].forEach((g) => {
            const el = document.getElementById(`multiplier-${g}`);
            if (!el) return;
            const val = parseFloat(el.value);
            if (Number.isFinite(val) && val > 0) {
              next[g] = val;
            }
          });
          state.rankMultipliers = next;
          closeMultiplierModal();
          if (onApplied) onApplied();
          showToast("배수를 적용했습니다.", "success");
        };
      }
      modal.backdrop.style.display = "flex";
    }

    function closeRankGuideModal() {
      if (state.rankGuideModal?.backdrop) state.rankGuideModal.backdrop.style.display = "none";
    }

    function closeMultiplierModal() {
      if (state.rankMultiplierModal?.backdrop) state.rankMultiplierModal.backdrop.style.display = "none";
    }

    function openMemoModal({ createdAt, ownerName, ownerId, text }) {
      if (!state.modal.backdrop) return;
      state.modal.date.textContent = `작성일: ${formatDate(createdAt)}`;
      state.modal.author.textContent = `작성자: ${ownerName || ownerId || "-"}`;
      const normalized = normalizeMemoText(text);
      state.modal.body.textContent = normalized || "(내용 없음)";
      state.modal.backdrop.style.display = "flex";
    }

    function closeMemoModal() {
      if (!state.modal.backdrop) return;
      state.modal.backdrop.style.display = "none";
    }

    function formatWebformDateLabel(val) {
      if (Array.isArray(val)) {
        const uniq = Array.from(new Set(val)).sort();
        return uniq.join(", ");
      }
      return val || "날짜 확인 불가";
    }

    function getWebformsForPerson(personId) {
      const source = state.filteredWonGroupJson?.groups?.length
        ? state.filteredWonGroupJson
        : state.wonGroupJson;
      if (!source || !source.groups) return [];
      for (const group of source.groups) {
        const match = (group.people || []).find((p) => p.id === personId);
        if (match && Array.isArray(match.webforms)) {
          return match.webforms;
        }
      }
      return [];
    }

    function flattenWebformRows(webforms) {
      const rows = [];
      (webforms || []).forEach((wf) => {
        const name = wf?.name || "-";
        const date = wf?.date;
        if (Array.isArray(date)) {
          const uniq = Array.from(new Set(date)).sort();
          uniq.forEach((d) => rows.push({ date: d || "날짜 확인 불가", name }));
        } else {
          rows.push({ date: date || "날짜 확인 불가", name });
        }
      });
      return rows;
    }

    function openWebformModal(personName, webforms) {
      if (!state.webformModal.backdrop) return;
      const rows = flattenWebformRows(webforms);
      state.webformModal.title.textContent = `웹폼 내역 - ${personName || "-"}`;
      if (!rows.length) {
        state.webformModal.body.innerHTML = `<div class="muted">웹폼 내역이 없습니다.</div>`;
        state.webformModal.backdrop.style.display = "flex";
        return;
      }
      const bodyRows = rows
        .map(
          (r) => `<tr><td>${formatWebformDateLabel(r.date)}</td><td>${r.name}</td></tr>`
        )
        .join("");
      state.webformModal.body.innerHTML = `
        <div class="table-wrap full">
          <table>
            <thead><tr><th style="width: 160px;">날짜</th><th>웹폼 제목</th></tr></thead>
            <tbody>${bodyRows}</tbody>
          </table>
        </div>
      `;
      state.webformModal.backdrop.style.display = "flex";
    }

    function closeWebformModal() {
      if (!state.webformModal.backdrop) return;
      state.webformModal.backdrop.style.display = "none";
    }

    function attachMemoRowClicks(tableId, memoList) {
      const table = document.getElementById(tableId);
      if (!table) return;
      table.querySelectorAll("tbody tr").forEach((tr, idx) => {
        const memo = memoList[idx];
        if (!memo) return;
        tr.style.cursor = "pointer";
        tr.addEventListener("click", () => openMemoModal(memo));
      });
    }

    function renderSidebar() {
      const list = document.getElementById("menuList");
      if (!list) return;
      list.innerHTML = "";
      menuConfig.forEach((item) => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "menu-item";
        if (state.activeMenuId === item.id) btn.classList.add("active");
        btn.textContent = item.label;
        btn.addEventListener("click", () => {
          if (state.activeMenuId === item.id) return;
          state.activeMenuId = item.id;
          renderSidebar();
          renderContent();
        });
        li.appendChild(btn);
        list.appendChild(li);
      });
    }

    async function renderContent() {
      const contentRoot = document.getElementById("contentRoot");
      if (!contentRoot) return;
      const menu = menuConfig.find((m) => m.id === state.activeMenuId);
      if (!menu) {
        contentRoot.innerHTML = "<div class='muted'>선택한 메뉴를 찾을 수 없습니다.</div>";
        return;
      }
      const result = menu.render(contentRoot);
      if (result && typeof result.then === "function") {
        await result;
      }
    }

    async function fetchJson(path) {
      const resp = await fetch(`${API_BASE}${path}`);
      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(txt || resp.statusText);
      }
      return resp.json();
    }

    async function fetchOrgById(orgId) {
      const cached = cache.orgLookup.get(orgId);
      if (cached) return cached;
      const data = await fetchJson(`/orgs/${orgId}`);
      if (data && data.item) {
        cache.orgLookup.set(orgId, data.item);
        return data.item;
      }
      return null;
    }

    async function navigateToOrg(orgId) {
      if (!orgId) return;
      state.activeMenuId = "org-view";
      state.pendingOrgId = orgId;
      state.orgSearch = orgId; // search by id to narrow list
      try {
        state.pendingOrgFallback = await fetchOrgById(orgId);
      } catch (_) {
        state.pendingOrgFallback = null;
      }
      state.size = "전체";
      renderSidebar();
      await renderContent(); // org screen will init and load
    }

    function formatDate(val) {
      if (!val) return "-";
      const clean = String(val).split("T")[0].split(" ")[0];
      return clean || val;
    }

    function formatAmount(num) {
      if (num === null || num === undefined || Number.isNaN(num)) return "-";
      const value = Number(num);
      if (!Number.isFinite(value)) return "-";
      return (value / 1e8).toFixed(2) + "억";
    }

    function formatEok(num) {
      if (num === null || num === undefined || Number.isNaN(num)) return "-";
      const value = Number(num);
      if (!Number.isFinite(value)) return "-";
      return value.toFixed(2) + "억";
    }

    function formatRatio(num) {
      if (num === null || num === undefined || Number.isNaN(num)) return "n/a";
      const value = Number(num);
      if (!Number.isFinite(value)) return "n/a";
      return value.toFixed(2);
    }

    function normalizeUpperOrg(val) {
      const text = (val || "").trim();
      return text || "미입력";
    }

    function normalizeUpperForDisplay(val) {
      const text = normalizeUpperOrg(val);
      return text === "미입력" ? "" : text;
    }

    function buildSalesmapLink(type, id) {
      if (!id || !SALESMAP_WORKSPACE_PATH) return null;
      const base = `https://salesmap.kr/${SALESMAP_WORKSPACE_PATH.replace(/^\/+/, "").replace(/\/+$/, "")}`;
      if (type === "deal") return `${base}/deal/${encodeURIComponent(id)}`;
      if (type === "person") return `${base}/contact/people/${encodeURIComponent(id)}`;
      return null;
    }

    function normalizeMemoText(text) {
      if (!text) return "";
      return String(text || "")
        .replace(/<br\s*\/?>/gi, "\n")
        .replace(/\r\n?/g, "\n")
        .trim();
    }

    function setBreadcrumb() {
      const orgName = state.orgs.find((o) => o.id === state.selectedOrg)?.name || "-";
      const personName = state.selectedPerson && state.people.find((p) => p.id === state.selectedPerson)?.name || "-";
      const dealName = state.selectedDeal && state.deals.find((d) => d.id === state.selectedDeal)?.name || "-";
      document.getElementById("crumb-org").textContent = orgName;
      document.getElementById("crumb-person").textContent = personName;
      document.getElementById("crumb-deal").textContent = dealName;
    }

    function renderOrgSelect() {
      const sel = document.getElementById("orgSelect");
      if (!sel) return;
      if (!state.orgs.length) {
        sel.innerHTML = '<option value="">해당 조건의 회사가 없습니다.</option>';
        return;
      }
      const options = ['<option value="">회사를 선택하세요</option>'];
      options.push(
        ...state.orgs.map(
          (o) =>
            `<option value="${o.id}" ${o.id === state.selectedOrg ? "selected" : ""}>${o.name || o.id}</option>`
        )
      );
      sel.innerHTML = options.join("");
      sel.value = state.selectedOrg || "";
      state.orgs.forEach((o) => {
        if (o.id) cache.orgLookup.set(o.id, o);
      });
      if (DEBUG_ORG_SELECT) {
        console.debug("[orgSelect] renderOrgSelect", {
          optionCount: state.orgs.length,
          selectedOrg: state.selectedOrg,
          selectValue: sel.value,
        });
      }
    }

    async function getSizes() {
      if (cache.sizes) return cache.sizes;
      const data = await fetchJson("/sizes");
      const sizes = Array.from(new Set(["전체", ...(data.sizes || [])]));
      cache.sizes = sizes;
      return sizes;
    }

    function updateStatePathButton() {
      const btn = document.getElementById("statePathBtn");
      if (!btn) return;
      btn.disabled = !state.selectedOrg;
    }

    async function loadSizes() {
      try {
        const sizes = await getSizes();
        const sel = document.getElementById("sizeSelect");
        sel.innerHTML = sizes.map((s) => `<option value="${s}">${s}</option>`).join("");
        if (!sizes.includes(state.size)) {
          state.size = sizes[0] || "전체";
        }
        sel.value = state.size;
      } catch (err) {
        cache.sizes = null;
        showToast(`규모 목록을 불러오지 못했습니다: ${err.message}`, "error");
      }
    }

    async function loadOrgs(offset = 0, preselectOrgId = null, fallbackOrg = null, allowFallback = true) {
      const search = document.getElementById("orgSearch").value.trim();
      state.orgSearch = search;
      const params = new URLSearchParams({
        size: state.size,
        limit: ORG_LIMIT.toString(),
        offset: offset.toString(),
      });
      if (search) params.set("search", search);
      document.getElementById("orgMemoHint").textContent = "회사 목록 불러오는 중...";
      try {
        const data = await fetchJson(`/orgs?${params.toString()}`);
        state.orgs = data.items || [];
        if (!state.orgs.length && allowFallback && state.size !== "전체" && !search) {
          // If no orgs for this size and no search, fall back to 전체 once
          state.size = "전체";
          const sizeSelectEl = document.getElementById("sizeSelect");
          if (sizeSelectEl) sizeSelectEl.value = state.size;
          showToast("해당 규모에 회사가 없습니다. 전체로 전환합니다.", "info");
          return await loadOrgs(offset, preselectOrgId, fallbackOrg, false);
        }
        const prev = preselectOrgId || state.selectedOrg;
        const stillExists = state.orgs.find((o) => o.id === prev);
        state.selectedOrg = stillExists ? prev : null;
        if (DEBUG_ORG_SELECT) {
          console.debug("[orgSelect] loadOrgs done", {
            count: state.orgs.length,
            prev,
            stillExists: Boolean(stillExists),
            selectedOrg: state.selectedOrg,
          });
        }
        renderOrgSelect();
        if (state.selectedOrg) {
          await loadOrgDetail(state.selectedOrg);
          showToast("선택한 회사를 불러왔습니다.", "success");
        } else if (preselectOrgId && fallbackOrg) {
          // insert fallback org to list and select
          state.orgs = [fallbackOrg];
          renderOrgSelect();
          state.selectedOrg = fallbackOrg.id;
          document.getElementById("orgSelect").value = fallbackOrg.id;
          await loadOrgDetail(fallbackOrg.id);
          showToast("선택한 회사를 불러왔습니다.", "success");
        } else {
          clearOrgViews();
          if (preselectOrgId) {
            showToast("해당 회사를 찾을 수 없습니다.", "error");
          }
        }
      } catch (err) {
        showToast(`회사 목록 오류: ${err.message}`, "error");
        clearOrgViews();
        if (DEBUG_ORG_SELECT) {
          console.debug("[orgSelect] loadOrgs error", err);
        }
      }
      setBreadcrumb();
    }

    function clearOrgViews() {
      state.selectedUpperOrg = null;
      state.selectedPerson = null;
      state.selectedDeal = null;
      state.people = [];
      state.deals = [];
      state.orgMemos = [];
      state.personMemos = [];
      state.dealMemos = [];
      state.wonSummary = [];
      state.wonGroupJson = null;
      state.wonGroupJsonCompact = null;
      state.filteredWonGroupJson = null;
      state.filteredWonGroupJsonCompact = null;
      state.statePath = null;
      updateStatePathButton();
      renderOrgMemos([]);
      renderWonSummary([]);
      renderWonGroupJsonAll(null);
      renderWonGroupJsonFiltered(null);
      renderWonGroupJsonAllCompact(null);
      renderWonGroupJsonFilteredCompact(null);
      renderUpperOrgSection();
    }

    async function loadOrgDetail(orgId) {
      if (DEBUG_ORG_SELECT) console.debug("[orgSelect] loadOrgDetail start", orgId);
      state.selectedOrg = orgId;
      state.selectedUpperOrg = null;
      state.selectedPerson = null;
      state.selectedDeal = null;
      state.deals = [];
      state.personMemos = [];
      state.dealMemos = [];
      state.wonGroupJson = null;
      state.wonGroupJsonCompact = null;
      state.statePath = null;
      state.filteredWonGroupJson = null;
      state.filteredWonGroupJsonCompact = null;
      setBreadcrumb();
      renderWonGroupJsonAll(null);
      renderWonGroupJsonFiltered(null);
      renderWonGroupJsonAllCompact(null);
      renderWonGroupJsonFilteredCompact(null);

      const memoPromise = cache.orgMemos.get(orgId)
        ? Promise.resolve(cache.orgMemos.get(orgId))
        : fetchJson(`/orgs/${orgId}/memos`).then((d) => d.items || []);

      const peoplePromise = cache.peopleByOrg.get(orgId)
        ? Promise.resolve(cache.peopleByOrg.get(orgId))
        : fetchJson(`/orgs/${orgId}/people`).then((d) => d.items || []);

      const wonSummaryPromise = cache.wonSummary.get(orgId)
        ? Promise.resolve(cache.wonSummary.get(orgId))
        : fetchJson(`/orgs/${orgId}/won-summary`).then((d) => d.items || []);

      try {
        // 메모/People/Won 요약을 모두 병렬로 가져와 상위 조직 테이블과 People/Deal 섹션을 채운다.
        const [memos, peopleList, wonSummary] = await Promise.all([
          memoPromise,
          peoplePromise,
          wonSummaryPromise,
        ]);
        cache.orgMemos.set(orgId, memos);
        cache.peopleByOrg.set(orgId, peopleList);
        cache.wonSummary.set(orgId, wonSummary || []);

        state.orgMemos = memos;
        state.people = peopleList || [];
        state.wonSummary = wonSummary || [];
        updateStatePathButton();

        renderOrgMemos(memos);
        renderWonSummary(state.wonSummary);
        renderUpperOrgSection();
        setBreadcrumb();
        await loadWonGroupJson(orgId);
      } catch (err) {
        showToast(`회사 데이터 로드 오류: ${err.message}`, "error");
        clearOrgViews();
        if (DEBUG_ORG_SELECT) console.debug("[orgSelect] loadOrgDetail error", err);
      }
    }

    function renderWonSummary(summary) {
      const card = document.getElementById("wonSummaryCard");
      const table = document.getElementById("wonSummaryTable");
      const hint = document.getElementById("wonSummaryHint");
      if (!card || !table || !hint) return;

      if (!state.selectedOrg) {
        card.style.display = "none";
        table.innerHTML = "";
        hint.textContent = "";
        return;
      }

       if (state.wonSummaryCleared) {
        card.style.display = "";
        table.innerHTML = "";
        hint.textContent = "상위 조직을 선택하세요.";
        state.wonSummaryCleared = false;
        return;
      }

      if (!summary || !summary.length) {
        card.style.display = "";
        hint.textContent = "Won 딜이 없습니다.";
        table.innerHTML = "";
        return;
      }

      card.style.display = "";
      hint.textContent = "";

      const rowsHtml = summary
        .map((row) => {
          const contacts = (row.contacts || []).length ? row.contacts.join("<br>") : "-";
          const owners = (row.owners || []).length ? row.owners.join("<br>") : "-";
          const owners2025 = Array.isArray(row.owners2025) ? row.owners2025 : [];
          const ownerTeamPart = computeTeamPartSummary(owners2025);
          const fmt = (val) => formatAmount(val);
          const upper = row.upper_org || "미입력";
          return `
            <tr data-upper="${upper}">
              <td>${upper}</td>
              <td>${fmt(row.won2023)}</td>
              <td>${fmt(row.won2024)}</td>
              <td>${fmt(row.won2025)}</td>
              <td>${contacts}</td>
              <td>${owners}</td>
              <td>${ownerTeamPart.ownersText}</td>
              <td>${ownerTeamPart.teamPartText}</td>
              <td>${ownerTeamPart.dri}</td>
            </tr>
          `;
        })
        .join("");

      table.innerHTML = `
        <thead>
          <tr>
            <th>소속 상위 조직</th>
            <th>2023 Won(억)</th>
            <th>2024 Won(억)</th>
            <th>2025 Won(억)</th>
            <th>고객사 담당자 (팀/이름/직급/교육)</th>
            <th>데이원 담당자</th>
            <th>2025 담당자</th>
            <th>팀&파트</th>
            <th>DRI 가능</th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
      `;
      table.querySelectorAll("tbody tr").forEach((tr) => {
        const upper = tr.getAttribute("data-upper");
        if (upper && state.selectedUpperOrg === upper) {
          tr.classList.add("active");
        }
        tr.addEventListener("click", () => {
          state.selectedUpperOrg = upper;
          state.selectedPerson = null;
          state.selectedDeal = null;
          state.deals = [];
          state.personMemos = [];
          state.dealMemos = [];
          state.filteredWonGroupJson = filterWonGroupByUpper(state.wonGroupJson, upper);
          state.filteredWonGroupJsonCompact = filterWonGroupByUpper(state.wonGroupJsonCompact, upper);
          renderWonSummary(summary);
          renderWonGroupJsonFiltered(state.filteredWonGroupJson);
          renderWonGroupJsonFilteredCompact(state.filteredWonGroupJsonCompact);
          autoSelectFirstPersonForUpperOrg();
        });
      });
    }

    async function autoSelectFirstPersonForUpperOrg() {
      const peopleList = filterPeopleByUpperOrg();
      if (!peopleList.length) {
        state.selectedPerson = null;
        state.selectedDeal = null;
        state.deals = [];
        state.personMemos = [];
        state.dealMemos = [];
        renderUpperOrgSection();
        setBreadcrumb();
        return;
      }
      const first = peopleList[0];
      const personChanged = state.selectedPerson !== first.id;
      state.selectedPerson = first.id;
      state.selectedDeal = null;
      state.deals = [];
      state.personMemos = [];
      state.dealMemos = [];
      renderUpperOrgSection();
      setBreadcrumb();
      if (personChanged) {
        // Load person memos and deals (which will auto-select first deal and load its memos).
        await Promise.all([
          loadPersonMemos(first.id),
          loadDealsForPerson(first.id),
        ]);
      } else if (state.selectedDeal) {
        await loadDealMemos(state.selectedDeal);
      }
    }

    function filterWonGroupByUpper(data, upper) {
      if (!data || !upper) return null;
      const filtered = (data.groups || []).filter((g) => g.upper_org === upper);
      return {
        ...data,
        groups: filtered,
      };
    }

    function renderWonGroupJsonAll(data) {
      const hint = document.getElementById("wonGroupJsonHintAll");
      const viewBtn = document.getElementById("viewWonGroupJsonAllBtn");
      const copyBtn = document.getElementById("copyWonGroupJsonAllBtn");
      if (!hint || !viewBtn || !copyBtn) return;

      if (!state.selectedOrg) {
        hint.textContent = "회사를 선택하세요.";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      if (!data) {
        hint.textContent = "불러오는 중...";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      const groups = data.groups || [];
      hint.textContent = groups.length ? "" : "23/24/25 Won 딜이 있는 상위 조직이 없습니다.";
      viewBtn.disabled = false;
      copyBtn.disabled = false;
    }

    function renderWonGroupJsonAllCompact(data) {
      const hint = document.getElementById("wonGroupJsonHintAll");
      const viewBtn = document.getElementById("viewWonGroupJsonAllCompactBtn");
      const copyBtn = document.getElementById("copyWonGroupJsonAllCompactBtn");
      if (!hint || !viewBtn || !copyBtn) return;

      if (!state.selectedOrg) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      if (!data) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      const groups = data.groups || [];
      viewBtn.disabled = groups.length === 0;
      copyBtn.disabled = groups.length === 0;
    }

    function renderWonGroupJsonFiltered(data) {
      const hint = document.getElementById("wonGroupJsonHintFiltered");
      const viewBtn = document.getElementById("viewWonGroupJsonFilteredBtn");
      const copyBtn = document.getElementById("copyWonGroupJsonFilteredBtn");
      const label = document.getElementById("wonGroupJsonSelectedUpper");
      if (!hint || !viewBtn || !copyBtn) return;

      if (!state.selectedOrg) {
        hint.textContent = "회사를 선택하세요.";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        if (label) label.textContent = "";
        return;
      }
      if (!state.selectedUpperOrg) {
        hint.textContent = "아래 표에서 소속 상위 조직을 선택해주세요.";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        if (label) label.textContent = "";
        return;
      }
      if (!data) {
        hint.textContent = "불러오는 중...";
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        if (label) label.textContent = `선택된 상위 조직: ${state.selectedUpperOrg}`;
        return;
      }
      const groups = data.groups || [];
      hint.textContent = groups.length ? "" : "선택한 상위 조직의 Won 딜이 없습니다.";
      viewBtn.disabled = groups.length === 0;
      copyBtn.disabled = groups.length === 0;
      if (label) label.textContent = `선택된 상위 조직: ${state.selectedUpperOrg}`;
    }

    function renderWonGroupJsonFilteredCompact(data) {
      const viewBtn = document.getElementById("viewWonGroupJsonFilteredCompactBtn");
      const copyBtn = document.getElementById("copyWonGroupJsonFilteredCompactBtn");
      const hint = document.getElementById("wonGroupJsonHintFiltered");
      const label = document.getElementById("wonGroupJsonSelectedUpper");
      if (!viewBtn || !copyBtn) return;

      if (!state.selectedOrg) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      if (!state.selectedUpperOrg) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        return;
      }
      if (!data) {
        viewBtn.disabled = true;
        copyBtn.disabled = true;
        if (label) label.textContent = `선택된 상위 조직: ${state.selectedUpperOrg}`;
        if (hint) hint.textContent = "불러오는 중...";
        return;
      }
      const groups = data.groups || [];
      const disabled = groups.length === 0;
      viewBtn.disabled = disabled;
      copyBtn.disabled = disabled;
    }

    async function loadWonGroupJson(orgId) {
      const card = document.getElementById("wonGroupJsonCardCombined");
      if (!card) return;
      if (!orgId) {
        state.wonGroupJson = null;
        state.wonGroupJsonCompact = null;
        state.filteredWonGroupJson = null;
        state.filteredWonGroupJsonCompact = null;
        renderWonGroupJsonAll(null);
        renderWonGroupJsonFiltered(null);
        renderWonGroupJsonAllCompact(null);
        renderWonGroupJsonFilteredCompact(null);
        return;
      }
      const cached = cache.wonGroupJsonByOrg.get(orgId);
      const cachedCompact = cache.wonGroupJsonCompactByOrg.get(orgId);
      state.wonGroupJson = null;
      state.wonGroupJsonCompact = null;
      state.filteredWonGroupJson = null;
      state.filteredWonGroupJsonCompact = null;
      renderWonGroupJsonAll(null);
      renderWonGroupJsonFiltered(null);
      renderWonGroupJsonAllCompact(null);
      renderWonGroupJsonFilteredCompact(null);
      try {
        const [rawRes, compactRes] = await Promise.allSettled([
          cached ? Promise.resolve(cached) : fetchJson(`/orgs/${orgId}/won-groups-json`),
          cachedCompact ? Promise.resolve(cachedCompact) : fetchJson(`/orgs/${orgId}/won-groups-json-compact`),
        ]);

        if (rawRes.status === "fulfilled") {
          const raw = rawRes.value;
          cache.wonGroupJsonByOrg.set(orgId, raw);
          state.wonGroupJson = raw;
          state.filteredWonGroupJson = filterWonGroupByUpper(raw, state.selectedUpperOrg);
          renderWonGroupJsonAll(raw);
          renderWonGroupJsonFiltered(state.filteredWonGroupJson);
        } else {
          throw rawRes.reason;
        }

        if (compactRes.status === "fulfilled") {
          const compact = compactRes.value;
          cache.wonGroupJsonCompactByOrg.set(orgId, compact);
          state.wonGroupJsonCompact = compact;
          state.filteredWonGroupJsonCompact = filterWonGroupByUpper(compact, state.selectedUpperOrg);
          renderWonGroupJsonAllCompact(compact);
          renderWonGroupJsonFilteredCompact(state.filteredWonGroupJsonCompact);
        } else {
          showToast(`간소화 JSON 오류: ${compactRes.reason?.message || compactRes.reason}`, "error");
        }

        renderUpperOrgSection();
      } catch (err) {
        showToast(`상위 조직 JSON 오류: ${err.message}`, "error");
        state.wonGroupJson = null;
        state.wonGroupJsonCompact = null;
        state.filteredWonGroupJson = null;
        state.filteredWonGroupJsonCompact = null;
        const hintAll = document.getElementById("wonGroupJsonHintAll");
        const hintFiltered = document.getElementById("wonGroupJsonHintFiltered");
        const buttons = [
          document.getElementById("viewWonGroupJsonAllBtn"),
          document.getElementById("copyWonGroupJsonAllBtn"),
          document.getElementById("viewWonGroupJsonFilteredBtn"),
          document.getElementById("copyWonGroupJsonFilteredBtn"),
          document.getElementById("viewWonGroupJsonAllCompactBtn"),
          document.getElementById("copyWonGroupJsonAllCompactBtn"),
          document.getElementById("viewWonGroupJsonFilteredCompactBtn"),
          document.getElementById("copyWonGroupJsonFilteredCompactBtn"),
        ];
        if (hintAll) hintAll.textContent = "오류가 발생했습니다.";
        if (hintFiltered) hintFiltered.textContent = "오류가 발생했습니다.";
        buttons.forEach((btn) => {
          if (btn) btn.disabled = true;
        });
      }
    }

    async function loadStatePath(orgId) {
      if (!orgId) {
        showToast("회사를 선택하세요.", "info");
        return;
      }
      const btn = document.getElementById("statePathBtn");
      if (btn) btn.disabled = true;
      try {
        const cached = cache.statePathByOrg.get(orgId);
        if (cached) {
          state.statePath = cached;
          openStatePathModal(cached);
          return;
        }
        const data = await fetchJson(`/orgs/${orgId}/statepath`);
        const item = data.item || data;
        cache.statePathByOrg.set(orgId, item);
        state.statePath = item;
        openStatePathModal(item);
      } catch (err) {
        showToast(`StatePath 로드 오류: ${err.message}`, "error");
      } finally {
        updateStatePathButton();
      }
    }

    function renderOrgMemos(memos) {
      const hint = document.getElementById("orgMemoHint");
      const table = document.getElementById("orgMemoTable");
      const card = document.getElementById("orgMemoCard");
      const status = document.getElementById("orgMemoStatus");
      if (!card || !table || !hint || !status) return; // DOM이 없으면 아무 것도 하지 않는다.
      status.textContent = memos.length ? `${memos.length}건` : "";
      if (!state.selectedOrg) {
        card.style.display = "none";
        hint.textContent = "";
        table.innerHTML = "";
        return;
      }
      if (!memos.length) {
        card.style.display = "none";
        hint.textContent = "";
        table.innerHTML = "";
        return;
      }
      card.style.display = "";
      hint.textContent = "";
      table.innerHTML = `
        <thead><tr><th>작성일</th><th>작성자</th><th>본문</th></tr></thead>
        <tbody>
          ${memos
            .map((m) => {
              const body = normalizeMemoText(m.text);
              const preview = body.slice(0, 140);
              return `<tr><td>${formatDate(m.createdAt)}</td><td>${m.ownerName || m.ownerId || "-"}</td><td class="memo-text" title="${body}">${preview}${body.length > 140 ? "…" : ""
                }</td></tr>`;
            })
            .join("")}
        </tbody>
      `;
      attachMemoRowClicks("orgMemoTable", memos);
    }

    function filterPeopleByUpperOrg() {
      if (!state.selectedUpperOrg) return [];
      return (state.people || []).filter(
        (p) => normalizeUpperOrg(p.upper_org) === state.selectedUpperOrg
      );
    }

    function renderUpperOrgSection() {
      const label = document.getElementById("upperOrgLabel");
      if (label) {
        label.textContent = state.selectedUpperOrg
          ? `소속 상위 조직: ${state.selectedUpperOrg}`
          : "상위 조직을 선택하세요.";
      }
      const peopleList = filterPeopleByUpperOrg();
      renderPeople(peopleList);
      renderDeals(state.deals);
      renderMemoTable("personMemoTable", "personMemos", Boolean(state.selectedPerson));
      renderMemoTable("dealMemoTable", "dealMemos", Boolean(state.selectedDeal));
    }

    function renderPeople(list) {
      const table = document.getElementById("peopleTable");
      const hint = document.getElementById("peopleHint");
      const countBadge = document.getElementById("peopleCount");
      if (!table || !hint || !countBadge) return;

      countBadge.textContent = list.length;
      if (!state.selectedOrg) {
        table.innerHTML = "";
        hint.textContent = "회사를 선택하세요.";
        return;
      }
      if (!state.selectedUpperOrg) {
        table.innerHTML = "";
        hint.textContent = "상위 조직을 선택하세요.";
        return;
      }
      if (!list.length) {
        table.innerHTML = "";
        hint.textContent = "사람이 없습니다.";
        return;
      }
      hint.textContent = "";
      table.innerHTML = `<thead><tr>
        <th>이름</th>
        <th>소속 상위 조직</th>
        <th>팀(명함/메일서명)</th>
        <th>직급(명함/메일서명)</th>
        <th>담당 교육 영역</th>
        <th>웹폼 내역</th>
      </tr></thead>`;
      const tbody = document.createElement("tbody");
      list.forEach((p) => {
        const tr = document.createElement("tr");
        if (state.selectedPerson === p.id) tr.classList.add("active");
        const personLink = buildSalesmapLink("person", p.id);
        const nameCell = personLink
          ? `<a href="${personLink}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: underline;">${p.name || "-"}</a>`
          : `${p.name || "-"}`;
        const webforms = getWebformsForPerson(p.id);
        const hasWebforms = Array.isArray(webforms) && webforms.length > 0;
        tr.innerHTML = `
          <td>${nameCell}</td>
          <td>${p.upper_org || "-"}</td>
          <td>${p.team_signature || "-"}</td>
          <td>${p.title_signature || "-"}</td>
          <td>${p.edu_area || "-"}</td>
          <td><button type="button" class="webform-btn" ${hasWebforms ? "" : "disabled"}>${hasWebforms ? "내역 확인" : "없음"}</button></td>
        `;
        tr.addEventListener("click", () => {
          state.selectedPerson = p.id;
          state.selectedDeal = null;
          state.deals = [];
          state.personMemos = [];
          state.dealMemos = [];
          renderPeople(list);
          renderDeals([]);
          renderMemoTable("personMemoTable", "personMemos", true);
          renderMemoTable("dealMemoTable", "dealMemos", false);
          loadDealsForPerson(p.id);
          loadPersonMemos(p.id);
          setBreadcrumb();
        });
        const wfBtn = tr.querySelector(".webform-btn");
        if (wfBtn) {
          wfBtn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            if (!hasWebforms) {
              showToast("웹폼 내역이 없습니다.", "info");
              return;
            }
            openWebformModal(p.name || "-", webforms);
          });
        }
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    async function loadDealsForPerson(personId) {
      const cacheHit = cache.deals.get(personId);
      const promise = cacheHit
        ? Promise.resolve(cacheHit)
        : fetchJson(`/people/${personId}/deals`).then((d) => d.items || []);
      try {
        const deals = await promise;
        cache.deals.set(personId, deals);
        state.deals = deals;
        state.selectedDeal = deals[0]?.id || null;
        renderDeals(deals);
        if (state.selectedDeal) {
          await loadDealMemos(state.selectedDeal);
        } else {
          renderMemoTable("dealMemoTable", "dealMemos", false);
        }
      } catch (err) {
        showToast(`딜 조회 오류: ${err.message}`, "error");
        state.deals = [];
        state.selectedDeal = null;
        renderDeals([]);
        renderMemoTable("dealMemoTable", "dealMemos", false);
      }
      setBreadcrumb();
    }

    function renderDeals(list) {
      const table = document.getElementById("dealTable");
      const hint = document.getElementById("dealHint");
      if (!table || !hint) return;

      if (!state.selectedOrg) {
        table.innerHTML = "";
        hint.textContent = "회사를 선택하세요.";
        return;
      }
      if (!state.selectedUpperOrg) {
        table.innerHTML = "";
        hint.textContent = "상위 조직을 선택하세요.";
        return;
      }
      if (!state.selectedPerson) {
        table.innerHTML = "";
        hint.textContent = "사람을 선택하세요.";
        return;
      }
      if (!list.length) {
        table.innerHTML = "";
        hint.textContent = "딜이 없습니다.";
        return;
      }
      hint.textContent = "";
      table.innerHTML = `<thead><tr><th>생성일</th><th>이름</th><th>상태</th><th>금액(억)</th><th>예상 체결액(억)</th><th>계약 체결일</th><th>담당자</th></tr></thead>`;
      const tbody = document.createElement("tbody");
      list.forEach((d) => {
        const tr = document.createElement("tr");
        if (state.selectedDeal === d.id) tr.classList.add("active");
        const dealLink = buildSalesmapLink("deal", d.id);
        const dealNameCell = dealLink
          ? `<a href="${dealLink}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: underline;">${d.name || "-"}</a>`
          : `${d.name || "-"}`;
        tr.innerHTML = `
          <td>${formatDate(d.created_at)}</td>
          <td>${dealNameCell}</td>
          <td>${d.status || "-"}</td>
          <td>${formatAmount(d.amount)}</td>
          <td>${formatAmount(d.expected_amount)}</td>
          <td>${formatDate(d.contract_date)}</td>
          <td>${d.ownerName || "-"}</td>
        `;
        tr.addEventListener("click", async () => {
          state.selectedDeal = d.id;
          renderDeals(list);
          await loadDealMemos(d.id);
          setBreadcrumb();
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    async function loadPersonMemos(personId) {
      const cacheHit = cache.personMemos.get(personId);
      const promise = cacheHit
        ? Promise.resolve(cacheHit)
        : fetchJson(`/people/${personId}/memos`).then((d) => d.items || []);
      try {
        const memos = await promise;
        cache.personMemos.set(personId, memos);
        state.personMemos = memos;
        renderMemoTable("personMemoTable", "personMemos", true);
      } catch (err) {
        showToast(`People 메모 오류: ${err.message}`, "error");
      }
    }

    async function loadDealMemos(dealId) {
      const cacheHit = cache.dealMemos.get(dealId);
      const promise = cacheHit ? Promise.resolve(cacheHit) : fetchJson(`/deals/${dealId}/memos`).then((d) => d.items || []);
      try {
        const memos = await promise;
        cache.dealMemos.set(dealId, memos);
        state.dealMemos = memos;
        renderMemoTable("dealMemoTable", "dealMemos", true);
      } catch (err) {
        showToast(`Deal 메모 오류: ${err.message}`, "error");
      }
    }

    function renderMemoTable(tableId, memoKey, hasSelection) {
      const table = document.getElementById(tableId);
      const memoList = state[memoKey] || [];
      if (!table) return;
      if (!hasSelection) {
        table.innerHTML = "";
        return;
      }
      if (!memoList.length) {
        table.innerHTML = `<tbody><tr><td class="muted">메모가 없습니다.</td></tr></tbody>`;
        return;
      }
      table.innerHTML = `
        <thead><tr><th>작성일</th><th>작성자</th><th>본문</th></tr></thead>
        <tbody>
          ${memoList
            .map(
              (m) => {
                const body = normalizeMemoText(m.text);
                const preview = body.slice(0, 120);
                return `<tr><td>${formatDate(m.createdAt)}</td><td>${m.ownerName || m.ownerId || "-"}</td><td class="memo-text" title="${body}">${preview}${body.length > 120 ? "…" : ""
                  }</td></tr>`;
              }
            )
            .join("")}
        </tbody>
      `;
      attachMemoRowClicks(tableId, memoList);
    }

    function getDefaultSize() {
      if (cache.sizes && cache.sizes.length) {
        if (cache.sizes.includes("대기업")) return "대기업";
        return cache.sizes[0];
      }
      return "대기업";
    }

    async function resetSelection() {
      state.orgSearch = "";
      const defaultSize = getDefaultSize();
      state.size = defaultSize;
      state.selectedOrg = null;
      state.selectedUpperOrg = null;
      state.selectedPerson = null;
      state.selectedDeal = null;
      state.orgs = [];
      state.orgMemos = [];
      state.people = [];
      state.deals = [];
      state.personMemos = [];
      state.dealMemos = [];
      state.wonSummary = [];
      state.statePath = null;
      state.filteredWonGroupJson = null;
      state.wonGroupJson = null;
      state.wonSummaryCleared = true;

      const searchInput = document.getElementById("orgSearch");
      if (searchInput) searchInput.value = "";
      const sizeSelect = document.getElementById("sizeSelect");
      if (sizeSelect) sizeSelect.value = defaultSize;
      const orgSelect = document.getElementById("orgSelect");
      if (orgSelect) orgSelect.value = "";

      clearOrgViews();
      setBreadcrumb();
      updateStatePathButton();
      await loadOrgs(0);
      state.wonSummaryCleared = false;
    }

    async function initOrgScreen() {
      document.getElementById("apiBaseLabel").textContent = API_BASE;
      updateStatePathButton();
      document.getElementById("sizeSelect").addEventListener("change", async (e) => {
        state.size = e.target.value;
        await loadOrgs(0);
      });
      document.getElementById("orgSearchBtn").addEventListener("click", () => loadOrgs(0));
      document.getElementById("orgSearch").addEventListener("keypress", (e) => {
        if (e.key === "Enter") loadOrgs(0);
      });
      document.getElementById("orgSelect").addEventListener("change", async (e) => {
        const val = e.target.value;
        if (DEBUG_ORG_SELECT) console.debug("[orgSelect] change", { val });
        if (!val) {
          state.selectedOrg = null;
          state.statePath = null;
          clearOrgViews();
          setBreadcrumb();
          updateStatePathButton();
          return;
        }
        try {
          await loadOrgDetail(val);
        } catch (err) {
          showToast(`회사 로드 오류: ${err.message}`, "error");
          if (DEBUG_ORG_SELECT) console.debug("[orgSelect] change error", err);
        }
      });
      document.getElementById("orgSelect").addEventListener("click", (e) => {
        if (DEBUG_ORG_SELECT) {
          const val = e.target.value;
          console.debug("[orgSelect] click", { val, optionCount: state.orgs.length });
        }
      });
      document.getElementById("resetBtn").addEventListener("click", () => resetSelection());
      document.getElementById("statePathBtn").addEventListener("click", () => loadStatePath(state.selectedOrg));
      const viewAll = document.getElementById("viewWonGroupJsonAllBtn");
      const copyAll = document.getElementById("copyWonGroupJsonAllBtn");
      const viewFiltered = document.getElementById("viewWonGroupJsonFilteredBtn");
      const copyFiltered = document.getElementById("copyWonGroupJsonFilteredBtn");
      const viewAllCompact = document.getElementById("viewWonGroupJsonAllCompactBtn");
      const copyAllCompact = document.getElementById("copyWonGroupJsonAllCompactBtn");
      const viewFilteredCompact = document.getElementById("viewWonGroupJsonFilteredCompactBtn");
      const copyFilteredCompact = document.getElementById("copyWonGroupJsonFilteredCompactBtn");
      if (viewAll) viewAll.addEventListener("click", () => openJsonModal("상위 조직별 JSON (전체)", state.wonGroupJson));
      if (copyAll) copyAll.addEventListener("click", () => copyJsonData(state.wonGroupJson));
      if (viewFiltered) viewFiltered.addEventListener("click", () => openJsonModal("선택 상위 조직 JSON", state.filteredWonGroupJson));
      if (copyFiltered) copyFiltered.addEventListener("click", () => copyJsonData(state.filteredWonGroupJson));
      if (viewAllCompact) viewAllCompact.addEventListener("click", () => openJsonModal("상위 조직별 간소화 JSON (전체)", state.wonGroupJsonCompact));
      if (copyAllCompact) copyAllCompact.addEventListener("click", () => copyJsonData(state.wonGroupJsonCompact));
      if (viewFilteredCompact) viewFilteredCompact.addEventListener("click", () => openJsonModal("선택 상위 조직 간소화 JSON", state.filteredWonGroupJsonCompact));
      if (copyFilteredCompact) copyFilteredCompact.addEventListener("click", () => copyJsonData(state.filteredWonGroupJsonCompact));

      state.modal.backdrop = document.getElementById("memoModalBackdrop");
      state.modal.close = document.getElementById("memoModalClose");
      state.modal.date = document.getElementById("memoModalDate");
      state.modal.author = document.getElementById("memoModalAuthor");
      state.modal.body = document.getElementById("memoModalBody");
      state.modal.backdrop.addEventListener("click", (e) => {
        if (e.target === state.modal.backdrop) closeMemoModal();
      });
      state.modal.close.addEventListener("click", closeMemoModal);
      state.jsonModal.backdrop = document.getElementById("jsonModalBackdrop");
      state.jsonModal.close = document.getElementById("jsonModalClose");
      state.jsonModal.title = document.getElementById("jsonModalTitle");
      state.jsonModal.body = document.getElementById("jsonModalBody");
      if (state.jsonModal.backdrop) {
        state.jsonModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.jsonModal.backdrop) closeJsonModal();
        });
      }
      if (state.jsonModal.close) state.jsonModal.close.addEventListener("click", closeJsonModal);
      state.webformModal.backdrop = document.getElementById("webformModalBackdrop");
      state.webformModal.close = document.getElementById("webformModalClose");
      state.webformModal.title = document.getElementById("webformModalTitle");
      state.webformModal.body = document.getElementById("webformModalBody");
      if (state.webformModal.backdrop) {
        state.webformModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.webformModal.backdrop) closeWebformModal();
        });
      }
      if (state.webformModal.close) state.webformModal.close.addEventListener("click", closeWebformModal);
      state.rankPeopleModal.backdrop = document.getElementById("dealsModalBackdrop");
      state.rankPeopleModal.close = document.getElementById("dealsModalClose");
      state.rankPeopleModal.title = document.getElementById("dealsModalTitle");
      state.rankPeopleModal.body = document.getElementById("dealsModalBody");
      if (state.rankPeopleModal.backdrop) {
        state.rankPeopleModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.rankPeopleModal.backdrop) closeDealsModal();
        });
      }
      if (state.rankPeopleModal.close) state.rankPeopleModal.close.addEventListener("click", closeDealsModal);
      state.statePathModal.backdrop = document.getElementById("statePathModalBackdrop");
      state.statePathModal.close = document.getElementById("statePathModalClose");
      state.statePathModal.title = document.getElementById("statePathModalTitle");
      state.statePathModal.body = document.getElementById("statePathModalBody");
      if (state.statePathModal.backdrop) {
        state.statePathModal.backdrop.addEventListener("click", (e) => {
          if (e.target === state.statePathModal.backdrop) closeStatePathModal();
        });
      }
      if (state.statePathModal.close) state.statePathModal.close.addEventListener("click", closeStatePathModal);
      if (!state.modal.bound) {
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeMemoModal();
            closeJsonModal();
            closeDealsModal();
            closeWebformModal();
            closeStatePathModal();
          }
        });
        state.modal.bound = true;
      }

      await loadSizes();
      const sizeSelect = document.getElementById("sizeSelect");
      if (sizeSelect) sizeSelect.value = state.size;
      const searchInput = document.getElementById("orgSearch");
      if (searchInput) searchInput.value = state.orgSearch || "";

      if (state.pendingOrgId) {
        await loadOrgs(0, state.pendingOrgId, state.pendingOrgFallback || undefined);
        state.pendingOrgId = null;
        state.pendingOrgFallback = null;
      } else {
        await loadOrgs(0);
      }
      setBreadcrumb();
    }

    async function renderOrgScreen(contentRoot) {
      contentRoot.innerHTML = `
        <header>
          <div class="control-row">
            <h1>조직/People/Deal 빠른 뷰어 (FastAPI)</h1>
            <div class="spacer"></div>
            <span class="pill">API: <span id="apiBaseLabel"></span></span>
          </div>
          <div class="control-row">
            <label class="muted">기업 규모</label>
            <select id="sizeSelect"></select>
            <label class="muted">회사 검색</label>
            <input id="orgSearch" type="text" placeholder="이름 또는 ID 검색 (상위 200건)" />
            <button id="orgSearchBtn" type="button">검색/새로고침</button>
            <label class="muted">회사</label>
            <select id="orgSelect"></select>
            <button id="resetBtn" type="button">선택 초기화</button>
            <button id="statePathBtn" type="button">StatePath 보기</button>
          </div>
        </header>

        <section class="card" id="wonGroupJsonCardCombined">
          <div class="control-row">
            <h2>상위 조직별 JSON</h2>
            <div class="spacer"></div>
            <span class="muted">좌: 전체 / 우: 선택 상위 조직</span>
          </div>
          <div class="json-grid">
            <div class="json-box">
              <div class="control-row">
                <h3 class="muted">전체</h3>
                <div class="spacer"></div>
                <button id="viewWonGroupJsonAllBtn" type="button">JSON 확인</button>
                <button id="copyWonGroupJsonAllBtn" type="button">JSON 복사</button>
                <button id="viewWonGroupJsonAllCompactBtn" type="button">간소화 JSON</button>
                <button id="copyWonGroupJsonAllCompactBtn" type="button">간소화 ver 복사</button>
              </div>
              <div class="muted" id="wonGroupJsonHintAll">회사를 선택하세요.</div>
            </div>
            <div class="json-box">
              <div class="control-row">
                <h3 class="muted">선택 상위 조직</h3>
                <div class="spacer"></div>
                <button id="viewWonGroupJsonFilteredBtn" type="button">JSON 확인</button>
                <button id="copyWonGroupJsonFilteredBtn" type="button">JSON 복사</button>
                <button id="viewWonGroupJsonFilteredCompactBtn" type="button">간소화 JSON</button>
                <button id="copyWonGroupJsonFilteredCompactBtn" type="button">간소화 ver 복사</button>
              </div>
              <div class="muted" id="wonGroupJsonSelectedUpper"></div>
              <div class="muted" id="wonGroupJsonHintFiltered">상위 조직을 선택하세요.</div>
            </div>
          </div>
        </section>

        <div class="breadcrumb" id="breadcrumb">
          <span>경로:</span>
          <span id="crumb-org">-</span>
          <span>›</span>
          <span id="crumb-person">-</span>
          <span>›</span>
          <span id="crumb-deal">-</span>
        </div>

        <section class="card" id="wonSummaryCard" style="display:none;">
          <h2>상위 조직별 Won 합계 (23/24/25)</h2>
          <div class="muted" id="wonSummaryHint">회사를 선택하세요.</div>
          <div class="table-wrap full">
            <table id="wonSummaryTable"></table>
          </div>
        </section>

        <section class="card" id="orgMemoCard">
          <h2>회사 메모 <span class="muted" id="orgMemoStatus"></span></h2>
          <div class="muted" id="orgMemoHint">회사를 선택하세요.</div>
          <div class="table-wrap full">
            <table id="orgMemoTable"></table>
          </div>
        </section>

        <main class="main-vertical">
          <section class="card">
            <div class="control-row">
              <h2>상위 조직 People/Deal</h2>
              <div class="spacer"></div>
              <span class="badge" id="peopleCount">0</span>
              <span class="muted" id="upperOrgLabel">상위 조직을 선택하세요.</span>
            </div>
            <div class="quad-grid">
              <div class="table-wrap">
                <div class="muted" id="peopleHint">회사를 선택하세요.</div>
                <table id="peopleTable"></table>
              </div>
              <div class="table-wrap">
                <div class="muted" id="dealHint">사람을 선택하세요.</div>
                <table id="dealTable"></table>
              </div>
              <div class="table-wrap">
                <table id="personMemoTable"></table>
              </div>
              <div class="table-wrap">
                <table id="dealMemoTable"></table>
              </div>
            </div>
          </section>
        </main>
      `;

      await initOrgScreen();
    }

    async function loadRankData(size) {
      const key = size && size !== "전체" ? size : "전체";
      const cached = cache.rank2025BySize.get(key);
      const params = new URLSearchParams();
      if (size && size !== "전체") params.set("size", size);
      const query = params.toString();
      try {
        const data = await fetchJson(`/rank/2025-deals${query ? `?${query}` : ""}`);
        const items = data.items || [];
        cache.rank2025BySize.set(key, items);
        return items;
      } catch (err) {
        if (cached) {
          showToast(`랭킹 데이터를 불러오지 못했습니다(캐시 사용): ${err.message}`, "error");
          return cached;
        }
        throw err;
      }
    }

    async function loadRankPeopleData(size) {
      const key = size && size !== "전체" ? size : "전체";
      const cached = cache.rank2025PeopleBySize.get(key);
      if (cached) return cached;
      const params = new URLSearchParams();
      if (size && size !== "전체") params.set("size", size);
      const query = params.toString();
      const data = await fetchJson(`/rank/2025-deals-people${query ? `?${query}` : ""}`);
      const items = data.items || [];
      cache.rank2025PeopleBySize.set(key, items);
      return items;
    }

    async function loadMismatchData(size) {
      const key = size && size !== "전체" ? size : "전체";
      const cached = cache.mismatch2025BySize.get(key);
      if (cached) return cached;
      const params = new URLSearchParams();
      if (size && size !== "전체") params.set("size", size);
      const query = params.toString();
      const data = await fetchJson(`/rank/mismatched-deals${query ? `?${query}` : ""}`);
      const items = data.items || [];
      cache.mismatch2025BySize.set(key, items);
      return items;
    }

    async function loadYearlyTotals() {
      if (cache.yearlyTotals) return cache.yearlyTotals;
      const data = await fetchJson("/rank/won-yearly-totals");
      cache.yearlyTotals = data.items || [];
      return cache.yearlyTotals;
    }

    function computeTargets(items) {
      const multipliers = state.rankMultipliers || {};
      return (items || []).map((row) => {
        const total2025 = row.totalAmount || 0;
        const grade = row.grade;
        const multiplier = Number(multipliers[grade]) || 1;
        let target2026 = total2025 * multiplier;
        if (row.orgName === "삼성전자" || row.orgId === "삼성전자") {
          target2026 = 50 * 1e8; // 50억 하드코딩
        }
        const total2024 = row.totalAmount2024 || 0;
        const ratio2025to2024 = total2024 ? total2025 / total2024 : null;
        return { ...row, target2026, ratio2025to2024 };
      });
    }

    function renderRankTable(items) {
      if (!items || !items.length) {
        return `<div class="muted">데이터가 없습니다.</div>`;
      }
      return `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>순위</th>
                <th>회사</th>
                <th>2024년 등급</th>
                <th>2024년 총액(억)</th>
                <th>24→25 배수</th>
                <th>2025년 등급</th>
                <th>2025년 총액(억)</th>
                <th>2025년 온라인(억)</th>
                <th>2025년 비온라인(억)</th>
                <th>2026년 목표액(억)</th>
              </tr>
            </thead>
            <tbody>
              ${items
                .map(
                  (row, idx) =>
                    `<tr>
                      <td>${idx + 1}</td>
                      <td><span class="org-link" data-idx="${idx}" style="cursor:pointer; color: var(--accent); text-decoration: underline;">${row.orgName || row.orgId || "-"}</span></td>
                      <td>${row.grade2024 || "-"}</td>
                      <td>${formatAmount(row.totalAmount2024)}</td>
                      <td>${formatRatio(row.ratio2025to2024)}</td>
                      <td>${row.grade || "-"}</td>
                      <td>${formatAmount(row.totalAmount)}</td>
                      <td>${formatAmount(row.onlineAmount)}</td>
                      <td>${formatAmount(row.offlineAmount)}</td>
                      <td>${formatAmount(row.target2026)}</td>
                    </tr>`
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderMismatchTable(items) {
      if (!items || !items.length) {
        return `<div class="muted">딜 회사와 People 회사가 다른 데이터가 없습니다.</div>`;
      }
      return `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>딜 회사(랭킹)</th>
                <th>고객 회사(People)</th>
                <th>딜</th>
                <th>고객</th>
                <th>계약일</th>
                <th>금액(억)</th>
              </tr>
            </thead>
            <tbody>
              ${items
                .map(
                  (row, idx) => `
                    <tr>
                      <td><span class="org-link" data-idx="${idx}" data-org-id="${row.dealOrgId || ""}" style="cursor:pointer; color: var(--accent); text-decoration: underline;">${row.dealOrgName || row.dealOrgId || "-"}</span></td>
                      <td><span class="org-link alt" data-idx="${idx}" data-org-id="${row.personOrgId || ""}" style="cursor:pointer; color: var(--accent-2); text-decoration: underline;">${row.personOrgName || row.personOrgId || "-"}</span></td>
                      <td>
                        <div>${
                          buildSalesmapLink("deal", row.dealId)
                            ? `<a href="${buildSalesmapLink("deal", row.dealId)}" target="_blank" rel="noopener">${row.dealName || "-"}</a>`
                            : (row.dealName || "-")
                        }</div>
                        <div class="muted" style="font-size:11px;">${row.dealId || ""}</div>
                      </td>
                      <td>
                        <div>${
                          buildSalesmapLink("person", row.personId)
                            ? `<a href="${buildSalesmapLink("person", row.personId)}" target="_blank" rel="noopener">${row.personName || "-"}</a>`
                            : (row.personName || "-")
                        }</div>
                        <div class="muted" style="font-size:11px;">${row.personId || ""}</div>
                      </td>
                      <td>${formatDate(row.contract_date)}</td>
                      <td>${formatAmount(row.amount)}</td>
                    </tr>
                  `
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function computeIndustrySummary(items) {
      const summaryMap = new Map();
      items.forEach((row) => {
        const key = (row.industryMajor || "미입력").trim() || "미입력";
        const entry = summaryMap.get(key) || { industry: key, total: 0, orgCount: 0 };
        const val = Number(row.totalAmount) || 0;
        entry.total += val;
        entry.orgCount += 1;
        summaryMap.set(key, entry);
      });
      return Array.from(summaryMap.values()).sort((a, b) => b.total - a.total);
    }

    function renderIndustryTable(container, summary) {
      if (!container) return;
      if (!summary || !summary.length) {
        container.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
        return;
      }
      container.innerHTML = `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>업종 구분(대)</th>
                <th>총액(억)</th>
                <th>회사 수</th>
              </tr>
            </thead>
            <tbody>
              ${summary
                .map(
                  (row) =>
                    `<tr>
                      <td>${row.industry}</td>
                      <td>${formatAmount(row.total)}</td>
                      <td>${row.orgCount}</td>
                    </tr>`
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderSizeTotalsTable(totals) {
      if (!totals || !totals.length) {
        return `<div class="muted">데이터가 없습니다.</div>`;
      }
      return `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>기업 규모</th>
                <th>2023 Won(억)</th>
                <th>2024 Won(억)</th>
                <th>2025 Won(억)</th>
              </tr>
            </thead>
            <tbody>
              ${totals
                .map(
                  (row) =>
                    `<tr>
                      <td>${row.size}</td>
                      <td>${formatAmount(row.won2023)}</td>
                      <td>${formatAmount(row.won2024)}</td>
                      <td>${formatAmount(row.won2025)}</td>
                    </tr>`
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderRankPeopleTable(items) {
      if (!items || !items.length) {
        return `<div class="muted">데이터가 없습니다.</div>`;
      }
      return `
        <div class="table-wrap full">
          <table>
            <thead>
              <tr>
                <th>회사</th>
                <th>소속 상위 조직</th>
                <th>팀</th>
                <th>이름</th>
                <th>직급</th>
                <th>담당 교육 영역</th>
                <th>딜 목록</th>
              </tr>
            </thead>
            <tbody>
              ${items
                .map(
                  (row, idx) => `
                    <tr>
                      <td><span class="org-link" data-idx="${idx}" style="cursor:pointer; color: var(--accent); text-decoration: underline;">${row.orgName || row.orgId || "-"}</span></td>
                      <td>${normalizeUpperForDisplay(row.upper_org) || "-"}</td>
                      <td>${row.team_signature === "미입력" ? "-" : (row.team_signature || "-")}</td>
                      <td>${(() => {
                        const link = buildSalesmapLink("person", row.personId);
                        const name = row.personName || "(연결 안 됨)";
                        return link
                          ? `<a href="${link}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: underline;">${name}</a>`
                          : name;
                      })()}</td>
                      <td>${row.title_signature || "-"}</td>
                      <td>${row.edu_area || "-"}</td>
                      <td>
                        <button class="secondary" data-idx="${idx}" data-action="deals">딜 보기</button>
                      </td>
                    </tr>
                  `
                )
                .join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    async function renderRank2025Screen(contentRoot) {
      contentRoot.innerHTML = `
        <section class="card">
          <div class="control-row">
            <h2>등급/목표 설정</h2>
            <div class="spacer"></div>
            <button id="openGradeGuide" type="button">등급 구간 확인하기</button>
            <button id="openMultiplierModal" type="button">등급별 배수 설정</button>
          </div>
        </section>
        <section class="card">
          <h2>요약 합계</h2>
          <div id="rankSummaryBody" class="muted">불러오는 중...</div>
        </section>
        <section class="card">
          <div class="control-row">
            <h2>2025년 체결액 순위 (Won 상태)</h2>
            <div class="spacer"></div>
            <label class="muted">기업 규모</label>
            <select id="rankSizeSelect"></select>
          </div>
          <div id="rankBody" class="muted">불러오는 중...</div>
        </section>
      `;

      ensureRankModals();

      const target = document.getElementById("rankBody");
      const sizeSelect = document.getElementById("rankSizeSelect");
      const summaryBody = document.getElementById("rankSummaryBody");
      const btnGuide = document.getElementById("openGradeGuide");
      const btnMultiplier = document.getElementById("openMultiplierModal");

      let currentItems = [];

      const renderSummary = (items) => {
        if (!summaryBody) return;
        if (!items || !items.length) {
          summaryBody.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
          return;
        }
        const total2025 = items.reduce((sum, row) => sum + (row.totalAmount || 0), 0);
        const total2026 = items.reduce((sum, row) => sum + (row.target2026 || 0), 0);
        summaryBody.innerHTML = `
          <div>규모: <strong>${state.rankSize || "전체"}</strong></div>
          <div>2025년 체결액 합: ${formatAmount(total2025)}</div>
          <div>2026년 목표액 합: ${formatAmount(total2026)}</div>
        `;
      };

      const renderAll = (items) => {
        currentItems = computeTargets(items);
        target.innerHTML = renderRankTable(currentItems);
        renderSummary(currentItems);
        target.querySelectorAll(".org-link").forEach((cell) => {
          cell.addEventListener("click", async () => {
            const idx = Number(cell.getAttribute("data-idx"));
            const row = currentItems[idx];
            if (!row) return;
            await navigateToOrg(row.orgId);
          });
        });
      };

      const refresh = async () => {
        if (target) target.textContent = "불러오는 중...";
        if (summaryBody) summaryBody.textContent = "불러오는 중...";
        try {
          const items = await loadRankData(state.rankSize);
          renderAll(items);
        } catch (err) {
          if (target) target.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
          if (summaryBody) summaryBody.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
          showToast(`랭킹 데이터를 불러오지 못했습니다: ${err.message}`, "error");
        }
      };

      try {
        const sizes = await getSizes();
        sizeSelect.innerHTML = sizes.map((s) => `<option value="${s}">${s}</option>`).join("");
        if (!sizes.includes(state.rankSize)) {
          state.rankSize = sizes[0] || "전체";
        }
        sizeSelect.value = state.rankSize;
      } catch (err) {
        if (target) target.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        showToast(`랭킹 규모 목록 오류: ${err.message}`, "error");
        return;
      }

      sizeSelect.addEventListener("change", async (e) => {
        state.rankSize = e.target.value || "전체";
        await refresh();
      });

      if (btnGuide) {
        btnGuide.addEventListener("click", () => openGradeGuideModal());
      }
      if (btnMultiplier) {
        btnMultiplier.addEventListener("click", () => openMultiplierModal(() => renderAll(currentItems)));
      }

      await refresh();
    }

    async function renderMismatch2025Screen(contentRoot) {
      contentRoot.innerHTML = `
        <section class="card">
          <div class="control-row">
            <h2>고객사 불일치 (Deal vs People)</h2>
            <div class="spacer"></div>
            <label class="muted">기업 규모</label>
            <select id="mismatchSizeSelect"></select>
          </div>
          <div class="muted">딜이 연결된 회사와 People이 연결된 회사가 다른 모든 딜을 보여줍니다. 딜/고객명을 클릭하면 Salesmap 원본으로 이동합니다.</div>
          <div id="mismatchBody" class="muted">불러오는 중...</div>
        </section>
      `;

      const sizeSelect = document.getElementById("mismatchSizeSelect");
      const body = document.getElementById("mismatchBody");

      try {
        const sizes = await getSizes();
        sizeSelect.innerHTML = sizes.map((s) => `<option value="${s}">${s}</option>`).join("");
        if (!sizes.includes(state.mismatchSize)) {
          state.mismatchSize = sizes.find((s) => s === "대기업") || sizes[0] || "전체";
        }
        sizeSelect.value = state.mismatchSize;
      } catch (err) {
        body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        showToast(`규모 목록을 불러오지 못했습니다: ${err.message}`, "error");
        return;
      }

      const refresh = async () => {
        body.textContent = "불러오는 중...";
        try {
          const items = await loadMismatchData(state.mismatchSize);
          body.innerHTML = renderMismatchTable(items);
          body.querySelectorAll(".org-link").forEach((cell) => {
            const orgId = cell.getAttribute("data-org-id");
            if (!orgId) return;
            cell.addEventListener("click", async () => {
              await navigateToOrg(orgId);
            });
          });
        } catch (err) {
          body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
          showToast(`불일치 목록을 불러오지 못했습니다: ${err.message}`, "error");
        }
      };

      sizeSelect.addEventListener("change", async (e) => {
        state.mismatchSize = e.target.value;
        await refresh();
      });

      await refresh();
    }

    async function renderRank2025PeopleScreen(contentRoot) {
      contentRoot.innerHTML = `
        <section class="card">
          <div class="control-row">
            <h2>2025 대기업 딜·People 매핑</h2>
            <div class="spacer"></div>
            <label class="muted">기업 규모</label>
            <select id="rankPeopleSizeSelect"></select>
            <label class="muted">회사</label>
            <select id="rankPeopleOrgSelect"></select>
            <label class="muted">상위 조직</label>
            <select id="rankPeopleUpperSelect"></select>
            <button id="rankPeopleReset" type="button">필터 리셋</button>
          </div>
          <div class="muted" id="rankPeopleHint">불러오는 중...</div>
          <div id="rankPeopleBody" class="muted">불러오는 중...</div>
        </section>
      `;

      const sizeSelect = document.getElementById("rankPeopleSizeSelect");
      const orgSelect = document.getElementById("rankPeopleOrgSelect");
      const upperSelect = document.getElementById("rankPeopleUpperSelect");
      const resetBtn = document.getElementById("rankPeopleReset");
      const hint = document.getElementById("rankPeopleHint");
      const body = document.getElementById("rankPeopleBody");
      let currentItems = [];

      const applyFilters = () => {
        const eligible = currentItems.filter((row) => {
          const upper = normalizeUpperOrg(row.upper_org);
          const team = (row.team_signature || "").trim();
          // 상위 조직과 팀이 모두 미입력일 때만 제외
          return !(upper === "미입력" && (!team || team === "미입력"));
        });
        const orgOptions = currentItems.reduce((acc, row) => {
          if (row.orgId) {
            const label = row.orgName || row.orgId || "미입력";
            acc.set(row.orgId, label);
          }
          return acc;
        }, new Map());
        const upperOptions = Array.from(
          new Set(
            eligible
              .map((row) => normalizeUpperForDisplay(row.upper_org))
              .filter((u) => u && u !== "미입력")
          )
        );

        const orgOptionsHtml = ['<option value="">전체</option>'];
        Array.from(orgOptions.entries())
          .sort((a, b) => String(a[1] || "").localeCompare(String(b[1] || "")))
          .forEach(([id, name]) => orgOptionsHtml.push(`<option value="${id}">${name || "미입력"}</option>`));
        orgSelect.innerHTML = orgOptionsHtml.join("");
        if (state.rankPeopleOrgFilter && !orgOptions.has(state.rankPeopleOrgFilter)) {
          state.rankPeopleOrgFilter = "";
        }
        orgSelect.value = state.rankPeopleOrgFilter;

        const upperOptionsHtml = ['<option value="">전체</option>'];
        upperOptions.sort().forEach((u) => upperOptionsHtml.push(`<option value="${u}">${u}</option>`));
        upperSelect.innerHTML = upperOptionsHtml.join("");
        if (state.rankPeopleUpperFilter && !upperOptions.includes(state.rankPeopleUpperFilter)) {
          state.rankPeopleUpperFilter = "";
        }
        upperSelect.value = state.rankPeopleUpperFilter;

        const filtered = eligible.filter((row) => {
          if (state.rankPeopleOrgFilter && row.orgId !== state.rankPeopleOrgFilter) return false;
          if (
            state.rankPeopleUpperFilter &&
            normalizeUpperForDisplay(row.upper_org) !== state.rankPeopleUpperFilter
          )
            return false;
          return true;
        });

        hint.textContent = `총 ${filtered.length}명 · 회사 ${orgOptions.size}곳`;
        body.innerHTML = renderRankPeopleTable(filtered);
        body.querySelectorAll(".org-link").forEach((cell) => {
          cell.addEventListener("click", async () => {
            const idx = Number(cell.getAttribute("data-idx"));
            const row = filtered[idx];
            if (!row) return;
            await navigateToOrg(row.orgId);
          });
        });
        body.querySelectorAll('button[data-action="deals"]').forEach((btn) => {
          btn.addEventListener("click", () => {
            const idx = Number(btn.getAttribute("data-idx"));
            const row = filtered[idx];
            if (!row) return;
            const label = `${row.personName || "(연결 안 됨)"} @ ${row.orgName || row.orgId || "-"}`;
            openDealsModal(label, row.deals || []);
          });
        });
        resetBtn.disabled =
          !state.rankPeopleOrgFilter && !state.rankPeopleUpperFilter && state.rankPeopleSize === (sizeSelect.value || "");
      };

      const refreshSize = async () => {
        body.textContent = "불러오는 중...";
        hint.textContent = "불러오는 중...";
        try {
          currentItems = await loadRankPeopleData(state.rankPeopleSize);
          applyFilters();
        } catch (err) {
          body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
          hint.textContent = "데이터를 불러오지 못했습니다.";
          showToast(`2025 딜·People 조회 오류: ${err.message}`, "error");
        }
      };

      try {
        const sizes = await getSizes();
        sizeSelect.innerHTML = sizes.map((s) => `<option value="${s}">${s}</option>`).join("");
        if (!sizes.includes(state.rankPeopleSize)) {
          state.rankPeopleSize = sizes.find((s) => s === "대기업") || sizes[0] || "전체";
        }
        sizeSelect.value = state.rankPeopleSize;
      } catch (err) {
        body.innerHTML = `<div class="muted">오류: ${err.message}</div>`;
        hint.textContent = "규모 목록을 불러오지 못했습니다.";
        showToast(`규모 목록 오류: ${err.message}`, "error");
        return;
      }

      sizeSelect.addEventListener("change", async (e) => {
        state.rankPeopleSize = e.target.value;
        state.rankPeopleOrgFilter = "";
        state.rankPeopleUpperFilter = "";
        await refreshSize();
      });

      orgSelect.addEventListener("change", () => {
        state.rankPeopleOrgFilter = orgSelect.value;
        applyFilters();
      });

      upperSelect.addEventListener("change", () => {
        state.rankPeopleUpperFilter = upperSelect.value;
        applyFilters();
      });

      resetBtn.addEventListener("click", () => {
        state.rankPeopleOrgFilter = "";
        state.rankPeopleUpperFilter = "";
        orgSelect.value = "";
        upperSelect.value = "";
        applyFilters();
      });

      await refreshSize();
    }


    async function renderIndustryMenu(contentRoot) {
      contentRoot.innerHTML = `
        <section class="card">
          <div class="control-row">
            <h2>업종별 매출 (23/24/25 Won)</h2>
            <div class="spacer"></div>
            <span class="muted">업종 구분(대)별 연도별 Won 합계</span>
          </div>
          <div class="quad-grid">
            <div>
              <h3 class="muted">대기업</h3>
              <div id="industryLargeBody"></div>
            </div>
            <div>
              <h3 class="muted">중견기업</h3>
              <div id="industryMidBody"></div>
            </div>
          </div>
        </section>
      `;
      const largeBody = document.getElementById("industryLargeBody");
      const midBody = document.getElementById("industryMidBody");

      const renderSummary = (container, items) => {
        if (!container) return;
        if (!items || !items.length) {
          container.innerHTML = `<div class="muted">데이터가 없습니다.</div>`;
          return;
        }
        container.innerHTML = `
          <div class="table-wrap full">
            <table>
              <thead>
                <tr>
                  <th>업종 구분(대)</th>
                  <th>2023 Won(억)</th>
                  <th>2024 Won(억)</th>
                  <th>2025 Won(억)</th>
                  <th>회사 수</th>
                </tr>
              </thead>
              <tbody>
                ${items
                  .map(
                    (row) =>
                      `<tr>
                        <td>${row.industry}</td>
                        <td>${formatAmount(row.won2023)}</td>
                        <td>${formatAmount(row.won2024)}</td>
                        <td>${formatAmount(row.won2025)}</td>
                        <td>${row.orgCount || 0}</td>
                      </tr>`
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
      };

      try {
        const [largeItems, midItems] = await Promise.all([
          fetchJson("/rank/won-industry-summary?size=대기업").then((d) => d.items || []),
          fetchJson("/rank/won-industry-summary?size=중견기업").then((d) => d.items || []),
        ]);
        renderSummary(largeBody, largeItems);
        renderSummary(midBody, midItems);
      } catch (err) {
        renderSummary(largeBody, []);
        renderSummary(midBody, []);
        showToast(`업종별 매출 조회 오류: ${err.message}`, "error");
      }
    }

    function initApp() {
      renderSidebar();
      renderContent();
    }

    document.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>

</html>
